<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>LynxLite - Dashboard (Overview)</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
    <!-- Fonts and icons -->
    <script src="assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
      WebFont.load({
        google: { families: ["Public Sans:300,400,500,600,700"] },
        custom: {
          families: [
            "Font Awesome 5 Solid",
            "Font Awesome 5 Regular",
            "Font Awesome 5 Brands",
            "simple-line-icons",
          ],
          urls: ["assets/css/fonts.min.css"],
        },
        active: function () {
          sessionStorage.fonts = true;
        },
      });
    </script>
    <!-- CSS Files -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/plugins.min.css" />
    <link rel="stylesheet" href="assets/css/lynxlite.min.css" />
    <link rel="stylesheet" href="assets/css/demo.css" />
    <link rel="stylesheet" href="assets/css/unified-custom.css" />
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" type="text/css">
    
    <!-- Custom Styles for New Widgets -->
    <style>
      /* Floating Feedback Button */
      .floating-feedback-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
        z-index: 1000;
        transition: all 0.3s ease;
      }
      
      .floating-feedback-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(0, 123, 255, 0.4);
      }
      
      .feedback-pulse {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(0, 123, 255, 0.4);
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(1.4); opacity: 0; }
      }
      
      /* Widget Card Styles */
      .usage-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        border-left: 4px solid #007bff;
      }
      
      .usage-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 12px;
        color: #6c757d;
      }
      
      .usage-card-header i {
        margin-right: 6px;
      }
      
      .usage-card-value {
        font-size: 24px;
        font-weight: bold;
        color: #495057;
        margin-bottom: 4px;
      }
      
      .usage-card-change {
        font-size: 11px;
        font-weight: 500;
      }
      
      /* Alert Summary Cards */
      .alert-summary-card {
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
      }
      
      .critical-alert-item {
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
      }
      
      .critical-alert-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-color: #007bff;
      }
      
      .critical-alert-item.acknowledged {
        opacity: 0.7;
        background: #f8f9fa;
      }
      
      .critical-alert-item.acknowledged .alert-content {
        text-decoration: line-through;
      }

      /* Weather Widget Styles */
      .weather-info {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #dee2e6;
      }

      .weather-details {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
      }

      .circular-progress-container {
        position: relative;
        display: inline-block;
      }

      .circular-progress {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: conic-gradient(#007bff 0deg 306deg, #e9ecef 306deg 360deg);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .circular-progress::before {
        content: '';
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: white;
        position: absolute;
      }

      .progress-value {
        position: relative;
        z-index: 1;
        font-weight: bold;
        font-size: 0.9rem;
        color: #007bff;
      }

      .demand-bar {
        min-width: 40px;
      }

      .forecast-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
      }

      .forecast-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
      }

      .demand-score-bar {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
      }

      .demand-score-fill {
        height: 100%;
        transition: width 0.3s ease;
      }

      .weather-alert {
        border-left: 4px solid;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0 8px 8px 0;
        background: rgba(255, 255, 255, 0.8);
      }

      .weather-alert.warning {
        border-left-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
      }

      .weather-alert.success {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
      }

      .weather-alert.info {
        border-left-color: #17a2b8;
        background: rgba(23, 162, 184, 0.1);
      }

      .recommendation-item {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
      }

      .recommendation-item:hover {
        background: #e9ecef;
        transform: translateX(3px);
      }

      #refreshIcon.spinning {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Customer Insights Widget Styles */
      .customer-insights-widget .customer-metric {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
      }

      .customer-insights-widget .customer-metric:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      }

      .customer-insights-widget .metric-icon {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
      }

      .customer-insights-panel {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        height: 100%;
      }

      .top-customer-item {
        background: white;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #007bff;
        transition: all 0.2s ease;
      }

      .top-customer-item:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .top-customer-item.vip {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
      }

      .customer-alert-item {
        background: white;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #dc3545;
        transition: all 0.2s ease;
      }

      .customer-alert-item:hover {
        transform: translateX(3px);
      }

      .customer-alert-item.warning {
        border-left-color: #ffc107;
        background: rgba(255, 193, 7, 0.05);
      }

      .customer-alert-item.info {
        border-left-color: #17a2b8;
        background: rgba(23, 162, 184, 0.05);
      }

      .customer-recommendation-item {
        background: white;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #28a745;
        transition: all 0.2s ease;
      }

      .customer-recommendation-item:hover {
        transform: translateX(3px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .segment-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
      }

      .segment-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      }

      .segment-progress {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        background: #e9ecef;
      }

      .segment-progress-fill {
        height: 100%;
        transition: width 0.5s ease;
        border-radius: 4px;
      }

      .retention-metric {
        text-align: center;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
      }

      #customerRefreshIcon.spinning {
        animation: spin 1s linear infinite;
      }

      /* Compact Customer Insights Styles */
      .customer-insights-panel-compact {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        height: 180px;
        overflow-y: auto;
      }

      .customer-alerts-compact,
      .customer-recommendations-compact,
      .customer-bookings-compact,
      .customer-reservations-compact {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
      }

      .booking-item-compact,
      .reservation-item-compact {
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        border-left: 3px solid #007bff;
        transition: all 0.2s ease;
      }

      .booking-item-compact:hover,
      .reservation-item-compact:hover {
        transform: translateX(3px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      }
      

      .top-customer-item-compact {
        background: white;
        border-radius: 6px;
        padding: 0.5rem;
        margin-bottom: 0.4rem;
        border-left: 3px solid #007bff;
        transition: all 0.2s ease;
      }

      .top-customer-item-compact:hover {
        transform: translateX(3px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      }

      .top-customer-item-compact.vip {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
      }

      .customer-metric {
        padding: 1rem;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .customer-metric .metric-icon {
        width: 50px;
        height: 50px;
      }

      .btn-xs {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        line-height: 1.2;
      }

      /* Financial Dashboard Styles */
      .financial-dashboard-widget .financial-metric {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .financial-dashboard-widget .financial-metric:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      }

      .financial-dashboard-widget .metric-icon {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
      }

      .financial-summary-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        height: 100%;
      }

      .target-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #dee2e6;
      }

      /* Fleet Management Widget Styles */
      .fleet-management-widget .fleet-stat-card {
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
      }

      .fleet-management-widget .fleet-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      .fleet-sidebar {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        height: 100%;
      }

      .fleet-performance-metrics .metric-item {
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        border: 1px solid #dee2e6;
      }
      
      .high-priority {
        border-left: 4px solid #dc3545 !important;
      }
      
      .medium-priority {
        border-left: 4px solid #ffc107 !important;
      }
      
      .low-priority {
        border-left: 4px solid #17a2b8 !important;
      }
      
      /* Calendar Styles */
      .mini-calendar {
        font-size: 12px;
      }
      
      .calendar-date {
        padding: 4px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .calendar-date:hover {
        background: #e9ecef;
      }
      
      .calendar-date.today {
        background: #007bff;
        color: white;
        font-weight: bold;
      }
      
      .calendar-date.has-event {
        position: relative;
      }
      
      .calendar-date.has-event::after {
        content: '';
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 4px;
        height: 4px;
        background: #28a745;
        border-radius: 50%;
      }
      
      /* Schedule Item Styles */
      .schedule-item {
        transition: all 0.2s ease;
      }
      
      .schedule-item:hover {
        background: #f8f9fa;
        transform: translateX(2px);
      }
      
      /* Fullscreen Map Styles */
      .fullscreen-map {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }
      
      .fullscreen-map #fleetMap {
        height: calc(100vh - 120px) !important;
      }
      
      /* Widget Animation Styles */
      [data-widget] {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      
      /* Fleet Usage Chart Enhancements */
      .fleet-usage-widget .chart-container {
        width: 100% !important;
        min-width: 0 !important;
        flex: 1 !important;
      }
      
      .fleet-usage-widget .chart-wrapper {
        width: 100% !important;
        display: block !important;
        position: relative !important;
        overflow: hidden;
      }
      
      .fleet-usage-widget canvas {
        max-width: 100% !important;
        width: 100% !important;
        height: 100% !important;
        display: block !important;
      }
      
      .fleet-usage-widget .row {
        width: 100% !important;
        margin: 0 !important;
      }
      
      .fleet-usage-widget .col-md-8,
      .fleet-usage-widget .col-md-4 {
        padding-left: 8px !important;
        padding-right: 8px !important;
      }
      
      /* Dark Mode Enhancements */
      .dark-mode .usage-card {
        background: #2c3e50;
        border-left-color: #3498db;
      }
      
      .dark-mode .critical-alert-item {
        background: #34495e;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      
      .dark-mode .alert-summary-card {
        border: 1px solid #4a5568;
      }
      
      /* Widget Card Styles */
      .widget-card {
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      
      .widget-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.15);
        border-color: #007bff;
      }
      
      .widget-card.active {
        border-color: #28a745;
        background: linear-gradient(135deg, #f8fff9, #e8f5e8);
      }
      
      .widget-card.active .widget-card-status {
        background: #28a745;
      }
      
      .widget-card.inactive {
        border-color: #dc3545;
        background: linear-gradient(135deg, #fff8f8, #fee);
        opacity: 0.7;
      }
      
      .widget-card.inactive .widget-card-status {
        background: #dc3545;
      }
      
      .widget-card-status {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #28a745;
        transition: all 0.3s ease;
      }
      
      .widget-card-icon {
        font-size: 28px;
        color: #007bff;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }
      
      .widget-card.active .widget-card-icon {
        color: #28a745;
      }
      
      .widget-card.inactive .widget-card-icon {
        color: #dc3545;
      }
      
      .widget-card-title {
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        margin: 0;
        line-height: 1.2;
      }
      
      .widget-card.active .widget-card-title {
        color: #28a745;
      }
      
      .widget-card.inactive .widget-card-title {
        color: #dc3545;
      }
      
      /* Enhanced Widget Card States */
      .widget-card.transitioning {
        transform: scale(0.98);
        opacity: 0.8;
      }
      
      .widget-card.pulse-effect {
        animation: pulseCard 0.6s ease-out;
      }
      
      @keyframes pulseCard {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(0, 123, 255, 0.3); }
        100% { transform: scale(1); }
      }
      
      /* Enhanced Panel Animations */
      #customizationPanel {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      /* Widget Selection Panel */
      .widget-selection-panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e9ecef;
      }
      
      /* Dark Mode Widget Cards */
      .dark-mode .widget-card {
        background: #2c3e50;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      
      .dark-mode .widget-card.active {
        background: linear-gradient(135deg, #1a2332, #2d3748);
        border-color: #48bb78;
      }
      
      .dark-mode .widget-card.inactive {
        background: linear-gradient(135deg, #2d1b1b, #3c2222);
        border-color: #e53e3e;
      }
      
      .dark-mode .widget-card-title {
        color: #e2e8f0;
      }
      
      .dark-mode .widget-selection-panel {
        background: #2d3748;
        border-color: #4a5568;
      }
      
      /* Responsive Adjustments */
      @media (max-width: 768px) {
        .floating-feedback-btn {
          bottom: 20px;
          right: 20px;
          width: 50px;
          height: 50px;
          font-size: 20px;
        }
        
        .usage-card-value {
          font-size: 20px;
        }
        
        .critical-alert-item {
          padding: 10px;
        }
        
        .widget-card {
          min-height: 100px;
          padding: 15px 10px;
        }
        
        .widget-card-icon {
          font-size: 24px;
        }
        
        .widget-card-title {
          font-size: 12px;
        }
      }
      
      /* Additional Dark Mode Fixes for Remaining Elements */
      .dark-mode .usage-card {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .critical-alert-item.acknowledged {
        background: #374151 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .weather-info {
        background: linear-gradient(135deg, #2d3748 0%, #374151 100%) !important;
        color: #e2e8f0;
      }
      
      .dark-mode .weather-details {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .weather-progress-ring {
        background: conic-gradient(#3182ce 0deg 306deg, #374151 306deg 360deg) !important;
      }
      
      .dark-mode .weather-progress-inner {
        background: #2d3748 !important;
      }
      
      .dark-mode .forecast-item {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .forecast-item:hover {
        background: #374151 !important;
      }
      
      .dark-mode .demand-score-bar {
        background: #374151 !important;
      }
      
      .dark-mode .recommendation-item {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .recommendation-item:hover {
        background: #374151 !important;
      }
      
      .dark-mode .customer-insights-widget .customer-metric {
        background: linear-gradient(135deg, #2d3748 0%, #374151 100%) !important;
        color: #e2e8f0;
        border-color: #4a5568;
      }
      
      .dark-mode .customer-insights-widget .metric-icon {
        background: rgba(45, 55, 72, 0.8) !important;
        color: #e2e8f0;
      }
      
      .dark-mode .customer-insights-panel {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .top-customer-item {
        background: #2d3748 !important;
        color: #e2e8f0;
        border-left-color: #3182ce;
      }
      
      .dark-mode .top-customer-item:hover {
        background: #374151 !important;
      }
      
      .dark-mode .top-customer-item.vip {
        background: linear-gradient(135deg, #744210 0%, #2d3748 100%) !important;
        border-left-color: #f6ad55;
      }
      
      .dark-mode .customer-alert-item {
        background: #2d3748 !important;
        color: #e2e8f0;
        border-left-color: #e53e3e;
      }
      
      .dark-mode .customer-alert-item.warning {
        background: rgba(255, 193, 7, 0.1) !important;
        border-left-color: #f6ad55;
      }
      
      .dark-mode .customer-alert-item.info {
        background: rgba(23, 162, 184, 0.1) !important;
        border-left-color: #4fd1c7;
      }
      
      .dark-mode .customer-recommendation-item {
        background: #2d3748 !important;
        color: #e2e8f0;
        border-left-color: #38a169;
      }
      
      .dark-mode .customer-recommendation-item:hover {
        background: #374151 !important;
      }
      
      .dark-mode .segment-card {
        background: #2d3748 !important;
        color: #e2e8f0;
        border-color: #4a5568;
      }
      
      .dark-mode .segment-card:hover {
        background: #374151 !important;
      }
      
      .dark-mode .segment-progress {
        background: #374151 !important;
      }
      
      .dark-mode .retention-metric {
        background: #2d3748 !important;
        color: #e2e8f0;
        border-color: #4a5568;
      }
      
      .dark-mode .customer-insights-panel-compact {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .customer-alerts-compact,
      .dark-mode .customer-recommendations-compact,
      .dark-mode .customer-bookings-compact,
      .dark-mode .customer-reservations-compact {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .booking-item-compact,
      .dark-mode .reservation-item-compact {
        background: #374151 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .top-customer-item-compact {
        background: #374151 !important;
        color: #e2e8f0;
        border-left-color: #3182ce;
      }
      
      .dark-mode .top-customer-item-compact.vip {
        background: linear-gradient(135deg, #744210 0%, #374151 100%) !important;
        border-left-color: #f6ad55;
      }
      
      .dark-mode .financial-dashboard-widget .financial-metric {
        background: linear-gradient(135deg, #2d3748 0%, #374151 100%) !important;
        color: #e2e8f0;
        border-color: #4a5568;
      }
      
      .dark-mode .financial-summary-card {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .target-item {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .fleet-sidebar {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .fleet-performance-metrics .metric-item {
        background: #2d3748 !important;
        color: #e2e8f0;
      }
      
      .dark-mode .calendar-date:hover {
        background: #374151 !important;
      }
      
      .dark-mode .schedule-item:hover {
        background: #2d3748 !important;
      }
      
      .dark-mode .widget-card {
        background: #2d3748 !important;
        color: #e2e8f0;
        border-color: #4a5568;
      }
      
      .dark-mode .widget-card.inactive {
        background: linear-gradient(135deg, #2d1b1b, #3c2222) !important;
        border-color: #e53e3e;
      }
      
      .dark-mode .widget-selection-panel {
        background: #2d3748 !important;
        color: #e2e8f0;
        border-color: #4a5568;
      }
      
      /* Key Insights Section Dark Mode - Executive Summary Widget */
      .dark-mode .alert.alert-info {
        background-color: #1a365d !important;
        border-color: #3182ce !important;
        color: #90cdf4 !important;
      }
      
      .dark-mode .alert.alert-info .alert-heading {
        color: #e2e8f0 !important;
      }
      
      .dark-mode .alert.alert-info .alert-heading i {
        color: #f6ad55 !important;
      }
      
      .dark-mode .alert.alert-info strong {
        color: #e2e8f0 !important;
      }
      
      .dark-mode .alert.alert-info small {
        color: #a0aec0 !important;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- Sidebar -->
      <div class="sidebar" data-background-color="dark">
        <div class="sidebar-logo">
          <div class="logo-header" data-background-color="dark">
            <a href="index.html" class="logo">
              <img src="assets/img/lynxlite/logo_light.svg" alt="LynxLite - Acacus" class="navbar-brand" height="45" />
            </a>
            <div class="nav-toggle">
              <button class="btn btn-toggle toggle-sidebar"><i class="gg-menu-right"></i></button>
              <button class="btn btn-toggle sidenav-toggler"><i class="gg-menu-left"></i></button>
            </div>
            <button class="topbar-toggler more"><i class="gg-more-vertical-alt"></i></button>
          </div>
        </div>
        <div class="sidebar-wrapper scrollbar scrollbar-inner">
          <div class="sidebar-content">
            <ul class="nav nav-secondary">
              <li class="nav-item active">
                <a href="#"><i class="fas fa-home"></i><p>Dashboard (Overview)</p></a>
              </li>
              <li class="nav-item">
                <a href="fleet-management.html"><i class="fas fa-car"></i><p>Fleet Management</p></a>
              </li>
              <li class="nav-item">
                <a href="booking-management.html"><i class="fas fa-calendar-alt"></i><p>Booking Management</p></a>
              </li>
              <li class="nav-item">
                <a href="customer-management.html"><i class="fas fa-users"></i><p>Customer Management</p></a>
              </li>
              <li class="nav-item">
                <a href="billing-payments.html"><i class="fas fa-credit-card"></i><p>Billing & Payments</p></a>
              </li>
              <li class="nav-item">
                <a href="maintenance-compliance.html"><i class="fas fa-wrench"></i><p>Maintenance & Compliance</p></a>
              </li>
              <li class="nav-item">
                <a href="telematics-tracking.html"><i class="fas fa-map-marked-alt"></i><p>Telematics & Tracking</p></a>
              </li>
              <li class="nav-item">
                <a href="reports-analytics.html"><i class="fas fa-chart-line"></i><p>Reports & Analytics</p></a>
              </li>
              <li class="nav-item">
                <a href="branch-staff-management.html"><i class="fas fa-building"></i><p>Branch / Staff Management</p></a>
              </li>
              <li class="nav-item">
                <a href="#"><i class="fas fa-cogs"></i><p>System Settings</p></a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <!-- End Sidebar -->
      <div class="main-panel">
        <div class="main-header">
          <div class="main-header-logo">
            <div class="logo-header" data-background-color="dark">
              <a href="index.html" class="logo">
                <img src="assets/img/lynxlite/logo_light.svg" alt="LynxLite - Acacus" class="navbar-brand" height="32" />
              </a>
              <div class="nav-toggle">
                <button class="btn btn-toggle toggle-sidebar"><i class="gg-menu-right"></i></button>
                <button class="btn btn-toggle sidenav-toggler"><i class="gg-menu-left"></i></button>
              </div>
              <button class="topbar-toggler more"><i class="gg-more-vertical-alt"></i></button>
            </div>
          </div>
          <!-- Navbar Header -->
          <nav class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom">
            <div class="container-fluid">
              <nav class="navbar navbar-header-left navbar-expand-lg navbar-form nav-search p-0 d-none d-lg-flex">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <button type="submit" class="btn btn-search pe-1">
                      <i class="fa fa-search search-icon"></i>
                    </button>
                  </div>
                  <input type="text" placeholder="Search ..." class="form-control" />
                </div>
              </nav>
              <ul class="navbar-nav topbar-nav ms-md-auto align-items-center">
                <li class="nav-item d-flex align-items-center">
                  <div class="form-check form-switch mb-0 ms-2">
                    <input class="form-check-input" type="checkbox" id="darkModeSwitch" />
                    <label class="form-check-label" for="darkModeSwitch" style="color:inherit;">Dark Mode</label>
                  </div>
                </li>
                <li class="nav-item topbar-icon dropdown hidden-caret d-flex d-lg-none">
                  <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false" aria-haspopup="true">
                    <i class="fa fa-search"></i>
                  </a>
                  <ul class="dropdown-menu dropdown-search animated fadeIn">
                    <form class="navbar-left navbar-form nav-search">
                      <div class="input-group">
                        <input type="text" placeholder="Search ..." class="form-control" />
                      </div>
                    </form>
                  </ul>
                </li>
                <li class="nav-item topbar-icon dropdown hidden-caret">
                  <a class="nav-link dropdown-toggle" href="#" id="messageDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-envelope"></i>
                  </a>
                  <ul class="dropdown-menu messages-notif-box animated fadeIn" aria-labelledby="messageDropdown">
                    <li>
                      <div class="dropdown-title d-flex justify-content-between align-items-center">Messages <a href="#" class="small">Mark all as read</a></div>
                    </li>
                    <li>
                      <div class="message-notif-scroll scrollbar-outer">
                        <div class="notif-center">
                          <a href="#"><div class="notif-img"><i class="fas fa-user-circle fa-2x"></i></div><div class="notif-content"><span class="subject">Jimmy Denis</span><span class="block"> How are you ? </span><span class="time">5 minutes ago</span></div></a>
                          <a href="#"><div class="notif-img"><i class="fas fa-user-circle fa-2x"></i></div><div class="notif-content"><span class="subject">Chad</span><span class="block"> Ok, Thanks ! </span><span class="time">12 minutes ago</span></div></a>
                          <a href="#"><div class="notif-img"><i class="fas fa-user-circle fa-2x"></i></div><div class="notif-content"><span class="subject">Jhon Doe</span><span class="block">I would like to report an issue with</span><span class="time">12 minutes ago</span></div></a>
                          <a href="#"><div class="notif-img"><i class="fas fa-user-circle fa-2x"></i></div><div class="notif-content"><span class="subject">Talha</span><span class="block"> Hi, are there any crossovers ? </span><span class="time">17 minutes ago</span></div></a>
                        </div>
                      </div>
                    </li>
                    <li><a class="see-all" href="javascript:void(0);">See all messages<i class="fa fa-angle-right"></i></a></li>
                  </ul>
                </li>
                <li class="nav-item topbar-icon dropdown hidden-caret">
                  <a class="nav-link dropdown-toggle" href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-bell"></i><span class="notification">4</span>
                  </a>
                  <ul class="dropdown-menu notif-box animated fadeIn" aria-labelledby="notifDropdown">
                    <li><div class="dropdown-title">You have 4 new notification</div></li>
                    <li>
                      <div class="notif-scroll scrollbar-outer">
                        <div class="notif-center">
                          <a href="#" class="notif-item"><div class="notif-icon notif-danger"><i class="fas fa-tachometer-alt"></i></div><div class="notif-content"><span class="block">Harsh Acceleration detected</span><span class="time">3 minutes ago</span></div></a>
                          <a href="#" class="notif-item"><div class="notif-icon notif-warning"><i class="fas fa-exclamation-triangle"></i></div><div class="notif-content"><span class="block">Speeding Violation: Vehicle 23</span><span class="time">7 minutes ago</span></div></a>
                          <a href="#" class="notif-item"><div class="notif-icon notif-info"><i class="fas fa-map-marker-alt"></i></div><div class="notif-content"><span class="block">Geofence Breach: Vehicle 45</span><span class="time">10 minutes ago</span></div></a>
                          <a href="#" class="notif-item"><div class="notif-icon notif-primary"><i class="fas fa-tools"></i></div><div class="notif-content"><span class="block">Maintenance Due: Vehicle 12</span><span class="time">15 minutes ago</span></div></a>
                        </div>
                      </div>
                    </li>
                    <li><a class="see-all" href="javascript:void(0);">See all notifications<i class="fa fa-angle-right"></i></a></li>
                  </ul>
                </li>
                <li class="nav-item topbar-icon dropdown hidden-caret">
                  <a class="nav-link" data-bs-toggle="dropdown" href="#" aria-expanded="false"><i class="fas fa-layer-group"></i></a>
                  <div class="dropdown-menu quick-actions animated fadeIn">
                    <div class="quick-actions-header"><span class="title mb-1">🚗 Rental Quick Actions</span><span class="subtitle op-7">Fast Operations</span></div>
                    <div class="quick-actions-scroll scrollbar-outer">
                      <div class="quick-actions-items">
                        <div class="row m-0">
                          <a class="col-6 col-md-4 p-0" href="#" onclick="quickNewBooking()"><div class="quick-actions-item"><div class="avatar-item bg-primary rounded-circle"><i class="fas fa-plus-circle"></i></div><span class="text">New Booking</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="addNewVehicleQuick()"><div class="quick-actions-item"><div class="avatar-item bg-success rounded-circle"><i class="fas fa-car-side"></i></div><span class="text">Add New Car</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="addNewCustomerQuick()"><div class="quick-actions-item"><div class="avatar-item bg-info rounded-circle"><i class="fas fa-user-plus"></i></div><span class="text">New Customer</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="addNewStaffQuick()"><div class="quick-actions-item"><div class="avatar-item bg-warning rounded-circle"><i class="fas fa-user-tie"></i></div><span class="text">Add Staff</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="quickCheckOut()"><div class="quick-actions-item"><div class="avatar-item bg-primary rounded-circle"><i class="fas fa-key"></i></div><span class="text">Check-Out</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="quickCheckIn()"><div class="quick-actions-item"><div class="avatar-item bg-success rounded-circle"><i class="fas fa-check-square"></i></div><span class="text">Check-In</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="customerLookup()"><div class="quick-actions-item"><div class="avatar-item bg-info rounded-circle"><i class="fas fa-search"></i></div><span class="text">Find Customer</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="processPayment()"><div class="quick-actions-item"><div class="avatar-item bg-warning rounded-circle"><i class="fas fa-credit-card"></i></div><span class="text">Payment</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="vehicleInspection()"><div class="quick-actions-item"><div class="avatar-item bg-secondary rounded-circle"><i class="fas fa-clipboard-check"></i></div><span class="text">Inspection</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="emergencyResponse()"><div class="quick-actions-item"><div class="avatar-item bg-danger rounded-circle"><i class="fas fa-phone"></i></div><span class="text">Emergency</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="reportDamage()"><div class="quick-actions-item"><div class="avatar-item bg-warning rounded-circle"><i class="fas fa-exclamation-triangle"></i></div><span class="text">Report Damage</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#" onclick="dailyReport()"><div class="quick-actions-item"><div class="avatar-item bg-info rounded-circle"><i class="fas fa-chart-bar"></i></div><span class="text">Daily Report</span></div></a>
                        </div>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="nav-item topbar-user dropdown hidden-caret">
                  <a class="dropdown-toggle profile-pic" data-bs-toggle="dropdown" href="#" aria-expanded="false">
                    <div class="avatar-sm"><i class="fas fa-user-circle fa-2x"></i></div>
                    <span class="profile-username"><span class="op-7">Hi,</span> <span class="fw-bold">Admin</span></span>
                  </a>
                  <ul class="dropdown-menu dropdown-user animated fadeIn">
                    <div class="dropdown-user-scroll scrollbar-outer">
                      <li>
                        <div class="user-box">
                          <div class="avatar-lg"><i class="fas fa-user-circle fa-3x"></i></div>
                          <div class="u-text">
                            <h4>Admin</h4>
                            <p class="text-muted">hello@example.com</p>
                            <a href="profile.html" class="btn btn-xs btn-secondary btn-sm">View Profile</a>
                          </div>
                        </div>
                      </li>
                      <li>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">My Profile</a>
                        <a class="dropdown-item" href="#">My Balance</a>
                        <a class="dropdown-item" href="#">Inbox</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Account Setting</a>
                        <a class="dropdown-item" href="#">Logout</a>
                      </li>
                    </div>
                  </ul>
                </li>
              </ul>
            </div>
          </nav>
        </div>
        
        <!-- Dashboard Content -->
        <div class="container">
          <div class="page-inner">
            <!-- Layout Customization Panel -->
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="card border-primary" id="customizationPanel" style="display: none;">
                  <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="mb-0"><i class="fas fa-palette me-2"></i>Dashboard Customization Center</h5>
                      <div>
                        <span class="badge bg-light text-primary me-2" id="selectedWidgetCount">12 widgets selected</span>
                        <button class="btn btn-outline-light btn-sm" onclick="closeCustomizationPanel()">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <!-- Layout Presets -->
                      <div class="col-md-12 mb-4">
                        <h6 class="mb-3"><i class="fas fa-layout me-2"></i>Quick Layout Presets</h6>
                        <div class="row g-3">
                          <div class="col-6 col-md-3">
                            <button class="btn btn-outline-primary w-100" onclick="applyLayout('executive')">
                              <div class="d-flex flex-column align-items-center py-2">
                                <i class="fas fa-crown mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold">Executive</span>
                                <small class="text-muted">Management View</small>
                              </div>
                            </button>
                          </div>
                          <div class="col-6 col-md-3">
                            <button class="btn btn-outline-success w-100" onclick="applyLayout('operations')">
                              <div class="d-flex flex-column align-items-center py-2">
                                <i class="fas fa-cogs mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold">Operations</span>
                                <small class="text-muted">Daily Operations</small>
                              </div>
                            </button>
                          </div>
                          <div class="col-6 col-md-3">
                            <button class="btn btn-outline-info w-100" onclick="applyLayout('analytics')">
                              <div class="d-flex flex-column align-items-center py-2">
                                <i class="fas fa-chart-bar mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold">Analytics</span>
                                <small class="text-muted">Data Focus</small>
                              </div>
                            </button>
                          </div>
                          <div class="col-6 col-md-3">
                            <button class="btn btn-outline-warning w-100" onclick="applyLayout('minimal')">
                              <div class="d-flex flex-column align-items-center py-2">
                                <i class="fas fa-compress mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold">Minimal</span>
                                <small class="text-muted">Clean View</small>
                              </div>
                            </button>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Widget Management -->
                      <div class="col-md-12">
                        <h6 class="mb-3"><i class="fas fa-th me-2"></i>Widget Management</h6>
                        <div class="widget-selection-panel">
                          <div class="row g-2" id="widgetSelectionGrid">
                            <!-- Widget cards will be populated by JavaScript -->
                          </div>
                          <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center">
                              <small class="text-muted">Click widgets to toggle visibility • Changes are saved automatically</small>
                              <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success btn-sm" onclick="enableAllWidgets()" title="Enable All Widgets">
                                  <i class="fas fa-check-double me-1"></i>All On
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="disableAllWidgets()" title="Disable All Widgets">
                                  <i class="fas fa-times-circle me-1"></i>All Off
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customization Toggle Button -->
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h4 class="mb-0">Dashboard Overview</h4>
                    <small class="text-muted">Welcome back, Admin • Last login: <span id="lastLoginTime">Loading...</span> • Last updated: <span id="lastDashboardUpdate">Just now</span></small>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="toggleCustomizationPanel()" id="customizeBtn">
                      <i class="fas fa-palette me-2"></i>Customize Layout
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleFullscreenDashboard()">
                      <i class="fas fa-expand me-2"></i>Fullscreen
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="refreshDashboard()">
                      <i class="fas fa-sync-alt me-2"></i>Refresh All
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Unified Financial Dashboard -->
            <div class="row mb-4" data-widget="financial-dashboard">
              <div class="col-md-12">
                <div class="card financial-dashboard-widget">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Financial Dashboard</h5>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary active" onclick="switchFinancialView('overview')" id="financialOverviewBtn">Overview</button>
                      <button type="button" class="btn btn-outline-primary" onclick="switchFinancialView('trends')" id="financialTrendsBtn">Trends</button>
                      <button type="button" class="btn btn-outline-primary" onclick="switchFinancialView('breakdown')" id="financialBreakdownBtn">Breakdown</button>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Financial Overview View -->
                    <div id="financialOverviewView">
                      <!-- Key Financial Metrics -->
                      <div class="row mb-4">
                        <div class="col-md-2 col-6">
                          <div class="financial-metric text-center">
                            <div class="metric-icon mb-2">
                              <i class="fas fa-dollar-sign text-success" style="font-size: 2rem;"></i>
                            </div>
                            <h3 class="text-success mb-1" id="todayRevenue">$8,450</h3>
                            <p class="text-muted mb-1 small">Today's Revenue</p>
                            <small class="text-success" id="revenueTrend">+12.5%</small>
                          </div>
                        </div>
                        <div class="col-md-2 col-6">
                          <div class="financial-metric text-center">
                            <div class="metric-icon mb-2">
                              <i class="fas fa-calendar-check text-primary" style="font-size: 2rem;"></i>
                            </div>
                            <h3 class="text-primary mb-1" id="todayBookings">156</h3>
                            <p class="text-muted mb-1 small">Active Bookings</p>
                            <small class="text-primary" id="bookingsTrend">+8.3%</small>
                          </div>
                        </div>
                        <div class="col-md-2 col-6">
                          <div class="financial-metric text-center">
                            <div class="metric-icon mb-2">
                              <i class="fas fa-car text-info" style="font-size: 2rem;"></i>
                            </div>
                            <h3 class="text-info mb-1" id="fleetUtilization">73%</h3>
                            <p class="text-muted mb-1 small">Fleet Utilization</p>
                            <small class="text-info" id="utilizationTrend">+3.2%</small>
                          </div>
                        </div>
                        <div class="col-md-2 col-6">
                          <div class="financial-metric text-center">
                            <div class="metric-icon mb-2">
                              <i class="fas fa-chart-line text-warning" style="font-size: 2rem;"></i>
                            </div>
                            <h3 class="text-warning mb-1" id="avgBookingValue">$54.20</h3>
                            <p class="text-muted mb-1 small">Avg Booking</p>
                            <small class="text-warning" id="avgValueTrend">+$2.30</small>
                          </div>
                        </div>
                        <div class="col-md-2 col-6">
                          <div class="financial-metric text-center">
                            <div class="metric-icon mb-2">
                              <i class="fas fa-percentage text-secondary" style="font-size: 2rem;"></i>
                            </div>
                            <h3 class="text-secondary mb-1" id="profitMargin">24.8%</h3>
                            <p class="text-muted mb-1 small">Profit Margin</p>
                            <small class="text-secondary" id="marginTrend">+1.1%</small>
                          </div>
                        </div>
                        <div class="col-md-2 col-6">
                          <div class="financial-metric text-center">
                            <div class="metric-icon mb-2">
                              <i class="fas fa-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
                            </div>
                            <h3 class="text-danger mb-1" id="overdueReturns">3</h3>
                            <p class="text-muted mb-1 small">Overdue Returns</p>
                            <small class="text-danger" id="overdueTrend">-1</small>
                          </div>
                        </div>
                      </div>

                      <!-- Quick Financial Summary Charts -->
                      <div class="row">
                        <div class="col-md-4">
                          <div class="financial-summary-card">
                            <h6 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Revenue Distribution</h6>
                            <div class="chart-container" style="height: 200px;">
                              <canvas id="quickRevenueChart"></canvas>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="financial-summary-card">
                            <h6 class="mb-3"><i class="fas fa-tachometer-alt me-2"></i>Fleet Performance</h6>
                            <div class="chart-container" style="height: 200px;">
                              <canvas id="quickFleetChart"></canvas>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="financial-summary-card">
                            <h6 class="mb-3"><i class="fas fa-calendar-alt me-2"></i>Booking Trends</h6>
                            <div class="chart-container" style="height: 200px;">
                              <canvas id="quickBookingChart"></canvas>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Financial Trends View -->
                    <div id="financialTrendsView" style="display: none;">
                      <div class="row mb-3">
                        <div class="col-md-8">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Revenue Trends & Performance</h6>
                            <select class="form-select form-select-sm" id="revenueTimeFilter" onchange="updateFinancialTrendsChart()" style="width: 150px;">
                              <option value="7">Last 7 Days</option>
                              <option value="30" selected>Last 30 Days</option>
                              <option value="90">Last 3 Months</option>
                            </select>
                          </div>
                          <div class="chart-container" style="height: 300px;">
                            <canvas id="revenueTrendsChart"></canvas>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <h6 class="mb-3">Financial Targets</h6>
                          <div class="financial-targets">
                            <div class="target-item mb-3">
                              <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Monthly Target</small>
                                <small class="fw-bold text-success">87%</small>
                              </div>
                              <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: 87%"></div>
                              </div>
                              <small class="text-muted">$245K / $280K</small>
                            </div>
                            <div class="target-item mb-3">
                              <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Quarterly Target</small>
                                <small class="fw-bold text-warning">73%</small>
                              </div>
                              <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: 73%"></div>
                              </div>
                              <small class="text-muted">$610K / $840K</small>
                            </div>
                            <div class="target-item mb-3">
                              <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Annual Target</small>
                                <small class="fw-bold text-info">65%</small>
                              </div>
                              <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" style="width: 65%"></div>
                              </div>
                              <small class="text-muted">$2.1M / $3.2M</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Financial Breakdown View -->
                    <div id="financialBreakdownView" style="display: none;">
                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="mb-3">Revenue by Category</h6>
                          <div class="chart-container" style="height: 300px;">
                            <canvas id="categoryBreakdownChart"></canvas>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <h6 class="mb-3">Revenue by Branch</h6>
                          <div class="chart-container" style="height: 300px;">
                            <canvas id="branchRevenueChart"></canvas>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Unified Fleet Management -->
            <div class="row mb-4" data-widget="fleet-management">
              <div class="col-md-12">
                <div class="card fleet-management-widget">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0"><i class="fas fa-car me-2"></i>Fleet Management & Tracking</h5>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary active" onclick="switchFleetView('map')" id="fleetMapViewBtn">Map View</button>
                      <button type="button" class="btn btn-outline-primary" onclick="switchFleetView('status')" id="fleetStatusViewBtn">Status Overview</button>
                      <button type="button" class="btn btn-outline-primary" onclick="switchFleetView('analytics')" id="fleetAnalyticsViewBtn">Analytics</button>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Fleet Status Summary (Always Visible) -->
                    <div class="fleet-status-summary mb-3">
                      <div class="row text-center">
                        <div class="col-md-3 col-6">
                          <div class="fleet-stat-card bg-success text-white">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-check-circle"></i>
                                <span class="ms-2">Available</span>
                              </div>
                              <h4 class="mb-0" id="fleetAvailableCount">120</h4>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-3 col-6">
                          <div class="fleet-stat-card bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-car"></i>
                                <span class="ms-2">Rented</span>
                              </div>
                              <h4 class="mb-0" id="fleetRentedCount">86</h4>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-3 col-6">
                          <div class="fleet-stat-card bg-warning text-dark">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-wrench"></i>
                                <span class="ms-2">Maintenance</span>
                              </div>
                              <h4 class="mb-0" id="fleetMaintenanceCount">11</h4>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-3 col-6">
                          <div class="fleet-stat-card bg-danger text-white">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-exclamation-triangle"></i>
                                <span class="ms-2">Alerts</span>
                              </div>
                              <h4 class="mb-0" id="fleetAlertCount">16</h4>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Map View -->
                    <div id="fleetMapView">
                      <div class="row">
                        <div class="col-md-9">
                          <div class="map-container">
                            <div id="fleetMap" style="height: 450px; width: 100%;"></div>
                          </div>
                          <div class="map-controls mt-2">
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshFleetMap()">
                              <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-primary btn-sm me-2" onclick="toggleFullscreen()">
                              <i class="fas fa-expand"></i> Fullscreen
                            </button>
                            <button id="toggleClusterBtn" class="btn btn-secondary btn-sm me-2" type="button">
                              <i class="fas fa-layer-group"></i> Clustering
                            </button>
                            <button id="toggleGeofenceBtn" class="btn btn-outline-success btn-sm" type="button">
                              <i class="fas fa-draw-polygon"></i> Geofence Tool
                            </button>
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="fleet-sidebar">
                            <h6 class="mb-3">Fleet Status Chart</h6>
                            <div class="chart-container" style="height: 200px;">
                              <canvas id="fleetStatusChart"></canvas>
                            </div>
                            <div class="mt-3">
                              <h6 class="mb-2">Quick Stats</h6>
                              <div class="fleet-quick-stats">
                                <div class="d-flex justify-content-between mb-2">
                                  <small class="text-muted">Utilization Rate</small>
                                  <span class="fw-bold text-primary" id="fleetUtilizationRate">73.5%</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                  <small class="text-muted">Avg Daily Revenue</small>
                                  <span class="fw-bold text-success" id="avgDailyRevenue">$8,450</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                  <small class="text-muted">Maintenance Due</small>
                                  <span class="fw-bold text-warning" id="maintenanceDueCount">7</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Status Overview -->
                    <div id="fleetStatusView" style="display: none;">
                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="mb-3">Fleet Distribution</h6>
                          <div class="chart-container" style="height: 300px;">
                            <canvas id="fleetDistributionChart"></canvas>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <h6 class="mb-3">Vehicle Status Details</h6>
                          <div id="vehicleStatusList" style="max-height: 300px; overflow-y: auto;">
                            <!-- Dynamic vehicle status list -->
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Analytics View -->
                    <div id="fleetAnalyticsView" style="display: none;">
                      <div class="row">
                        <div class="col-md-8">
                          <h6 class="mb-3">Fleet Performance Trends</h6>
                          <div class="chart-container" style="height: 300px;">
                            <canvas id="fleetPerformanceTrendsChart"></canvas>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <h6 class="mb-3">Performance Metrics</h6>
                          <div class="fleet-performance-metrics">
                            <div class="metric-item mb-3">
                              <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Fleet Efficiency</small>
                                <small class="fw-bold text-success">92.3%</small>
                              </div>
                              <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 92%"></div>
                              </div>
                            </div>
                            <div class="metric-item mb-3">
                              <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Maintenance Compliance</small>
                                <small class="fw-bold text-warning">87.5%</small>
                              </div>
                              <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-warning" style="width: 87%"></div>
                              </div>
                            </div>
                            <div class="metric-item mb-3">
                              <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Safety Score</small>
                                <small class="fw-bold text-info">94.2%</small>
                              </div>
                              <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-info" style="width: 94%"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>



            <!-- Executive Summary Dashboard -->
            <div class="row mb-4" data-widget="executive-summary">
              <div class="col-md-8">
                <div class="card">
                  <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                      <h4 class="card-title"><i class="fas fa-chart-area me-2"></i>Executive Summary</h4>
                      <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="executivePeriodFilter" onchange="updateExecutiveSummary()" style="width: 150px;">
                          <option value="today">Today</option>
                          <option value="week" selected>This Week</option>
                          <option value="month">This Month</option>
                          <option value="quarter">This Quarter</option>
                        </select>
                        <button class="btn btn-outline-success btn-sm" onclick="exportExecutiveSummary()">
                          <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Executive KPIs -->
                    <div class="row mb-4">
                      <div class="col-md-3 text-center">
                        <div class="executive-metric">
                          <h3 class="text-primary mb-1" id="monthlyGrowth">+15.2%</h3>
                          <p class="text-muted mb-0">Monthly Growth</p>
                          <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar bg-primary" style="width: 75%"></div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3 text-center">
                        <div class="executive-metric">
                          <h3 class="text-success mb-1" id="roi">28.7%</h3>
                          <p class="text-muted mb-0">Return on Investment</p>
                          <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar bg-success" style="width: 85%"></div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3 text-center">
                        <div class="executive-metric">
                          <h3 class="text-warning mb-1" id="marketShare">23.4%</h3>
                          <p class="text-muted mb-0">Market Share</p>
                          <small class="text-success">+2.1% vs last period</small>
                        </div>
                      </div>
                      <div class="col-md-3 text-center">
                        <div class="executive-metric">
                          <h3 class="text-info mb-1" id="growthRate">+12.8%</h3>
                          <p class="text-muted mb-0">Growth Rate</p>
                          <small class="text-success">Above target (+10%)</small>
                        </div>
                      </div>
                    </div>

                    <!-- Performance Trends -->
                    <div class="row">
                      <div class="col-md-12">
                        <canvas id="executivePerformanceChart" height="80"></canvas>
                      </div>
                    </div>

                    <!-- Key Insights -->
                    <div class="row mt-3">
                      <div class="col-md-12">
                        <div class="alert alert-info">
                          <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Key Insights</h6>
                          <div class="row">
                            <div class="col-md-4">
                              <strong>🎯 Top Opportunity:</strong><br>
                              <small>Weekend bookings up 18% - consider dynamic pricing</small>
                            </div>
                            <div class="col-md-4">
                              <strong>⚠️ Risk Alert:</strong><br>
                              <small>Fleet utilization below optimal in Bronx branch</small>
                            </div>
                            <div class="col-md-4">
                              <strong>💡 Recommendation:</strong><br>
                              <small>Add 3 vehicles to Manhattan for peak demand</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <!-- Calendar Integration -->
                <div class="card">
                  <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title mb-0"><i class="fas fa-calendar-alt me-2"></i>Operations Calendar</h5>
                      <button class="btn btn-outline-primary btn-sm" onclick="openFullCalendar()">
                        <i class="fas fa-expand"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Mini Calendar -->
                    <div id="miniCalendar" class="mb-3">
                      <!-- Populated by JavaScript -->
                    </div>
                    
                    <!-- Today's Schedule -->
                    <div class="schedule-today">
                      <h6 class="mb-3">Today's Schedule</h6>
                      <div id="todaySchedule">
                        <!-- Populated by JavaScript -->
                      </div>
                    </div>

                    <!-- Quick Schedule Actions -->
                    <div class="mt-3 d-grid gap-2">
                      <button class="btn btn-primary btn-sm" onclick="scheduleMaintenanceSlot()">
                        <i class="fas fa-wrench me-2"></i>Schedule Maintenance
                      </button>
                      <button class="btn btn-success btn-sm" onclick="bookStaffMeeting()">
                        <i class="fas fa-users me-2"></i>Staff Meeting
                      </button>
                      <button class="btn btn-info btn-sm" onclick="planVehicleInspection()">
                        <i class="fas fa-clipboard-check me-2"></i>Vehicle Inspection
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Weather & Demand Forecast Widget -->
            <div class="row mb-4" data-widget="weather-demand">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0"><i class="fas fa-cloud-sun me-2"></i>Weather Impact & Demand Analytics</h5>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary active" onclick="switchWeatherView('current')" id="currentViewBtn">Current</button>
                      <button type="button" class="btn btn-outline-primary" onclick="switchWeatherView('forecast')" id="forecastViewBtn">5-Day</button>
                      <button type="button" class="btn btn-outline-primary" onclick="switchWeatherView('trends')" id="trendsViewBtn">Trends</button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <!-- Left Column - Weather Info -->
                      <div class="col-md-6">
                        <!-- Current Weather View -->
                        <div id="currentWeatherView">
                          <div class="row">
                            <div class="col-md-6">
                              <div class="weather-info text-center mb-3">
                                <div class="weather-icon mb-2">
                                  <i class="fas fa-sun text-warning" style="font-size: 3rem;" id="mainWeatherIcon"></i>
                                </div>
                                <h3 class="mb-1" id="currentTemp">72°F</h3>
                                <p class="text-muted mb-1" id="currentCondition">Sunny, Clear</p>
                                <small class="text-muted" id="currentLocation">New York, NY</small>
                                <div class="mt-2">
                                  <span class="badge bg-success" id="demandImpact">+15% booking impact</span>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="weather-details">
                                <div class="row text-center mb-3">
                                  <div class="col-6">
                                    <small class="text-muted">Humidity</small>
                                    <div class="fw-bold" id="humidity">65%</div>
                                  </div>
                                  <div class="col-6">
                                    <small class="text-muted">Wind</small>
                                    <div class="fw-bold" id="windSpeed">8 mph</div>
                                  </div>
                                </div>
                                <div class="row text-center">
                                  <div class="col-6">
                                    <small class="text-muted">UV Index</small>
                                    <div class="fw-bold" id="uvIndex">6</div>
                                  </div>
                                  <div class="col-6">
                                    <small class="text-muted">Visibility</small>
                                    <div class="fw-bold" id="visibility">10 mi</div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- 5-Day Forecast View -->
                        <div id="forecastWeatherView" style="display: none;">
                          <h6 class="mb-3">5-Day Forecast & Demand Impact</h6>
                          <div id="forecastList">
                            <!-- Dynamic forecast items will be populated here -->
                          </div>
                        </div>

                        <!-- Trends View -->
                        <div id="trendsWeatherView" style="display: none;">
                          <h6 class="mb-3">Weather vs Booking Trends (24h)</h6>
                          <div class="chart-container" style="height: 250px;">
                            <canvas id="weatherTrendsChart"></canvas>
                          </div>
                        </div>
                      </div>

                      <!-- Right Column - Demand Analytics -->
                      <div class="col-md-6">
                        <div class="demand-analytics">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Demand Analytics</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshWeatherData()">
                              <i class="fas fa-sync-alt" id="refreshIcon"></i>
                            </button>
                          </div>
                          
                          <div class="row text-center mb-4">
                            <div class="col-4">
                              <div class="demand-metric">
                                <div class="circular-progress-container mb-2">
                                  <div class="circular-progress" data-percentage="85">
                                    <span class="progress-value">85%</span>
                                  </div>
                                </div>
                                <small class="text-muted">Current Demand</small>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="demand-metric">
                                <h3 class="text-success mb-1" id="demandChange">+12%</h3>
                                <small class="text-muted">vs Yesterday</small>
                                <div class="mt-1">
                                  <i class="fas fa-arrow-up text-success"></i>
                                </div>
                              </div>
                            </div>
                            <div class="col-4">
                              <div class="demand-metric">
                                <h3 class="text-warning mb-1" id="peakDemand">92%</h3>
                                <small class="text-muted">Peak Today</small>
                                <div class="mt-1">
                                  <small class="text-muted">at 3 PM</small>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <div class="weather-impact">
                            <h6 class="mb-3">
                              <i class="fas fa-chart-trend-up me-2"></i>Business Impact
                            </h6>
                            <div class="impact-metrics">
                              <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted">Expected Bookings</small>
                                <span class="badge bg-success">+15%</span>
                              </div>
                              <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted">Revenue Impact</small>
                                <span class="badge bg-primary">+$2,340</span>
                              </div>
                              <div class="d-flex justify-content-between">
                                <small class="text-muted">Fleet Utilization</small>
                                <span class="badge bg-info">+8%</span>
                              </div>
                            </div>
                          </div>

                          <div class="mt-4">
                            <h6 class="mb-3">Smart Recommendations</h6>
                            <div id="weatherRecommendations">
                              <!-- Dynamic recommendations will be populated here -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer Insights & Analytics Row -->
            <div class="row mb-4" data-widget="customer-insights">
              <div class="col-md-12">
                <div class="card customer-insights-widget">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0"><i class="fas fa-users me-2"></i>Customer Insights & Analytics</h5>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary active" onclick="switchCustomerView('overview')" id="overviewViewBtn">Overview</button>
                      <button type="button" class="btn btn-outline-primary" onclick="switchCustomerView('segments')" id="segmentsViewBtn">Segments</button>
                      <button type="button" class="btn btn-outline-primary" onclick="switchCustomerView('behavior')" id="behaviorViewBtn">Behavior</button>
                      <button type="button" class="btn btn-outline-primary" onclick="switchCustomerView('retention')" id="retentionViewBtn">Retention</button>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Overview View -->
                    <div id="overviewCustomerView">
                      <!-- Key Metrics Row -->
                      <div class="row mb-4">
                        <div class="col-md-3 col-6">
                          <div class="customer-metric text-center">
                            <div class="metric-icon mb-2">
                              <i class="fas fa-star text-warning" style="font-size: 1.5rem;"></i>
                            </div>
                            <h4 class="text-warning mb-1" id="avgRating">4.6</h4>
                            <p class="text-muted mb-1 small">Avg Rating</p>
                            <div class="rating-stars mb-2" id="ratingStars">
                              <!-- Dynamic stars -->
                            </div>
                            <small class="text-success" id="ratingTrend">+0.2 this month</small>
                          </div>
                        </div>
                        <div class="col-md-3 col-6">
                          <div class="customer-metric text-center">
                            <div class="metric-icon mb-2">
                              <i class="fas fa-redo text-success" style="font-size: 1.5rem;"></i>
                            </div>
                            <h4 class="text-success mb-1" id="repeatRate">73%</h4>
                            <p class="text-muted mb-1 small">Repeat Rate</p>
                            <div class="progress mb-2" style="height: 4px;">
                              <div class="progress-bar bg-success" style="width: 73%"></div>
                            </div>
                            <small class="text-success" id="repeatTrend">+5% this month</small>
                          </div>
                        </div>
                        <div class="col-md-3 col-6">
                          <div class="customer-metric text-center">
                            <div class="metric-icon mb-2">
                              <i class="fas fa-clock text-info" style="font-size: 1.5rem;"></i>
                            </div>
                            <h4 class="text-info mb-1" id="avgBookingDuration">4.2</h4>
                            <p class="text-muted mb-1 small">Avg Days</p>
                            <div class="progress mb-2" style="height: 4px;">
                              <div class="progress-bar bg-info" style="width: 65%"></div>
                            </div>
                            <small class="text-info" id="durationTrend">+0.3 days</small>
                          </div>
                        </div>
                        <div class="col-md-3 col-6">
                          <div class="customer-metric text-center">
                            <div class="metric-icon mb-2">
                              <i class="fas fa-dollar-sign text-primary" style="font-size: 1.5rem;"></i>
                            </div>
                            <h4 class="text-primary mb-1" id="avgSpend">$247</h4>
                            <p class="text-muted mb-1 small">Avg Spend</p>
                            <div class="progress mb-2" style="height: 4px;">
                              <div class="progress-bar bg-primary" style="width: 80%"></div>
                            </div>
                            <small class="text-primary" id="spendTrend">+$23 this month</small>
                          </div>
                        </div>
                      </div>

                      <!-- Charts and Insights Row -->
                      <div class="row">
                        <div class="col-md-4">
                          <h6 class="mb-3">Customer Satisfaction</h6>
                          <div class="chart-container" style="height: 180px;">
                            <canvas id="satisfactionTrendsChart"></canvas>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <h6 class="mb-3">Revenue Segments</h6>
                          <div class="chart-container" style="height: 180px;">
                            <canvas id="revenueSegmentChart"></canvas>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="customer-insights-panel-compact">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <h6 class="mb-0 small">Smart Insights</h6>
                              <button class="btn btn-sm btn-outline-primary btn-xs" onclick="refreshCustomerInsights()">
                                <i class="fas fa-sync-alt" id="customerRefreshIcon"></i>
                              </button>
                            </div>
                            
                            <!-- Compact Top Customers -->
                            <div class="mb-3">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="fw-bold text-warning">
                                  <i class="fas fa-crown me-1"></i>Top Customers
                                </small>
                                <span class="badge bg-warning text-dark">5</span>
                              </div>
                              <div id="topCustomersListCompact" style="max-height: 120px; overflow-y: auto;">
                                <!-- Compact top customers list -->
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Segments View -->
                    <div id="segmentsCustomerView" style="display: none;">
                      <h6 class="mb-3">Customer Segmentation Analysis</h6>
                      <div id="customerSegmentsList">
                        <!-- Dynamic segments will be populated here -->
                      </div>
                    </div>

                    <!-- Behavior View -->
                    <div id="behaviorCustomerView" style="display: none;">
                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="mb-3">Booking Patterns</h6>
                          <div class="chart-container" style="height: 250px;">
                            <canvas id="bookingPatternsChart"></canvas>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <h6 class="mb-3">Peak Booking Hours</h6>
                          <div class="chart-container" style="height: 250px;">
                            <canvas id="peakHoursChart"></canvas>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Retention View -->
                    <div id="retentionCustomerView" style="display: none;">
                      <h6 class="mb-3">Customer Retention Analysis</h6>
                      <div class="row">
                        <div class="col-md-8">
                          <div class="chart-container" style="height: 300px;">
                            <canvas id="retentionCohortChart"></canvas>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="retention-metrics">
                            <div class="retention-metric mb-3">
                              <h4 class="text-success">85%</h4>
                              <small class="text-muted">30-Day Retention</small>
                            </div>
                            <div class="retention-metric mb-3">
                              <h4 class="text-warning">67%</h4>
                              <small class="text-muted">90-Day Retention</small>
                            </div>
                            <div class="retention-metric mb-3">
                              <h4 class="text-info">52%</h4>
                              <small class="text-muted">1-Year Retention</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Customer Management Row (shown for all views) -->
                    <div class="row mt-4">
                      <div class="col-md-4">
                        <div class="customer-bookings-compact">
                          <h6 class="mb-3">
                            <i class="fas fa-calendar-plus me-2 text-primary"></i>Upcoming Bookings
                            <span class="badge bg-primary ms-2" id="upcomingBookingsCount">8</span>
                          </h6>
                          <div id="customerUpcomingBookingsList" style="max-height: 150px; overflow-y: auto;">
                            <!-- Dynamic upcoming bookings -->
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="customer-reservations-compact">
                          <h6 class="mb-3">
                            <i class="fas fa-calendar-check me-2 text-info"></i>Active Reservations
                            <span class="badge bg-info ms-2" id="activeReservationsCount">12</span>
                          </h6>
                          <div id="customerActiveReservationsList" style="max-height: 150px; overflow-y: auto;">
                            <!-- Dynamic active reservations -->
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="customer-recommendations-compact">
                          <h6 class="mb-3">
                            <i class="fas fa-lightbulb me-2 text-success"></i>Growth Opportunities
                          </h6>
                          <div id="customerRecommendationsList" style="max-height: 150px; overflow-y: auto;">
                            <!-- Dynamic recommendations -->
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <!-- Branch Performance Widget -->
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-building me-2"></i>Branch Performance</h5>
                  </div>
                  <div class="card-body">
                    <div id="branchPerformanceList">
                      <!-- Populated by JavaScript -->
                    </div>
                    <div class="mt-3">
                      <button class="btn btn-primary btn-sm w-100" onclick="openBranchAnalytics()">
                        <i class="fas fa-chart-line me-1"></i>Branch Analytics
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Fleet Usage Analytics Widget -->
            <div class="row mb-4" data-widget="fleet-usage">
              <div class="col-md-12">
                <div class="card fleet-usage-widget">
                  <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title mb-0"><i class="fas fa-tachometer-alt me-2"></i>Fleet Usage Analytics</h5>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="setUsagePeriod('today')">24 Hours</button>
                        <button class="btn btn-outline-primary" onclick="setUsagePeriod('week')">7 Days</button>
                        <button class="btn btn-outline-primary" onclick="setUsagePeriod('month')">12 Months</button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-3">
                    <div class="row">
                      <!-- Usage Summary Cards -->
                      <div class="col-md-3">
                        <div class="usage-summary-cards" style="max-height: 280px;">
                          <div class="usage-card mb-2">
                            <div class="usage-card-header">
                              <i class="fas fa-clock text-primary"></i>
                              <span>Total Usage Hours</span>
                            </div>
                            <div class="usage-card-value" id="totalUsageHours">847.5h</div>
                            <div class="usage-card-change text-success">+12.3% vs last period</div>
                          </div>
                          
                          <div class="usage-card mb-2">
                            <div class="usage-card-header">
                              <i class="fas fa-route text-warning"></i>
                              <span>Total Miles</span>
                            </div>
                            <div class="usage-card-value" id="totalMiles">12,847</div>
                            <div class="usage-card-change text-success">+8.7% vs last period</div>
                          </div>
                          
                          <div class="usage-card mb-2">
                            <div class="usage-card-header">
                              <i class="fas fa-percentage text-success"></i>
                              <span>Efficiency Rate</span>
                            </div>
                            <div class="usage-card-value" id="efficiencyRate">87.3%</div>
                            <div class="usage-card-change text-success">+2.1% vs last period</div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Usage Charts -->
                      <div class="col-md-9">
                        <div class="row">
                          <div class="col-md-8">
                            <div class="chart-container w-100">
                              <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Usage Pattern Over Time</h6>
                                <span class="badge bg-secondary" id="seasonalIndicator">Peak Season</span>
                              </div>
                              <div class="chart-wrapper w-100" style="height: 320px; position: relative;">
                                <canvas id="usagePatternChart" style="width: 100% !important; height: 100% !important;"></canvas>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-4">
                            <div class="chart-container w-100">
                              <h6 class="mb-3">Vehicle Type Distribution</h6>
                              <div class="chart-wrapper w-100" style="height: 320px; position: relative;">
                                <canvas id="vehicleTypeUsageChart" style="width: 100% !important; height: 100% !important;"></canvas>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Detailed Usage Table -->
                    <div class="row mt-3">
                      <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <button class="btn btn-outline-secondary btn-sm" onclick="toggleUsageTable()">
                            <i class="fas fa-chevron-down" id="tableToggleIcon"></i>
                            <span id="tableToggleText">Show Details</span>
                          </button>
                        </div>
                        <div class="table-responsive" id="usageTableContainer" style="display: none; max-height: 300px; overflow-y: auto;">
                          <table class="table table-hover table-sm">
                            <thead class="table-light sticky-top">
                              <tr>
                                <th>Vehicle</th>
                                <th>Usage Hours</th>
                                <th>Miles Driven</th>
                                <th>Efficiency</th>
                                <th>Peak Hours</th>
                                <th>Status</th>
                              </tr>
                            </thead>
                            <tbody id="usageDetailsTable">
                              <!-- Populated by JavaScript -->
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Unified Alert Center -->
            <div class="row mb-4" data-widget="critical-alerts">
              <div class="col-md-12">
                <div class="card border-danger alert-center-widget">
                  <div class="card-header bg-danger text-white">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Unified Alert Center
                        <span class="badge bg-light text-danger ms-2" id="totalAlertCount">11</span>
                      </h5>
                      <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-light btn-sm active" onclick="switchAlertCategory('all')" id="alertCategoryAll">All</button>
                        <button class="btn btn-outline-light btn-sm" onclick="switchAlertCategory('system')" id="alertCategorySystem">System</button>
                        <button class="btn btn-outline-light btn-sm" onclick="switchAlertCategory('customer')" id="alertCategoryCustomer">Customer</button>
                        <button class="btn btn-outline-light btn-sm" onclick="switchAlertCategory('fleet')" id="alertCategoryFleet">Fleet</button>
                        <button class="btn btn-outline-light btn-sm" onclick="switchAlertCategory('weather')" id="alertCategoryWeather">Weather</button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-3">
                    <div class="row">
                      <!-- Alert Summary Cards -->
                      <div class="col-md-3">
                        <div class="alert-summary-cards">
                          <!-- Priority Summary -->
                          <div class="alert-summary-card bg-danger text-white mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-exclamation-triangle"></i>
                                <span class="ms-2">Critical</span>
                              </div>
                              <h4 class="mb-0" id="criticalPriorityCount">2</h4>
                            </div>
                          </div>
                          
                          <div class="alert-summary-card bg-warning text-dark mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-exclamation-circle"></i>
                                <span class="ms-2">High Priority</span>
                              </div>
                              <h4 class="mb-0" id="highPriorityCount">5</h4>
                            </div>
                          </div>
                          
                          <div class="alert-summary-card bg-info text-white mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-info-circle"></i>
                                <span class="ms-2">Medium</span>
                              </div>
                              <h4 class="mb-0" id="mediumPriorityCount">3</h4>
                            </div>
                          </div>
                          
                          <!-- Category Breakdown -->
                          <div class="mt-3">
                            <h6 class="text-muted small mb-2">By Category:</h6>
                            <div class="category-breakdown">
                              <div class="d-flex justify-content-between mb-1">
                                <small><i class="fas fa-cogs me-1 text-primary"></i>System</small>
                                <span class="badge bg-primary" id="systemAlertsCount">4</span>
                              </div>
                              <div class="d-flex justify-content-between mb-1">
                                <small><i class="fas fa-users me-1 text-success"></i>Customer</small>
                                <span class="badge bg-success" id="customerAlertsCountSidebar">3</span>
                              </div>
                              <div class="d-flex justify-content-between mb-1">
                                <small><i class="fas fa-car me-1 text-info"></i>Fleet</small>
                                <span class="badge bg-info" id="fleetAlertsCount">3</span>
                              </div>
                              <div class="d-flex justify-content-between">
                                <small><i class="fas fa-cloud me-1 text-warning"></i>Weather</small>
                                <span class="badge bg-warning text-dark" id="weatherAlertsCountSidebar">1</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Unified Alerts List -->
                      <div class="col-md-9">
                        <!-- Alert Filters -->
                        <div class="alert-filters mb-3">
                          <div class="btn-group btn-group-sm me-3" role="group">
                            <button class="btn btn-outline-danger active" onclick="filterAlertsByPriority('all')" id="priorityFilterAll">
                              <i class="fas fa-list me-1"></i>All
                            </button>
                            <button class="btn btn-outline-danger" onclick="filterAlertsByPriority('critical')" id="priorityFilterCritical">
                              Critical
                            </button>
                            <button class="btn btn-outline-warning" onclick="filterAlertsByPriority('high')" id="priorityFilterHigh">
                              High
                            </button>
                            <button class="btn btn-outline-info" onclick="filterAlertsByPriority('medium')" id="priorityFilterMedium">
                              Medium
                            </button>
                          </div>
                          <div class="float-end">
                            <small class="text-muted me-3">Updated: <span id="lastUnifiedAlertUpdate">Just now</span></small>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshAllAlerts()">
                              <i class="fas fa-sync-alt" id="unifiedAlertRefreshIcon"></i>
                            </button>
                          </div>
                        </div>

                        <div class="unified-alerts-container" style="max-height: 320px; overflow-y: auto;">
                          <div id="unifiedAlertsList">
                            <!-- All consolidated alerts will be populated here -->
                          </div>
                        </div>
                        
                        <!-- Alert Actions -->
                        <div class="mt-3">
                          <div class="btn-group w-100">
                            <button class="btn btn-danger btn-sm" onclick="handleEmergencyProtocol()">
                              <i class="fas fa-phone me-1"></i>Emergency
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="acknowledgeAllUnifiedAlerts()">
                              <i class="fas fa-check me-1"></i>Acknowledge All
                            </button>
                            <button class="btn btn-info btn-sm" onclick="openUnifiedAlertSettings()">
                              <i class="fas fa-cog me-1"></i>Settings
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="generateUnifiedAlertReport()">
                              <i class="fas fa-file-alt me-1"></i>Report
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>


          </div>
        </div>
      </div>
    </div>
    <!-- JS Files -->
    <script src="assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="assets/js/core/popper.min.js"></script>
    <script src="assets/js/core/bootstrap.min.js"></script>
    <script src="assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="assets/js/lynxlite.min.js"></script>
    
    <!-- Chart.js for Fleet Availability Pie Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script>
      // Dark mode toggle logic
      function setDarkMode(enabled) {
        if (enabled) {
          document.body.classList.add('dark-mode');
        } else {
          document.body.classList.remove('dark-mode');
        }
      }

      // Main DOMContentLoaded event - consolidating all initialization
      document.addEventListener('DOMContentLoaded', function() {
        // === DARK MODE INITIALIZATION ===
        const darkModeSwitch = document.getElementById('darkModeSwitch');
        const darkPref = localStorage.getItem('darkMode') === 'true';
        setDarkMode(darkPref);
        if (darkModeSwitch) {
          darkModeSwitch.checked = darkPref;
          darkModeSwitch.addEventListener('change', function() {
            setDarkMode(this.checked);
            localStorage.setItem('darkMode', this.checked);
          });
        }

        // === FINANCIAL SNAPSHOT FILTERS ===
        const btns = ['fs-today', 'fs-week', 'fs-month', 'fs-lastmonth', 'fs-custom'];
        btns.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.addEventListener('click', function() {
              btns.forEach(bid => {
                const b = document.getElementById(bid);
                if (b) b.classList.remove('active');
              });
              btn.classList.add('active');
              const customRange = document.getElementById('fs-custom-range');
              if (customRange) {
                customRange.style.display = (id === 'fs-custom') ? '' : 'none';
              }
            });
          }
        });

        const applyRangeBtn = document.getElementById('fs-apply-range');
        if (applyRangeBtn) {
          applyRangeBtn.addEventListener('click', function() {
            // TODO: Add logic to update the snapshot data for the selected range
          });
        }

        // === MOBILE PERIOD SELECTOR ===
        window.setMobilePeriod = function(text, buttonId) {
          document.getElementById('mobile-period-text').textContent = text;
          // Trigger the same logic as desktop buttons
          const btn = document.getElementById(buttonId);
          if (btn) {
            btn.click();
          }
        };

        // === CHART INITIALIZATION ===
        initializeAllCharts();

        // === MAP INITIALIZATION ===
        try {
          initFleetMap();
        } catch (error) {
          console.error('Error initializing fleet map:', error);
          showMapError();
        }

        // === SIDEBAR TOGGLE FUNCTIONALITY ===
        initializeSidebarToggles();

        // === SEARCH FUNCTIONALITY ===
        initializeSearchFunctionality();

        // === RESERVATION MANAGEMENT ===
        initializeReservationManagement();

        // === ENHANCED FEATURES INITIALIZATION ===
        initializeLoginTracking();
        initializeEnhancedAlerts();
        initializeRealTimeStatus();
        initializeExecutiveSummary();
        initializeCalendarIntegration();
        initializeLayoutCustomization();
        initializeWidgetSelectionPanel();
        initializeNewWidgets();
        initializeFleetUsageWidget();
        // Critical alerts are now handled by initializeUnifiedAlertCenter() in initializeNewWidgets()
        
        // Add keyboard shortcut for feedback (Ctrl+Shift+F)
        document.addEventListener('keydown', function(e) {
          if (e.ctrlKey && e.shiftKey && e.key === 'F') {
            e.preventDefault();
            openFeedbackModal();
          }
        });
      });

      // === ENHANCED CHART INITIALIZATION ===
      function initializeAllCharts() {
        // Fleet Chart
        const fleetCtx = document.getElementById('fleetChart');
        if (fleetCtx) {
          new Chart(fleetCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['Available', 'Booked', 'Under Repair'],
              datasets: [{
                data: [120, 86, 11],
                backgroundColor: ['#28a745', '#007bff', '#ffc107'],
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.parsed;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((value / total) * 100).toFixed(1);
                      return `${label}: ${value} vehicles (${percentage}%)`;
                    }
                  }
                }
              },
              cutout: '60%'
            }
          });
        }

        // Revenue Trend Chart
        const revenueTrendCtx = document.getElementById('revenueTrendChart');
        if (revenueTrendCtx) {
          window.revenueTrendChart = new Chart(revenueTrendCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
              datasets: [{
                label: 'Revenue',
                data: [68450, 72180, 75920, 68023],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
              }, {
                label: 'Costs',
                data: [44200, 46800, 49100, 44200],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
              }, {
                label: 'Profit',
                data: [24250, 25380, 26820, 23823],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }

        // Revenue Breakdown Chart
        const revenueBreakdownCtx = document.getElementById('revenueBreakdownChart');
        if (revenueBreakdownCtx) {
          new Chart(revenueBreakdownCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['Vehicle Rentals', 'Insurance & Fees', 'Fuel & Services'],
              datasets: [{
                data: [198450, 52180, 33943],
                backgroundColor: ['#007bff', '#28a745', '#ffc107']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }

        // Executive Performance Chart
        const executiveCtx = document.getElementById('executivePerformanceChart');
        if (executiveCtx) {
          window.executiveChart = new Chart(executiveCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
              datasets: [{
                label: 'Business Health Score',
                data: [82, 85, 87, 89, 88, 91, 87],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
              }, {
                label: 'Customer Satisfaction',
                data: [4.2, 4.4, 4.5, 4.6, 4.5, 4.7, 4.6],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true,
                yAxisID: 'y1'
              }, {
                label: 'Fleet Utilization %',
                data: [68, 72, 75, 78, 76, 82, 74],
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                y: { 
                  beginAtZero: true, 
                  max: 100,
                  position: 'left'
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  min: 0,
                  max: 5,
                  grid: {
                    drawOnChartArea: false,
                  },
                }
              }
            }
          });
        }
      }

      // === ENHANCED ALERT SYSTEM ===
      let allAlerts = [];
      let currentAlertFilter = 'all';

      function initializeEnhancedAlerts() {
        allAlerts = [
          { id: 1, type: 'maintenance', message: 'Honda Civic - ABC123 due for service', severity: 'warning', time: '2 min ago', vehicle: 'ABC123' },
          { id: 2, type: 'insurance', message: 'BMW X3 insurance expires in 3 days', severity: 'critical', time: '5 min ago', vehicle: 'GHI345' },
          { id: 3, type: 'geofence', message: 'Mercedes C-Class left authorized area', severity: 'high', time: '8 min ago', vehicle: 'MNO345' },
          { id: 4, type: 'fuel', message: '3 vehicles below 25% fuel level', severity: 'medium', time: '12 min ago', vehicle: 'Multiple' },
          { id: 5, type: 'overdue', message: 'Toyota Camry overdue return (2 hours)', severity: 'high', time: '15 min ago', vehicle: 'DEF456' }
        ];
        
        updateLiveAlerts();
        
        // Simulate real-time alerts every 45 seconds
        setInterval(() => {
          if (Math.random() > 0.85) { // 15% chance
            generateRandomAlert();
          }
        }, 45000);
      }

      function updateLiveAlerts() {
        const filteredAlerts = currentAlertFilter === 'all' ? 
          allAlerts : allAlerts.filter(a => a.severity === currentAlertFilter);
        
        const container = document.getElementById('liveAlertsList');
        if (!container) return;
        
        container.innerHTML = filteredAlerts.slice(0, 5).map(alert => `
          <div class="alert-item d-flex justify-content-between align-items-start p-2 mb-2 border-start border-3 border-${getSeverityColor(alert.severity)} ${alert.severity === 'critical' ? 'bg-danger bg-opacity-10' : ''}">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center mb-1">
                <i class="fas ${getAlertIcon(alert.type)} me-2"></i>
                <span class="fw-bold small">${alert.message}</span>
              </div>
              <small class="text-muted">${alert.time} • ${alert.vehicle}</small>
            </div>
            <div class="d-flex gap-1">
              <button class="btn btn-outline-primary btn-sm" onclick="handleAlert(${alert.id})" title="Handle">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="dismissAlert(${alert.id})" title="Dismiss">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        `).join('');
      }

      // === REAL-TIME STATUS MONITORING ===
      function initializeRealTimeStatus() {
        updateRealTimeStatus();
        setInterval(updateRealTimeStatus, 20000); // Update every 20 seconds
      }

      function updateRealTimeStatus() {
        // Real-time status elements were removed with reservations widget
        // This function is kept for backward compatibility but does nothing
        
        // Update any remaining status elements if they exist
        const staffElement = document.getElementById('staffOnlineCount');
        if (staffElement) {
          const staffOnline = Math.floor(16 + Math.random() * 12);
          const staffTotal = 28;
          const staffPercentage = Math.round((staffOnline / staffTotal) * 100);
          
          staffElement.textContent = `${staffOnline}/${staffTotal}`;
          const staffProgress = document.getElementById('staffOnlineProgress');
          if (staffProgress) {
            staffProgress.style.width = `${staffPercentage}%`;
          }
        }
        
        const vehicleElement = document.getElementById('activeVehicleCount');
        if (vehicleElement) {
          const activeVehicles = Math.floor(100 + Math.random() * 20);
          const vehicleTotal = 120;
          const vehiclePercentage = Math.round((activeVehicles / vehicleTotal) * 100);
          
          vehicleElement.textContent = `${activeVehicles}/${vehicleTotal}`;
          const vehicleProgress = document.getElementById('activeVehicleProgress');
          if (vehicleProgress) {
            vehicleProgress.style.width = `${vehiclePercentage}%`;
          }
        }
        
        const capacityElement = document.getElementById('totalCapacityCount');
        if (capacityElement) {
          const totalCapacity = Math.floor(180 + Math.random() * 20);
          const capacityTotal = 200;
          const capacityPercentage = Math.round((totalCapacity / capacityTotal) * 100);
          
          capacityElement.textContent = `${totalCapacity}/${capacityTotal}`;
          const capacityProgress = document.getElementById('totalCapacityProgress');
          if (capacityProgress) {
            capacityProgress.style.width = `${capacityPercentage}%`;
          }
        }
      }

      // === EXECUTIVE SUMMARY DASHBOARD ===
      function initializeExecutiveSummary() {
        updateExecutiveMetrics();
        setInterval(updateExecutiveMetrics, 60000); // Update every minute
      }

      function updateExecutiveMetrics() {
        // Monthly Growth (10-20% range)
        const monthlyGrowth = (10 + Math.random() * 10).toFixed(1);
        document.getElementById('monthlyGrowth').textContent = `+${monthlyGrowth}%`;
        document.querySelector('#monthlyGrowth').parentElement.querySelector('.progress-bar').style.width = `${Math.min(100, monthlyGrowth * 4)}%`;
        
        // Return on Investment (20-35% range)
        const roi = (20 + Math.random() * 15).toFixed(1);
        document.getElementById('roi').textContent = `${roi}%`;
        document.querySelector('#roi').parentElement.querySelector('.progress-bar').style.width = `${Math.min(100, roi * 2.5)}%`;
        
        // Market Share (20-30% range)
        const marketShare = (20 + Math.random() * 10).toFixed(1);
        document.getElementById('marketShare').textContent = `${marketShare}%`;
        
        // Growth Rate (8-18% range)
        const growthRate = (8 + Math.random() * 10).toFixed(1);
        document.getElementById('growthRate').textContent = `+${growthRate}%`;
      }

      // updateStarRating function removed - customer satisfaction now handled in Customer Insights widget

      function updateExecutiveSummary() {
        const period = document.getElementById('executivePeriodFilter').value;
        console.log('Updating executive summary for period:', period);
        
        // Update executive chart based on period
        if (window.executiveChart) {
          let newLabels, newData;
          
          switch(period) {
            case 'today':
              newLabels = ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'];
              newData = [
                [75, 82, 87, 89, 85, 78],
                [4.1, 4.3, 4.6, 4.7, 4.5, 4.4],
                [45, 68, 74, 78, 72, 58]
              ];
              break;
            case 'month':
              newLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
              newData = [
                [84, 87, 89, 87],
                [4.3, 4.5, 4.6, 4.6],
                [71, 75, 78, 74]
              ];
              break;
            case 'quarter':
              newLabels = ['Month 1', 'Month 2', 'Month 3'];
              newData = [
                [85, 88, 87],
                [4.4, 4.6, 4.6],
                [73, 76, 74]
              ];
              break;
            default: // week
              newLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
              newData = [
                [82, 85, 87, 89, 88, 91, 87],
                [4.2, 4.4, 4.5, 4.6, 4.5, 4.7, 4.6],
                [68, 72, 75, 78, 76, 82, 74]
              ];
          }
          
          window.executiveChart.data.labels = newLabels;
          window.executiveChart.data.datasets[0].data = newData[0];
          window.executiveChart.data.datasets[1].data = newData[1];
          window.executiveChart.data.datasets[2].data = newData[2];
          window.executiveChart.update();
        }
      }

      // === CALENDAR INTEGRATION ===
      function initializeCalendarIntegration() {
        generateMiniCalendar();
        populateTodaySchedule();
        
        // Update schedule every 30 minutes
        setInterval(populateTodaySchedule, 1800000);
      }

      function generateMiniCalendar() {
        const container = document.getElementById('miniCalendar');
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        const currentDate = today.getDate();
        
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        let calendarHTML = `
          <div class="mini-calendar">
            <div class="calendar-header text-center mb-2">
              <h6 class="mb-0">${monthNames[currentMonth]} ${currentYear}</h6>
            </div>
            <div class="calendar-grid">
              <div class="row text-center mb-1">
                <div class="col calendar-day-header"><small>S</small></div>
                <div class="col calendar-day-header"><small>M</small></div>
                <div class="col calendar-day-header"><small>T</small></div>
                <div class="col calendar-day-header"><small>W</small></div>
                <div class="col calendar-day-header"><small>T</small></div>
                <div class="col calendar-day-header"><small>F</small></div>
                <div class="col calendar-day-header"><small>S</small></div>
              </div>
        `;
        
        let dayCount = 1;
        for (let week = 0; week < 6; week++) {
          calendarHTML += '<div class="row text-center mb-1">';
          for (let day = 0; day < 7; day++) {
            if ((week === 0 && day < firstDay) || dayCount > daysInMonth) {
              calendarHTML += '<div class="col calendar-day"></div>';
            } else {
              const isToday = dayCount === currentDate;
              const hasEvent = Math.random() > 0.7; // 30% chance of event
              calendarHTML += `
                <div class="col calendar-day">
                  <small class="calendar-date ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}" 
                         onclick="showDaySchedule(${dayCount})">${dayCount}</small>
                </div>
              `;
              dayCount++;
            }
          }
          calendarHTML += '</div>';
          if (dayCount > daysInMonth) break;
        }
        
        calendarHTML += '</div></div>';
        container.innerHTML = calendarHTML;
      }

      function populateTodaySchedule() {
        const container = document.getElementById('todaySchedule');
        const scheduleItems = [
          { time: '09:00', type: 'maintenance', title: 'Honda Civic Service', priority: 'high' },
          { time: '11:30', type: 'meeting', title: 'Staff Briefing', priority: 'medium' },
          { time: '14:00', type: 'inspection', title: 'Fleet Inspection', priority: 'high' },
          { time: '16:30', type: 'customer', title: 'VIP Customer Pickup', priority: 'high' },
          { time: '18:00', type: 'maintenance', title: 'BMW X3 Oil Change', priority: 'medium' }
        ];
        
        container.innerHTML = scheduleItems.map(item => `
          <div class="schedule-item d-flex justify-content-between align-items-center p-2 mb-2 border rounded ${getPriorityClass(item.priority)}">
            <div class="d-flex align-items-center">
              <div class="schedule-time me-3">
                <strong>${item.time}</strong>
              </div>
              <div>
                <div class="fw-bold">${item.title}</div>
                <small class="text-muted">${getScheduleTypeIcon(item.type)} ${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</small>
              </div>
            </div>
            <span class="badge bg-${getPriorityColor(item.priority)}">${item.priority}</span>
          </div>
        `).join('');
      }

      function getPriorityClass(priority) {
        return priority === 'high' ? 'border-warning' : '';
      }

      function getPriorityColor(priority) {
        const colors = { high: 'danger', medium: 'warning', low: 'info' };
        return colors[priority] || 'secondary';
      }

      function getScheduleTypeIcon(type) {
        const icons = {
          maintenance: '🔧',
          meeting: '👥',
          inspection: '📋',
          customer: '👤'
        };
        return icons[type] || '📅';
      }

      // === LAYOUT CUSTOMIZATION SYSTEM ===
      let layoutPreferences = {
        widgets: {
          'financial-dashboard': true,
          'fleet-management': true,
          'executive-summary': true,
          'weather-demand': true,
          'customer-insights': true,
          'fleet-usage': true,
          'critical-alerts': true
        },
        density: 'compact',
        updateFrequency: 30,
        animations: true
      };

      function initializeWidgetSelectionPanel() {
        const container = document.getElementById('widgetSelectionGrid');
        if (!container) return;

        const widgets = [
          { id: 'financial-dashboard', name: 'Financial Dashboard', icon: 'fas fa-chart-line', description: 'Comprehensive financial analytics and KPIs' },
          { id: 'fleet-management', name: 'Fleet Management', icon: 'fas fa-car', description: 'Complete fleet tracking, status, and analytics' },
          { id: 'executive-summary', name: 'Executive Summary', icon: 'fas fa-crown', description: 'Management insights' },
          { id: 'weather-demand', name: 'Weather & Demand', icon: 'fas fa-cloud-sun', description: 'Weather impact analysis' },
          { id: 'customer-insights', name: 'Customer Insights', icon: 'fas fa-users', description: 'Complete customer management and analytics' },
          { id: 'fleet-usage', name: 'Fleet Usage', icon: 'fas fa-tachometer-alt', description: 'Fleet usage analytics and patterns' },
          { id: 'critical-alerts', name: 'Critical Alerts', icon: 'fas fa-exclamation-triangle', description: 'Unified alert management' }
        ];

        container.innerHTML = widgets.map(widget => `
          <div class="col-6 col-sm-4 col-md-3 col-lg-2">
            <div class="widget-card ${layoutPreferences.widgets[widget.id] ? 'active' : 'inactive'}" 
                 data-widget-id="${widget.id}" 
                 onclick="toggleWidgetCard('${widget.id}')"
                 title="${widget.description}">
              <div class="widget-card-status"></div>
              <i class="widget-card-icon ${widget.icon}"></i>
              <p class="widget-card-title">${widget.name}</p>
            </div>
          </div>
        `).join('');
      }

      function toggleWidgetCard(widgetId) {
        try {
          // Validate widget ID
          if (!widgetId || typeof widgetId !== 'string') {
            console.error('Invalid widget ID provided:', widgetId);
            showNotification('Error: Invalid widget ID', 'danger');
            return false;
          }
          
          // Check if widget exists in preferences
          if (!(widgetId in layoutPreferences.widgets)) {
            console.error('Widget not found in preferences:', widgetId);
            showNotification(`Error: Widget "${widgetId}" not found`, 'danger');
            return false;
          }
          
          const card = document.querySelector(`[data-widget-id="${widgetId}"]`);
          const widget = document.querySelector(`[data-widget="${widgetId}"]`);
          
          if (!card) {
            console.warn('Widget card not found (panel may not be open):', widgetId);
            // Still proceed with the widget state change even if card not found
            // The card will be updated when the panel is opened
          }
          
          if (!widget) {
            console.warn('Widget element not found (may not be rendered yet):', widgetId);
          }
          
          // Get current state
          const wasActive = layoutPreferences.widgets[widgetId];
          const willBeActive = !wasActive;
          
          // Update preferences
          layoutPreferences.widgets[widgetId] = willBeActive;
          
          // Update card appearance with enhanced feedback
          updateCardState(card, willBeActive, widgetId);
          
          // Update widget visibility if element exists
          if (widget) {
            updateWidgetVisibility(widget, willBeActive, widgetId);
          }
          
          // Update UI components
          updateWidgetCounter();
          updateDashboardStats();
          
          // Save preferences automatically with debouncing
          debouncedSave();
          
          // Track analytics
          trackEvent('widget_toggled', {
            widget_id: widgetId,
            action: willBeActive ? 'enabled' : 'disabled',
            total_active: Object.values(layoutPreferences.widgets).filter(Boolean).length
          });
          
          return true;
          
        } catch (error) {
          console.error('Error toggling widget card:', error);
          showNotification('An error occurred while toggling the widget', 'danger');
          return false;
        }
      }

      function updateCardState(card, isActive, widgetId) {
        if (!card) return;
        
        // Remove existing states
        card.classList.remove('active', 'inactive', 'transitioning');
        
        // Add transitioning state
        card.classList.add('transitioning');
        
        // Update state after brief delay for smooth animation
        setTimeout(() => {
          card.classList.remove('transitioning');
          card.classList.add(isActive ? 'active' : 'inactive');
          
          // Add pulse effect for visual feedback
          card.classList.add('pulse-effect');
          setTimeout(() => card.classList.remove('pulse-effect'), 600);
          
          // Visual feedback notification
          const widgetName = getWidgetName(widgetId);
          const message = `${widgetName} ${isActive ? 'enabled' : 'disabled'}`;
          const type = isActive ? 'success' : 'warning';
          
          showNotification(message, type);
        }, 50);
      }

      function updateWidgetVisibility(widget, isVisible, widgetId) {
        if (!widget) return;
        
        if (isVisible) {
          // Show widget with smooth animation
          widget.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
          widget.style.display = '';
          widget.style.opacity = '0';
          widget.style.transform = 'translateY(-20px) scale(0.95)';
          
          // Force reflow
          widget.offsetHeight;
          
          setTimeout(() => {
            widget.style.opacity = '1';
            widget.style.transform = 'translateY(0) scale(1)';
          }, 10);
          
          // Clean up transition after animation
          setTimeout(() => {
            widget.style.transition = '';
          }, 400);
          
        } else {
          // Hide widget with smooth animation
          widget.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
          widget.style.opacity = '0';
          widget.style.transform = 'translateY(-20px) scale(0.95)';
          
          setTimeout(() => {
            widget.style.display = 'none';
            widget.style.transition = '';
          }, 300);
        }
      }

      // Debounced save function to prevent excessive localStorage writes
      let saveTimeout;
      function debouncedSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          saveLayoutPreferences();
        }, 500);
      }

      function getWidgetName(widgetId) {
        const names = {
          'financial-dashboard': 'Financial Dashboard',
          'fleet-management': 'Fleet Management',
          'executive-summary': 'Executive Summary',
          'weather-demand': 'Weather & Demand',
          'customer-insights': 'Customer Insights',
          'fleet-usage': 'Fleet Usage',
          'critical-alerts': 'Critical Alerts'
        };
        return names[widgetId] || widgetId;
      }

      function updateWidgetCounter() {
        const activeCount = Object.values(layoutPreferences.widgets).filter(Boolean).length;
        const totalCount = Object.keys(layoutPreferences.widgets).length;
        const counter = document.getElementById('selectedWidgetCount');
        if (counter) {
          counter.textContent = `${activeCount}/${totalCount} widgets selected`;
          counter.className = `badge me-2 ${activeCount === totalCount ? 'bg-success text-white' : activeCount > totalCount/2 ? 'bg-warning text-dark' : 'bg-light text-primary'}`;
        }
      }

      function updateWidgetCards() {
        try {
          // Check if widget selection panel exists
          const widgetSelectionGrid = document.getElementById('widgetSelectionGrid');
          if (!widgetSelectionGrid || !widgetSelectionGrid.hasChildNodes()) {
            // Widget selection panel not initialized yet, skip update
            return;
          }
          
          Object.keys(layoutPreferences.widgets).forEach(widgetId => {
            const card = document.querySelector(`[data-widget-id="${widgetId}"]`);
            const isActive = layoutPreferences.widgets[widgetId];
            
            if (card) {
              // Remove all state classes
              card.classList.remove('active', 'inactive', 'transitioning', 'pulse-effect');
              
              // Add appropriate state class
              card.classList.add(isActive ? 'active' : 'inactive');
              
              // Update accessibility attributes
              card.setAttribute('aria-pressed', isActive.toString());
              card.setAttribute('title', `${getWidgetName(widgetId)} - ${isActive ? 'Enabled' : 'Disabled'}`);
            }
            // Removed the console.warn to reduce noise since cards may not exist yet
          });
        } catch (error) {
          console.error('Error updating widget cards:', error);
        }
      }

      function updateDashboardStats() {
        try {
          const totalWidgets = Object.keys(layoutPreferences.widgets).length;
          const activeWidgets = Object.values(layoutPreferences.widgets).filter(Boolean).length;
          const inactiveWidgets = totalWidgets - activeWidgets;
          
          // Update stats in customization panel if elements exist
          const statsElements = {
            total: document.getElementById('totalWidgetCount'),
            active: document.getElementById('activeWidgetCount'),
            inactive: document.getElementById('inactiveWidgetCount')
          };
          
          if (statsElements.total) statsElements.total.textContent = totalWidgets;
          if (statsElements.active) statsElements.active.textContent = activeWidgets;
          if (statsElements.inactive) statsElements.inactive.textContent = inactiveWidgets;
          
          // Update dashboard performance metrics
          updatePerformanceMetrics(activeWidgets, totalWidgets);
          
        } catch (error) {
          console.error('Error updating dashboard stats:', error);
        }
      }

      function updatePerformanceMetrics(activeWidgets, totalWidgets) {
        const utilizationPercentage = Math.round((activeWidgets / totalWidgets) * 100);
        
        // Update any performance indicators
        const perfIndicator = document.getElementById('dashboardUtilization');
        if (perfIndicator) {
          perfIndicator.textContent = `${utilizationPercentage}%`;
          perfIndicator.className = `badge ${utilizationPercentage > 80 ? 'bg-success' : utilizationPercentage > 50 ? 'bg-warning' : 'bg-danger'}`;
        }
      }

      // Analytics tracking function
      function trackEvent(eventName, properties = {}) {
        try {
          // Basic analytics tracking - can be extended with real analytics service
          const event = {
            name: eventName,
            timestamp: new Date().toISOString(),
            properties: {
              ...properties,
              page: 'dashboard',
              user_agent: navigator.userAgent,
              viewport: `${window.innerWidth}x${window.innerHeight}`
            }
          };
          
          // Store in localStorage for now (replace with real analytics)
          const analytics = JSON.parse(localStorage.getItem('dashboard_analytics') || '[]');
          analytics.push(event);
          
          // Keep only last 100 events
          if (analytics.length > 100) {
            analytics.splice(0, analytics.length - 100);
          }
          
          localStorage.setItem('dashboard_analytics', JSON.stringify(analytics));
          
          console.log('Analytics event:', event);
        } catch (error) {
          console.error('Error tracking event:', error);
        }
      }

      // Widget state validation
      function validateWidgetState() {
        try {
          const issues = [];
          
          Object.keys(layoutPreferences.widgets).forEach(widgetId => {
            const card = document.querySelector(`[data-widget-id="${widgetId}"]`);
            const widget = document.querySelector(`[data-widget="${widgetId}"]`);
            const isActive = layoutPreferences.widgets[widgetId];
            
            if (!card) {
              issues.push(`Missing card for widget: ${widgetId}`);
            }
            
            if (isActive && widget && widget.style.display === 'none') {
              issues.push(`Active widget is hidden: ${widgetId}`);
            }
            
            if (!isActive && widget && widget.style.display !== 'none') {
              issues.push(`Inactive widget is visible: ${widgetId}`);
            }
          });
          
          if (issues.length > 0) {
            console.warn('Widget state validation issues:', issues);
            return false;
          }
          
          return true;
        } catch (error) {
          console.error('Error validating widget state:', error);
          return false;
        }
      }

      // Bulk widget operations
      function enableAllWidgets() {
        try {
          Object.keys(layoutPreferences.widgets).forEach(widgetId => {
            layoutPreferences.widgets[widgetId] = true;
          });
          
          updateWidgetCards();
          updateWidgetCounter();
          updateDashboardStats();
          applyLayoutPreferences();
          debouncedSave();
          
          trackEvent('bulk_enable_widgets', { count: Object.keys(layoutPreferences.widgets).length });
          showNotification('All widgets enabled successfully', 'success');
        } catch (error) {
          console.error('Error enabling all widgets:', error);
          showNotification('Error enabling all widgets', 'danger');
        }
      }

      function disableAllWidgets() {
        try {
          const confirmMessage = 'Are you sure you want to disable all widgets?\n\nThis will hide all dashboard content.';
          
          if (!confirm(confirmMessage)) {
            return;
          }
          
          Object.keys(layoutPreferences.widgets).forEach(widgetId => {
            layoutPreferences.widgets[widgetId] = false;
          });
          
          updateWidgetCards();
          updateWidgetCounter();
          updateDashboardStats();
          applyLayoutPreferences();
          debouncedSave();
          
          trackEvent('bulk_disable_widgets', { count: Object.keys(layoutPreferences.widgets).length });
          showNotification('All widgets disabled', 'warning');
        } catch (error) {
          console.error('Error disabling all widgets:', error);
          showNotification('Error disabling all widgets', 'danger');
        }
      }

      // User-facing validation function with feedback
      function runWidgetValidation() {
        try {
          const button = event.target.closest('button');
          const icon = button.querySelector('i');
          
          // Show loading state
          icon.className = 'fas fa-spinner fa-spin me-1';
          button.disabled = true;
          
          setTimeout(() => {
            const isValid = validateWidgetState();
            
            // Reset button state
            icon.className = 'fas fa-check-circle me-1';
            button.disabled = false;
            
            if (isValid) {
              showNotification('✅ All widgets are in valid state', 'success');
              trackEvent('widget_validation_success');
            } else {
              showNotification('⚠️ Widget state validation found issues - check console', 'warning');
              trackEvent('widget_validation_failed');
            }
          }, 1000);
          
        } catch (error) {
          console.error('Error running widget validation:', error);
          showNotification('Error running validation', 'danger');
        }
      }

      function initializeLayoutCustomization() {
        // Load saved preferences
        const saved = localStorage.getItem('dashboardLayout');
        if (saved) {
          const savedPreferences = JSON.parse(saved);
          
          // Migration: Remove obsolete widgets from saved preferences
          const validWidgets = ['financial-dashboard', 'fleet-management', 'executive-summary', 'weather-demand', 'customer-insights', 'fleet-usage', 'critical-alerts'];
          const cleanedWidgets = {};
          
          // Only keep valid widgets from saved preferences
          validWidgets.forEach(widgetId => {
            cleanedWidgets[widgetId] = savedPreferences.widgets && savedPreferences.widgets[widgetId] !== undefined 
              ? savedPreferences.widgets[widgetId] 
              : layoutPreferences.widgets[widgetId];
          });
          
          // Update layout preferences with cleaned widgets
          layoutPreferences = { 
            ...layoutPreferences, 
            ...savedPreferences, 
            widgets: cleanedWidgets 
          };
          
          // Save cleaned preferences back to localStorage
          saveLayoutPreferences();
        }
        
        // Update widget counter
        updateWidgetCounter();
        
        // Apply saved preferences
        applyLayoutPreferences();
      }

      function toggleCustomizationPanel() {
        const panel = document.getElementById('customizationPanel');
        const btn = document.getElementById('customizeBtn');
        
        if (!panel || !btn) {
          console.error('Customization panel elements not found');
          return;
        }
        
        const isOpen = panel.style.display !== 'none';
        
        if (!isOpen) {
          openCustomizationPanel();
        } else {
          closeCustomizationPanel();
        }
      }

      function openCustomizationPanel() {
        const panel = document.getElementById('customizationPanel');
        const btn = document.getElementById('customizeBtn');
        
        // Initialize widget selection panel if not already done
        initializeWidgetSelectionPanel();
        
        // Show panel with animation
        panel.style.display = 'block';
        panel.style.opacity = '0';
        panel.style.transform = 'translateY(-20px)';
        
        // Update button state
        btn.innerHTML = '<i class="fas fa-times me-2"></i>Close Customization';
        
        // Update widget cards after panel is shown
        setTimeout(() => {
          updateWidgetCards();
        }, 100);
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-primary');
        
        // Animate panel in
        setTimeout(() => {
          panel.style.opacity = '1';
          panel.style.transform = 'translateY(0)';
        }, 10);
        
        // Update widget counter and cards
        updateWidgetCounter();
        updateWidgetCards();
        
        // Track analytics
        trackEvent('customization_panel_opened');
        
        showNotification('Customization panel opened', 'info');
      }

      function closeCustomizationPanel() {
        const panel = document.getElementById('customizationPanel');
        const btn = document.getElementById('customizeBtn');
        
        if (!panel || !btn) return;
        
        // Animate panel out
        panel.style.opacity = '0';
        panel.style.transform = 'translateY(-20px)';
        
        // Update button state
        btn.innerHTML = '<i class="fas fa-palette me-2"></i>Customize Layout';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
        
        // Hide panel after animation
        setTimeout(() => {
          panel.style.display = 'none';
        }, 300);
        
        // Track analytics
        trackEvent('customization_panel_closed');
        
        showNotification('Customization panel closed', 'info');
      }

      function toggleWidget(widgetName) {
        const widget = document.querySelector(`[data-widget="${widgetName}"]`);
        
        // Correct ID mapping
        const idMap = {
          'kpi-cards': 'showKPICards',
          'revenue-charts': 'showRevenueCharts', 
          'executive-summary': 'showExecutiveSummary',
          'fleet-map': 'showFleetMap',
          'reservations': 'showReservations',
          'financial-snapshot': 'showFinancialSnapshot',
          'weather-demand': 'showWeatherDemand',
          'customer-insights': 'showCustomerInsights',
          'upcoming-bookings': 'showUpcomingBookings',
          'fleet-usage': 'showFleetUsage',
          'critical-alerts': 'showCriticalAlerts'
        };
        
        const checkbox = document.getElementById(idMap[widgetName]);
        
        if (widget && checkbox) {
          if (checkbox.checked) {
            widget.style.display = '';
            widget.style.opacity = '1';
            widget.style.transform = 'translateY(0)';
          } else {
            widget.style.opacity = '0';
            widget.style.transform = 'translateY(-10px)';
            setTimeout(() => {
              widget.style.display = 'none';
            }, 300);
          }
          
          layoutPreferences.widgets[widgetName] = checkbox.checked;
          saveLayoutPreferences();
        } else {
          console.error(`Widget or checkbox not found: ${widgetName}, checkbox ID: ${idMap[widgetName]}`);
        }
      }

      function applyLayout(layoutType) {
        const layouts = {
          executive: {
            'kpi-cards': true,
            'revenue-charts': true,
            'executive-summary': true,
            'fleet-map': false,
            'reservations': false,
            'financial-snapshot': true,
            'weather-demand': false,
            'customer-insights': true,
            'upcoming-bookings': false,
            'fleet-usage': false,
            'critical-alerts': true
          },
          operations: {
            'kpi-cards': true,
            'revenue-charts': false,
            'executive-summary': false,
            'fleet-map': true,
            'reservations': true,
            'financial-snapshot': false,
            'weather-demand': true,
            'customer-insights': false,
            'upcoming-bookings': true,
            'fleet-usage': true,
            'critical-alerts': true
          },
          analytics: {
            'kpi-cards': true,
            'revenue-charts': true,
            'executive-summary': true,
            'fleet-map': false,
            'reservations': false,
            'financial-snapshot': true,
            'weather-demand': true,
            'customer-insights': true,
            'upcoming-bookings': false,
            'fleet-usage': true,
            'critical-alerts': false
          },
          minimal: {
            'kpi-cards': true,
            'revenue-charts': false,
            'executive-summary': false,
            'fleet-map': false,
            'reservations': true,
            'financial-snapshot': false,
            'weather-demand': false,
            'customer-insights': false,
            'upcoming-bookings': false,
            'fleet-usage': false,
            'critical-alerts': false
          }
        };

        const layout = layouts[layoutType];
        if (layout) {
          // Update layout preferences
          layoutPreferences.widgets = { ...layoutPreferences.widgets, ...layout };
          
          // Update widget cards
          updateWidgetCards();
          updateWidgetCounter();
          
          // Apply the layout
          applyLayoutPreferences();
          
          // Save the updated preferences
          saveLayoutPreferences();
          
          showNotification(`${layoutType.charAt(0).toUpperCase() + layoutType.slice(1)} layout applied successfully!`, 'success');
        }
      }

      function changeDashboardDensity() {
        const density = document.getElementById('dashboardDensity').value;
        const body = document.body;
        
        // Remove existing density classes
        body.classList.remove('dashboard-comfortable', 'dashboard-compact', 'dashboard-dense');
        
        // Add new density class
        body.classList.add(`dashboard-${density}`);
        
        layoutPreferences.density = density;
        saveLayoutPreferences();
        
        showNotification(`Dashboard density changed to ${density}`, 'info');
      }

      function changeUpdateFrequency() {
        const frequency = parseInt(document.getElementById('updateFrequency').value);
        layoutPreferences.updateFrequency = frequency;
        
        // Clear existing intervals and restart with new frequency
        clearInterval(window.kpiUpdateInterval);
        clearInterval(window.statusUpdateInterval);
        
        window.kpiUpdateInterval = setInterval(updateKPICards, frequency * 1000);
        window.statusUpdateInterval = setInterval(updateRealTimeStatus, frequency * 1000);
        
        saveLayoutPreferences();
        showNotification(`Update frequency changed to every ${frequency} seconds`, 'info');
      }

      function toggleAnimations() {
        const enabled = document.getElementById('enableAnimations').checked;
        layoutPreferences.animations = enabled;
        
        if (enabled) {
          document.body.classList.remove('no-animations');
        } else {
          document.body.classList.add('no-animations');
        }
        
        saveLayoutPreferences();
        showNotification(`Animations ${enabled ? 'enabled' : 'disabled'}`, 'info');
      }

      function saveLayoutPreferences() {
        localStorage.setItem('dashboardLayout', JSON.stringify(layoutPreferences));
        console.log('Layout preferences saved:', layoutPreferences);
      }

      function applyLayoutPreferences() {
        // Apply widget visibility
        Object.keys(layoutPreferences.widgets).forEach(widget => {
          setWidgetVisibility(widget, layoutPreferences.widgets[widget]);
        });
        
        // Update widget cards
        updateWidgetCards();
        updateWidgetCounter();
      }

      // Simplified widget visibility function for internal use
      function setWidgetVisibility(widgetName, isVisible) {
        const widget = document.querySelector(`[data-widget="${widgetName}"]`);
        
        if (widget) {
          if (isVisible) {
            widget.style.display = '';
            widget.style.opacity = '1';
            widget.style.transform = 'translateY(0)';
          } else {
            widget.style.opacity = '0';
            widget.style.transform = 'translateY(-10px)';
            setTimeout(() => {
              widget.style.display = 'none';
            }, 300);
          }
        }
      }

      function resetToDefault() {
        if (confirm('Reset dashboard to default layout?\n\nThis will:\n• Show all widgets\n• Reset to compact density\n• Set 30-second updates\n• Enable animations')) {
          layoutPreferences = {
            widgets: {
              'kpi-cards': true,
              'revenue-charts': true,
              'executive-summary': true,
              'fleet-map': true,
              'reservations': true,
              'financial-snapshot': true,
              'weather-demand': true,
              'customer-insights': true,
              'upcoming-bookings': true,
              'fleet-usage': true,
              'critical-alerts': true
            },
            density: 'compact',
            updateFrequency: 30,
            animations: true
          };
          
          // Update widget cards to reflect reset state
          updateWidgetCards();
          updateWidgetCounter();
          
          // Apply layout preferences
          applyLayoutPreferences();
          
          // Save preferences
          saveLayoutPreferences();
          
          showNotification('Dashboard reset to default layout successfully!', 'success');
        }
      }

      function exportLayoutConfig() {
        const config = {
          layout: layoutPreferences,
          timestamp: new Date().toISOString(),
          version: '1.0'
        };
        
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dashboard-layout-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('Layout configuration exported', 'success');
      }

      function importLayoutConfig() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              try {
                const config = JSON.parse(e.target.result);
                if (config.layout) {
                  layoutPreferences = { ...layoutPreferences, ...config.layout };
                  applyLayoutPreferences();
                  showNotification('Layout configuration imported successfully', 'success');
                } else {
                  showNotification('Invalid configuration file', 'danger');
                }
              } catch (error) {
                showNotification('Error reading configuration file', 'danger');
              }
            };
            reader.readAsText(file);
          }
        };
        input.click();
      }

      function toggleFullscreenDashboard() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().then(() => {
            showNotification('Dashboard in fullscreen mode', 'info');
          });
        } else {
          document.exitFullscreen().then(() => {
            showNotification('Exited fullscreen mode', 'info');
          });
        }
      }

      function refreshDashboard() {
        const btn = event.target.closest('button');
        const icon = btn.querySelector('i');
        
        icon.classList.add('fa-spin');
        
        // Refresh all components
        updateKPICards();
        updateRealTimeStatus();
        updateExecutiveMetrics();
        populateTodaySchedule();
        generateRandomAlert();
        
        // Update last refresh time
        document.getElementById('lastDashboardUpdate').textContent = new Date().toLocaleTimeString();
        
        setTimeout(() => {
          icon.classList.remove('fa-spin');
          showNotification('Dashboard refreshed successfully', 'success');
        }, 1500);
      }
      
      // --- Geofence Storage ---
      let geofenceSource = new ol.source.Vector();
      let geofenceLayer = new ol.layer.Vector({
        source: geofenceSource,
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: '#28a745', width: 2 }),
          fill: new ol.style.Fill({ color: 'rgba(40,167,69,0.1)' })
        })
      });

      // --- Geofence Drawing Interaction ---
      let drawGeofence = null;
      let geofenceMode = false;

      function enableGeofenceDrawing(map) {
        if (drawGeofence) map.removeInteraction(drawGeofence);
        drawGeofence = new ol.interaction.Draw({
          source: geofenceSource,
          type: 'Polygon',
        });
        map.addInteraction(drawGeofence);
        drawGeofence.on('drawend', function(evt) {
          setTimeout(() => map.removeInteraction(drawGeofence), 100); // Remove after drawing
          geofenceMode = false;
          document.getElementById('toggleGeofenceBtn').classList.remove('active');
          // Show geofence rules popup
          showGeofenceRulesPopup(evt.feature);
        });
      }

      // --- Geofence Rules Popup ---
      function showGeofenceRulesPopup(feature) {
        // Create modal HTML if not present
        let modal = document.getElementById('geofenceRulesModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'geofenceRulesModal';
          modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                <h5 class="mb-3">Geofence Rules</h5>
                <form id="geofenceRulesForm">
                  <div class="mb-2">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" name="name" required placeholder="Geofence name">
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Allowed Vehicle Status</label>
                    <select class="form-control" name="status">
                      <option value="all">All</option>
                      <option value="available">Available</option>
                      <option value="rented">Rented</option>
                      <option value="service">In Service</option>
                      <option value="alert">Alert</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Alert on Entry?</label>
                    <select class="form-control" name="alertEntry">
                      <option value="yes">Yes</option>
                      <option value="no">No</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Alert on Exit?</label>
                    <select class="form-control" name="alertExit">
                      <option value="yes">Yes</option>
                      <option value="no">No</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" name="notes" rows="2" placeholder="Optional notes"></textarea>
                  </div>
                  <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" id="geofenceRulesCancel">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        } else {
          modal.style.display = 'flex';
        }
        // Cancel button closes modal and removes geofence
        document.getElementById('geofenceRulesCancel').onclick = function() {
          modal.style.display = 'none';
          // Remove the just-drawn geofence
          geofenceSource.removeFeature(feature);
        };
        // Save button closes modal (add your logic here)
        document.getElementById('geofenceRulesForm').onsubmit = function(e) {
          e.preventDefault();
          // You can collect rule data here:
          // const data = Object.fromEntries(new FormData(this).entries());
          modal.style.display = 'none';
          // Optionally, attach rule data to the feature:
          // feature.set('rules', data);
        };
      }
    

      function toggleGeofenceMode(map) {
        geofenceMode = !geofenceMode;
        const btn = document.getElementById('toggleGeofenceBtn');
        if (geofenceMode) {
          btn.classList.add('active');
          enableGeofenceDrawing(map);
        } else {
          btn.classList.remove('active');
          if (drawGeofence) map.removeInteraction(drawGeofence);
        }
      }

      // Remove all geofences helper
      function clearGeofences() {
        geofenceSource.clear();
      }

      function showMapError() {
        const mapContainer = document.getElementById('fleetMap');
        if (mapContainer) {
          mapContainer.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #6c757d;">
              <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
              <h5>Map Loading Error</h5>
              <p>Unable to load the fleet tracking map. Please check your internet connection and refresh the page.</p>
              <button class="btn btn-primary btn-sm" onclick="location.reload()">
                <i class="fas fa-sync-alt me-2"></i>Retry
              </button>
            </div>
          `;
        }
      }

      function initFleetMap() {
        // Check if OpenLayers is available
        if (typeof ol === 'undefined') {
          console.error('OpenLayers library not loaded');
          showMapError();
          return;
        }

        try {
        // --- Vehicle Data Simulation ---
        function randomLatLon() {
          const minLat = 31.90, maxLat = 32.05;
          const minLon = 35.80, maxLon = 36.00;
          return {
            lat: +(Math.random() * (maxLat - minLat) + minLat).toFixed(6),
            lon: +(Math.random() * (maxLon - minLon) + minLon).toFixed(6)
          };
        }
        function randomPlate() {
          const letters = () => String.fromCharCode(65 + Math.floor(Math.random() * 26));
          return `${letters()}${letters()}${letters()}${Math.floor(100 + Math.random() * 900)}`;
        }
        const vehicleData = [];
        let id = 1;
        for (let i = 0; i < 120; i++, id++) {
          const pos = randomLatLon();
          vehicleData.push({ id, name: `Vehicle ${id} - ${randomPlate()}`, lat: pos.lat, lon: pos.lon, status: 'available', driver: null });
        }
        for (let i = 0; i < 86; i++, id++) {
          const pos = randomLatLon();
          vehicleData.push({ id, name: `Vehicle ${id} - ${randomPlate()}`, lat: pos.lat, lon: pos.lon, status: 'rented', driver: `Driver ${id}` });
        }
        for (let i = 0; i < 11; i++, id++) {
          const pos = randomLatLon();
          vehicleData.push({ id, name: `Vehicle ${id} - ${randomPlate()}`, lat: pos.lat, lon: pos.lon, status: 'service', driver: null });
        }
        for (let i = 0; i < 16; i++, id++) {
          const pos = randomLatLon();
          vehicleData.push({ id, name: `Vehicle ${id} - ${randomPlate()}`, lat: pos.lat, lon: pos.lon, status: 'alert', driver: `Driver ${id}` });
        }

        // --- OpenLayers Sources & Layers ---
        const vectorSource = new ol.source.Vector();
        vehicleData.forEach(vehicle => {
          const marker = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.fromLonLat([vehicle.lon, vehicle.lat])),
            name: vehicle.name,
            status: vehicle.status,
            driver: vehicle.driver,
            id: vehicle.id
          });
          vectorSource.addFeature(marker);
        });
        const vectorLayer = new ol.layer.Vector({
          source: vectorSource,
          style: function(feature) {
            const status = feature.get('status');
            let color = '#28a745';
            switch(status) {
              case 'rented': color = '#007bff'; break;
              case 'service': color = '#ffc107'; break;
              case 'alert': color = '#dc3545'; break;
              default: color = '#28a745';
            }
            return new ol.style.Style({
              image: new ol.style.Circle({ radius: 8, fill: new ol.style.Fill({ color: color }), stroke: new ol.style.Stroke({ color: '#fff', width: 2 }) }),
              text: new ol.style.Text({ text: feature.get('name').split(' - ')[1], offsetY: -20, fill: new ol.style.Fill({ color: '#000' }), stroke: new ol.style.Stroke({ color: '#fff', width: 2 }), font: '12px Arial, sans-serif' })
            });
          }
        });

        // Cluster source/layer
        const clusterSource = new ol.source.Cluster({
          distance: 40,
          source: vectorSource
        });
        const clusterLayer = new ol.layer.Vector({
          source: clusterSource,
          style: function(feature) {
            const size = feature.get('features').length;
            if (size === 1) {
              // Single marker, use normal style
              return vectorLayer.getStyle()(feature.get('features')[0]);
            }
            // Clustered style
            return new ol.style.Style({
              image: new ol.style.Circle({
                radius: 14,
                fill: new ol.style.Fill({ color: '#6666ff' }),
                stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
              }),
              text: new ol.style.Text({
                text: size.toString(),
                fill: new ol.style.Fill({ color: '#fff' }),
                font: 'bold 14px Arial, sans-serif'
              })
            });
          }
        });

        // --- Map Initialization ---
        const map = new ol.Map({
          target: 'fleetMap',
          layers: [
            new ol.layer.Tile({ source: new ol.source.OSM() }),
            vectorLayer,
            geofenceLayer
          ],
          view: new ol.View({ center: ol.proj.fromLonLat([35.9106, 31.9632]), zoom: 12 })
        });

        // --- Refresh Button Functionality ---
        const refreshBtn = document.querySelector('.btn-outline-primary');
        if (refreshBtn && refreshBtn.querySelector('.fa-sync-alt')) {
          refreshBtn.addEventListener('click', function() {
            // Add spinning animation
            const icon = this.querySelector('.fa-sync-alt');
            icon.classList.add('fa-spin');

            // Simulate data refresh
            setTimeout(() => {
              // Update map markers with new positions
              vectorSource.getFeatures().forEach(feature => {
                const currentCoords = feature.getGeometry().getCoordinates();
                const lonLat = ol.proj.toLonLat(currentCoords);

                // Slightly move each vehicle (simulate movement)
                const newLon = lonLat[0] + (Math.random() - 0.5) * 0.001;
                const newLat = lonLat[1] + (Math.random() - 0.5) * 0.001;

                feature.getGeometry().setCoordinates(ol.proj.fromLonLat([newLon, newLat]));
              });

              // Update last refresh time
              updateLastRefreshTime();

              // Remove spinning animation
              icon.classList.remove('fa-spin');

              // Show success message
              showNotification('Fleet data refreshed successfully!', 'success');
            }, 1500);
          });
        }

        // --- Fullscreen Toggle Functionality ---
        const fullscreenBtn = document.querySelector('.btn-primary[class*="btn-sm"]');
        if (fullscreenBtn && fullscreenBtn.querySelector('.fa-expand')) {
          fullscreenBtn.addEventListener('click', function() {
            const mapContainer = document.getElementById('fleetMap').parentElement.parentElement.parentElement;
            const icon = this.querySelector('i');

            if (!document.fullscreenElement) {
              mapContainer.requestFullscreen().then(() => {
                icon.className = 'fas fa-compress';
                this.innerHTML = '<i class="fas fa-compress"></i> Exit Fullscreen';

                // Resize map after entering fullscreen
                setTimeout(() => {
                  map.updateSize();
                }, 100);
              });
            } else {
              document.exitFullscreen().then(() => {
                icon.className = 'fas fa-expand';
                this.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';

                // Resize map after exiting fullscreen
                setTimeout(() => {
                  map.updateSize();
                }, 100);
              });
            }
          });
        }

        // --- Geofence Tool Button Logic ---
        document.getElementById('toggleGeofenceBtn').addEventListener('click', function() {
          toggleGeofenceMode(map);
        });

        // Optional: Right-click to remove all geofences
        map.getViewport().addEventListener('contextmenu', function(e) {
          if (geofenceSource.getFeatures().length > 0) {
            e.preventDefault();
            if (confirm('Remove all geofences?')) clearGeofences();
          }
        });

        // --- Clustering Toggle Logic ---
        let clusteringEnabled = false;
        const toggleBtn = document.getElementById('toggleClusterBtn');
        function setClustering(enabled) {
          clusteringEnabled = enabled;
          // Helper to check if a layer is present
          function hasLayer(layer) {
            return map.getLayers().getArray().includes(layer);
          }
          if (enabled) {
            if (hasLayer(vectorLayer)) map.removeLayer(vectorLayer);
            if (!hasLayer(clusterLayer)) map.addLayer(clusterLayer);
            toggleBtn.classList.add('active');
            toggleBtn.innerHTML = '<i class="fas fa-layer-group"></i> Clustering On';
          } else {
            if (hasLayer(clusterLayer)) map.removeLayer(clusterLayer);
            if (!hasLayer(vectorLayer)) map.addLayer(vectorLayer);
            toggleBtn.classList.remove('active');
            toggleBtn.innerHTML = '<i class="fas fa-layer-group"></i> Clustering';
          }
        }
        toggleBtn.addEventListener('click', function() {
          setClustering(!clusteringEnabled);
        });
        // Default: clustering off
        setClustering(false);

        // --- Map Interactions ---
        map.on('click', function(evt) {
          if (clusteringEnabled) {
            // Check if a cluster was clicked
            const clusterFeature = map.forEachFeatureAtPixel(evt.pixel, function(f) { return f; });
            if (clusterFeature && clusterFeature.get('features')) {
              const features = clusterFeature.get('features');
              if (features.length === 1) {
                // Single vehicle in cluster: show info
                const feature = features[0];
                const vehicleName = feature.get('name');
                const status = feature.get('status');
                const driver = feature.get('driver');
                let statusText = status.charAt(0).toUpperCase() + status.slice(1);
                let driverText = driver ? `Driver: ${driver}` : 'No driver assigned';
                alert(`${vehicleName}\nStatus: ${statusText}\n${driverText}`);
              } else if (features.length > 1) {
                // Zoom in on cluster
                const extent = ol.extent.createEmpty();
                features.forEach(function(f) {
                  ol.extent.extend(extent, f.getGeometry().getExtent());
                });
                map.getView().fit(extent, { duration: 500, maxZoom: 18, padding: [40, 40, 40, 40] });
              }
            }
          } else {
            // Not clustering: show info for single vehicle
            const feature = map.forEachFeatureAtPixel(evt.pixel, function(f) { return f; });
            if (feature) {
              const vehicleName = feature.get('name');
              const status = feature.get('status');
              const driver = feature.get('driver');
              let statusText = status.charAt(0).toUpperCase() + status.slice(1);
              let driverText = driver ? `Driver: ${driver}` : 'No driver assigned';
              alert(`${vehicleName}\nStatus: ${statusText}\n${driverText}`);
            }
          }
        });
        map.on('pointermove', function(evt) {
          const hit = map.hasFeatureAtPixel(evt.pixel);
          map.getTargetElement().style.cursor = hit ? 'pointer' : '';
        });
        window.fleetMap = map;
        setInterval(function() { updateLastRefreshTime(); }, 30000);

        // Start real-time KPI updates
        startKPIUpdates();

        } catch (error) {
          console.error('Error during map initialization:', error);
          showMapError();
        }
      }

      // Notification system function (needs to be defined before use)
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 10000;
          min-width: 300px;
          max-width: 400px;
        `;
        notification.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        // Auto remove after 3 seconds
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 3000);
      }


      function updateLastRefreshTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        const lastUpdateElement = document.getElementById('lastUpdate');
        if (lastUpdateElement) {
          lastUpdateElement.textContent = timeString;
        }
      }

      // Real-time KPI update functions
      function startKPIUpdates() {
        // Update KPI cards every 45 seconds with realistic variations
        setInterval(updateKPICards, 45000);

        // Update financial data every 2 minutes
        setInterval(updateFinancialData, 120000);
      }

      function updateKPICards() {
        // Fleet Utilization (70-80% range)
        const fleetUtil = (70 + Math.random() * 10).toFixed(1) + '%';
        const fleetCard = document.querySelector('.card-stats:nth-child(1) .card-title');
        if (fleetCard) {
          animateCounterUpdate(fleetCard, fleetUtil);
        }

        // Active Bookings (40-55 range)
        const activeBookings = Math.floor(40 + Math.random() * 15);
        const bookingsCard = document.querySelector('.card-stats:nth-child(2) .card-title');
        if (bookingsCard) {
          animateCounterUpdate(bookingsCard, activeBookings.toString());
        }

        // Overdue Returns (0-8 range)
        const overdueReturns = Math.floor(Math.random() * 9);
        const overdueCard = document.querySelector('.card-stats:nth-child(3) .card-title');
        if (overdueCard) {
          animateCounterUpdate(overdueCard, overdueReturns.toString());
        }

        // Today's Revenue ($6000-$12000 range)
        const revenue = Math.floor(6000 + Math.random() * 6000);
        const revenueCard = document.querySelector('.card-stats:nth-child(4) .card-title');
        if (revenueCard) {
          animateCounterUpdate(revenueCard, '$' + revenue.toLocaleString());
        }
      }

      function updateFinancialData() {
        // Update Financial Snapshot numbers
        const todayRevenue = Math.floor(6000 + Math.random() * 6000);
        const monthRevenue = Math.floor(100000 + Math.random() * 50000);
        const pendingDeposits = Math.floor(15000 + Math.random() * 15000);
        const pendingRefunds = Math.floor(2000 + Math.random() * 5000);

        // Find and update financial elements by content
        const financialElements = document.querySelectorAll('.text-success, .text-info, .text-warning, .text-primary');
        financialElements.forEach(el => {
          const text = el.textContent.trim();
          if (text.includes('$8,450') || text.includes('Today\'s Revenue')) {
            animateCounterUpdate(el, '$' + todayRevenue.toLocaleString());
          } else if (text.includes('$125,330') || text.includes('This Month')) {
            animateCounterUpdate(el, '$' + monthRevenue.toLocaleString());
          } else if (text.includes('$23,500') || text.includes('Pending Deposits')) {
            animateCounterUpdate(el, '$' + pendingDeposits.toLocaleString());
          } else if (text.includes('$4,200') || text.includes('Pending Refunds')) {
            animateCounterUpdate(el, '$' + pendingRefunds.toLocaleString());
          }
        });
      }

      function animateCounterUpdate(element, newValue) {
        if (!element) return;

        // Add update animation
        element.style.transition = 'all 0.3s ease';
        element.style.transform = 'scale(1.1)';
        element.style.color = '#007bff';

        setTimeout(() => {
          element.textContent = newValue;
          setTimeout(() => {
            element.style.transform = 'scale(1)';
            element.style.color = '';
          }, 150);
        }, 150);
      }

      // === SIDEBAR TOGGLE FUNCTIONS ===
      function initializeSidebarToggles() {
        const toggleSidebarBtns = document.querySelectorAll('.toggle-sidebar');
        const sidenavTogglers = document.querySelectorAll('.sidenav-toggler');
        const topbarTogglers = document.querySelectorAll('.topbar-toggler');
        const sidebar = document.querySelector('.sidebar');
        const mainPanel = document.querySelector('.main-panel');

        // Toggle sidebar visibility
        toggleSidebarBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            if (sidebar) {
              sidebar.classList.toggle('sidebar-collapse');
              if (mainPanel) {
                mainPanel.classList.toggle('full-width');
              }
              if (window.fleetMap) {
                setTimeout(() => window.fleetMap.updateSize(), 300);
              }
            }
          });
        });

        // Side navigation togglers (for mobile)
        sidenavTogglers.forEach(btn => {
          btn.addEventListener('click', function() {
            if (sidebar) sidebar.classList.toggle('sidebar-show');
          });
        });

        // Topbar togglers (for mobile menu)
        topbarTogglers.forEach(btn => {
          btn.addEventListener('click', function() {
            const navbar = document.querySelector('.navbar-header');
            if (navbar) navbar.classList.toggle('mobile-menu-show');
          });
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
          if (window.innerWidth <= 768 && sidebar) {
            if (!sidebar.contains(e.target) && !e.target.closest('.sidenav-toggler')) {
              sidebar.classList.remove('sidebar-show');
            }
          }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
          if (window.innerWidth > 768 && sidebar) {
            sidebar.classList.remove('sidebar-show');
          }
          if (window.fleetMap) {
            setTimeout(() => window.fleetMap.updateSize(), 100);
          }
          // Update mobile period selector visibility
          const mobileDropdown = document.querySelector('.dropdown.d-md-none');
          const desktopGroup = document.querySelector('.btn-group.d-none.d-md-flex');
          if (mobileDropdown && desktopGroup) {
            if (window.innerWidth < 768) {
              mobileDropdown.style.display = 'block';
              desktopGroup.style.display = 'none';
            } else {
              mobileDropdown.style.display = 'none';
              desktopGroup.style.display = 'flex';
            }
          }
        });
      }

      // === SEARCH FUNCTIONS ===
      function initializeSearchFunctionality() {
        const searchInputs = document.querySelectorAll('input[placeholder="Search ..."]');
        const searchButtons = document.querySelectorAll('.btn-search');

        function performSearch(query) {
          if (!query.trim()) return;
          showSearchResults(query);
        }

        function showSearchResults(query) {
          let modal = document.getElementById('searchResultsModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'searchResultsModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:600px;max-height:80vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Search Results for: "<span id="searchQuery"></span>"</h5>
                    <button class="btn-close" id="closeSearchModal"></button>
                  </div>
                  <div id="searchResultsContent">
                    <div class="row">
                      <div class="col-md-4">
                        <h6><i class="fas fa-car me-2"></i>Vehicles</h6>
                        <div id="vehicleResults"></div>
                      </div>
                      <div class="col-md-4">
                        <h6><i class="fas fa-users me-2"></i>Customers</h6>
                        <div id="customerResults"></div>
                      </div>
                      <div class="col-md-4">
                        <h6><i class="fas fa-calendar-alt me-2"></i>Bookings</h6>
                        <div id="bookingResults"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closeSearchModal').onclick = function() {
              modal.style.display = 'none';
            };
          }

          document.getElementById('searchQuery').textContent = query;

          // Simulate search results
          const mockVehicles = ['Toyota Camry - ABC123', 'Honda CR-V - XYZ789', 'Ford Focus - DEF456'];
          const mockCustomers = ['John Smith', 'Sarah Johnson', 'Mike Davis'];
          const mockBookings = ['Booking #1001', 'Booking #1002', 'Booking #1003'];

          const vehicleResults = mockVehicles.filter(v => v.toLowerCase().includes(query.toLowerCase()))
            .map(v => `<div class="mb-1"><small>${v}</small></div>`).join('');
          const customerResults = mockCustomers.filter(c => c.toLowerCase().includes(query.toLowerCase()))
            .map(c => `<div class="mb-1"><small>${c}</small></div>`).join('');
          const bookingResults = mockBookings.filter(b => b.toLowerCase().includes(query.toLowerCase()))
            .map(b => `<div class="mb-1"><small>${b}</small></div>`).join('');

          document.getElementById('vehicleResults').innerHTML = vehicleResults || '<small class="text-muted">No vehicles found</small>';
          document.getElementById('customerResults').innerHTML = customerResults || '<small class="text-muted">No customers found</small>';
          document.getElementById('bookingResults').innerHTML = bookingResults || '<small class="text-muted">No bookings found</small>';

          modal.style.display = 'flex';
        }

        // Add search functionality to all search inputs
        searchInputs.forEach(input => {
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              performSearch(this.value);
            }
          });
        });

        searchButtons.forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const input = this.parentElement.parentElement.querySelector('input');
            if (input) {
              performSearch(input.value);
            }
          });
        });

        // Sidebar navigation functionality
        const sidebarLinks = document.querySelectorAll('.sidebar .nav-item a');
        sidebarLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            if (!this.getAttribute('href') || this.getAttribute('href') === '#') {
              e.preventDefault();
              const pageName = this.querySelector('p').textContent.trim();
              showPagePlaceholder(pageName);
            }
          });
        });
      }

      function showPagePlaceholder(pageName) {
          let modal = document.getElementById('pageModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'pageModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:2rem;border-radius:8px;width:95vw;max-width:400px;text-align:center;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="mb-3">
                    <i class="fas fa-info-circle text-primary" style="font-size: 48px;"></i>
                  </div>
                  <h4 id="modalPageTitle" class="mb-3"></h4>
                  <p class="text-muted mb-4">This page is under development and will be available soon.</p>
                  <button class="btn btn-primary" id="closePageModal">OK</button>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closePageModal').onclick = function() {
              modal.style.display = 'none';
            };
          }

          document.getElementById('modalPageTitle').textContent = pageName;
          modal.style.display = 'flex';
      }

      // === RESERVATION MANAGEMENT FUNCTIONS ===
      function initializeReservationManagement() {
        // New Booking button functionality
        const newBookingBtn = document.querySelector('.btn-primary.btn-round');
        if (newBookingBtn && newBookingBtn.querySelector('.fa-plus')) {
          newBookingBtn.addEventListener('click', function() {
            showBookingForm();
          });
        }

        // Reservation table action buttons
        document.addEventListener('click', handleReservationActions);
      }

      function showBookingForm() {
          let modal = document.getElementById('bookingModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'bookingModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:600px;max-height:80vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-plus-circle me-2"></i>New Booking</h4>
                    <button class="btn-close" id="closeBookingModal"></button>
                  </div>
                  <form id="newBookingForm">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Customer Name *</label>
                        <input type="text" class="form-control" name="customerName" required placeholder="Enter customer name">
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" name="phoneNumber" required placeholder="Enter phone number">
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" placeholder="customer@example.com">
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Vehicle Type *</label>
                        <select class="form-control" name="vehicleType" required>
                          <option value="">Select vehicle type</option>
                          <option value="economy">Economy</option>
                          <option value="compact">Compact</option>
                          <option value="suv">SUV</option>
                          <option value="luxury">Luxury</option>
                        </select>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Pickup Date *</label>
                        <input type="datetime-local" class="form-control" name="pickupDate" required>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Return Date *</label>
                        <input type="datetime-local" class="form-control" name="returnDate" required>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Pickup Location</label>
                      <input type="text" class="form-control" name="pickupLocation" placeholder="Branch location or address">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Special Requirements</label>
                      <textarea class="form-control" name="requirements" rows="3" placeholder="Any special requirements or notes"></textarea>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                      <button type="button" class="btn btn-secondary" id="cancelBooking">Cancel</button>
                      <button type="submit" class="btn btn-primary">Create Booking</button>
                    </div>
                  </form>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closeBookingModal').onclick = function() {
              modal.style.display = 'none';
            };
            document.getElementById('cancelBooking').onclick = function() {
              modal.style.display = 'none';
            };

            document.getElementById('newBookingForm').onsubmit = function(e) {
              e.preventDefault();
              const formData = Object.fromEntries(new FormData(this).entries());

              // Simulate booking creation
              showNotification('Booking created successfully!', 'success');
              modal.style.display = 'none';

              // Reset form
              this.reset();
            };
          }

          modal.style.display = 'flex';
        }

      // Consolidated reservation action handler
      function handleReservationActions(e) {
        // Check-out button
        if (e.target.matches('.btn-primary.btn-xs') || e.target.closest('.btn-primary.btn-xs')) {
          const button = e.target.closest('.btn-primary.btn-xs') || e.target;
          if (button.textContent.trim() === 'Check-out') {
            const row = button.closest('tr');
            const customerName = row.cells[0].textContent;
            const vehicle = row.cells[1].textContent;
            showCheckoutModal(customerName, vehicle);
          }
        }

        // View button
        if (e.target.matches('.btn-outline-primary.btn-xs') || e.target.closest('.btn-outline-primary.btn-xs')) {
          const button = e.target.closest('.btn-outline-primary.btn-xs') || e.target;
          const row = button.closest('tr');
          const customerName = row.cells[0].textContent;
          const vehicle = row.cells[1].textContent;
          const status = row.cells[3].textContent.trim();
          showReservationDetails(customerName, vehicle, status);
        }

        // Contact button
        if (e.target.matches('.btn-warning.btn-xs') || e.target.closest('.btn-warning.btn-xs')) {
          const button = e.target.closest('.btn-warning.btn-xs') || e.target;
          if (button.textContent.trim() === 'Contact') {
            const row = button.closest('tr');
            const customerName = row.cells[0].textContent;
            const vehicle = row.cells[1].textContent;
            showContactModal(customerName, vehicle);
          }
        }
      }

      function showCheckoutModal(customerName, vehicle) {
          let modal = document.getElementById('checkoutModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'checkoutModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-car me-2"></i>Vehicle Check-out</h4>
                    <button class="btn-close" id="closeCheckoutModal"></button>
                  </div>
                  <div class="mb-3">
                    <h6>Customer: <span id="checkoutCustomer"></span></h6>
                    <h6>Vehicle: <span id="checkoutVehicle"></span></h6>
                  </div>
                  <form id="checkoutForm">
                    <div class="mb-3">
                      <label class="form-label">Mileage Reading</label>
                      <input type="number" class="form-control" name="mileage" required placeholder="Current mileage">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Fuel Level</label>
                      <select class="form-control" name="fuelLevel" required>
                        <option value="">Select fuel level</option>
                        <option value="full">Full</option>
                        <option value="3/4">3/4</option>
                        <option value="1/2">1/2</option>
                        <option value="1/4">1/4</option>
                        <option value="empty">Empty</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Vehicle Condition</label>
                      <textarea class="form-control" name="condition" rows="3" placeholder="Note any damages or issues"></textarea>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                      <button type="button" class="btn btn-secondary" id="cancelCheckout">Cancel</button>
                      <button type="submit" class="btn btn-success">Complete Check-out</button>
                    </div>
                  </form>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closeCheckoutModal').onclick = function() {
              modal.style.display = 'none';
            };
            document.getElementById('cancelCheckout').onclick = function() {
              modal.style.display = 'none';
            };

            document.getElementById('checkoutForm').onsubmit = function(e) {
              e.preventDefault();
              showNotification('Vehicle checked out successfully!', 'success');
              modal.style.display = 'none';
              this.reset();
            };
          }

          document.getElementById('checkoutCustomer').textContent = customerName;
          document.getElementById('checkoutVehicle').textContent = vehicle;
          modal.style.display = 'flex';
        }

      function showReservationDetails(customerName, vehicle, status) {
          let modal = document.getElementById('detailsModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'detailsModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-info-circle me-2"></i>Reservation Details</h4>
                    <button class="btn-close" id="closeDetailsModal"></button>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <h6>Customer Information</h6>
                      <p><strong>Name:</strong> <span id="detailsCustomer"></span></p>
                      <p><strong>Phone:</strong> +1 (555) 123-4567</p>
                      <p><strong>Email:</strong> customer@example.com</p>
                    </div>
                    <div class="col-md-6">
                      <h6>Booking Details</h6>
                      <p><strong>Vehicle:</strong> <span id="detailsVehicle"></span></p>
                      <p><strong>Status:</strong> <span id="detailsStatus"></span></p>
                      <p><strong>Duration:</strong> 3 days</p>
                    </div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Pickup:</strong> Today 09:30 AM</p>
                      <p><strong>Return:</strong> Dec 20, 2024 09:30 AM</p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Total Amount:</strong> $450.00</p>
                      <p><strong>Deposit:</strong> $100.00</p>
                    </div>
                  </div>
                  <div class="d-flex justify-content-end">
                    <button class="btn btn-primary" id="closeDetailsBtn">Close</button>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closeDetailsModal').onclick = function() {
              modal.style.display = 'none';
            };
            document.getElementById('closeDetailsBtn').onclick = function() {
              modal.style.display = 'none';
            };
          }

          document.getElementById('detailsCustomer').textContent = customerName;
          document.getElementById('detailsVehicle').textContent = vehicle;
          document.getElementById('detailsStatus').innerHTML = status;
          modal.style.display = 'flex';
        }

      function showContactModal(customerName, vehicle) {
          let modal = document.getElementById('contactModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'contactModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-phone me-2"></i>Contact Customer</h4>
                    <button class="btn-close" id="closeContactModal"></button>
                  </div>
                  <div class="mb-3">
                    <h6>Customer: <span id="contactCustomer"></span></h6>
                    <h6>Vehicle: <span id="contactVehicle"></span></h6>
                    <div class="alert alert-warning">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      Vehicle return is overdue. Customer needs to be contacted immediately.
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="window.location.href='tel:+15551234567'">
                      <i class="fas fa-phone me-2"></i>Call Customer
                    </button>
                    <button class="btn btn-info" onclick="window.location.href='sms:+15551234567'">
                      <i class="fas fa-sms me-2"></i>Send SMS
                    </button>
                    <button class="btn btn-success" onclick="window.location.href='mailto:customer@example.com'">
                      <i class="fas fa-envelope me-2"></i>Send Email
                    </button>
                  </div>
                  <div class="mt-3 d-flex justify-content-end">
                    <button class="btn btn-secondary" id="closeContactBtn">Close</button>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closeContactModal').onclick = function() {
              modal.style.display = 'none';
            };
            document.getElementById('closeContactBtn').onclick = function() {
              modal.style.display = 'none';
            };
          }

          document.getElementById('contactCustomer').textContent = customerName;
          document.getElementById('contactVehicle').textContent = vehicle;
          modal.style.display = 'flex';
        };

      // === ENHANCED DASHBOARD UTILITY FUNCTIONS ===
      function getSeverityColor(severity) {
        const colors = {
          critical: 'danger',
          high: 'warning', 
          medium: 'info',
          warning: 'warning',
          info: 'info'
        };
        return colors[severity] || 'secondary';
      }

      function getAlertIcon(type) {
        const icons = {
          maintenance: 'fa-wrench',
          insurance: 'fa-shield-alt',
          geofence: 'fa-map-marker-alt',
          fuel: 'fa-gas-pump',
          overdue: 'fa-clock',
          booking: 'fa-calendar-alt'
        };
        return icons[type] || 'fa-bell';
      }

      function generateRandomAlert() {
        const alertTypes = [
          { type: 'maintenance', message: 'Ford Focus requires oil change', severity: 'medium', vehicle: 'FOR123' },
          { type: 'fuel', message: 'Nissan Altima fuel level critical (8%)', severity: 'high', vehicle: 'NIS456' },
          { type: 'geofence', message: 'Honda CR-V entered restricted zone', severity: 'warning', vehicle: 'HON789' },
          { type: 'booking', message: 'Customer requesting immediate pickup', severity: 'info', vehicle: 'TBD' }
        ];
        
        const randomAlert = alertTypes[Math.floor(Math.random() * alertTypes.length)];
        const newAlert = {
          id: Date.now(),
          ...randomAlert,
          time: 'Just now'
        };
        
        allAlerts.unshift(newAlert);
        if (allAlerts.length > 15) allAlerts.pop();
        
        updateLiveAlerts();
        
        if (newAlert.severity === 'critical') {
          showNotification(`CRITICAL: ${newAlert.message}`, 'danger');
        }
      }

      // === ENHANCED ACTION FUNCTIONS ===
      function filterAlerts(type) {
        currentAlertFilter = type;
        updateLiveAlerts();
        
        document.querySelectorAll('.btn-group-sm button').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
      }

      function handleAlert(alertId) {
        const alert = allAlerts.find(a => a.id === alertId);
        if (alert) {
          alert(`Handling Alert: ${alert.message}\n\nRecommended Actions:\n• Contact relevant staff\n• Verify alert details\n• Take corrective action\n• Update alert status`);
        }
      }

      function dismissAlert(alertId) {
        allAlerts = allAlerts.filter(a => a.id !== alertId);
        updateLiveAlerts();
        showNotification('Alert dismissed', 'info');
      }

      function showAlertCenter() {
        alert('Alert Management Center\n\nFeatures:\n• Alert history and tracking\n• Automated escalation rules\n• Performance threshold configuration\n• Notification preferences\n• Alert analytics and trends');
      }

      function showRealTimeMonitoring() {
        alert('Real-Time Operations Monitor\n\nLive Data:\n• Staff locations and status\n• Vehicle tracking and assignments\n• Branch capacity and alerts\n• System performance metrics\n• Emergency response coordination');
      }

      function updateRevenueChart() {
        const period = document.getElementById('revenueTimeFilter').value;
        console.log('Updating revenue chart for period:', period);
        
        if (window.revenueTrendChart) {
          let newData, newLabels;
          
          switch(period) {
            case '7':
              newLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
              newData = [
                [9800, 10200, 11500, 12800, 13200, 15600, 14200],
                [6400, 6800, 7200, 7800, 8200, 9800, 8900],
                [3400, 3400, 4300, 5000, 5000, 5800, 5300]
              ];
              break;
            case '90':
              newLabels = ['Month 1', 'Month 2', 'Month 3'];
              newData = [
                [198450, 205600, 189300],
                [128200, 132800, 121500],
                [70250, 72800, 67800]
              ];
              break;
            default:
              newLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
              newData = [
                [68450, 72180, 75920, 68023],
                [44200, 46800, 49100, 44200],
                [24250, 25380, 26820, 23823]
              ];
          }
          
          window.revenueTrendChart.data.labels = newLabels;
          window.revenueTrendChart.data.datasets[0].data = newData[0];
          window.revenueTrendChart.data.datasets[1].data = newData[1];
          window.revenueTrendChart.data.datasets[2].data = newData[2];
          window.revenueTrendChart.update();
        }
      }

      function exportRevenueData() {
        alert('Revenue Data Export\n\nExporting:\n• Revenue trends and forecasts\n• Cost analysis breakdown\n• Profit margin calculations\n• Performance comparisons\n\nFormats: Excel, PDF, CSV');
      }

      // Quick Action Functions
      function emergencyVehicleDispatch() {
        alert('🚨 EMERGENCY DISPATCH SYSTEM 🚨\n\nActivating:\n• Emergency response protocols\n• Nearest vehicle identification\n• Staff notification system\n• Customer communication\n• Incident logging');
      }

      function lockdownMode() {
        if (confirm('⚠️ ACTIVATE SYSTEM LOCKDOWN? ⚠️\n\nThis will:\n• Disable new bookings\n• Lock vehicle assignments\n• Alert all staff\n• Enable emergency protocols\n\nConfirm lockdown?')) {
          alert('🔒 SYSTEM LOCKDOWN ACTIVATED\n\nAll operations secured.\nEmergency protocols enabled.\nStaff have been notified.');
        }
      }

      function broadcastAlert() {
        const message = prompt('📢 Broadcast Message to All Staff:', 'URGENT: Please check your stations immediately');
        if (message) {
          alert(`📡 BROADCASTING TO ALL STAFF:\n\n"${message}"\n\nDelivery:\n• SMS notifications sent\n• Email alerts dispatched\n• Dashboard notifications active\n• Mobile app push notifications`);
        }
      }

      function quickVehicleAssignment() {
        alert('🚗 Quick Vehicle Assignment\n\nFeatures:\n• Smart vehicle matching\n• Instant availability check\n• Automated customer notification\n• GPS location verification\n• Digital key assignment');
      }

      function instantCheckout() {
        alert('✅ Instant Checkout System\n\nStreamlined process:\n• QR code vehicle identification\n• Digital signature capture\n• Automated documentation\n• Real-time status updates\n• Customer SMS confirmation');
      }

      function customerSupportChat() {
        alert('💬 Live Customer Support\n\nCapabilities:\n• Real-time chat interface\n• Customer history access\n• Screen sharing support\n• Escalation workflows\n• Multi-language support');
      }

      function processRefund() {
        alert('💰 Quick Refund Processing\n\nFeatures:\n• Instant refund approval\n• Multiple payment methods\n• Automated customer notifications\n• Audit trail creation\n• Compliance verification');
      }

      function escalateIssue() {
        alert('⬆️ Issue Escalation System\n\nEscalation levels:\n• Level 1: Supervisor (immediate)\n• Level 2: Branch Manager (15 min)\n• Level 3: Regional Director (30 min)\n• Emergency: Executive team (immediate)');
      }

      function generateInstantReport() {
        alert('📊 Instant Report Generator\n\nQuick reports:\n• Daily operations summary\n• Revenue snapshot analysis\n• Fleet utilization metrics\n• Customer satisfaction scores\n• Performance benchmarks');
      }

      function exportDashboardData() {
        alert('📁 Dashboard Data Export\n\nExport options:\n• Complete dashboard dataset\n• Selected widgets only\n• Custom date ranges\n• Multiple formats available\n• Automated scheduling');
      }

      function scheduleReport() {
        alert('📅 Report Scheduling\n\nAutomated reporting:\n• Daily operational reports\n• Weekly performance summaries\n• Monthly analytics\n• Custom intervals\n• Multi-recipient delivery');
      }

      // === EXECUTIVE SUMMARY FUNCTIONS ===
      function exportExecutiveSummary() {
        alert('📊 Executive Summary Export\n\nGenerating comprehensive executive report:\n• Business health analysis\n• Performance metrics\n• Key insights and recommendations\n• Market position analysis\n• Strategic action items\n\nFormat: Professional PDF report');
      }

      // === LOGIN TIME TRACKING SYSTEM ===
      function initializeLoginTracking() {
        updateLastLoginTime();
        updateCurrentSessionTime();
        
        // Update session time every minute
        setInterval(updateCurrentSessionTime, 60000);
      }

      function updateLastLoginTime() {
        const lastLoginElement = document.getElementById('lastLoginTime');
        if (!lastLoginElement) return;
        
        // Get stored login times
        let lastLoginTime = localStorage.getItem('lastLoginTime');
        let currentSessionStart = localStorage.getItem('currentSessionStart');
        const now = new Date().toISOString();
        
        // Check if this is a new session (more than 30 minutes since last activity)
        const lastActivity = localStorage.getItem('lastActivity');
        const isNewSession = !lastActivity || (new Date() - new Date(lastActivity)) > (30 * 60 * 1000); // 30 minutes
        
        if (!lastLoginTime) {
          // Very first time using the system
          lastLoginElement.textContent = 'First time login';
          localStorage.setItem('lastLoginTime', now);
          localStorage.setItem('currentSessionStart', now);
        } else if (isNewSession) {
          // New session - display the previous login time
          const loginDate = new Date(lastLoginTime);
          const timeDiff = new Date() - loginDate;
          let timeAgo = formatTimeAgo(timeDiff);
          lastLoginElement.textContent = timeAgo;
          
          // Update last login time to current session start for next time
          localStorage.setItem('lastLoginTime', now);
          localStorage.setItem('currentSessionStart', now);
        } else {
          // Same session continuing - show the last login (before current session)
          if (lastLoginTime) {
            const loginDate = new Date(lastLoginTime);
            const timeDiff = new Date() - loginDate;
            let timeAgo = formatTimeAgo(timeDiff);
            lastLoginElement.textContent = timeAgo;
          }
        }
        
        // Update last activity timestamp
        localStorage.setItem('lastActivity', now);
      }

      function updateCurrentSessionTime() {
        // Use the currentSessionStart time that was set during login tracking
        const sessionStart = localStorage.getItem('currentSessionStart') || localStorage.getItem('sessionStartTime') || new Date().toISOString();
        
        // Ensure we have a session start time
        if (!localStorage.getItem('currentSessionStart')) {
          localStorage.setItem('currentSessionStart', sessionStart);
        }
        
        const startTime = new Date(sessionStart);
        const now = new Date();
        const sessionDuration = now - startTime;
        
        // Update session info in the dashboard update span
        const updateElement = document.getElementById('lastDashboardUpdate');
        if (updateElement) {
          const sessionTime = formatSessionDuration(sessionDuration);
          updateElement.textContent = `Just now (Session: ${sessionTime})`;
        }
        
        // Update last activity for session tracking
        localStorage.setItem('lastActivity', now.toISOString());
      }

      function formatTimeAgo(milliseconds) {
        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        const weeks = Math.floor(days / 7);
        const months = Math.floor(days / 30);
        
        if (months > 0) return `${months} month${months > 1 ? 's' : ''} ago`;
        if (weeks > 0) return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
        if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
        if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        return 'Just now';
      }

      function formatSessionDuration(milliseconds) {
        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        if (hours > 0) {
          const remainingMinutes = minutes % 60;
          return `${hours}h ${remainingMinutes}m`;
        }
        if (minutes > 0) {
          return `${minutes}m`;
        }
        return '< 1m';
      }

      // === NEW WIDGET INITIALIZATION ===
      function initializeNewWidgets() {
        populateMaintenanceAlerts();
        populateBranchPerformance();
        populateUpcomingBookings();
        populateTopCustomers();
        initializeWeatherWidget();
        initializeCustomerInsightsWidget();
        initializeUnifiedAlertCenter();
        initializeFinancialDashboard();
        initializeFleetManagementWidget();
        
        // Update weather every 30 minutes
        setInterval(updateWeatherData, 1800000);
      }

      function populateMaintenanceAlerts() {
        const container = document.getElementById('maintenanceAlertsList');
        if (!container) return;
        
        const maintenanceAlerts = [
          { vehicle: 'Honda Civic - ABC123', issue: 'Oil Change Due', priority: 'medium', dueDate: 'Today' },
          { vehicle: 'Ford Focus - DEF456', issue: 'Brake Inspection', priority: 'high', dueDate: 'Tomorrow' },
          { vehicle: 'BMW X3 - GHI345', issue: 'Tire Rotation', priority: 'low', dueDate: 'Dec 20' }
        ];
        
        container.innerHTML = maintenanceAlerts.map(alert => `
          <div class="maintenance-alert d-flex justify-content-between align-items-center p-2 mb-2 border-start border-3 border-${getPriorityColor(alert.priority)}">
            <div>
              <div class="fw-bold">${alert.vehicle}</div>
              <small class="text-muted">${alert.issue} • Due: ${alert.dueDate}</small>
            </div>
            <span class="badge bg-${getPriorityColor(alert.priority)}">${alert.priority}</span>
          </div>
        `).join('');
      }

      function populateBranchPerformance() {
        const container = document.getElementById('branchPerformanceList');
        if (!container) return;
        
        const branchData = [
          { name: 'Manhattan', performance: 87, vehicles: 42, status: 'excellent' },
          { name: 'Brooklyn', performance: 82, vehicles: 28, status: 'good' },
          { name: 'Queens', performance: 76, vehicles: 31, status: 'average' },
          { name: 'Bronx', performance: 68, vehicles: 18, status: 'needs-attention' }
        ];
        
        container.innerHTML = branchData.map(branch => `
          <div class="branch-performance d-flex justify-content-between align-items-center mb-3">
            <div>
              <div class="fw-bold">${branch.name}</div>
              <small class="text-muted">${branch.vehicles} vehicles</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-${getPerformanceColor(branch.performance)}">${branch.performance}%</div>
              <div class="progress mt-1" style="width: 60px; height: 4px;">
                <div class="progress-bar bg-${getPerformanceColor(branch.performance)}" style="width: ${branch.performance}%"></div>
              </div>
            </div>
          </div>
        `).join('');
      }

      function populateUpcomingBookings() {
        const container = document.getElementById('upcomingBookingsList');
        if (!container) return;
        
        const upcomingBookings = [
          { customer: 'Alice Brown', vehicle: 'Toyota Camry', time: '10:30 AM', type: 'pickup' },
          { customer: 'Bob Wilson', vehicle: 'Honda CR-V', time: '2:15 PM', type: 'return' },
          { customer: 'Carol Davis', vehicle: 'BMW X3', time: '4:45 PM', type: 'pickup' },
          { customer: 'David Lee', vehicle: 'Ford Focus', time: '6:00 PM', type: 'return' }
        ];
        
        container.innerHTML = upcomingBookings.map(booking => `
          <div class="upcoming-booking d-flex justify-content-between align-items-center p-2 mb-2 border rounded">
            <div>
              <div class="fw-bold">${booking.customer}</div>
              <small class="text-muted">${booking.vehicle} • ${booking.time}</small>
            </div>
            <span class="badge bg-${booking.type === 'pickup' ? 'success' : 'info'}">${booking.type}</span>
          </div>
        `).join('');
      }

      function populateTopCustomers() {
        const container = document.getElementById('topCustomersList');
        if (!container) return;
        
        const topCustomers = [
          { name: 'TechCorp Inc.', spent: 45200, type: 'corporate', rating: 4.9 },
          { name: 'Global Solutions', spent: 38900, type: 'corporate', rating: 4.8 },
          { name: 'John Smith', spent: 8450, type: 'individual', rating: 4.6 },
          { name: 'Tourism Agency', spent: 12300, type: 'tourist', rating: 4.2 }
        ];
        
        container.innerHTML = topCustomers.map((customer, index) => `
          <div class="top-customer d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
              <span class="badge bg-${index === 0 ? 'warning' : index < 3 ? 'success' : 'primary'} rounded-pill me-2">#${index + 1}</span>
              <div>
                <div class="fw-bold">${customer.name}</div>
                <small class="text-muted">${getCustomerTypeIcon(customer.type)} ${customer.rating} ⭐</small>
              </div>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">$${customer.spent.toLocaleString()}</div>
            </div>
          </div>
        `).join('');
      }

      // === ENHANCED WEATHER & DEMAND WIDGET ===
      let weatherData = {
        current: {
          temperature: 72,
          condition: 'Sunny, Clear',
          humidity: 65,
          windSpeed: 8,
          pressure: 30.15,
          visibility: 10,
          uvIndex: 6,
          icon: 'fa-sun',
          iconColor: 'warning',
          lastUpdated: new Date(),
          location: 'New York, NY',
          demandImpact: '+15%',
          demandScore: 85
        },
        forecast: [
          { 
            day: 'Today', 
            temp: '72°F', 
            condition: 'Sunny, Clear', 
            demand: 'High', 
            icon: 'fa-sun',
            iconColor: 'warning',
            demandScore: 85,
            precipitation: 0,
            windSpeed: 8,
            bookingChange: '+15%'
          },
          { 
            day: 'Tomorrow', 
            temp: '68°F', 
            condition: 'Light Rain', 
            demand: 'Low', 
            icon: 'fa-cloud-rain',
            iconColor: 'primary',
            demandScore: 35,
            precipitation: 80,
            windSpeed: 15,
            bookingChange: '-25%'
          },
          { 
            day: 'Wednesday', 
            temp: '75°F', 
            condition: 'Sunny', 
            demand: 'Very High', 
            icon: 'fa-sun',
            iconColor: 'warning',
            demandScore: 95,
            precipitation: 0,
            windSpeed: 5,
            bookingChange: '+35%'
          },
          { 
            day: 'Thursday', 
            temp: '73°F', 
            condition: 'Partly Cloudy', 
            demand: 'High', 
            icon: 'fa-cloud-sun',
            iconColor: 'info',
            demandScore: 78,
            precipitation: 10,
            windSpeed: 7,
            bookingChange: '+12%'
          },
          { 
            day: 'Friday', 
            temp: '70°F', 
            condition: 'Overcast', 
            demand: 'Medium', 
            icon: 'fa-cloud',
            iconColor: 'secondary',
            demandScore: 60,
            precipitation: 30,
            windSpeed: 12,
            bookingChange: '-8%'
          }
        ],
        historical: {
          labels: ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'],
          temperatures: [65, 68, 72, 75, 73, 70],
          bookings: [12, 25, 45, 38, 42, 28],
          demandScores: [45, 65, 85, 80, 85, 60]
        },
        alerts: [
          {
            type: 'weather',
            severity: 'warning',
            message: 'Rain expected tomorrow - 25% booking decrease anticipated',
            icon: 'fa-cloud-rain',
            color: 'warning'
          },
          {
            type: 'demand',
            severity: 'success', 
            message: 'Perfect weather Wednesday - Prepare for 35% booking surge',
            icon: 'fa-trending-up',
            color: 'success'
          }
        ],
        recommendations: [
          {
            type: 'fleet',
            icon: 'fa-car',
            message: 'Increase fleet availability for Wednesday\'s sunny weather',
            priority: 'high'
          },
          {
            type: 'pricing',
            icon: 'fa-dollar-sign',
            message: 'Consider surge pricing during peak weather conditions',
            priority: 'medium'
          },
          {
            type: 'operations',
            icon: 'fa-shield-alt',
            message: 'Prepare covered parking for tomorrow\'s rain',
            priority: 'medium'
          }
        ]
      };

      let currentWeatherView = 'current';
      let weatherTrendsChart = null;

      function initializeWeatherWidget() {
        populateWeatherData();
        populateWeatherImpactMetrics();
        populateWeatherRecommendations();
        
        // Update weather every 15 minutes
        setInterval(() => {
          updateWeatherData();
          populateWeatherImpactMetrics();
        }, 900000);
        
        // Initialize with current view
        switchWeatherView('current');
      }

      function switchWeatherView(view) {
        currentWeatherView = view;
        
        // Update button states
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(view + 'ViewBtn').classList.add('active');
        
        // Hide all views
        document.getElementById('currentWeatherView').style.display = 'none';
        document.getElementById('forecastWeatherView').style.display = 'none';
        document.getElementById('trendsWeatherView').style.display = 'none';
        
        // Show selected view
        if (view === 'current') {
          document.getElementById('currentWeatherView').style.display = 'block';
          populateWeatherData();
        } else if (view === 'forecast') {
          document.getElementById('forecastWeatherView').style.display = 'block';
          populateForecastData();
        } else if (view === 'trends') {
          document.getElementById('trendsWeatherView').style.display = 'block';
          initializeWeatherTrendsChart();
        }
        
        showNotification(`Switched to ${view} weather view`, 'info');
      }

      function populateWeatherData() {
        const current = weatherData.current;
        
        document.getElementById('mainWeatherIcon').className = `fas ${current.icon} text-${current.iconColor}`;
        document.getElementById('currentTemp').textContent = `${current.temperature}°F`;
        document.getElementById('currentCondition').textContent = current.condition;
        document.getElementById('currentLocation').textContent = current.location;
        document.getElementById('demandImpact').textContent = `${current.demandImpact} booking impact`;
        document.getElementById('demandImpact').className = `badge bg-${current.demandImpact.startsWith('+') ? 'success' : 'danger'}`;
        
        document.getElementById('humidity').textContent = `${current.humidity}%`;
        document.getElementById('windSpeed').textContent = `${current.windSpeed} mph`;
        document.getElementById('uvIndex').textContent = current.uvIndex;
        document.getElementById('visibility').textContent = `${current.visibility} mi`;
        
        // Update circular progress
        updateCircularProgress(current.demandScore);
      }

      function populateForecastData() {
        const container = document.getElementById('forecastList');
        container.innerHTML = weatherData.forecast.map(day => `
          <div class="forecast-item">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <i class="fas ${day.icon} text-${day.iconColor} me-3" style="font-size: 1.5rem;"></i>
                <div>
                  <div class="fw-bold">${day.day}</div>
                  <small class="text-muted">${day.condition}</small>
                </div>
              </div>
              <div class="text-end">
                <div class="fw-bold">${day.temp}</div>
                <small class="text-muted">${day.precipitation}% rain</small>
              </div>
            </div>
            <div class="mt-2">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <small class="text-muted">Demand Score</small>
                <small class="fw-bold ${day.bookingChange.startsWith('+') ? 'text-success' : 'text-danger'}">${day.bookingChange}</small>
              </div>
              <div class="demand-score-bar">
                <div class="demand-score-fill bg-${getDemandColor(day.demandScore)}" style="width: ${day.demandScore}%"></div>
              </div>
            </div>
          </div>
        `).join('');
      }

      function populateWeatherImpactMetrics() {
        // Update business impact metrics instead of alerts
        const current = weatherData.current;
        const expectedBookings = current.demandImpact;
        const revenueImpact = current.demandScore > 80 ? '+$2,340' : current.demandScore > 60 ? '+$1,200' : '-$800';
        const fleetUtilization = current.demandScore > 80 ? '+8%' : current.demandScore > 60 ? '+3%' : '-5%';
        
        // Update impact metrics if elements exist
        const impactElements = document.querySelectorAll('.impact-metrics .badge');
        if (impactElements.length >= 3) {
          impactElements[0].textContent = expectedBookings;
          impactElements[0].className = `badge bg-${expectedBookings.startsWith('+') ? 'success' : 'danger'}`;
          impactElements[1].textContent = revenueImpact;
          impactElements[1].className = `badge bg-${revenueImpact.startsWith('+') ? 'primary' : 'danger'}`;
          impactElements[2].textContent = fleetUtilization;
          impactElements[2].className = `badge bg-${fleetUtilization.startsWith('+') ? 'info' : 'warning'}`;
        }
      }

      function populateWeatherRecommendations() {
        const container = document.getElementById('weatherRecommendations');
        container.innerHTML = weatherData.recommendations.map(rec => `
          <div class="recommendation-item d-flex align-items-start">
            <i class="fas ${rec.icon} text-${rec.priority === 'high' ? 'warning' : 'info'} me-2 mt-1"></i>
            <small class="text-muted">${rec.message}</small>
          </div>
        `).join('');
      }

      function initializeWeatherTrendsChart() {
        if (weatherTrendsChart) {
          weatherTrendsChart.destroy();
        }
        
        const ctx = document.getElementById('weatherTrendsChart').getContext('2d');
        weatherTrendsChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: weatherData.historical.labels,
            datasets: [
              {
                label: 'Temperature (°F)',
                data: weatherData.historical.temperatures,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              },
              {
                label: 'Bookings',
                data: weatherData.historical.bookings,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                yAxisID: 'y1',
                tension: 0.4
              },
              {
                label: 'Demand Score',
                data: weatherData.historical.demandScores,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                yAxisID: 'y2',
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                display: true,
                title: {
                  display: true,
                  text: 'Time'
                }
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'Temperature (°F)'
                },
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Bookings'
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
              y2: {
                type: 'linear',
                display: false,
                position: 'right',
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'Weather Impact on Bookings (Last 24 Hours)'
              },
              legend: {
                display: true,
                position: 'bottom'
              }
            }
          }
        });
      }

      function updateWeatherData() {
        // Simulate weather API data update
        const weatherConditions = [
          { icon: 'fa-sun', temp: 75, condition: 'Sunny, Clear', impact: '+18%', color: 'warning', score: 88 },
          { icon: 'fa-cloud-sun', temp: 70, condition: 'Partly Cloudy', impact: '+12%', color: 'info', score: 75 },
          { icon: 'fa-cloud-rain', temp: 65, condition: 'Light Rain', impact: '-15%', color: 'primary', score: 45 },
          { icon: 'fa-cloud', temp: 68, condition: 'Overcast', impact: '-5%', color: 'secondary', score: 60 }
        ];
        
        const randomWeather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
        
        // Update current weather data
        weatherData.current = {
          ...weatherData.current,
          temperature: randomWeather.temp,
          condition: randomWeather.condition,
          icon: randomWeather.icon,
          iconColor: randomWeather.color,
          demandImpact: randomWeather.impact,
          demandScore: randomWeather.score,
          lastUpdated: new Date()
        };
        
        // Refresh current view if active
        if (currentWeatherView === 'current') {
          populateWeatherData();
        }
        
        showNotification('Weather data updated', 'info');
      }

      function refreshWeatherData() {
        const refreshIcon = document.getElementById('refreshIcon');
        refreshIcon.classList.add('spinning');
        
        setTimeout(() => {
          updateWeatherData();
          refreshIcon.classList.remove('spinning');
          showNotification('Weather data refreshed successfully', 'success');
        }, 1000);
      }

      function updateCircularProgress(percentage) {
        const progressElement = document.querySelector('.circular-progress');
        const valueElement = document.querySelector('.progress-value');
        
        if (progressElement && valueElement) {
          const degrees = (percentage / 100) * 360;
          progressElement.style.background = `conic-gradient(#007bff 0deg ${degrees}deg, #e9ecef ${degrees}deg 360deg)`;
          valueElement.textContent = `${percentage}%`;
        }
      }

      function getDemandColor(score) {
        if (score >= 80) return 'success';
        if (score >= 60) return 'warning';
        if (score >= 40) return 'info';
        return 'danger';
      }

      // === UNIFIED FINANCIAL DASHBOARD ===
      let financialData = {
        overview: {
          todayRevenue: 8450,
          todayBookings: 156,
          fleetUtilization: 73.5,
          avgBookingValue: 54.20,
          profitMargin: 24.8,
          overdueReturns: 3,
          trends: {
            revenue: 12.5,
            bookings: 8.3,
            utilization: 3.2,
            avgValue: 2.30,
            margin: 1.1,
            overdue: -1
          }
        },
        charts: {
          revenueDistribution: {
            labels: ['Vehicle Rentals', 'Insurance & Fees', 'Fuel & Services'],
            data: [69.7, 18.3, 12.0],
            colors: ['#007bff', '#28a745', '#ffc107']
          },
          fleetPerformance: {
            labels: ['Available', 'Rented', 'Maintenance'],
            data: [120, 86, 11],
            colors: ['#28a745', '#007bff', '#ffc107']
          },
          bookingTrends: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            data: [45, 52, 48, 61, 55, 78, 82]
          }
        },
        targets: {
          monthly: { current: 245000, target: 280000, percentage: 87 },
          quarterly: { current: 610000, target: 840000, percentage: 73 },
          annual: { current: 2100000, target: 3200000, percentage: 65 }
        }
      };

      let currentFinancialView = 'overview';
      let financialCharts = {};

      function initializeFinancialDashboard() {
        populateFinancialOverview();
        initializeFinancialOverviewCharts();
        
        // Initialize with overview
        switchFinancialView('overview');
        
        // Update financial data every 5 minutes
        setInterval(() => {
          updateFinancialData();
        }, 300000);
      }

      function switchFinancialView(view) {
        currentFinancialView = view;
        
        // Update button states
        document.querySelectorAll('[id^="financial"][id$="Btn"]').forEach(btn => btn.classList.remove('active'));
        document.getElementById('financial' + view.charAt(0).toUpperCase() + view.slice(1) + 'Btn').classList.add('active');
        
        // Hide all views
        document.getElementById('financialOverviewView').style.display = 'none';
        document.getElementById('financialTrendsView').style.display = 'none';
        document.getElementById('financialBreakdownView').style.display = 'none';
        
        // Show selected view
        document.getElementById('financial' + view.charAt(0).toUpperCase() + view.slice(1) + 'View').style.display = 'block';
        
        if (view === 'overview') {
          initializeFinancialOverviewCharts();
        } else if (view === 'trends') {
          initializeFinancialTrendsCharts();
        } else if (view === 'breakdown') {
          initializeFinancialBreakdownCharts();
        }
        
        showNotification(`Switched to ${view} financial view`, 'info');
      }

      function populateFinancialOverview() {
        const data = financialData.overview;
        
        document.getElementById('todayRevenue').textContent = `$${data.todayRevenue.toLocaleString()}`;
        document.getElementById('todayBookings').textContent = data.todayBookings;
        document.getElementById('fleetUtilization').textContent = `${data.fleetUtilization}%`;
        document.getElementById('avgBookingValue').textContent = `$${data.avgBookingValue}`;
        document.getElementById('profitMargin').textContent = `${data.profitMargin}%`;
        document.getElementById('overdueReturns').textContent = data.overdueReturns;
        
        document.getElementById('revenueTrend').textContent = `+${data.trends.revenue}%`;
        document.getElementById('bookingsTrend').textContent = `+${data.trends.bookings}%`;
        document.getElementById('utilizationTrend').textContent = `+${data.trends.utilization}%`;
        document.getElementById('avgValueTrend').textContent = `+$${data.trends.avgValue}`;
        document.getElementById('marginTrend').textContent = `+${data.trends.margin}%`;
        document.getElementById('overdueTrend').textContent = `${data.trends.overdue}`;
      }

      function initializeFinancialOverviewCharts() {
        // Revenue Distribution Chart
        if (financialCharts.quickRevenue) {
          financialCharts.quickRevenue.destroy();
        }
        
        const revenueCtx = document.getElementById('quickRevenueChart').getContext('2d');
        financialCharts.quickRevenue = new Chart(revenueCtx, {
          type: 'doughnut',
          data: {
            labels: financialData.charts.revenueDistribution.labels,
            datasets: [{
              data: financialData.charts.revenueDistribution.data,
              backgroundColor: financialData.charts.revenueDistribution.colors,
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 10,
                  font: {
                    size: 11
                  }
                }
              }
            }
          }
        });

        // Fleet Performance Chart
        if (financialCharts.quickFleet) {
          financialCharts.quickFleet.destroy();
        }
        
        const fleetCtx = document.getElementById('quickFleetChart').getContext('2d');
        financialCharts.quickFleet = new Chart(fleetCtx, {
          type: 'doughnut',
          data: {
            labels: financialData.charts.fleetPerformance.labels,
            datasets: [{
              data: financialData.charts.fleetPerformance.data,
              backgroundColor: financialData.charts.fleetPerformance.colors,
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 10,
                  font: {
                    size: 11
                  }
                }
              }
            }
          }
        });

        // Booking Trends Chart
        if (financialCharts.quickBooking) {
          financialCharts.quickBooking.destroy();
        }
        
        const bookingCtx = document.getElementById('quickBookingChart').getContext('2d');
        financialCharts.quickBooking = new Chart(bookingCtx, {
          type: 'line',
          data: {
            labels: financialData.charts.bookingTrends.labels,
            datasets: [{
              label: 'Bookings',
              data: financialData.charts.bookingTrends.data,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }

      function updateFinancialData() {
        // Simulate financial data updates
        const variations = {
          revenue: (Math.random() - 0.5) * 1000,
          bookings: Math.floor((Math.random() - 0.5) * 20),
          utilization: (Math.random() - 0.5) * 5
        };

        financialData.overview.todayRevenue += variations.revenue;
        financialData.overview.todayBookings += variations.bookings;
        financialData.overview.fleetUtilization += variations.utilization;

        if (currentFinancialView === 'overview') {
          populateFinancialOverview();
          initializeFinancialOverviewCharts();
        }
        
        showNotification('Financial data updated', 'info');
      }


      // === ENHANCED RENTAL COMPANY OPERATIONS ===

      // Booking Operations
      function quickNewBooking() {
        showNotification('🚗 Opening quick booking form...', 'info');
        
        // Simulate booking form with multiple steps
        setTimeout(() => {
          const customerName = prompt('Enter customer name:', '');
          if (!customerName) return;
          
          const vehicleType = prompt('Select vehicle type:\n1. Economy\n2. Compact\n3. SUV\n4. Luxury\n\nEnter choice (1-4):', '1');
          const vehicleTypes = {'1': 'Economy', '2': 'Compact', '3': 'SUV', '4': 'Luxury'};
          const selectedType = vehicleTypes[vehicleType] || 'Economy';
          
          const startDate = prompt('Enter start date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
          const endDate = prompt('Enter end date (YYYY-MM-DD):', new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0]);
          
          if (startDate && endDate) {
            const bookingId = 'BK-' + Date.now().toString().slice(-6);
            showNotification(`✅ Booking ${bookingId} created for ${customerName}`, 'success');
            
            setTimeout(() => {
              showNotification(`🚗 ${selectedType} vehicle reserved from ${startDate} to ${endDate}`, 'info');
            }, 1000);
            
            setTimeout(() => {
              showNotification(`📧 Confirmation email sent to customer`, 'success');
            }, 2000);
          }
        }, 500);
      }

      function walkInCustomer() {
        showNotification('👤 Processing walk-in customer...', 'info');
        
        setTimeout(() => {
          const hasLicense = confirm('Does customer have a valid driver\'s license?');
          if (!hasLicense) {
            showNotification('❌ Cannot process rental without valid license', 'danger');
            return;
          }
          
          const hasCredit = confirm('Does customer have a valid credit card?');
          if (!hasCredit) {
            showNotification('❌ Cannot process rental without valid payment method', 'danger');
            return;
          }
          
          const customerName = prompt('Enter customer name:', '');
          if (customerName) {
            const customerId = 'CUST-' + Date.now().toString().slice(-4);
            showNotification(`✅ Walk-in customer ${customerName} registered as ${customerId}`, 'success');
            
            setTimeout(() => {
              showNotification('🚗 Available vehicles: 15 Economy, 8 Compact, 5 SUV, 2 Luxury', 'info');
            }, 1000);
          }
        }, 500);
      }

      function modifyBooking() {
        const bookingId = prompt('Enter Booking ID to modify:', 'BK-2024-');
        if (bookingId) {
          showNotification(`📝 Loading booking ${bookingId}...`, 'info');
          
          setTimeout(() => {
            const action = prompt('What would you like to modify?\n1. Dates\n2. Vehicle type\n3. Customer details\n4. Add extras\n\nEnter choice (1-4):', '1');
            const actions = {
              '1': 'Dates modified - new rate calculated',
              '2': 'Vehicle type upgraded - price difference applied',
              '3': 'Customer details updated',
              '4': 'GPS and insurance added'
            };
            
            const result = actions[action] || 'Booking updated';
            showNotification(`✅ ${result} for booking ${bookingId}`, 'success');
            
            setTimeout(() => {
              showNotification('📧 Updated confirmation sent to customer', 'info');
            }, 1000);
          }, 1000);
        }
      }

      function cancelBooking() {
        const bookingId = prompt('Enter Booking ID to cancel:', 'BK-2024-');
        if (bookingId) {
          showNotification(`📋 Checking cancellation policy for ${bookingId}...`, 'info');
          
          setTimeout(() => {
            const reason = prompt('Cancellation reason:\n1. Customer request\n2. Vehicle unavailable\n3. Weather conditions\n4. Other\n\nEnter choice (1-4):', '1');
            
            if (confirm(`Cancel booking ${bookingId}?\n\n• Refund will be processed\n• Vehicle will be released\n• Customer will be notified\n\nThis action cannot be undone.`)) {
              showNotification(`❌ Booking ${bookingId} cancelled successfully`, 'warning');
              
              setTimeout(() => {
                showNotification('💰 Refund initiated - will appear in 3-5 business days', 'info');
              }, 1000);
              
              setTimeout(() => {
                showNotification('🚗 Vehicle released back to available inventory', 'success');
              }, 2000);
            }
          }, 1000);
        }
      }

      // Vehicle Operations
      function quickCheckOut() {
        const customerId = prompt('Enter Customer ID or Name:', '');
        if (customerId) {
          showNotification(`🔍 Looking up customer ${customerId}...`, 'info');
          
          setTimeout(() => {
            const hasBooking = confirm(`Customer found: ${customerId}\nActive booking: BK-${Date.now().toString().slice(-6)}\n\nProceed with check-out?`);
            
            if (hasBooking) {
              showNotification('📋 Starting vehicle inspection checklist...', 'info');
              
              setTimeout(() => {
                const fuelLevel = prompt('Current fuel level (%):', '100');
                const mileage = prompt('Current mileage:', '15234');
                const condition = confirm('Vehicle in good condition? (No visible damage)');
                
                if (condition) {
                  const vehicleId = 'VH-' + Math.floor(Math.random() * 1000);
                  showNotification(`🔑 Vehicle ${vehicleId} checked out successfully`, 'success');
                  showNotification(`⛽ Fuel: ${fuelLevel}% | 🛣️ Mileage: ${mileage}`, 'info');
                  
                  setTimeout(() => {
                    showNotification('📱 SMS sent to customer with vehicle location and keys', 'success');
                  }, 1000);
                } else {
                  showNotification('⚠️ Vehicle inspection failed - maintenance required', 'warning');
                }
              }, 1500);
            }
          }, 1000);
        }
      }

      function quickCheckIn() {
        const vehicleId = prompt('Enter Vehicle ID or License Plate:', 'ABC-');
        if (vehicleId) {
          showNotification(`🔍 Locating vehicle ${vehicleId}...`, 'info');
          
          setTimeout(() => {
            showNotification('📋 Starting return inspection...', 'info');
            
            setTimeout(() => {
              const fuelLevel = prompt('Return fuel level (%):', '75');
              const mileage = prompt('Return mileage:', '15456');
              const damages = confirm('Any new damages or issues found?');
              
              if (!damages) {
                const extraCharges = Math.random() > 0.7 ? Math.floor(Math.random() * 50) + 25 : 0;
                showNotification(`✅ Vehicle ${vehicleId} checked in successfully`, 'success');
                
                if (extraCharges > 0) {
                  showNotification(`💰 Additional charges: $${extraCharges} (fuel, cleaning)`, 'warning');
                } else {
                  showNotification('💚 No additional charges - thank you!', 'success');
                }
                
                setTimeout(() => {
                  showNotification('🧽 Vehicle scheduled for cleaning and maintenance check', 'info');
                }, 1000);
              } else {
                showNotification('📸 Damage photos required - initiating damage assessment', 'warning');
                setTimeout(() => {
                  const damageAmount = prompt('Estimated damage cost:', '$150');
                  if (damageAmount) {
                    showNotification(`💸 Damage charge: ${damageAmount} - insurance claim initiated`, 'danger');
                  }
                }, 1000);
              }
            }, 1500);
          }, 1000);
        }
      }

      function vehicleInspection() {
        const vehicleId = prompt('Enter Vehicle ID for inspection:', 'ABC-');
        if (vehicleId) {
          showNotification(`🔍 Starting comprehensive inspection for ${vehicleId}...`, 'info');
          
          const inspectionItems = [
            'Exterior condition',
            'Interior cleanliness', 
            'Engine performance',
            'Brake system',
            'Tire condition',
            'Lights and signals',
            'Fluid levels',
            'Safety equipment'
          ];
          
          let currentItem = 0;
          const inspectionInterval = setInterval(() => {
            if (currentItem < inspectionItems.length) {
              showNotification(`✓ Checking: ${inspectionItems[currentItem]}`, 'info');
              currentItem++;
            } else {
              clearInterval(inspectionInterval);
              const passed = Math.random() > 0.2;
              if (passed) {
                showNotification(`✅ Vehicle ${vehicleId} passed inspection - ready for rental`, 'success');
              } else {
                showNotification(`⚠️ Vehicle ${vehicleId} requires maintenance before next rental`, 'warning');
              }
            }
          }, 800);
        }
      }

      function reportDamage() {
        const vehicleId = prompt('Enter Vehicle ID with damage:', 'ABC-');
        if (vehicleId) {
          showNotification(`📸 Creating damage report for ${vehicleId}...`, 'warning');
          
          setTimeout(() => {
            const damageType = prompt('Damage type:\n1. Scratches\n2. Dent\n3. Broken glass\n4. Interior damage\n5. Mechanical issue\n\nEnter choice (1-5):', '1');
            const damageTypes = {'1': 'Scratches', '2': 'Dent', '3': 'Broken glass', '4': 'Interior damage', '5': 'Mechanical issue'};
            const selectedDamage = damageTypes[damageType] || 'Unspecified damage';
            
            const severity = prompt('Severity level:\n1. Minor\n2. Moderate\n3. Major\n\nEnter choice (1-3):', '2');
            const severityLevels = {'1': 'Minor', '2': 'Moderate', '3': 'Major'};
            const selectedSeverity = severityLevels[severity] || 'Moderate';
            
            const reportId = 'DMG-' + Date.now().toString().slice(-6);
            showNotification(`📋 Damage report ${reportId} created: ${selectedDamage} (${selectedSeverity})`, 'warning');
            
            setTimeout(() => {
              showNotification('📧 Insurance company notified automatically', 'info');
            }, 1000);
            
            setTimeout(() => {
              showNotification('🔧 Vehicle marked as out-of-service pending repairs', 'danger');
            }, 2000);
          }, 1000);
        }
      }

      // Payment Operations
      function processPayment() {
        const amount = prompt('Enter payment amount:', '$');
        if (amount) {
          const cleanAmount = amount.replace('$', '');
          if (isNaN(cleanAmount)) {
            showNotification('❌ Invalid amount entered', 'danger');
            return;
          }
          
          showNotification(`💳 Processing payment of $${cleanAmount}...`, 'info');
          
          setTimeout(() => {
            const paymentMethod = prompt('Payment method:\n1. Credit Card\n2. Debit Card\n3. Cash\n4. Bank Transfer\n\nEnter choice (1-4):', '1');
            const methods = {'1': 'Credit Card', '2': 'Debit Card', '3': 'Cash', '4': 'Bank Transfer'};
            const selectedMethod = methods[paymentMethod] || 'Credit Card';
            
            // Simulate payment processing
            setTimeout(() => {
              const success = Math.random() > 0.1; // 90% success rate
              if (success) {
                const transactionId = 'TXN-' + Date.now().toString().slice(-8);
                showNotification(`✅ Payment of $${cleanAmount} processed successfully`, 'success');
                showNotification(`📄 Transaction ID: ${transactionId} (${selectedMethod})`, 'info');
                
                setTimeout(() => {
                  showNotification('📧 Receipt sent to customer email', 'info');
                }, 1000);
              } else {
                showNotification('❌ Payment declined - please try another payment method', 'danger');
              }
            }, 2000);
          }, 1000);
        }
      }

      function adjustCharges() {
        const bookingId = prompt('Enter Booking ID for charge adjustment:', 'BK-2024-');
        if (bookingId) {
          showNotification(`💰 Loading charges for booking ${bookingId}...`, 'info');
          
          setTimeout(() => {
            const currentTotal = Math.floor(Math.random() * 500) + 100;
            showNotification(`Current total: $${currentTotal}`, 'info');
            
            const adjustment = prompt(`Current charges: $${currentTotal}\n\nAdjustment options:\n1. Add late fee\n2. Remove cleaning fee\n3. Apply discount\n4. Add damage charge\n5. Custom adjustment\n\nEnter choice (1-5):`, '3');
            
            const adjustments = {
              '1': { amount: 50, description: 'Late return fee added' },
              '2': { amount: -25, description: 'Cleaning fee removed' },
              '3': { amount: -75, description: '15% loyalty discount applied' },
              '4': { amount: 150, description: 'Minor damage charge added' },
              '5': { amount: parseInt(prompt('Enter adjustment amount (+ or -):', '0')), description: 'Custom adjustment applied' }
            };
            
            const selectedAdjustment = adjustments[adjustment] || adjustments['3'];
            const newTotal = currentTotal + selectedAdjustment.amount;
            
            showNotification(`✅ ${selectedAdjustment.description}`, 'success');
            showNotification(`💰 New total: $${newTotal} (${selectedAdjustment.amount >= 0 ? '+' : ''}$${selectedAdjustment.amount})`, 'warning');
          }, 1000);
        }
      }

      function generateInvoice() {
        const customerId = prompt('Enter Customer ID for invoice:', '');
        if (customerId) {
          showNotification(`📄 Generating invoice for customer ${customerId}...`, 'info');
          
          setTimeout(() => {
            const invoiceId = 'INV-' + Date.now().toString().slice(-6);
            const amount = Math.floor(Math.random() * 800) + 200;
            
            showNotification(`📋 Invoice ${invoiceId} generated - Amount: $${amount}`, 'success');
            
            setTimeout(() => {
              const sendMethod = confirm('Send invoice via email? (Cancel for print)');
              if (sendMethod) {
                showNotification('📧 Invoice sent to customer email address', 'success');
              } else {
                showNotification('🖨️ Invoice queued for printing', 'info');
              }
            }, 1000);
            
            setTimeout(() => {
              showNotification('💾 Invoice saved to customer account', 'info');
            }, 2000);
          }, 1500);
        }
      }

      // Emergency Operations  
      function emergencyResponse() {
        if (confirm('Activate emergency response protocol?\n\nThis will:\n• Alert emergency contacts\n• Dispatch roadside assistance\n• Create incident report\n• Notify insurance if needed')) {
          showNotification('🚨 Emergency response protocol activated!', 'danger');
          
          setTimeout(() => {
            showNotification('📞 Emergency contacts notified', 'warning');
          }, 1000);
          
          setTimeout(() => {
            showNotification('🚗 Roadside assistance dispatched', 'info');
          }, 2000);
          
          setTimeout(() => {
            const incidentId = 'INC-' + Date.now().toString().slice(-6);
            showNotification(`📋 Incident report ${incidentId} created`, 'warning');
          }, 3000);
          
          setTimeout(() => {
            showNotification('🛡️ Insurance company automatically notified', 'info');
          }, 4000);
        }
      }

      function vehicleBreakdown() {
        const vehicleId = prompt('Enter Vehicle ID with breakdown:', 'ABC-');
        if (vehicleId) {
          showNotification(`🔧 Initiating breakdown protocol for ${vehicleId}...`, 'danger');
          
          setTimeout(() => {
            const location = prompt('Current vehicle location:', 'Highway 101, Mile Marker 45');
            if (location) {
              showNotification(`📍 Location logged: ${location}`, 'info');
              
              setTimeout(() => {
                showNotification('🚗 Tow truck dispatched - ETA 30 minutes', 'warning');
              }, 1000);
              
              setTimeout(() => {
                showNotification('🏨 Customer offered alternative transportation', 'info');
              }, 2000);
              
              setTimeout(() => {
                showNotification('📋 Breakdown report filed with maintenance team', 'warning');
              }, 3000);
            }
          }, 1000);
        }
      }

      function overdueAlert() {
        showNotification('⏰ Scanning for overdue rentals...', 'info');
        
        setTimeout(() => {
          const overdueCount = Math.floor(Math.random() * 8) + 2;
          showNotification(`📋 Found ${overdueCount} overdue rentals`, 'warning');
          
          setTimeout(() => {
            showNotification(`📧 Automated reminder emails sent to ${overdueCount} customers`, 'info');
          }, 1000);
          
          setTimeout(() => {
            showNotification(`📱 SMS alerts sent for rentals >24hrs overdue`, 'warning');
          }, 2000);
          
          setTimeout(() => {
            const escalated = Math.floor(overdueCount * 0.3);
            if (escalated > 0) {
              showNotification(`🚨 ${escalated} cases escalated to collections`, 'danger');
            }
          }, 3000);
        }, 1500);
      }

      function incidentReport() {
        showNotification('📋 Opening incident report form...', 'info');
        
        setTimeout(() => {
          const incidentType = prompt('Incident type:\n1. Vehicle accident\n2. Customer complaint\n3. Equipment failure\n4. Security issue\n5. Other\n\nEnter choice (1-5):', '1');
          const types = {'1': 'Vehicle accident', '2': 'Customer complaint', '3': 'Equipment failure', '4': 'Security issue', '5': 'Other'};
          const selectedType = types[incidentType] || 'Other';
          
          const severity = prompt('Severity:\n1. Low\n2. Medium\n3. High\n4. Critical\n\nEnter choice (1-4):', '2');
          const severities = {'1': 'Low', '2': 'Medium', '3': 'High', '4': 'Critical'};
          const selectedSeverity = severities[severity] || 'Medium';
          
          const reportId = 'RPT-' + Date.now().toString().slice(-6);
          showNotification(`📋 Incident report ${reportId} created`, 'success');
          showNotification(`Type: ${selectedType} | Severity: ${selectedSeverity}`, 'info');
          
          setTimeout(() => {
            if (selectedSeverity === 'High' || selectedSeverity === 'Critical') {
              showNotification('🚨 Management automatically notified', 'warning');
            }
          }, 1000);
          
          setTimeout(() => {
            showNotification('📧 Report saved and distributed to relevant departments', 'info');
          }, 2000);
        }, 1000);
      }

      // Administrative Operations
      function endOfDayClose() {
        if (confirm('Perform end of day close?\n\nThis will:\n• Process all pending transactions\n• Generate daily reports\n• Update financial records\n• Backup data')) {
          showNotification('🏁 Starting end of day close process...', 'warning');
          
          const steps = [
            'Processing pending transactions',
            'Calculating daily revenue',
            'Updating vehicle status',
            'Generating financial reports',
            'Backing up database',
            'Sending reports to management'
          ];
          
          let currentStep = 0;
          const closeInterval = setInterval(() => {
            if (currentStep < steps.length) {
              showNotification(`⏳ ${steps[currentStep]}...`, 'info');
              currentStep++;
            } else {
              clearInterval(closeInterval);
              const dailyRevenue = Math.floor(Math.random() * 50000) + 10000;
              showNotification(`✅ End of day close completed successfully`, 'success');
              showNotification(`💰 Daily revenue: $${dailyRevenue.toLocaleString()}`, 'success');
            }
          }, 2000);
        }
      }

      function dailyReport() {
        showNotification('📊 Generating comprehensive daily operations report...', 'info');
        
        const reportSections = [
          'Fleet utilization statistics',
          'Revenue breakdown by category',
          'Customer satisfaction metrics',
          'Maintenance and service records',
          'Staff performance summary'
        ];
        
        let currentSection = 0;
        const reportInterval = setInterval(() => {
          if (currentSection < reportSections.length) {
            showNotification(`📋 Compiling: ${reportSections[currentSection]}`, 'info');
            currentSection++;
          } else {
            clearInterval(reportInterval);
            const reportId = 'RPT-DAILY-' + new Date().toISOString().split('T')[0];
            showNotification(`✅ Daily report ${reportId} generated successfully`, 'success');
            
            setTimeout(() => {
              showNotification('📧 Report emailed to management team', 'info');
            }, 1000);
            
            setTimeout(() => {
              showNotification('💾 Report archived in document management system', 'info');
            }, 2000);
          }
        }, 1500);
      }

      function systemLockdown() {
        if (confirm('Initiate system lockdown?\n\nThis will:\n• Disable new bookings\n• Alert all staff\n• Secure all systems\n• Log security event')) {
          showNotification('🔒 System lockdown initiated!', 'danger');
          
          setTimeout(() => {
            showNotification('🚫 New bookings disabled system-wide', 'warning');
          }, 1000);
          
          setTimeout(() => {
            showNotification('📢 All staff notified of security lockdown', 'warning');
          }, 2000);
          
          setTimeout(() => {
            showNotification('🛡️ All systems secured - access restricted to admin only', 'danger');
          }, 3000);
          
          setTimeout(() => {
            const eventId = 'SEC-' + Date.now().toString().slice(-8);
            showNotification(`📋 Security event ${eventId} logged`, 'warning');
          }, 4000);
        }
      }

      // === ADDITIONAL QUICK ACTIONS FOR TOP NAVIGATION ===
      
      function addNewVehicleQuick() {
        const vehicleData = {
          make: prompt('Enter vehicle make (e.g., Toyota, Honda):', ''),
          model: prompt('Enter vehicle model (e.g., Camry, Civic):', ''),
          year: prompt('Enter vehicle year:', new Date().getFullYear()),
          licensePlate: prompt('Enter license plate:', ''),
          vin: prompt('Enter VIN (last 4 digits):', ''),
          category: prompt('Enter category (Economy, Compact, SUV, Luxury):', 'Economy')
        };
        
        if (vehicleData.make && vehicleData.model && vehicleData.licensePlate) {
          showNotification(`🚗 New ${vehicleData.year} ${vehicleData.make} ${vehicleData.model} (${vehicleData.licensePlate}) added to fleet!`, 'success');
          
          // Simulate adding to system
          setTimeout(() => {
            showNotification(`✅ Vehicle registration completed. Assigning to ${vehicleData.category} category...`, 'info');
          }, 1500);
          
          setTimeout(() => {
            showNotification(`🎯 Vehicle is now available for booking!`, 'success');
          }, 3000);
        } else {
          showNotification('❌ Vehicle registration cancelled - missing required information', 'warning');
        }
      }

      function addNewCustomerQuick() {
        const customerData = {
          firstName: prompt('Enter customer first name:', ''),
          lastName: prompt('Enter customer last name:', ''),
          phone: prompt('Enter phone number:', ''),
          email: prompt('Enter email address:', ''),
          licenseNumber: prompt('Enter driver license number:', ''),
          address: prompt('Enter address (optional):', '')
        };
        
        if (customerData.firstName && customerData.lastName && customerData.phone && customerData.licenseNumber) {
          const customerId = 'CUST-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
          
          showNotification(`👤 Creating customer profile for ${customerData.firstName} ${customerData.lastName}...`, 'info');
          
          setTimeout(() => {
            showNotification(`✅ Customer ${customerId} created successfully!`, 'success');
          }, 1500);
          
          setTimeout(() => {
            showNotification(`📧 Welcome email sent to ${customerData.email}`, 'info');
          }, 2500);
          
          setTimeout(() => {
            showNotification(`🎯 Customer is ready for bookings!`, 'success');
          }, 3500);
        } else {
          showNotification('❌ Customer registration cancelled - missing required information', 'warning');
        }
      }

      function addNewStaffQuick() {
        const staffData = {
          firstName: prompt('Enter staff first name:', ''),
          lastName: prompt('Enter staff last name:', ''),
          position: prompt('Enter position (Manager, Agent, Mechanic, etc.):', 'Agent'),
          branch: prompt('Enter branch/location:', 'Main Branch'),
          phone: prompt('Enter phone number:', ''),
          email: prompt('Enter email address:', ''),
          startDate: prompt('Enter start date (YYYY-MM-DD):', new Date().toISOString().split('T')[0])
        };
        
        if (staffData.firstName && staffData.lastName && staffData.position && staffData.email) {
          const employeeId = 'EMP-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
          
          showNotification(`👨‍💼 Creating staff profile for ${staffData.firstName} ${staffData.lastName}...`, 'info');
          
          setTimeout(() => {
            showNotification(`✅ Employee ${employeeId} added to ${staffData.branch}!`, 'success');
          }, 1500);
          
          setTimeout(() => {
            showNotification(`🔑 Access credentials generated and sent to ${staffData.email}`, 'info');
          }, 2500);
          
          setTimeout(() => {
            showNotification(`📚 Training materials scheduled for ${staffData.position} role`, 'warning');
          }, 3500);
          
          setTimeout(() => {
            showNotification(`🎯 Staff member is ready to start on ${staffData.startDate}!`, 'success');
          }, 4500);
        } else {
          showNotification('❌ Staff registration cancelled - missing required information', 'warning');
        }
      }

      // === UNIFIED FLEET MANAGEMENT WIDGET ===
      let fleetManagementData = {
        status: {
          available: 120,
          rented: 86,
          maintenance: 11,
          alerts: 16
        },
        performance: {
          utilization: 73.5,
          efficiency: 92.3,
          maintenance_compliance: 87.5,
          safety_score: 94.2
        },
        trends: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          utilization: [68, 72, 75, 78, 82, 85, 73],
          revenue: [7200, 7800, 8100, 8450, 8900, 9200, 8450]
        }
      };

      let currentFleetView = 'map';
      let fleetManagementCharts = {};

      function initializeFleetManagementWidget() {
        populateFleetStatus();
        initializeFleetStatusChart();
        
        // Initialize with map view
        switchFleetView('map');
        
        // Update fleet data every 3 minutes
        setInterval(() => {
          updateFleetData();
        }, 180000);
      }

      function switchFleetView(view) {
        currentFleetView = view;
        
        // Update button states
        document.querySelectorAll('[id^="fleet"][id$="ViewBtn"]').forEach(btn => btn.classList.remove('active'));
        document.getElementById('fleet' + view.charAt(0).toUpperCase() + view.slice(1) + 'ViewBtn').classList.add('active');
        
        // Hide all views
        document.getElementById('fleetMapView').style.display = 'none';
        document.getElementById('fleetStatusView').style.display = 'none';
        document.getElementById('fleetAnalyticsView').style.display = 'none';
        
        // Show selected view
        document.getElementById('fleet' + view.charAt(0).toUpperCase() + view.slice(1) + 'View').style.display = 'block';
        
        if (view === 'status') {
          initializeFleetDistributionChart();
          populateVehicleStatusList();
        } else if (view === 'analytics') {
          initializeFleetPerformanceTrendsChart();
        }
        
        showNotification(`Switched to fleet ${view} view`, 'info');
      }

      function populateFleetStatus() {
        const data = fleetManagementData.status;
        
        document.getElementById('fleetAvailableCount').textContent = data.available;
        document.getElementById('fleetRentedCount').textContent = data.rented;
        document.getElementById('fleetMaintenanceCount').textContent = data.maintenance;
        document.getElementById('fleetAlertCount').textContent = data.alerts;
        
        // Update utilization rate
        const total = data.available + data.rented + data.maintenance;
        const utilizationRate = ((data.rented / total) * 100).toFixed(1);
        document.getElementById('fleetUtilizationRate').textContent = `${utilizationRate}%`;
      }

      function initializeFleetStatusChart() {
        if (fleetManagementCharts.status) {
          fleetManagementCharts.status.destroy();
        }
        
        const ctx = document.getElementById('fleetStatusChart').getContext('2d');
        fleetManagementCharts.status = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Available', 'Rented', 'Maintenance', 'Alerts'],
            datasets: [{
              data: [
                fleetManagementData.status.available,
                fleetManagementData.status.rented,
                fleetManagementData.status.maintenance,
                fleetManagementData.status.alerts
              ],
              backgroundColor: ['#28a745', '#007bff', '#ffc107', '#dc3545'],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }

      function populateVehicleStatusList() {
        const vehicles = [
          { id: 'ABC123', model: 'Toyota Camry', status: 'available', location: 'Manhattan Branch', battery: 85 },
          { id: 'XYZ789', model: 'Honda CR-V', status: 'rented', location: 'Brooklyn', battery: 67 },
          { id: 'DEF456', model: 'Ford Focus', status: 'maintenance', location: 'Queens Branch', battery: 45 },
          { id: 'GHI345', model: 'BMW X3', status: 'available', location: 'Bronx Branch', battery: 92 },
          { id: 'JKL012', model: 'Nissan Altima', status: 'rented', location: 'Staten Island', battery: 78 }
        ];

        const container = document.getElementById('vehicleStatusList');
        container.innerHTML = vehicles.map(vehicle => `
          <div class="vehicle-status-item mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold small">${vehicle.model} - ${vehicle.id}</div>
                <small class="text-muted">${vehicle.location}</small>
              </div>
              <div class="text-end">
                <span class="badge bg-${getVehicleStatusColor(vehicle.status)}">${vehicle.status.toUpperCase()}</span>
                <div class="mt-1">
                  <small class="text-muted">Battery: ${vehicle.battery}%</small>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      function getVehicleStatusColor(status) {
        const colors = {
          available: 'success',
          rented: 'primary',
          maintenance: 'warning',
          alert: 'danger'
        };
        return colors[status] || 'secondary';
      }

      function updateFleetData() {
        // Simulate fleet data updates
        const variations = {
          available: Math.floor((Math.random() - 0.5) * 10),
          rented: Math.floor((Math.random() - 0.5) * 8),
          maintenance: Math.floor((Math.random() - 0.5) * 4)
        };

        fleetManagementData.status.available += variations.available;
        fleetManagementData.status.rented += variations.rented;
        fleetManagementData.status.maintenance += variations.maintenance;

        // Ensure realistic bounds
        fleetManagementData.status.available = Math.max(100, Math.min(130, fleetManagementData.status.available));
        fleetManagementData.status.rented = Math.max(70, Math.min(100, fleetManagementData.status.rented));
        fleetManagementData.status.maintenance = Math.max(5, Math.min(20, fleetManagementData.status.maintenance));

        populateFleetStatus();
        initializeFleetStatusChart();
        
        if (currentFleetView === 'status') {
          populateVehicleStatusList();
        }
        
        showNotification('Fleet data updated', 'info');
      }

      // === ENHANCED CUSTOMER INSIGHTS WIDGET ===
      let customerInsightsData = {
        overview: {
          avgRating: 4.6,
          repeatRate: 73,
          avgBookingDuration: 4.2,
          avgSpend: 247,
          trends: {
            ratingChange: 0.2,
            repeatChange: 5,
            durationChange: 0.3,
            spendChange: 23
          },
          satisfactionTrends: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            data: [4.2, 4.3, 4.4, 4.5, 4.6, 4.6]
          },
          revenueSegments: {
            labels: ['Corporate', 'Individual', 'Tourist'],
            data: [45, 38, 17],
            colors: ['#007bff', '#28a745', '#17a2b8']
          }
        },
        segments: [
          {
            name: 'VIP Corporate',
            count: 156,
            percentage: 12,
            avgSpend: 850,
            repeatRate: 95,
            satisfaction: 4.8,
            growth: 15,
            color: 'warning',
            characteristics: ['High volume bookings', 'Long-term contracts', 'Premium vehicles']
          },
          {
            name: 'Frequent Business',
            count: 432,
            percentage: 28,
            avgSpend: 320,
            repeatRate: 82,
            satisfaction: 4.6,
            growth: 8,
            color: 'primary',
            characteristics: ['Regular weekly bookings', 'Airport transfers', 'Expense accounts']
          },
          {
            name: 'Weekend Warriors',
            count: 298,
            percentage: 23,
            avgSpend: 180,
            repeatRate: 65,
            satisfaction: 4.5,
            growth: 12,
            color: 'success',
            characteristics: ['Weekend bookings', 'Leisure travel', 'Price sensitive']
          },
          {
            name: 'Occasional Users',
            count: 387,
            percentage: 25,
            avgSpend: 95,
            repeatRate: 35,
            satisfaction: 4.2,
            growth: -3,
            color: 'info',
            characteristics: ['Infrequent bookings', 'Special occasions', 'New customers']
          },
          {
            name: 'Tourist Visitors',
            count: 189,
            percentage: 12,
            avgSpend: 220,
            repeatRate: 15,
            satisfaction: 4.4,
            growth: 22,
            color: 'secondary',
            characteristics: ['Vacation bookings', 'Multi-day rentals', 'Seasonal patterns']
          }
        ],
        topCustomers: [
          {
            name: 'Acme Corporation',
            type: 'Corporate',
            totalSpend: 15420,
            bookings: 48,
            rating: 4.9,
            lastBooking: '2 days ago',
            tier: 'VIP'
          },
          {
            name: 'John Smith',
            type: 'Individual',
            totalSpend: 3240,
            bookings: 12,
            rating: 4.8,
            lastBooking: '1 week ago',
            tier: 'Gold'
          },
          {
            name: 'TechStart Inc.',
            type: 'Corporate',
            totalSpend: 8950,
            bookings: 28,
            rating: 4.7,
            lastBooking: '3 days ago',
            tier: 'VIP'
          },
          {
            name: 'Sarah Johnson',
            type: 'Individual',
            totalSpend: 2180,
            bookings: 8,
            rating: 4.6,
            lastBooking: '5 days ago',
            tier: 'Silver'
          },
          {
            name: 'Global Consulting',
            type: 'Corporate',
            totalSpend: 12300,
            bookings: 35,
            rating: 4.8,
            lastBooking: '1 day ago',
            tier: 'VIP'
          }
        ],
        alerts: [
          {
            type: 'churn_risk',
            severity: 'high',
            message: '3 VIP customers haven\'t booked in 30+ days',
            count: 3,
            action: 'Send retention offer',
            color: 'danger'
          },
          {
            type: 'satisfaction',
            severity: 'warning',
            message: '12 customers gave ratings below 3 stars this week',
            count: 12,
            action: 'Follow up for feedback',
            color: 'warning'
          },
          {
            type: 'opportunity',
            severity: 'info',
            message: '25 customers are eligible for tier upgrade',
            count: 25,
            action: 'Send upgrade invitation',
            color: 'info'
          }
        ],
        recommendations: [
          {
            type: 'retention',
            icon: 'fa-heart',
            message: 'Launch loyalty program for frequent customers',
            impact: 'High',
            effort: 'Medium'
          },
          {
            type: 'upsell',
            icon: 'fa-arrow-up',
            message: 'Offer premium vehicles to high-spend segments',
            impact: 'Medium',
            effort: 'Low'
          },
          {
            type: 'acquisition',
            icon: 'fa-user-plus',
            message: 'Target corporate accounts similar to top performers',
            impact: 'High',
            effort: 'High'
          },
          {
            type: 'experience',
            icon: 'fa-star',
            message: 'Implement personalized booking preferences',
            impact: 'Medium',
            effort: 'Medium'
          }
        ],
        behavior: {
          bookingPatterns: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            corporate: [25, 30, 35, 40, 45, 15, 10],
            individual: [10, 12, 15, 18, 20, 35, 30],
            tourist: [5, 8, 10, 12, 15, 25, 25]
          },
          peakHours: {
            labels: ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'],
            data: [5, 25, 35, 30, 40, 15]
          }
        },
        retention: {
          cohorts: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            retention30: [85, 82, 88, 90, 87, 85],
            retention90: [67, 65, 70, 72, 68, 67],
            retention365: [52, 48, 55, 58, 54, 52]
          }
        }
      };

      let currentCustomerView = 'overview';
      let customerCharts = {};

      function initializeCustomerInsightsWidget() {
        populateCustomerOverview();
        populateTopCustomers();
        populateCustomerRecommendations();
        populateCustomerBookings();
        populateCustomerReservations();
        
        // Initialize with overview
        switchCustomerView('overview');
        
        // Update customer insights every 10 minutes
        setInterval(() => {
          refreshCustomerInsights();
        }, 600000);
      }

      function switchCustomerView(view) {
        currentCustomerView = view;
        
        // Update button states
        document.querySelectorAll('#overviewViewBtn, #segmentsViewBtn, #behaviorViewBtn, #retentionViewBtn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.getElementById(view + 'ViewBtn').classList.add('active');
        
        // Hide all views
        document.getElementById('overviewCustomerView').style.display = 'none';
        document.getElementById('segmentsCustomerView').style.display = 'none';
        document.getElementById('behaviorCustomerView').style.display = 'none';
        document.getElementById('retentionCustomerView').style.display = 'none';
        
        // Show selected view
        document.getElementById(view + 'CustomerView').style.display = 'block';
        
        if (view === 'overview') {
          initializeOverviewCharts();
        } else if (view === 'segments') {
          populateCustomerSegments();
        } else if (view === 'behavior') {
          initializeBehaviorCharts();
        } else if (view === 'retention') {
          initializeRetentionChart();
        }
        
        showNotification(`Switched to ${view} customer view`, 'info');
      }

      function populateCustomerOverview() {
        const data = customerInsightsData.overview;
        
        document.getElementById('avgRating').textContent = data.avgRating;
        document.getElementById('repeatRate').textContent = `${data.repeatRate}%`;
        document.getElementById('avgBookingDuration').textContent = data.avgBookingDuration;
        document.getElementById('avgSpend').textContent = `$${data.avgSpend}`;
        
        document.getElementById('ratingTrend').textContent = `+${data.trends.ratingChange} this month`;
        document.getElementById('repeatTrend').textContent = `+${data.trends.repeatChange}% this month`;
        document.getElementById('durationTrend').textContent = `+${data.trends.durationChange} days`;
        document.getElementById('spendTrend').textContent = `+$${data.trends.spendChange} this month`;
        
        // Generate rating stars
        generateRatingStars(data.avgRating);
      }

      function generateRatingStars(rating) {
        const container = document.getElementById('ratingStars');
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        
        let starsHTML = '';
        for (let i = 0; i < fullStars; i++) {
          starsHTML += '<i class="fas fa-star text-warning"></i>';
        }
        if (hasHalfStar) {
          starsHTML += '<i class="fas fa-star-half-alt text-warning"></i>';
        }
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        for (let i = 0; i < emptyStars; i++) {
          starsHTML += '<i class="far fa-star text-warning"></i>';
        }
        
        container.innerHTML = starsHTML;
      }

      function initializeOverviewCharts() {
        // Satisfaction Trends Chart
        if (customerCharts.satisfaction) {
          customerCharts.satisfaction.destroy();
        }
        
        const satisfactionCtx = document.getElementById('satisfactionTrendsChart').getContext('2d');
        customerCharts.satisfaction = new Chart(satisfactionCtx, {
          type: 'line',
          data: {
            labels: customerInsightsData.overview.satisfactionTrends.labels,
            datasets: [{
              label: 'Average Rating',
              data: customerInsightsData.overview.satisfactionTrends.data,
              borderColor: '#ffc107',
              backgroundColor: 'rgba(255, 193, 7, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: false,
                min: 4.0,
                max: 5.0
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
        
        // Revenue Segment Chart
        if (customerCharts.revenueSegment) {
          customerCharts.revenueSegment.destroy();
        }
        
        const revenueCtx = document.getElementById('revenueSegmentChart').getContext('2d');
        customerCharts.revenueSegment = new Chart(revenueCtx, {
          type: 'doughnut',
          data: {
            labels: customerInsightsData.overview.revenueSegments.labels,
            datasets: [{
              data: customerInsightsData.overview.revenueSegments.data,
              backgroundColor: customerInsightsData.overview.revenueSegments.colors,
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }

      function populateCustomerSegments() {
        const container = document.getElementById('customerSegmentsList');
        container.innerHTML = customerInsightsData.segments.map(segment => `
          <div class="segment-card">
            <div class="row">
              <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0 text-${segment.color}">${segment.name}</h6>
                  <span class="badge bg-${segment.color}">${segment.count} customers</span>
                </div>
                <div class="row mb-3">
                  <div class="col-6 col-md-3">
                    <small class="text-muted">Avg Spend</small>
                    <div class="fw-bold text-success">$${segment.avgSpend}</div>
                  </div>
                  <div class="col-6 col-md-3">
                    <small class="text-muted">Repeat Rate</small>
                    <div class="fw-bold text-primary">${segment.repeatRate}%</div>
                  </div>
                  <div class="col-6 col-md-3">
                    <small class="text-muted">Satisfaction</small>
                    <div class="fw-bold text-warning">${segment.satisfaction}/5</div>
                  </div>
                  <div class="col-6 col-md-3">
                    <small class="text-muted">Growth</small>
                    <div class="fw-bold ${segment.growth > 0 ? 'text-success' : 'text-danger'}">${segment.growth > 0 ? '+' : ''}${segment.growth}%</div>
                  </div>
                </div>
                <div class="characteristics">
                  <small class="text-muted">Key Characteristics:</small>
                  <div class="mt-1">
                    ${segment.characteristics.map(char => `<span class="badge bg-light text-dark me-1">${char}</span>`).join('')}
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <div class="segment-size mb-2">
                    <h4 class="text-${segment.color}">${segment.percentage}%</h4>
                    <small class="text-muted">of customer base</small>
                  </div>
                  <div class="segment-progress">
                    <div class="segment-progress-fill bg-${segment.color}" style="width: ${segment.percentage}%"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      function initializeBehaviorCharts() {
        // Booking Patterns Chart
        if (customerCharts.bookingPatterns) {
          customerCharts.bookingPatterns.destroy();
        }
        
        const patternsCtx = document.getElementById('bookingPatternsChart').getContext('2d');
        customerCharts.bookingPatterns = new Chart(patternsCtx, {
          type: 'bar',
          data: {
            labels: customerInsightsData.behavior.bookingPatterns.labels,
            datasets: [
              {
                label: 'Corporate',
                data: customerInsightsData.behavior.bookingPatterns.corporate,
                backgroundColor: 'rgba(0, 123, 255, 0.8)',
                borderColor: '#007bff',
                borderWidth: 1
              },
              {
                label: 'Individual',
                data: customerInsightsData.behavior.bookingPatterns.individual,
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: '#28a745',
                borderWidth: 1
              },
              {
                label: 'Tourist',
                data: customerInsightsData.behavior.bookingPatterns.tourist,
                backgroundColor: 'rgba(23, 162, 184, 0.8)',
                borderColor: '#17a2b8',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                stacked: true
              },
              y: {
                stacked: true
              }
            },
            plugins: {
              legend: {
                position: 'top'
              }
            }
          }
        });
        
        // Peak Hours Chart
        if (customerCharts.peakHours) {
          customerCharts.peakHours.destroy();
        }
        
        const hoursCtx = document.getElementById('peakHoursChart').getContext('2d');
        customerCharts.peakHours = new Chart(hoursCtx, {
          type: 'radar',
          data: {
            labels: customerInsightsData.behavior.peakHours.labels,
            datasets: [{
              label: 'Booking Volume',
              data: customerInsightsData.behavior.peakHours.data,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.2)',
              pointBackgroundColor: '#007bff',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#007bff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
              line: {
                borderWidth: 3
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }

      function initializeRetentionChart() {
        if (customerCharts.retention) {
          customerCharts.retention.destroy();
        }
        
        const retentionCtx = document.getElementById('retentionCohortChart').getContext('2d');
        customerCharts.retention = new Chart(retentionCtx, {
          type: 'line',
          data: {
            labels: customerInsightsData.retention.cohorts.labels,
            datasets: [
              {
                label: '30-Day Retention',
                data: customerInsightsData.retention.cohorts.retention30,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4
              },
              {
                label: '90-Day Retention',
                data: customerInsightsData.retention.cohorts.retention90,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4
              },
              {
                label: '1-Year Retention',
                data: customerInsightsData.retention.cohorts.retention365,
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: false,
                min: 40,
                max: 100,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            },
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }

      function populateTopCustomers() {
        // Populate full list (if container exists)
        const container = document.getElementById('topCustomersList');
        if (container) {
          container.innerHTML = customerInsightsData.topCustomers.map(customer => `
            <div class="top-customer-item ${customer.tier === 'VIP' ? 'vip' : ''}">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-bold">${customer.name}</div>
                  <small class="text-muted">${customer.type} • ${customer.bookings} bookings</small>
                </div>
                <div class="text-end">
                  <div class="fw-bold text-success">$${customer.totalSpend.toLocaleString()}</div>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-star text-warning me-1"></i>
                    <small>${customer.rating}</small>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        }

        // Populate compact list
        const compactContainer = document.getElementById('topCustomersListCompact');
        if (compactContainer) {
          compactContainer.innerHTML = customerInsightsData.topCustomers.slice(0, 3).map(customer => `
            <div class="top-customer-item-compact ${customer.tier === 'VIP' ? 'vip' : ''}">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-bold small">${customer.name}</div>
                  <small class="text-muted" style="font-size: 0.7rem;">${customer.type}</small>
                </div>
                <div class="text-end">
                  <div class="fw-bold text-success small">$${(customer.totalSpend/1000).toFixed(1)}K</div>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-star text-warning me-1" style="font-size: 0.7rem;"></i>
                    <small style="font-size: 0.7rem;">${customer.rating}</small>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        }
      }

      // Customer alerts are now handled by the Unified Alert Center
      // This function is kept for backward compatibility but does nothing
      function populateCustomerAlerts() {
        // Customer alerts are now consolidated in the Unified Alert Center
        // No action needed here
        return;
      }

      function populateCustomerRecommendations() {
        const container = document.getElementById('customerRecommendationsList');
        container.innerHTML = customerInsightsData.recommendations.map(rec => `
          <div class="customer-recommendation-item">
            <div class="d-flex align-items-start">
              <i class="fas ${rec.icon} text-success me-2 mt-1"></i>
              <div class="flex-grow-1">
                <small class="fw-bold">${rec.message}</small>
                <div class="mt-1">
                  <span class="badge bg-light text-dark me-1">Impact: ${rec.impact}</span>
                  <span class="badge bg-light text-dark">Effort: ${rec.effort}</span>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      function populateCustomerBookings() {
        const upcomingBookings = [
          {
            id: 'BK001',
            customer: 'John Smith',
            vehicle: 'Toyota Camry - ABC123',
            pickupTime: '09:30 AM',
            date: 'Today',
            status: 'confirmed',
            value: '$85'
          },
          {
            id: 'BK002',
            customer: 'Sarah Johnson',
            vehicle: 'Honda CR-V - XYZ789',
            pickupTime: '11:00 AM',
            date: 'Today',
            status: 'preparing',
            value: '$120'
          },
          {
            id: 'BK003',
            customer: 'Mike Davis',
            vehicle: 'Ford Focus - DEF456',
            pickupTime: '02:15 PM',
            date: 'Tomorrow',
            status: 'confirmed',
            value: '$75'
          },
          {
            id: 'BK004',
            customer: 'Lisa Wong',
            vehicle: 'BMW X3 - GHI345',
            pickupTime: '04:30 PM',
            date: 'Tomorrow',
            status: 'pending',
            value: '$150'
          }
        ];

        const container = document.getElementById('customerUpcomingBookingsList');
        document.getElementById('upcomingBookingsCount').textContent = upcomingBookings.length;
        
        container.innerHTML = upcomingBookings.map(booking => `
          <div class="booking-item-compact mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold small">${booking.customer}</div>
                <small class="text-muted">${booking.vehicle}</small>
              </div>
              <div class="text-end">
                <div class="fw-bold text-success small">${booking.value}</div>
                <small class="text-muted">${booking.pickupTime}</small>
              </div>
            </div>
            <div class="mt-1">
              <span class="badge bg-${getBookingStatusColor(booking.status)} me-1">${booking.status.toUpperCase()}</span>
              <small class="text-muted">${booking.date}</small>
            </div>
          </div>
        `).join('');
      }

      function populateCustomerReservations() {
        const activeReservations = [
          {
            id: 'RES001',
            customer: 'John Smith',
            vehicle: 'Toyota Camry - ABC123',
            status: 'ready',
            pickupTime: '09:30 AM',
            duration: '3 days'
          },
          {
            id: 'RES002',
            customer: 'Sarah Johnson',
            vehicle: 'Honda CR-V - XYZ789',
            status: 'preparing',
            pickupTime: '11:00 AM',
            duration: '1 day'
          },
          {
            id: 'RES003',
            customer: 'Mike Davis',
            vehicle: 'Ford Focus - DEF456',
            status: 'confirmed',
            pickupTime: '02:15 PM',
            duration: '2 days'
          },
          {
            id: 'RES004',
            customer: 'Lisa Wong',
            vehicle: 'Nissan Altima - GHI012',
            status: 'overdue',
            pickupTime: '04:30 PM',
            duration: '1 day (overdue)'
          }
        ];

        const container = document.getElementById('customerActiveReservationsList');
        document.getElementById('activeReservationsCount').textContent = activeReservations.length;
        
        container.innerHTML = activeReservations.map(reservation => `
          <div class="reservation-item-compact mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold small">${reservation.customer}</div>
                <small class="text-muted">${reservation.vehicle}</small>
              </div>
              <div class="text-end">
                <span class="badge bg-${getReservationStatusColor(reservation.status)}">${reservation.status.toUpperCase()}</span>
              </div>
            </div>
            <div class="mt-1">
              <small class="text-muted">
                <i class="fas fa-clock me-1"></i>${reservation.pickupTime} • ${reservation.duration}
              </small>
            </div>
          </div>
        `).join('');
      }

      function getBookingStatusColor(status) {
        const colors = {
          confirmed: 'success',
          preparing: 'warning',
          pending: 'info',
          cancelled: 'danger'
        };
        return colors[status] || 'secondary';
      }

      function getReservationStatusColor(status) {
        const colors = {
          ready: 'success',
          preparing: 'warning',
          confirmed: 'info',
          overdue: 'danger'
        };
        return colors[status] || 'secondary';
      }

      function refreshCustomerInsights() {
        const refreshIcon = document.getElementById('customerRefreshIcon');
        refreshIcon.classList.add('spinning');
        
        setTimeout(() => {
          // Simulate data refresh
          populateCustomerOverview();
          populateTopCustomers();
          populateCustomerRecommendations();
          populateCustomerBookings();
          populateCustomerReservations();
          
          if (currentCustomerView === 'overview') {
            initializeOverviewCharts();
          }
          
          refreshIcon.classList.remove('spinning');
          showNotification('Customer insights refreshed successfully', 'success');
        }, 1000);
      }

      function getPerformanceColor(performance) {
        if (performance >= 85) return 'success';
        if (performance >= 75) return 'primary';
        if (performance >= 65) return 'warning';
        return 'danger';
      }

      function getCustomerTypeIcon(type) {
        const icons = {
          corporate: '🏢',
          individual: '👤',
          tourist: '✈️'
        };
        return icons[type] || '👤';
      }

      // New Widget Action Functions
      function openMaintenanceCenter() {
        alert('🔧 Maintenance Center\n\nOpening comprehensive maintenance management:\n• Predictive maintenance alerts\n• Service scheduling\n• Parts inventory\n• Technician assignments\n• Cost tracking\n• Compliance monitoring');
      }

      function openBranchAnalytics() {
        alert('📊 Branch Analytics Center\n\nDetailed branch analysis:\n• Performance comparisons\n• Revenue per branch\n• Staff productivity\n• Vehicle utilization\n• Customer satisfaction\n• Market penetration');
      }

      function openBookingCenter() {
        alert('📅 Booking Management Center\n\nAdvanced booking operations:\n• Booking pipeline\n• Demand forecasting\n• Capacity planning\n• Customer preferences\n• Pricing optimization\n• Availability management');
      }

      function openCustomerCenter() {
        alert('👥 Customer Relationship Center\n\nVIP customer management:\n• Customer lifetime value\n• Loyalty programs\n• Personalized offers\n• Communication history\n• Satisfaction tracking\n• Retention strategies');
      }

      // === FLOATING FEEDBACK SYSTEM ===
      function openFeedbackModal() {
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        modal.show();
        
        // Focus on name field
        setTimeout(() => {
          document.getElementById('feedbackName').focus();
        }, 500);
      }

      function getCurrentPageName() {
        const path = window.location.pathname;
        const fileName = path.split('/').pop();
        
        const pageMap = {
          'index.html': 'Dashboard',
          'fleet-management.html': 'Fleet Management',
          'booking-management.html': 'Booking Management',
          'customer-management.html': 'Customer Management',
          'billing-payments.html': 'Billing & Payments',
          'telematics-tracking.html': 'Telematics & Tracking',
          'reports-analytics.html': 'Reports & Analytics',
          'maintenance-compliance.html': 'Maintenance & Compliance',
          'branch-staff-management.html': 'Branch & Staff Management'
        };
        
        return pageMap[fileName] || '';
      }

      async function submitFeedback() {
        const form = document.getElementById('feedbackForm');
        const submitBtn = document.getElementById('submitFeedbackBtn');
        const statusDiv = document.getElementById('feedbackStatus');
        
        // Validate form
        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }
        
        // Disable submit button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';
        
        // Collect form data (simplified for 4-column sheet)
        const feedbackData = {
          Name: document.getElementById('feedbackName').value,
          'Specific Module': document.getElementById('feedbackModule').value,
          Page: getCurrentPageName(),
          Comment: document.getElementById('feedbackComment').value
        };
        
        try {
          // Submit to SheetDB API
          const response = await fetch('https://sheetdb.io/api/v1/m6e9alkji637v', {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(feedbackData)
          });
          
          if (response.ok) {
            // Success
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = `
              <i class="fas fa-check-circle me-2"></i>
              <strong>Thank you!</strong> Your feedback has been submitted successfully.
            `;
            statusDiv.style.display = 'block';
            
            // Reset form
            form.reset();
            form.classList.remove('was-validated');
            
            // Auto-close modal after 3 seconds
            setTimeout(() => {
              bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
            }, 3000);
            
            // Show success notification
            showNotification('✅ Feedback submitted successfully! Thank you for helping us improve.', 'success');
            
          } else {
            throw new Error('Failed to submit feedback');
          }
          
        } catch (error) {
          console.error('Feedback submission error:', error);
          
          // Show error message
          statusDiv.className = 'alert alert-danger';
          statusDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Submission Failed</strong><br>
            Please try again or contact IT support if the problem persists.<br>
            <small class="text-muted">Error: ${error.message}</small>
          `;
          statusDiv.style.display = 'block';
        }
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Submit Feedback';
      }

      // === CALENDAR INTEGRATION FUNCTIONS ===
      function openFullCalendar() {
        alert('📅 Full Calendar System\n\nOpening comprehensive calendar with:\n• Monthly/weekly/daily views\n• Booking management\n• Staff scheduling\n• Maintenance planning\n• Event coordination\n• Integration with all modules');
      }

      // === FLEET USAGE ANALYTICS WIDGET ===
      function initializeFleetUsageWidget() {
        populateFleetUsageData();
        initializeUsageCharts();
        updateSeasonalIndicator();
        
        // Update fleet usage data every 5 minutes
        setInterval(populateFleetUsageData, 300000);
        
        // Add window resize handler for chart responsiveness
        window.addEventListener('resize', function() {
          if (usagePatternChart) {
            setTimeout(() => {
              usagePatternChart.resize();
            }, 100);
          }
        });
      }

      let currentUsagePeriod = 'today';
      let usagePatternChart = null;
      
      const fleetUsageData = {
        today: {
          totalHours: 847.5,
          totalMiles: 12847,
          efficiency: 87.3,
          hoursChange: '+12.3%',
          milesChange: '+8.7%',
          efficiencyChange: '+2.1%',
          chartLabels: ['12AM', '2AM', '4AM', '6AM', '8AM', '10AM', '12PM', '2PM', '4PM', '6PM', '8PM', '10PM'],
          chartData: [12, 8, 5, 15, 35, 45, 52, 68, 75, 62, 38, 25],
          vehicles: [
            { name: 'Toyota Camry - ABC123', hours: 8.5, miles: 245, efficiency: 92, peak: '2-6 PM', status: 'Active' },
            { name: 'Honda CR-V - XYZ789', hours: 7.2, miles: 198, efficiency: 88, peak: '10-2 PM', status: 'Active' },
            { name: 'Ford Focus - DEF456', hours: 6.8, miles: 167, efficiency: 85, peak: '9-1 PM', status: 'Maintenance' },
            { name: 'BMW X3 - GHI345', hours: 9.1, miles: 287, efficiency: 94, peak: '1-5 PM', status: 'Active' },
            { name: 'Nissan Altima - JKL012', hours: 5.3, miles: 134, efficiency: 78, peak: '3-7 PM', status: 'Available' }
          ]
        },
        week: {
          totalHours: 5234.8,
          totalMiles: 89567,
          efficiency: 84.7,
          hoursChange: '+15.6%',
          milesChange: '+11.2%',
          efficiencyChange: '+3.8%',
          chartLabels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
          chartData: [420, 480, 520, 580, 610, 720, 650],
          vehicles: [
            { name: 'Toyota Camry - ABC123', hours: 52.3, miles: 1567, efficiency: 91, peak: 'Weekdays 2-6 PM', status: 'Active' },
            { name: 'Honda CR-V - XYZ789', hours: 48.7, miles: 1423, efficiency: 87, peak: 'Weekdays 10-2 PM', status: 'Active' },
            { name: 'Ford Focus - DEF456', hours: 41.2, miles: 1198, efficiency: 82, peak: 'Weekends 9-1 PM', status: 'Maintenance' },
            { name: 'BMW X3 - GHI345', hours: 58.9, miles: 1789, efficiency: 93, peak: 'Daily 1-5 PM', status: 'Active' },
            { name: 'Nissan Altima - JKL012', hours: 35.6, miles: 987, efficiency: 76, peak: 'Evenings 3-7 PM', status: 'Available' }
          ]
        },
        month: {
          totalHours: 21456.3,
          totalMiles: 387234,
          efficiency: 82.1,
          hoursChange: '+18.9%',
          milesChange: '+14.3%',
          efficiencyChange: '+5.2%',
          chartLabels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          chartData: [1850, 1920, 2100, 2280, 2450, 2680, 2820, 2750, 2580, 2380, 2150, 1890],
          vehicles: [
            { name: 'Toyota Camry - ABC123', hours: 234.7, miles: 6789, efficiency: 89, peak: 'Business Hours', status: 'Active' },
            { name: 'Honda CR-V - XYZ789', hours: 198.3, miles: 5634, efficiency: 85, peak: 'Morning Rush', status: 'Active' },
            { name: 'Ford Focus - DEF456', hours: 167.8, miles: 4567, efficiency: 80, peak: 'Weekend Peak', status: 'Maintenance' },
            { name: 'BMW X3 - GHI345', hours: 267.2, miles: 7890, efficiency: 91, peak: 'Afternoon Peak', status: 'Active' },
            { name: 'Nissan Altima - JKL012', hours: 145.9, miles: 3987, efficiency: 74, peak: 'Evening Hours', status: 'Available' }
          ]
        }
      };

      function setUsagePeriod(period) {
        currentUsagePeriod = period;
        
        // Update button states
        document.querySelectorAll('.fleet-usage-widget .btn-group .btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update data and charts
        populateFleetUsageData();
        updateUsagePatternChart();
        updateSeasonalIndicator();
        
        showNotification(`Fleet usage switched to ${period} view`, 'info');
      }

      function updateUsagePatternChart() {
        if (!usagePatternChart) return;
        
        const data = fleetUsageData[currentUsagePeriod];
        
        // Update chart data
        usagePatternChart.data.labels = data.chartLabels;
        usagePatternChart.data.datasets[0].data = data.chartData;
        
        // Update chart title based on period
        const periodTitles = {
          today: 'Usage Pattern - 24 Hours',
          week: 'Usage Pattern - 7 Days', 
          month: 'Usage Pattern - 12 Months'
        };
        
        usagePatternChart.options.plugins.title = {
          display: true,
          text: periodTitles[currentUsagePeriod] || 'Usage Pattern'
        };
        
        // Animate the update
        usagePatternChart.update('active');
      }

      function updateSeasonalIndicator() {
        const indicator = document.getElementById('seasonalIndicator');
        if (!indicator) return;
        
        const indicators = {
          today: 'Real-time',
          week: 'Weekly Trend',
          month: 'Yearly Overview'
        };
        
        const colors = {
          today: 'bg-success',
          week: 'bg-primary', 
          month: 'bg-info'
        };
        
        indicator.textContent = indicators[currentUsagePeriod];
        indicator.className = `badge ${colors[currentUsagePeriod]}`;
      }

      function populateFleetUsageData() {
        const data = fleetUsageData[currentUsagePeriod];
        
        // Update summary cards
        document.getElementById('totalUsageHours').textContent = data.totalHours + 'h';
        document.getElementById('totalMiles').textContent = data.totalMiles.toLocaleString();
        document.getElementById('efficiencyRate').textContent = data.efficiency + '%';
        
        // Update usage details table
        populateUsageDetailsTable(data.vehicles);
      }

      function populateUsageDetailsTable(vehicles) {
        const tbody = document.getElementById('usageDetailsTable');
        if (!tbody) return;
        
        tbody.innerHTML = vehicles.map(vehicle => `
          <tr>
            <td>
              <div class="fw-bold">${vehicle.name}</div>
            </td>
            <td>
              <span class="badge bg-primary">${vehicle.hours}h</span>
            </td>
            <td>
              <span class="text-muted">${vehicle.miles.toLocaleString()} mi</span>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="progress me-2" style="width: 60px; height: 8px;">
                  <div class="progress-bar bg-${getEfficiencyColor(vehicle.efficiency)}" 
                       style="width: ${vehicle.efficiency}%"></div>
                </div>
                <span class="text-${getEfficiencyColor(vehicle.efficiency)}">${vehicle.efficiency}%</span>
              </div>
            </td>
            <td>
              <small class="text-muted">${vehicle.peak}</small>
            </td>
            <td>
              <span class="badge bg-${getStatusColor(vehicle.status)}">${vehicle.status}</span>
            </td>
          </tr>
        `).join('');
      }

      function getEfficiencyColor(efficiency) {
        if (efficiency >= 90) return 'success';
        if (efficiency >= 80) return 'primary';
        if (efficiency >= 70) return 'warning';
        return 'danger';
      }

      function getStatusColor(status) {
        const colors = {
          'Active': 'success',
          'Available': 'info',
          'Maintenance': 'warning',
          'Out of Service': 'danger'
        };
        return colors[status] || 'secondary';
      }

      function initializeUsageCharts() {
        initializeUsagePatternChart();
        initializeVehicleTypeUsageChart();
      }

      function initializeUsagePatternChart() {
        const ctx = document.getElementById('usagePatternChart');
        if (!ctx) return;
        
        const initialData = fleetUsageData[currentUsagePeriod];
        
        usagePatternChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: initialData.chartLabels,
            datasets: [{
              label: 'Active Vehicles',
              data: initialData.chartData,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.1)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#007bff',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2.5,
            plugins: {
              legend: { 
                display: true,
                position: 'top',
                labels: {
                  usePointStyle: true,
                  padding: 20
                }
              },
              title: {
                display: true,
                text: 'Usage Pattern - 24 Hours',
                font: {
                  size: 16,
                  weight: 'bold'
                },
                padding: 20
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function(context) {
                    return `Active Vehicles: ${context.parsed.y}`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                  maxRotation: 45
                }
              },
              y: { 
                beginAtZero: true,
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                  callback: function(value) {
                    return value + ' vehicles';
                  }
                }
              }
            },
            interaction: {
              intersect: false,
              mode: 'index'
            }
          }
        });
      }

      function initializeVehicleTypeUsageChart() {
        const ctx = document.getElementById('vehicleTypeUsageChart');
        if (!ctx) return;
        
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Sedan', 'SUV', 'Compact', 'Luxury'],
            datasets: [{
              data: [35, 28, 22, 15],
              backgroundColor: ['#007bff', '#28a745', '#ffc107', '#6f42c1'],
              borderWidth: 3,
              borderColor: '#ffffff',
              cutout: '65%'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { 
                  padding: 15, 
                  usePointStyle: true,
                  font: { size: 12 },
                  generateLabels: function(chart) {
                    const data = chart.data;
                    if (data.labels.length && data.datasets.length) {
                      return data.labels.map((label, i) => {
                        const dataset = data.datasets[0];
                        const value = dataset.data[i];
                        const total = dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return {
                          text: `${label}: ${percentage}%`,
                          fillStyle: dataset.backgroundColor[i],
                          strokeStyle: dataset.borderColor,
                          lineWidth: dataset.borderWidth,
                          pointStyle: 'circle'
                        };
                      });
                    }
                    return [];
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                cornerRadius: 8,
                callbacks: {
                  label: function(context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                    return `${context.label}: ${context.parsed} vehicles (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }

      function toggleUsageTable() {
        const container = document.getElementById('usageTableContainer');
        const icon = document.getElementById('tableToggleIcon');
        const text = document.getElementById('tableToggleText');
        
        if (container.style.display === 'none') {
          container.style.display = 'block';
          icon.className = 'fas fa-chevron-up';
          text.textContent = 'Hide Details';
          
          const data = fleetUsageData[currentUsagePeriod];
          populateUsageDetailsTable(data.vehicles);
        } else {
          container.style.display = 'none';
          icon.className = 'fas fa-chevron-down';
          text.textContent = 'Show Details';
        }
      }

      // === CRITICAL ALERTS & NOTIFICATIONS WIDGET ===
      // === UNIFIED ALERT CENTER SYSTEM ===
      let unifiedAlertsData = {
        system: [
          {
            id: 'SYS001',
            type: 'system',
            priority: 'critical',
            category: 'system',
            title: 'Database Connection Timeout',
            message: 'Primary database experiencing connection timeouts - affecting booking system',
            timestamp: new Date(Date.now() - 15 * 60 * 1000),
            status: 'active',
            source: 'System Monitor',
            acknowledged: false,
            businessImpact: 'critical',
            estimatedLoss: 'System Downtime'
          },
          {
            id: 'SYS002',
            type: 'system',
            priority: 'high',
            category: 'system',
            title: 'Payment Gateway Error Rate High',
            message: 'Payment processing error rate exceeded 5% threshold',
            timestamp: new Date(Date.now() - 45 * 60 * 1000),
            status: 'active',
            source: 'Payment Monitor',
            acknowledged: false,
            businessImpact: 'high',
            estimatedLoss: '$1,200/hour'
          }
        ],
        customer: [
          {
            id: 'CUST001',
            type: 'customer',
            priority: 'high',
            category: 'customer',
            title: 'VIP Customer Churn Risk',
            message: '3 VIP customers haven\'t booked in 30+ days - immediate retention action needed',
            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000),
            status: 'active',
            source: 'Customer Analytics',
            acknowledged: false,
            businessImpact: 'high',
            estimatedLoss: '$15,000 potential'
          },
          {
            id: 'CUST002',
            type: 'customer',
            priority: 'medium',
            category: 'customer',
            title: 'Low Satisfaction Ratings',
            message: '12 customers gave ratings below 3 stars this week',
            timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000),
            status: 'active',
            source: 'Rating System',
            acknowledged: false,
            businessImpact: 'medium',
            estimatedLoss: 'Reputation Risk'
          }
        ],
        fleet: [
          {
            id: 'FLEET001',
            type: 'fleet',
            priority: 'critical',
            category: 'fleet',
            title: 'Vehicle Breakdown - Safety Issue',
            message: 'Ford Focus brake system warning - immediate service required',
            timestamp: new Date(Date.now() - 30 * 60 * 1000),
            status: 'active',
            source: 'Telematics',
            acknowledged: false,
            businessImpact: 'critical',
            estimatedLoss: 'Safety Risk'
          },
          {
            id: 'FLEET002',
            type: 'fleet',
            priority: 'high',
            category: 'fleet',
            title: 'Vehicle Overdue Return',
            message: 'Toyota Camry (ABC123) - 2 days overdue, customer not responding',
            timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
            status: 'active',
            source: 'Fleet Management',
            acknowledged: false,
            businessImpact: 'high',
            estimatedLoss: '$450/day'
          },
          {
            id: 'FLEET003',
            type: 'fleet',
            priority: 'medium',
            category: 'fleet',
            title: 'Insurance Expiring Soon',
            message: 'BMW X3 (GHI345) insurance expires in 3 days',
            timestamp: new Date(Date.now() - 60 * 60 * 1000),
            status: 'active',
            source: 'Insurance Monitor',
            acknowledged: false,
            businessImpact: 'high',
            estimatedLoss: '$2,500 potential'
          }
        ],
        weather: [
          {
            id: 'WEATHER001',
            type: 'weather',
            priority: 'medium',
            category: 'weather',
            title: 'Heavy Rain Expected Tomorrow',
            message: 'Severe weather forecast - expect 25% booking decrease, prepare fleet protection',
            timestamp: new Date(Date.now() - 20 * 60 * 1000),
            status: 'active',
            source: 'Weather Service',
            acknowledged: false,
            businessImpact: 'medium',
            estimatedLoss: '$3,000 revenue'
          }
        ]
      };

      let currentAlertCategory = 'all';
      let currentAlertPriority = 'all';

      function initializeUnifiedAlertCenter() {
        populateUnifiedAlerts();
        updateUnifiedAlertCounts();
        
        // Update alerts every 2 minutes
        setInterval(() => {
          populateUnifiedAlerts();
          updateUnifiedAlertCounts();
        }, 120000);
        
        // Generate random alerts for demo
        setInterval(() => {
          if (Math.random() > 0.8) { // 20% chance
            generateRandomUnifiedAlert();
          }
        }, Math.random() * 180000 + 240000); // 4-7 minutes
        
        // Update timestamps every minute
        setInterval(updateUnifiedAlertTimestamps, 60000);
      }

      function getAllUnifiedAlerts() {
        let allAlerts = [];
        Object.values(unifiedAlertsData).forEach(categoryAlerts => {
          allAlerts = allAlerts.concat(categoryAlerts);
        });
        return allAlerts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      }

      function populateUnifiedAlerts() {
        const container = document.getElementById('unifiedAlertsList');
        if (!container) return;

        let alerts = getAllUnifiedAlerts();
        
        // Filter by category
        if (currentAlertCategory !== 'all') {
          alerts = alerts.filter(alert => alert.category === currentAlertCategory);
        }
        
        // Filter by priority
        if (currentAlertPriority !== 'all') {
          alerts = alerts.filter(alert => alert.priority === currentAlertPriority);
        }

        container.innerHTML = alerts.map(alert => `
          <div class="unified-alert-item ${alert.priority}-priority mb-3 ${alert.acknowledged ? 'acknowledged' : ''}" data-alert-id="${alert.id}">
            <div class="d-flex justify-content-between align-items-start">
              <div class="alert-content flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas ${getUnifiedAlertIcon(alert.type)} text-${getUnifiedAlertColor(alert.priority)} me-2"></i>
                  <h6 class="mb-0 fw-bold">${alert.title}</h6>
                  <span class="badge bg-${getUnifiedAlertColor(alert.priority)} ms-2">${alert.priority.toUpperCase()}</span>
                  <span class="badge bg-secondary ms-1">${alert.category.toUpperCase()}</span>
                  ${alert.acknowledged ? '<span class="badge bg-success ms-1">ACK</span>' : ''}
                </div>
                <p class="mb-2 text-dark">${alert.message}</p>
                <div class="alert-meta mb-2">
                  <div class="row">
                    <div class="col-md-6">
                      <small class="text-muted">
                        <i class="fas fa-clock me-1"></i><strong>Time:</strong> ${getRelativeTime(alert.timestamp)}<br>
                        <i class="fas fa-source me-1"></i><strong>Source:</strong> ${alert.source}
                      </small>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">
                        <i class="fas fa-exclamation-triangle me-1"></i><strong>Impact:</strong> ${alert.businessImpact}<br>
                        <i class="fas fa-dollar-sign me-1"></i><strong>Loss:</strong> ${alert.estimatedLoss}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="alert-actions ms-3">
                <div class="btn-group-vertical btn-group-sm">
                  <button class="btn btn-outline-success btn-sm" onclick="resolveUnifiedAlert('${alert.id}')" title="Resolve Alert">
                    <i class="fas fa-check"></i>
                  </button>
                  <button class="btn btn-outline-warning btn-sm" onclick="snoozeUnifiedAlert('${alert.id}')" title="Snooze Alert">
                    <i class="fas fa-clock"></i>
                  </button>
                  <button class="btn btn-outline-info btn-sm" onclick="viewUnifiedAlertDetails('${alert.id}')" title="View Details">
                    <i class="fas fa-info-circle"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" onclick="escalateUnifiedAlert('${alert.id}')" title="Escalate">
                    <i class="fas fa-arrow-up"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      function updateUnifiedAlertCounts() {
        const allAlerts = getAllUnifiedAlerts();
        
        // Update total count
        document.getElementById('totalAlertCount').textContent = allAlerts.length;
        
        // Update priority counts
        document.getElementById('criticalPriorityCount').textContent = allAlerts.filter(a => a.priority === 'critical').length;
        document.getElementById('highPriorityCount').textContent = allAlerts.filter(a => a.priority === 'high').length;
        document.getElementById('mediumPriorityCount').textContent = allAlerts.filter(a => a.priority === 'medium').length;
        
        // Update category counts
        document.getElementById('systemAlertsCount').textContent = unifiedAlertsData.system?.length || 0;
        document.getElementById('customerAlertsCountSidebar').textContent = unifiedAlertsData.customer?.length || 0;
        document.getElementById('fleetAlertsCount').textContent = unifiedAlertsData.fleet?.length || 0;
        document.getElementById('weatherAlertsCountSidebar').textContent = unifiedAlertsData.weather?.length || 0;
      }

      function switchAlertCategory(category) {
        currentAlertCategory = category;
        
        // Update button states
        document.querySelectorAll('[id^="alertCategory"]').forEach(btn => btn.classList.remove('active'));
        document.getElementById('alertCategory' + category.charAt(0).toUpperCase() + category.slice(1)).classList.add('active');
        
        populateUnifiedAlerts();
        showNotification(`Filtering alerts: ${category === 'all' ? 'All Categories' : category.toUpperCase()}`, 'info');
      }

      function filterAlertsByPriority(priority) {
        currentAlertPriority = priority;
        
        // Update button states
        document.querySelectorAll('[id^="priorityFilter"]').forEach(btn => btn.classList.remove('active'));
        document.getElementById('priorityFilter' + priority.charAt(0).toUpperCase() + priority.slice(1)).classList.add('active');
        
        populateUnifiedAlerts();
        showNotification(`Filtering by priority: ${priority === 'all' ? 'All Priorities' : priority.toUpperCase()}`, 'info');
      }

      function getUnifiedAlertIcon(type) {
        const icons = {
          system: 'fa-cogs',
          customer: 'fa-users',
          fleet: 'fa-car',
          weather: 'fa-cloud',
          overdue: 'fa-clock',
          insurance: 'fa-shield-alt',
          payment: 'fa-credit-card',
          maintenance: 'fa-wrench',
          geofence: 'fa-map-marker-alt',
          fuel: 'fa-gas-pump',
          speeding: 'fa-tachometer-alt',
          breakdown: 'fa-exclamation-triangle',
          accident: 'fa-car-crash'
        };
        return icons[type] || 'fa-bell';
      }

      function getUnifiedAlertColor(priority) {
        const colors = {
          critical: 'danger',
          high: 'warning',
          medium: 'info',
          low: 'secondary'
        };
        return colors[priority] || 'secondary';
      }

      function getRelativeTime(timestamp) {
        const now = new Date();
        const diff = now - new Date(timestamp);
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
        if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        return 'Just now';
      }

      // Unified Alert Actions
      function resolveUnifiedAlert(alertId) {
        const alert = findAlertById(alertId);
        if (!alert) return;
        
        const resolution = prompt(`Resolve Alert ${alertId}:\n\nPlease provide resolution details:`, 'Issue resolved - appropriate action taken');
        
        if (resolution) {
          alert.status = 'resolved';
          alert.resolvedAt = new Date().toISOString();
          alert.resolution = resolution;
          alert.resolvedBy = 'Admin';
          
          populateUnifiedAlerts();
          updateUnifiedAlertCounts();
          showNotification(`✅ Alert ${alertId} resolved successfully`, 'success');
        }
      }

      function acknowledgeAllUnifiedAlerts() {
        const allAlerts = getAllUnifiedAlerts().filter(a => a.status === 'active' && !a.acknowledged);
        
        if (allAlerts.length === 0) {
          showNotification('No unacknowledged alerts to acknowledge', 'info');
          return;
        }
        
        if (confirm(`Acknowledge all ${allAlerts.length} active alerts?\n\nThis will mark them as seen but keep them active for resolution.`)) {
          allAlerts.forEach(alert => {
            alert.acknowledged = true;
            alert.acknowledgedAt = new Date().toISOString();
            alert.acknowledgedBy = 'Admin';
          });
          
          populateUnifiedAlerts();
          updateUnifiedAlertCounts();
          showNotification(`✅ ${allAlerts.length} alerts acknowledged`, 'success');
        }
      }

      function refreshAllAlerts() {
        const refreshIcon = document.getElementById('unifiedAlertRefreshIcon');
        refreshIcon.classList.add('spinning');
        
        setTimeout(() => {
          populateUnifiedAlerts();
          updateUnifiedAlertCounts();
          document.getElementById('lastUnifiedAlertUpdate').textContent = 'Just now';
          refreshIcon.classList.remove('spinning');
          showNotification('All alerts refreshed successfully', 'success');
        }, 1000);
      }

      function findAlertById(alertId) {
        for (const category of Object.values(unifiedAlertsData)) {
          const alert = category.find(a => a.id === alertId);
          if (alert) return alert;
        }
        return null;
      }

      // Placeholder functions for new unified actions
      function snoozeUnifiedAlert(alertId) {
        showNotification(`Alert ${alertId} snoozed for 1 hour`, 'warning');
      }

      function viewUnifiedAlertDetails(alertId) {
        const alert = findAlertById(alertId);
        if (alert) {
          alert(`Alert Details: ${alert.title}\n\n${alert.message}\n\nSource: ${alert.source}\nPriority: ${alert.priority}\nCategory: ${alert.category}`);
        }
      }

      function escalateUnifiedAlert(alertId) {
        showNotification(`Alert ${alertId} escalated to supervisor`, 'warning');
      }

      function handleEmergencyProtocol() {
        showNotification('🚨 Emergency protocol activated - All relevant teams notified', 'danger');
      }

      function openUnifiedAlertSettings() {
        showNotification('Opening unified alert settings...', 'info');
      }

      function generateUnifiedAlertReport() {
        showNotification('📊 Generating comprehensive alert report...', 'info');
      }

      function updateUnifiedAlertTimestamps() {
        const allAlerts = getAllUnifiedAlerts();
        
        allAlerts.forEach(alert => {
          if (alert.timestamp) {
            // Update relative time display
            const now = new Date();
            const diff = now - new Date(alert.timestamp);
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
              alert.relativeTime = `${days} day${days > 1 ? 's' : ''} ago`;
            } else if (hours > 0) {
              alert.relativeTime = `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else if (minutes > 0) {
              alert.relativeTime = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            } else {
              alert.relativeTime = 'Just now';
            }
          }
        });
        
        // Refresh display if alerts are visible
        if (document.getElementById('unifiedAlertsList')) {
          populateUnifiedAlerts();
          document.getElementById('lastUnifiedAlertUpdate').textContent = 'Just now';
        }
      }

      function generateRandomUnifiedAlert() {
        const categories = ['system', 'customer', 'fleet', 'weather'];
        const priorities = ['critical', 'high', 'medium'];
        
        const alertTemplates = {
          system: [
            { title: 'Server Load High', message: 'Server CPU usage exceeded 85% threshold', impact: 'high', loss: '$500/hour' },
            { title: 'API Rate Limit Reached', message: 'External API rate limit reached - some features may be slow', impact: 'medium', loss: 'Service Degradation' }
          ],
          customer: [
            { title: 'Customer Complaint Escalated', message: 'High-value customer filed formal complaint', impact: 'high', loss: '$5,000 potential' },
            { title: 'Booking Cancellation Spike', message: 'Unusual increase in booking cancellations detected', impact: 'medium', loss: '$2,000 revenue' }
          ],
          fleet: [
            { title: 'Vehicle GPS Signal Lost', message: 'GPS tracking lost for multiple vehicles', impact: 'high', loss: 'Security Risk' },
            { title: 'Fuel Level Critical', message: 'Multiple vehicles reporting low fuel levels', impact: 'medium', loss: '$300 operational' }
          ],
          weather: [
            { title: 'Severe Weather Warning', message: 'Hurricane watch issued - prepare fleet protection', impact: 'critical', loss: '$50,000 potential' },
            { title: 'Heat Wave Alert', message: 'Extreme temperatures may affect vehicle performance', impact: 'medium', loss: 'Maintenance Risk' }
          ]
        };
        
        const category = categories[Math.floor(Math.random() * categories.length)];
        const priority = priorities[Math.floor(Math.random() * priorities.length)];
        const templates = alertTemplates[category];
        const template = templates[Math.floor(Math.random() * templates.length)];
        
        const newAlert = {
          id: category.toUpperCase() + Date.now(),
          type: category,
          priority: priority,
          category: category,
          title: template.title,
          message: template.message,
          timestamp: new Date(),
          status: 'active',
          source: category.charAt(0).toUpperCase() + category.slice(1) + ' Monitor',
          acknowledged: false,
          businessImpact: template.impact,
          estimatedLoss: template.loss
        };
        
        unifiedAlertsData[category].push(newAlert);
        
        // Keep only last 10 alerts per category
        if (unifiedAlertsData[category].length > 10) {
          unifiedAlertsData[category] = unifiedAlertsData[category].slice(-10);
        }
        
        populateUnifiedAlerts();
        updateUnifiedAlertCounts();
        
        // Show notification for critical/high priority alerts
        if (newAlert.priority === 'critical' || newAlert.priority === 'high') {
          showNotification(`🚨 NEW ${newAlert.priority.toUpperCase()} ALERT: ${newAlert.title}`, 'danger');
        }
      }

      function generateRandomCriticalAlert() {
        const alertTemplates = [
          {
            type: 'fuel',
            priority: 'medium',
            title: 'Low Fuel Alert',
            messageTemplate: 'Vehicle {vehicle} fuel level below 15%',
            businessImpact: 'medium',
            estimatedLoss: '$50-100'
          },
          {
            type: 'speeding',
            priority: 'high',
            title: 'Speeding Violation',
            messageTemplate: 'Vehicle {vehicle} exceeded speed limit by 15+ mph',
            businessImpact: 'high',
            estimatedLoss: 'Insurance Risk'
          },
          {
            type: 'breakdown',
            priority: 'high',
            title: 'Vehicle Breakdown',
            messageTemplate: 'Vehicle {vehicle} reported mechanical issues',
            businessImpact: 'critical',
            estimatedLoss: '$200-500'
          },
          {
            type: 'accident',
            priority: 'high',
            title: 'Incident Report',
            messageTemplate: 'Minor incident reported for vehicle {vehicle}',
            businessImpact: 'critical',
            estimatedLoss: '$1000+'
          }
        ];

        const vehicles = ['ABC123', 'XYZ789', 'DEF456', 'GHI345', 'JKL012', 'MNO678', 'PQR901'];
        const customers = ['Alice Brown', 'Bob Wilson', 'Carol Davis', 'David Lee', 'Emma White'];
        const locations = ['Manhattan Branch', 'Brooklyn Branch', 'Queens Branch', 'Bronx Branch'];
        
        const template = alertTemplates[Math.floor(Math.random() * alertTemplates.length)];
        const vehicle = vehicles[Math.floor(Math.random() * vehicles.length)];
        const customer = customers[Math.floor(Math.random() * customers.length)];
        const location = locations[Math.floor(Math.random() * locations.length)];
        
        const newAlert = {
          id: 'AUTO' + Date.now(),
          type: template.type,
          priority: template.priority,
          title: template.title,
          message: template.messageTemplate.replace('{vehicle}', `${getVehicleType()} - ${vehicle}`),
          customer: template.type === 'fuel' || template.type === 'breakdown' ? 'Fleet Vehicle' : customer,
          vehicle: `${getVehicleType()} - ${vehicle}`,
          time: 'Just now',
          timestamp: new Date(),
          status: 'active',
          businessImpact: template.businessImpact,
          location: location,
          contactNumber: template.type === 'fuel' || template.type === 'breakdown' ? 'N/A' : `+1 (555) ${Math.floor(100 + Math.random() * 900)}-${Math.floor(1000 + Math.random() * 9000)}`,
          estimatedLoss: template.estimatedLoss,
          acknowledged: false
        };
        
        criticalAlertsData.unshift(newAlert);
        
        // Keep only last 20 alerts
        if (criticalAlertsData.length > 20) {
          criticalAlertsData = criticalAlertsData.slice(0, 20);
        }
        
        populateCriticalAlerts();
        updateAlertCounts();
        
        // Show notification for high priority alerts
        if (newAlert.priority === 'high') {
          showNotification(`🚨 NEW CRITICAL ALERT: ${newAlert.title}`, 'danger');
        }
        
        // Track new alert
        trackEvent('alert_generated', {
          alert_id: newAlert.id,
          alert_type: newAlert.type,
          priority: newAlert.priority
        });
      }

      function getVehicleType() {
        const types = ['Toyota Camry', 'Honda CR-V', 'Ford Focus', 'BMW X3', 'Nissan Altima', 'Mercedes C-Class'];
        return types[Math.floor(Math.random() * types.length)];
      }

      function updateAlertTimestamps() {
        criticalAlertsData.forEach(alert => {
          if (alert.timestamp) {
            const now = new Date();
            const diff = now - new Date(alert.timestamp);
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
              alert.time = `${days} day${days > 1 ? 's' : ''} ago`;
            } else if (hours > 0) {
              alert.time = `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else if (minutes > 0) {
              alert.time = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            } else {
              alert.time = 'Just now';
            }
          }
        });
        
        // Refresh display if alerts are visible
        if (document.getElementById('criticalAlertsList')) {
          populateCriticalAlerts();
        }
      }

      let criticalAlertsData = [
        {
          id: 'OVR001',
          type: 'overdue',
          priority: 'high',
          title: 'Vehicle Overdue Return',
          message: 'Toyota Camry (ABC123) - 2 days overdue',
          customer: 'John Smith',
          vehicle: 'Toyota Camry - ABC123',
          time: '2 days ago',
          timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
          status: 'active',
          businessImpact: 'high',
          location: 'Manhattan Branch',
          contactNumber: '+1 (555) 123-4567',
          estimatedLoss: '$450/day',
          acknowledged: false
        },
        {
          id: 'INS002',
          type: 'insurance',
          priority: 'high',
          title: 'Insurance Expiring Soon',
          message: 'BMW X3 (GHI345) insurance expires in 3 days',
          customer: 'Fleet Vehicle',
          vehicle: 'BMW X3 - GHI345',
          time: '1 hour ago',
          timestamp: new Date(Date.now() - 60 * 60 * 1000),
          status: 'active',
          businessImpact: 'critical',
          location: 'Queens Branch',
          contactNumber: 'N/A',
          estimatedLoss: '$2,500 potential',
          acknowledged: false
        },
        {
          id: 'PAY003',
          type: 'payment',
          priority: 'medium',
          title: 'Payment Failure',
          message: 'Credit card declined for booking #BK-2024-0156',
          customer: 'Sarah Johnson',
          vehicle: 'Honda CR-V - XYZ789',
          time: '30 minutes ago',
          timestamp: new Date(Date.now() - 30 * 60 * 1000),
          status: 'active',
          businessImpact: 'medium',
          location: 'Brooklyn Branch',
          contactNumber: '+1 (555) 987-6543',
          estimatedLoss: '$285',
          acknowledged: false
        },
        {
          id: 'MAINT004',
          type: 'maintenance',
          priority: 'high',
          title: 'Critical Maintenance Required',
          message: 'Ford Focus brake system warning - immediate service needed',
          customer: 'Fleet Vehicle',
          vehicle: 'Ford Focus - DEF456',
          time: '45 minutes ago',
          timestamp: new Date(Date.now() - 45 * 60 * 1000),
          status: 'active',
          businessImpact: 'critical',
          location: 'Bronx Branch',
          contactNumber: 'N/A',
          estimatedLoss: 'Safety Risk',
          acknowledged: false
        },
        {
          id: 'GEO005',
          type: 'geofence',
          priority: 'medium',
          title: 'Geofence Violation',
          message: 'Nissan Altima left authorized zone without permission',
          customer: 'Mike Davis',
          vehicle: 'Nissan Altima - JKL012',
          time: '15 minutes ago',
          timestamp: new Date(Date.now() - 15 * 60 * 1000),
          status: 'active',
          businessImpact: 'medium',
          location: 'Outside Zone A',
          contactNumber: '+1 (555) 456-7890',
          estimatedLoss: 'Policy Violation',
          acknowledged: false
        }
      ];

      function populateCriticalAlerts() {
        const container = document.getElementById('criticalAlertsList');
        if (!container) return;
        
        const filteredAlerts = currentAlertFilter === 'all' 
          ? criticalAlertsData.filter(alert => alert.status === 'active')
          : criticalAlertsData.filter(alert => alert.status === 'active' && alert.priority === currentAlertFilter);
        
        container.innerHTML = filteredAlerts.map(alert => `
          <div class="critical-alert-item ${alert.priority}-priority mb-3 ${alert.acknowledged ? 'acknowledged' : ''}" data-alert-id="${alert.id}">
            <div class="d-flex justify-content-between align-items-start">
              <div class="alert-content flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas ${getAlertIcon(alert.type)} text-${getAlertColor(alert.priority)} me-2"></i>
                  <h6 class="mb-0 fw-bold">${alert.title}</h6>
                  <span class="badge bg-${getAlertColor(alert.priority)} ms-2">${alert.priority.toUpperCase()}</span>
                  ${alert.acknowledged ? '<span class="badge bg-secondary ms-1">ACK</span>' : ''}
                </div>
                <p class="mb-2 text-dark">${alert.message}</p>
                <div class="alert-meta mb-2">
                  <div class="row">
                    <div class="col-md-6">
                      <small class="text-muted">
                        <i class="fas fa-user me-1"></i><strong>Customer:</strong> ${alert.customer}<br>
                        <i class="fas fa-map-marker-alt me-1"></i><strong>Location:</strong> ${alert.location}
                      </small>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">
                        <i class="fas fa-clock me-1"></i><strong>Time:</strong> ${alert.time}<br>
                        <i class="fas fa-dollar-sign me-1"></i><strong>Impact:</strong> ${alert.estimatedLoss}
                      </small>
                    </div>
                  </div>
                </div>
                ${alert.contactNumber !== 'N/A' ? `
                  <div class="alert-contact mb-2">
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="contactCustomer('${alert.contactNumber}', '${alert.customer}')">
                      <i class="fas fa-phone me-1"></i>Call Customer
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="sendSMS('${alert.contactNumber}', '${alert.customer}')">
                      <i class="fas fa-sms me-1"></i>SMS
                    </button>
                  </div>
                ` : ''}
              </div>
              <div class="alert-actions ms-3">
                <div class="btn-group-vertical btn-group-sm">
                  <button class="btn btn-outline-success btn-sm" onclick="resolveAlert('${alert.id}')" title="Resolve Alert">
                    <i class="fas fa-check"></i>
                  </button>
                  <button class="btn btn-outline-warning btn-sm" onclick="snoozeAlert('${alert.id}')" title="Snooze Alert">
                    <i class="fas fa-clock"></i>
                  </button>
                  <button class="btn btn-outline-info btn-sm" onclick="viewAlertDetails('${alert.id}')" title="View Details">
                    <i class="fas fa-info-circle"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" onclick="escalateAlert('${alert.id}')" title="Escalate">
                    <i class="fas fa-arrow-up"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      function updateAlertCounts() {
        const overdueAlerts = criticalAlertsData.filter(a => a.type === 'overdue' && a.status === 'active');
        const insuranceAlerts = criticalAlertsData.filter(a => a.type === 'insurance' && a.status === 'active');
        const paymentAlerts = criticalAlertsData.filter(a => a.type === 'payment' && a.status === 'active');
        const maintenanceAlerts = criticalAlertsData.filter(a => a.type === 'maintenance' && a.status === 'active');
        
        document.getElementById('overdueCount').textContent = overdueAlerts.length;
        document.getElementById('insuranceCount').textContent = insuranceAlerts.length;
        document.getElementById('paymentCount').textContent = paymentAlerts.length;
        document.getElementById('maintenanceCount').textContent = maintenanceAlerts.length;
        
        const totalAlerts = criticalAlertsData.filter(a => a.status === 'active').length;
        document.getElementById('criticalAlertCount').textContent = totalAlerts;
      }

      function getAlertColor(priority) {
        const colors = {
          high: 'danger',
          medium: 'warning',
          low: 'info'
        };
        return colors[priority] || 'secondary';
      }

      function getAlertIcon(type) {
        const icons = {
          overdue: 'fa-clock',
          insurance: 'fa-shield-alt',
          payment: 'fa-credit-card',
          maintenance: 'fa-wrench',
          geofence: 'fa-map-marker-alt',
          fuel: 'fa-gas-pump',
          speeding: 'fa-tachometer-alt',
          breakdown: 'fa-exclamation-triangle',
          accident: 'fa-car-crash'
        };
        return icons[type] || 'fa-bell';
      }

      function resolveAlert(alertId) {
        const alert = criticalAlertsData.find(a => a.id === alertId);
        if (!alert) return;
        
        const resolution = prompt(`Resolve Alert ${alertId}:\n\nPlease provide resolution details:`, 'Issue resolved - customer contacted and situation handled');
        
        if (resolution) {
          alert.status = 'resolved';
          alert.resolvedAt = new Date().toISOString();
          alert.resolution = resolution;
          alert.resolvedBy = 'Admin'; // In real system, get current user
          
          populateCriticalAlerts();
          updateAlertCounts();
          
          showNotification(`✅ Alert ${alertId} resolved successfully`, 'success');
          
          // Track resolution
          trackEvent('alert_resolved', {
            alert_id: alertId,
            alert_type: alert.type,
            resolution_time: new Date() - new Date(alert.timestamp),
            resolved_by: 'Admin'
          });
        }
      }

      function snoozeAlert(alertId) {
        const alert = criticalAlertsData.find(a => a.id === alertId);
        if (!alert) return;
        
        const snoozeOptions = [
          { label: '15 minutes', value: 15 },
          { label: '30 minutes', value: 30 },
          { label: '1 hour', value: 60 },
          { label: '2 hours', value: 120 },
          { label: '4 hours', value: 240 }
        ];
        
        const choice = prompt(`Snooze Alert ${alertId} for:\n\n${snoozeOptions.map((opt, i) => `${i+1}. ${opt.label}`).join('\n')}\n\nEnter choice (1-5):`, '3');
        
        if (choice && choice >= 1 && choice <= 5) {
          const snoozeTime = snoozeOptions[choice - 1];
          
          alert.status = 'snoozed';
          alert.snoozedAt = new Date().toISOString();
          alert.snoozeUntil = new Date(Date.now() + snoozeTime.value * 60000).toISOString();
          
          populateCriticalAlerts();
          updateAlertCounts();
          
          showNotification(`⏰ Alert ${alertId} snoozed for ${snoozeTime.label}`, 'warning');
          
          // Reactivate after snooze period
          setTimeout(() => {
            if (alert.status === 'snoozed') {
              alert.status = 'active';
              alert.snoozedAt = null;
              alert.snoozeUntil = null;
              populateCriticalAlerts();
              updateAlertCounts();
              showNotification(`🔔 Alert ${alertId} reactivated`, 'info');
            }
          }, snoozeTime.value * 60000);
          
          // Track snooze
          trackEvent('alert_snoozed', {
            alert_id: alertId,
            snooze_duration: snoozeTime.value,
            alert_type: alert.type
          });
        }
      }

      function handleEmergencyAlert() {
        alert('🚨 Emergency Response Protocol\n\nActivating emergency procedures:\n• Notifying on-call manager\n• Dispatching roadside assistance\n• Contacting emergency services if needed\n• Creating incident report\n• Customer communication initiated');
      }

      function acknowledgeAllAlerts() {
        const activeAlerts = criticalAlertsData.filter(a => a.status === 'active' && !a.acknowledged);
        
        if (activeAlerts.length === 0) {
          showNotification('No unacknowledged alerts to acknowledge', 'info');
          return;
        }
        
        if (confirm(`Acknowledge all ${activeAlerts.length} active alerts?\n\nThis will mark them as seen but keep them active for resolution.`)) {
          activeAlerts.forEach(alert => {
            alert.acknowledged = true;
            alert.acknowledgedAt = new Date().toISOString();
            alert.acknowledgedBy = 'Admin'; // In real system, get current user
          });
          
          populateCriticalAlerts();
          updateAlertCounts();
          showNotification(`✅ ${activeAlerts.length} alerts acknowledged`, 'success');
          
          // Track bulk acknowledgment
          trackEvent('bulk_acknowledge_alerts', {
            count: activeAlerts.length,
            acknowledged_by: 'Admin'
          });
        }
      }

      function filterAlerts(type) {
        currentAlertFilter = type;
        
        // Update filter button states
        document.querySelectorAll('#alertFilterAll, #alertFilterHigh, #alertFilterMedium').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Add active class to clicked button
        const buttonMap = {
          'all': 'alertFilterAll',
          'high': 'alertFilterHigh', 
          'medium': 'alertFilterMedium'
        };
        
        const activeButton = document.getElementById(buttonMap[type]);
        if (activeButton) {
          activeButton.classList.add('active');
        }
        
        // Update display
        populateCriticalAlerts();
        
        // Show filter feedback
        const filterNames = {
          'all': 'All Alerts',
          'high': 'High Priority Only',
          'medium': 'Medium Priority Only'
        };
        
        showNotification(`Filtering: ${filterNames[type]}`, 'info');
        
        // Track filter usage
        trackEvent('alert_filter_changed', {
          filter_type: type,
          visible_alerts: document.querySelectorAll('.critical-alert-item').length
        });
      }

      function openAlertCenter() {
        alert('🔔 Alert Management Center\n\nComprehensive alert management:\n• Alert history and trends\n• Notification settings\n• Escalation rules\n• Alert templates\n• Response procedures\n• Performance metrics');
      }

      function generateAlertReport() {
        alert('📊 Critical Alerts Report\n\nGenerating comprehensive alert report:\n• Active alerts summary\n• Response time analysis\n• Alert trend analysis\n• Performance metrics\n• Recommendations');
      }

      // === ENHANCED ALERT MANAGEMENT FUNCTIONS ===
      function contactCustomer(phoneNumber, customerName) {
        if (confirm(`Call ${customerName} at ${phoneNumber}?`)) {
          // Simulate phone call
          showNotification(`📞 Calling ${customerName}...`, 'info');
          
          // Log the contact attempt
          const alert = criticalAlertsData.find(a => a.contactNumber === phoneNumber);
          if (alert) {
            alert.lastContact = new Date().toISOString();
            alert.contactAttempts = (alert.contactAttempts || 0) + 1;
          }
          
          // In a real system, this would integrate with a phone system
          setTimeout(() => {
            showNotification(`Call logged for ${customerName}`, 'success');
          }, 2000);
        }
      }

      function sendSMS(phoneNumber, customerName) {
        const message = prompt(`Send SMS to ${customerName}:`, 'Your vehicle return is overdue. Please contact us immediately.');
        if (message) {
          showNotification(`📱 SMS sent to ${customerName}`, 'success');
          
          // Log the SMS
          const alert = criticalAlertsData.find(a => a.contactNumber === phoneNumber);
          if (alert) {
            alert.lastSMS = new Date().toISOString();
            alert.smsAttempts = (alert.smsAttempts || 0) + 1;
          }
        }
      }

      function viewAlertDetails(alertId) {
        const alert = criticalAlertsData.find(a => a.id === alertId);
        if (!alert) return;

        // Create detailed alert modal
        let modal = document.getElementById('alertDetailsModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'alertDetailsModal';
          modal.innerHTML = `
            <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
              <div style="background:#fff;padding:2rem;border-radius:12px;width:95vw;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.2);">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h4 class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Alert Details</h4>
                  <button class="btn-close" id="closeAlertDetailsModal"></button>
                </div>
                <div id="alertDetailsContent"></div>
                <div class="mt-4 d-flex justify-content-end gap-2">
                  <button class="btn btn-outline-secondary" id="closeAlertDetails">Close</button>
                  <button class="btn btn-warning" onclick="snoozeAlert('${alertId}'); closeAlertDetailsModal();">Snooze</button>
                  <button class="btn btn-success" onclick="resolveAlert('${alertId}'); closeAlertDetailsModal();">Resolve</button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);

          document.getElementById('closeAlertDetailsModal').onclick = closeAlertDetailsModal;
          document.getElementById('closeAlertDetails').onclick = closeAlertDetailsModal;
        }

        // Populate alert details
        const detailsHTML = `
          <div class="alert alert-${getAlertColor(alert.priority)} mb-3">
            <h5 class="alert-heading">${alert.title} - ${alert.id}</h5>
            <p class="mb-0">${alert.message}</p>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <h6>Alert Information</h6>
              <table class="table table-sm">
                <tr><td><strong>Type:</strong></td><td>${alert.type.charAt(0).toUpperCase() + alert.type.slice(1)}</td></tr>
                <tr><td><strong>Priority:</strong></td><td><span class="badge bg-${getAlertColor(alert.priority)}">${alert.priority.toUpperCase()}</span></td></tr>
                <tr><td><strong>Status:</strong></td><td><span class="badge bg-${alert.status === 'active' ? 'danger' : 'secondary'}">${alert.status.toUpperCase()}</span></td></tr>
                <tr><td><strong>Business Impact:</strong></td><td>${alert.businessImpact}</td></tr>
                <tr><td><strong>Estimated Loss:</strong></td><td class="text-danger">${alert.estimatedLoss}</td></tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6>Contact Information</h6>
              <table class="table table-sm">
                <tr><td><strong>Customer:</strong></td><td>${alert.customer}</td></tr>
                <tr><td><strong>Vehicle:</strong></td><td>${alert.vehicle}</td></tr>
                <tr><td><strong>Location:</strong></td><td>${alert.location}</td></tr>
                <tr><td><strong>Phone:</strong></td><td>${alert.contactNumber}</td></tr>
                <tr><td><strong>Acknowledged:</strong></td><td>${alert.acknowledged ? 'Yes' : 'No'}</td></tr>
              </table>
            </div>
          </div>
          
          <div class="mt-3">
            <h6>Recommended Actions</h6>
            <div class="alert alert-info">
              ${getRecommendedActions(alert.type, alert.priority)}
            </div>
          </div>
        `;

        document.getElementById('alertDetailsContent').innerHTML = detailsHTML;
        modal.style.display = 'flex';
      }

      function closeAlertDetailsModal() {
        const modal = document.getElementById('alertDetailsModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function escalateAlert(alertId) {
        const alert = criticalAlertsData.find(a => a.id === alertId);
        if (!alert) return;

        const escalationLevels = {
          low: 'Supervisor',
          medium: 'Branch Manager', 
          high: 'Regional Director',
          critical: 'Emergency Team'
        };

        const nextLevel = escalationLevels[alert.businessImpact] || 'Supervisor';
        
        if (confirm(`Escalate alert ${alertId} to ${nextLevel}?\n\nThis will:\n• Send immediate notification\n• Create escalation record\n• Update alert priority\n• Track response time`)) {
          alert.escalated = true;
          alert.escalatedTo = nextLevel;
          alert.escalatedAt = new Date().toISOString();
          
          populateCriticalAlerts();
          showNotification(`🚨 Alert ${alertId} escalated to ${nextLevel}`, 'warning');
          
          // Track escalation
          trackEvent('alert_escalated', {
            alert_id: alertId,
            escalated_to: nextLevel,
            original_priority: alert.priority
          });
        }
      }

      function getRecommendedActions(type, priority) {
        const actions = {
          overdue: {
            high: '• Contact customer immediately<br>• Dispatch recovery team if needed<br>• Apply late fees per policy<br>• Document incident',
            medium: '• Send reminder notification<br>• Schedule follow-up call<br>• Review customer history',
            low: '• Send automated reminder<br>• Monitor for 24 hours'
          },
          insurance: {
            high: '• Remove vehicle from service immediately<br>• Contact insurance provider<br>• Update fleet availability<br>• Notify all staff',
            medium: '• Schedule insurance renewal<br>• Prepare documentation<br>• Set calendar reminder',
            low: '• Review renewal options<br>• Prepare paperwork'
          },
          payment: {
            high: '• Contact customer immediately<br>• Hold vehicle if not released<br>• Process alternative payment<br>• Update booking status',
            medium: '• Send payment reminder<br>• Offer payment assistance<br>• Schedule follow-up',
            low: '• Send automated reminder<br>• Monitor payment status'
          },
          maintenance: {
            high: '• Remove vehicle from service immediately<br>• Schedule emergency maintenance<br>• Notify safety team<br>• Document safety concern',
            medium: '• Schedule maintenance within 24 hours<br>• Monitor vehicle status<br>• Prepare parts order',
            low: '• Schedule routine maintenance<br>• Add to maintenance queue'
          },
          geofence: {
            high: '• Contact customer immediately<br>• Track vehicle location<br>• Assess security risk<br>• Consider remote disable',
            medium: '• Send location alert<br>• Monitor vehicle movement<br>• Contact if continues',
            low: '• Log violation<br>• Send automated notification'
          }
        };

        return actions[type]?.[priority] || '• Review alert details<br>• Take appropriate action<br>• Document response';
      }

      function showDaySchedule(day) {
        alert(`📅 Schedule for Day ${day}\n\nShowing:\n• All scheduled events\n• Staff assignments\n• Vehicle bookings\n• Maintenance appointments\n• Available time slots\n• Conflict detection`);
      }

      function scheduleMaintenanceSlot() {
        alert('🔧 Schedule Maintenance\n\nMaintenance scheduling:\n• Available service slots\n• Vehicle selection\n• Technician assignment\n• Customer notification\n• Parts availability check\n• Service duration estimation');
      }

      function bookStaffMeeting() {
        alert('👥 Staff Meeting Scheduler\n\nMeeting planning:\n• Staff availability check\n• Room booking\n• Agenda creation\n• Calendar invitations\n• Video conference setup\n• Reminder notifications');
      }

      function planVehicleInspection() {
        alert('📋 Vehicle Inspection Planner\n\nInspection scheduling:\n• Inspection checklist\n• Inspector assignment\n• Time slot booking\n• Vehicle preparation\n• Documentation setup\n• Compliance tracking');
      }
    </script>

    <!-- Floating Feedback Button -->
    <div class="floating-feedback-btn" onclick="openFeedbackModal()" title="Share Your Feedback (Ctrl+Shift+F)">
      <i class="fas fa-comment-dots"></i>
      <span class="feedback-pulse"></span>
    </div>

    <!-- Feedback Modal -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-gradient-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-comment-medical me-2"></i>Share Your Feedback
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="feedback-intro text-center mb-4">
              <i class="fas fa-users text-primary" style="font-size: 3rem;"></i>
              <h6 class="mt-2">Help Us Improve LynxLite</h6>
              <p class="text-muted">Your feedback helps us build a better rental management experience</p>
            </div>

            <form id="feedbackForm" class="needs-validation" novalidate>
              <div class="mb-3">
                <label for="feedbackName" class="form-label">
                  <i class="fas fa-user me-1"></i>Name <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control" id="feedbackName" placeholder="Your name" required>
                <div class="invalid-feedback">Please provide your name.</div>
              </div>

              <div class="mb-3">
                <label for="feedbackModule" class="form-label">
                  <i class="fas fa-puzzle-piece me-1"></i>Specific Module <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="feedbackModule" required>
                  <option value="">Select Module</option>
                  <option value="Dashboard">📊 Dashboard</option>
                  <option value="Fleet Management">🚗 Fleet Management</option>
                  <option value="Booking Management">📅 Booking Management</option>
                  <option value="Customer Management">👥 Customer Management</option>
                  <option value="Billing & Payments">💳 Billing & Payments</option>
                  <option value="Telematics & Tracking">📍 Telematics & Tracking</option>
                  <option value="Reports & Analytics">📈 Reports & Analytics</option>
                  <option value="Maintenance & Compliance">🔧 Maintenance & Compliance</option>
                  <option value="Branch & Staff Management">🏢 Branch & Staff Management</option>
                  <option value="General System">⚙️ General System</option>
                </select>
                <div class="invalid-feedback">Please select a specific module.</div>
              </div>

              <div class="mb-3">
                <label for="feedbackComment" class="form-label">
                  <i class="fas fa-comment me-1"></i>Comment <span class="text-danger">*</span>
                </label>
                <textarea class="form-control" id="feedbackComment" rows="4" 
                          placeholder="Please share your feedback, suggestions, or report any issues..." 
                          required></textarea>
                <div class="invalid-feedback">Please provide your comment.</div>
              </div>

              <!-- Submission Status -->
              <div id="feedbackStatus" class="alert" style="display: none;"></div>
            </form>
          </div>
          <div class="modal-footer">
            <div class="d-flex justify-content-between w-100 align-items-center">
              <div>
                <small class="text-muted">
                  <i class="fas fa-shield-alt me-1"></i>Your feedback is confidential and helps improve the system
                </small>
              </div>
              <div>
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                  <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="submitFeedback()" id="submitFeedbackBtn">
                  <i class="fas fa-paper-plane me-1"></i>Submit Feedback
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Disclaimer Modal -->
    <div class="modal fade" id="disclaimerModal" tabindex="-1" aria-labelledby="disclaimerModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-primary text-white border-0">
            <h4 class="modal-title fw-bold" id="disclaimerModalLabel">
              <i class="fas fa-info-circle me-2"></i>
              Prototype Disclaimer
            </h4>
          </div>
          <div class="modal-body p-4">
            <div class="text-center mb-4">
              <div class="mb-3">
                <i class="fas fa-code text-primary" style="font-size: 3rem;"></i>
              </div>
              <h5 class="text-primary fw-bold mb-3">LynxLite Rental Management System</h5>
              <div class="alert alert-warning border-0 shadow-sm">
                <div class="d-flex align-items-center justify-content-center">
                  <i class="fas fa-flask me-2" style="font-size: 1.5rem;"></i>
                  <span class="badge bg-warning text-dark px-3 py-2 fs-6">PROTOTYPE VERSION</span>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-8 mx-auto">
                <div class="card border-0 bg-light">
                  <div class="card-body text-center">
                    <h6 class="card-title text-primary mb-3">
                      <i class="fas fa-user-tie me-2"></i>
                      Designed & Developed by
                    </h6>
                    <h4 class="text-dark fw-bold mb-3">Omar Qatamin</h4>
                    <hr class="my-3">
                    <p class="card-text text-muted mb-0">
                      This prototype system is designed for <strong>testing and validation purposes only</strong>. 
                      It demonstrates the proposed functionality and user interface for the LynxLite 
                      Rental Management System.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <div class="row text-center">
                <div class="col-md-4">
                  <div class="p-3">
                    <i class="fas fa-cogs text-primary mb-2" style="font-size: 2rem;"></i>
                    <h6 class="fw-bold">Testing Phase</h6>
                    <small class="text-muted">Functionality validation and user experience testing</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="p-3">
                    <i class="fas fa-users text-success mb-2" style="font-size: 2rem;"></i>
                    <h6 class="fw-bold">User Feedback</h6>
                    <small class="text-muted">Gathering insights for product improvement</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="p-3">
                    <i class="fas fa-rocket text-warning mb-2" style="font-size: 2rem;"></i>
                    <h6 class="fw-bold">Development</h6>
                    <small class="text-muted">Iterative design and feature enhancement</small>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-4 p-3 bg-info bg-opacity-10 rounded">
              <div class="d-flex align-items-start">
                <i class="fas fa-lightbulb text-info me-3 mt-1"></i>
                <div>
                  <h6 class="text-info fw-bold mb-2">Important Notice</h6>
                  <ul class="list-unstyled text-muted mb-0 small">
                    <li class="mb-1">• This is a demonstration prototype, not a production system</li>
                    <li class="mb-1">• Data shown is simulated for testing purposes</li>
                    <li class="mb-1">• Features may be incomplete or subject to change</li>
                    <li>• Your feedback is valuable for the development process</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer border-0 bg-light">
            <div class="w-100 text-center">
              <button type="button" class="btn btn-primary btn-lg px-5" id="acknowledgeBtn">
                <i class="fas fa-check me-2"></i>
                Acknowledged - Continue to Dashboard
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Show disclaimer modal on page load
        document.addEventListener('DOMContentLoaded', function() {
          // Debug: Confirm enhanced Quick Actions are loaded
          console.log('🚀 LynxLite Enhanced Quick Actions v2.0 Loading...');
          
          // Check if user has already acknowledged the disclaimer
          const hasAcknowledged = localStorage.getItem('disclaimerAcknowledged');
          
          if (!hasAcknowledged) {
            // Show the modal
            const disclaimerModal = new bootstrap.Modal(document.getElementById('disclaimerModal'));
            disclaimerModal.show();
          
          // Handle acknowledge button click
          document.getElementById('acknowledgeBtn').addEventListener('click', function() {
            // Store acknowledgment in localStorage
            localStorage.setItem('disclaimerAcknowledged', 'true');
            localStorage.setItem('disclaimerAcknowledgedDate', new Date().toISOString());
            
            // Hide the modal
            disclaimerModal.hide();
            
            // Optional: Show a welcome notification
            setTimeout(() => {
              if (typeof showNotification === 'function') {
                showNotification('Welcome to LynxLite Prototype! Explore the features and provide feedback.', 'success');
              }
            }, 500);
          });
        }
        
        // Optional: Add a way to reset disclaimer (for testing purposes)
        // Uncomment the line below to reset disclaimer on every page load
        // localStorage.removeItem('disclaimerAcknowledged');
      });
    </script>

  </body>
</html>

