<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>LynxLite - Dashboard (Overview)</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
    <!-- Fonts and icons -->
    <script src="assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
      WebFont.load({
        google: { families: ["Public Sans:300,400,500,600,700"] },
        custom: {
          families: [
            "Font Awesome 5 Solid",
            "Font Awesome 5 Regular",
            "Font Awesome 5 Brands",
            "simple-line-icons",
          ],
          urls: ["assets/css/fonts.min.css"],
        },
        active: function () {
          sessionStorage.fonts = true;
        },
      });
    </script>
    <!-- CSS Files -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/plugins.min.css" />
    <link rel="stylesheet" href="assets/css/lynxlite.min.css" />
    <link rel="stylesheet" href="assets/css/demo.css" />
    <link rel="stylesheet" href="assets/css/unified-custom.css" />
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" type="text/css">
    
    <!-- Custom Styles for New Widgets -->
    <style>
      /* Floating Feedback Button */
      .floating-feedback-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
        z-index: 1000;
        transition: all 0.3s ease;
      }
      
      .floating-feedback-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(0, 123, 255, 0.4);
      }
      
      .feedback-pulse {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(0, 123, 255, 0.4);
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(1.4); opacity: 0; }
      }
      
      /* Widget Card Styles */
      .usage-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        border-left: 4px solid #007bff;
      }
      
      .usage-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 12px;
        color: #6c757d;
      }
      
      .usage-card-header i {
        margin-right: 6px;
      }
      
      .usage-card-value {
        font-size: 24px;
        font-weight: bold;
        color: #495057;
        margin-bottom: 4px;
      }
      
      .usage-card-change {
        font-size: 11px;
        font-weight: 500;
      }
      
      /* Alert Summary Cards */
      .alert-summary-card {
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
      }
      
      .critical-alert-item {
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
      }
      
      .critical-alert-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-color: #007bff;
      }
      
      .high-priority {
        border-left: 4px solid #dc3545 !important;
      }
      
      .medium-priority {
        border-left: 4px solid #ffc107 !important;
      }
      
      .low-priority {
        border-left: 4px solid #17a2b8 !important;
      }
      
      /* Calendar Styles */
      .mini-calendar {
        font-size: 12px;
      }
      
      .calendar-date {
        padding: 4px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .calendar-date:hover {
        background: #e9ecef;
      }
      
      .calendar-date.today {
        background: #007bff;
        color: white;
        font-weight: bold;
      }
      
      .calendar-date.has-event {
        position: relative;
      }
      
      .calendar-date.has-event::after {
        content: '';
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 4px;
        height: 4px;
        background: #28a745;
        border-radius: 50%;
      }
      
      /* Schedule Item Styles */
      .schedule-item {
        transition: all 0.2s ease;
      }
      
      .schedule-item:hover {
        background: #f8f9fa;
        transform: translateX(2px);
      }
      
      /* Fullscreen Map Styles */
      .fullscreen-map {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }
      
      .fullscreen-map #fleetMap {
        height: calc(100vh - 120px) !important;
      }
      
      /* Widget Animation Styles */
      [data-widget] {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      
      /* Fleet Usage Chart Enhancements */
      .fleet-usage-widget .chart-container {
        width: 100% !important;
        min-width: 0 !important;
        flex: 1 !important;
      }
      
      .fleet-usage-widget .chart-wrapper {
        width: 100% !important;
        display: block !important;
        position: relative !important;
        overflow: hidden;
      }
      
      .fleet-usage-widget canvas {
        max-width: 100% !important;
        width: 100% !important;
        height: 100% !important;
        display: block !important;
      }
      
      .fleet-usage-widget .row {
        width: 100% !important;
        margin: 0 !important;
      }
      
      .fleet-usage-widget .col-md-8,
      .fleet-usage-widget .col-md-4 {
        padding-left: 8px !important;
        padding-right: 8px !important;
      }
      
      /* Dark Mode Enhancements */
      .dark-mode .usage-card {
        background: #2c3e50;
        border-left-color: #3498db;
      }
      
      .dark-mode .critical-alert-item {
        background: #34495e;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      
      .dark-mode .alert-summary-card {
        border: 1px solid #4a5568;
      }
      
      /* Widget Card Styles */
      .widget-card {
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      
      .widget-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.15);
        border-color: #007bff;
      }
      
      .widget-card.active {
        border-color: #28a745;
        background: linear-gradient(135deg, #f8fff9, #e8f5e8);
      }
      
      .widget-card.active .widget-card-status {
        background: #28a745;
      }
      
      .widget-card.inactive {
        border-color: #dc3545;
        background: linear-gradient(135deg, #fff8f8, #fee);
        opacity: 0.7;
      }
      
      .widget-card.inactive .widget-card-status {
        background: #dc3545;
      }
      
      .widget-card-status {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #28a745;
        transition: all 0.3s ease;
      }
      
      .widget-card-icon {
        font-size: 28px;
        color: #007bff;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }
      
      .widget-card.active .widget-card-icon {
        color: #28a745;
      }
      
      .widget-card.inactive .widget-card-icon {
        color: #dc3545;
      }
      
      .widget-card-title {
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        margin: 0;
        line-height: 1.2;
      }
      
      .widget-card.active .widget-card-title {
        color: #28a745;
      }
      
      .widget-card.inactive .widget-card-title {
        color: #dc3545;
      }
      
      /* Enhanced Widget Card States */
      .widget-card.transitioning {
        transform: scale(0.98);
        opacity: 0.8;
      }
      
      .widget-card.pulse-effect {
        animation: pulseCard 0.6s ease-out;
      }
      
      @keyframes pulseCard {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(0, 123, 255, 0.3); }
        100% { transform: scale(1); }
      }
      
      /* Enhanced Panel Animations */
      #customizationPanel {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      /* Widget Selection Panel */
      .widget-selection-panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e9ecef;
      }
      
      /* Dark Mode Widget Cards */
      .dark-mode .widget-card {
        background: #2c3e50;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      
      .dark-mode .widget-card.active {
        background: linear-gradient(135deg, #1a2332, #2d3748);
        border-color: #48bb78;
      }
      
      .dark-mode .widget-card.inactive {
        background: linear-gradient(135deg, #2d1b1b, #3c2222);
        border-color: #e53e3e;
      }
      
      .dark-mode .widget-card-title {
        color: #e2e8f0;
      }
      
      .dark-mode .widget-selection-panel {
        background: #2d3748;
        border-color: #4a5568;
      }
      
      /* Responsive Adjustments */
      @media (max-width: 768px) {
        .floating-feedback-btn {
          bottom: 20px;
          right: 20px;
          width: 50px;
          height: 50px;
          font-size: 20px;
        }
        
        .usage-card-value {
          font-size: 20px;
        }
        
        .critical-alert-item {
          padding: 10px;
        }
        
        .widget-card {
          min-height: 100px;
          padding: 15px 10px;
        }
        
        .widget-card-icon {
          font-size: 24px;
        }
        
        .widget-card-title {
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- Sidebar -->
      <div class="sidebar" data-background-color="dark">
        <div class="sidebar-logo">
          <div class="logo-header" data-background-color="dark">
            <a href="index.html" class="logo">
              <img src="assets/img/lynxlite/logo_light.svg" alt="LynxLite - Acacus" class="navbar-brand" height="45" />
            </a>
            <div class="nav-toggle">
              <button class="btn btn-toggle toggle-sidebar"><i class="gg-menu-right"></i></button>
              <button class="btn btn-toggle sidenav-toggler"><i class="gg-menu-left"></i></button>
            </div>
            <button class="topbar-toggler more"><i class="gg-more-vertical-alt"></i></button>
          </div>
        </div>
        <div class="sidebar-wrapper scrollbar scrollbar-inner">
          <div class="sidebar-content">
            <ul class="nav nav-secondary">
              <li class="nav-item active">
                <a href="#"><i class="fas fa-home"></i><p>Dashboard (Overview)</p></a>
              </li>
              <li class="nav-item">
                <a href="fleet-management.html"><i class="fas fa-car"></i><p>Fleet Management</p></a>
              </li>
              <li class="nav-item">
                <a href="booking-management.html"><i class="fas fa-calendar-alt"></i><p>Booking Management</p></a>
              </li>
              <li class="nav-item">
                <a href="customer-management.html"><i class="fas fa-users"></i><p>Customer Management</p></a>
              </li>
              <li class="nav-item">
                <a href="billing-payments.html"><i class="fas fa-credit-card"></i><p>Billing & Payments</p></a>
              </li>
              <li class="nav-item">
                <a href="maintenance-compliance.html"><i class="fas fa-wrench"></i><p>Maintenance & Compliance</p></a>
              </li>
              <li class="nav-item">
                <a href="telematics-tracking.html"><i class="fas fa-map-marked-alt"></i><p>Telematics & Tracking</p></a>
              </li>
              <li class="nav-item">
                <a href="reports-analytics.html"><i class="fas fa-chart-line"></i><p>Reports & Analytics</p></a>
              </li>
              <li class="nav-item">
                <a href="branch-staff-management.html"><i class="fas fa-building"></i><p>Branch / Staff Management</p></a>
              </li>
              <li class="nav-item">
                <a href="#"><i class="fas fa-cogs"></i><p>System Settings</p></a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <!-- End Sidebar -->
      <div class="main-panel">
        <div class="main-header">
          <div class="main-header-logo">
            <div class="logo-header" data-background-color="dark">
              <a href="index.html" class="logo">
                <img src="assets/img/lynxlite/logo_light.svg" alt="LynxLite - Acacus" class="navbar-brand" height="32" />
              </a>
              <div class="nav-toggle">
                <button class="btn btn-toggle toggle-sidebar"><i class="gg-menu-right"></i></button>
                <button class="btn btn-toggle sidenav-toggler"><i class="gg-menu-left"></i></button>
              </div>
              <button class="topbar-toggler more"><i class="gg-more-vertical-alt"></i></button>
            </div>
          </div>
          <!-- Navbar Header -->
          <nav class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom">
            <div class="container-fluid">
              <nav class="navbar navbar-header-left navbar-expand-lg navbar-form nav-search p-0 d-none d-lg-flex">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <button type="submit" class="btn btn-search pe-1">
                      <i class="fa fa-search search-icon"></i>
                    </button>
                  </div>
                  <input type="text" placeholder="Search ..." class="form-control" />
                </div>
              </nav>
              <ul class="navbar-nav topbar-nav ms-md-auto align-items-center">
                <li class="nav-item d-flex align-items-center">
                  <div class="form-check form-switch mb-0 ms-2">
                    <input class="form-check-input" type="checkbox" id="darkModeSwitch" />
                    <label class="form-check-label" for="darkModeSwitch" style="color:inherit;">Dark Mode</label>
                  </div>
                </li>
                <li class="nav-item topbar-icon dropdown hidden-caret d-flex d-lg-none">
                  <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false" aria-haspopup="true">
                    <i class="fa fa-search"></i>
                  </a>
                  <ul class="dropdown-menu dropdown-search animated fadeIn">
                    <form class="navbar-left navbar-form nav-search">
                      <div class="input-group">
                        <input type="text" placeholder="Search ..." class="form-control" />
                      </div>
                    </form>
                  </ul>
                </li>
                <li class="nav-item topbar-icon dropdown hidden-caret">
                  <a class="nav-link dropdown-toggle" href="#" id="messageDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-envelope"></i>
                  </a>
                  <ul class="dropdown-menu messages-notif-box animated fadeIn" aria-labelledby="messageDropdown">
                    <li>
                      <div class="dropdown-title d-flex justify-content-between align-items-center">Messages <a href="#" class="small">Mark all as read</a></div>
                    </li>
                    <li>
                      <div class="message-notif-scroll scrollbar-outer">
                        <div class="notif-center">
                          <a href="#"><div class="notif-img"><i class="fas fa-user-circle fa-2x"></i></div><div class="notif-content"><span class="subject">Jimmy Denis</span><span class="block"> How are you ? </span><span class="time">5 minutes ago</span></div></a>
                          <a href="#"><div class="notif-img"><i class="fas fa-user-circle fa-2x"></i></div><div class="notif-content"><span class="subject">Chad</span><span class="block"> Ok, Thanks ! </span><span class="time">12 minutes ago</span></div></a>
                          <a href="#"><div class="notif-img"><i class="fas fa-user-circle fa-2x"></i></div><div class="notif-content"><span class="subject">Jhon Doe</span><span class="block">I would like to report an issue with</span><span class="time">12 minutes ago</span></div></a>
                          <a href="#"><div class="notif-img"><i class="fas fa-user-circle fa-2x"></i></div><div class="notif-content"><span class="subject">Talha</span><span class="block"> Hi, are there any crossovers ? </span><span class="time">17 minutes ago</span></div></a>
                        </div>
                      </div>
                    </li>
                    <li><a class="see-all" href="javascript:void(0);">See all messages<i class="fa fa-angle-right"></i></a></li>
                  </ul>
                </li>
                <li class="nav-item topbar-icon dropdown hidden-caret">
                  <a class="nav-link dropdown-toggle" href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-bell"></i><span class="notification">4</span>
                  </a>
                  <ul class="dropdown-menu notif-box animated fadeIn" aria-labelledby="notifDropdown">
                    <li><div class="dropdown-title">You have 4 new notification</div></li>
                    <li>
                      <div class="notif-scroll scrollbar-outer">
                        <div class="notif-center">
                          <a href="#" class="notif-item"><div class="notif-icon notif-danger"><i class="fas fa-tachometer-alt"></i></div><div class="notif-content"><span class="block">Harsh Acceleration detected</span><span class="time">3 minutes ago</span></div></a>
                          <a href="#" class="notif-item"><div class="notif-icon notif-warning"><i class="fas fa-exclamation-triangle"></i></div><div class="notif-content"><span class="block">Speeding Violation: Vehicle 23</span><span class="time">7 minutes ago</span></div></a>
                          <a href="#" class="notif-item"><div class="notif-icon notif-info"><i class="fas fa-map-marker-alt"></i></div><div class="notif-content"><span class="block">Geofence Breach: Vehicle 45</span><span class="time">10 minutes ago</span></div></a>
                          <a href="#" class="notif-item"><div class="notif-icon notif-primary"><i class="fas fa-tools"></i></div><div class="notif-content"><span class="block">Maintenance Due: Vehicle 12</span><span class="time">15 minutes ago</span></div></a>
                        </div>
                      </div>
                    </li>
                    <li><a class="see-all" href="javascript:void(0);">See all notifications<i class="fa fa-angle-right"></i></a></li>
                  </ul>
                </li>
                <li class="nav-item topbar-icon dropdown hidden-caret">
                  <a class="nav-link" data-bs-toggle="dropdown" href="#" aria-expanded="false"><i class="fas fa-layer-group"></i></a>
                  <div class="dropdown-menu quick-actions animated fadeIn">
                    <div class="quick-actions-header"><span class="title mb-1">Quick Actions</span><span class="subtitle op-7">Shortcuts</span></div>
                    <div class="quick-actions-scroll scrollbar-outer">
                      <div class="quick-actions-items">
                        <div class="row m-0">
                          <a class="col-6 col-md-4 p-0" href="#"><div class="quick-actions-item"><div class="avatar-item bg-danger rounded-circle"><i class="far fa-calendar-alt"></i></div><span class="text">Calendar</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#"><div class="quick-actions-item"><div class="avatar-item bg-warning rounded-circle"><i class="fas fa-map"></i></div><span class="text">Maps</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#"><div class="quick-actions-item"><div class="avatar-item bg-info rounded-circle"><i class="fas fa-file-excel"></i></div><span class="text">Reports</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#"><div class="quick-actions-item"><div class="avatar-item bg-success rounded-circle"><i class="fas fa-envelope"></i></div><span class="text">Emails</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#"><div class="quick-actions-item"><div class="avatar-item bg-primary rounded-circle"><i class="fas fa-file-invoice-dollar"></i></div><span class="text">Invoice</span></div></a>
                          <a class="col-6 col-md-4 p-0" href="#"><div class="quick-actions-item"><div class="avatar-item bg-secondary rounded-circle"><i class="fas fa-credit-card"></i></div><span class="text">Payments</span></div></a>
                        </div>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="nav-item topbar-user dropdown hidden-caret">
                  <a class="dropdown-toggle profile-pic" data-bs-toggle="dropdown" href="#" aria-expanded="false">
                    <div class="avatar-sm"><i class="fas fa-user-circle fa-2x"></i></div>
                    <span class="profile-username"><span class="op-7">Hi,</span> <span class="fw-bold">Admin</span></span>
                  </a>
                  <ul class="dropdown-menu dropdown-user animated fadeIn">
                    <div class="dropdown-user-scroll scrollbar-outer">
                      <li>
                        <div class="user-box">
                          <div class="avatar-lg"><i class="fas fa-user-circle fa-3x"></i></div>
                          <div class="u-text">
                            <h4>Admin</h4>
                            <p class="text-muted">hello@example.com</p>
                            <a href="profile.html" class="btn btn-xs btn-secondary btn-sm">View Profile</a>
                          </div>
                        </div>
                      </li>
                      <li>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">My Profile</a>
                        <a class="dropdown-item" href="#">My Balance</a>
                        <a class="dropdown-item" href="#">Inbox</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Account Setting</a>
                        <a class="dropdown-item" href="#">Logout</a>
                      </li>
                    </div>
                  </ul>
                </li>
              </ul>
            </div>
          </nav>
        </div>
        
        <!-- Dashboard Content -->
        <div class="container">
          <div class="page-inner">
            <!-- Layout Customization Panel -->
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="card border-primary" id="customizationPanel" style="display: none;">
                  <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="mb-0"><i class="fas fa-palette me-2"></i>Dashboard Customization Center</h5>
                      <div>
                        <span class="badge bg-light text-primary me-2" id="selectedWidgetCount">12 widgets selected</span>
                        <button class="btn btn-outline-light btn-sm" onclick="closeCustomizationPanel()">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <!-- Layout Presets -->
                      <div class="col-md-12 mb-4">
                        <h6 class="mb-3"><i class="fas fa-layout me-2"></i>Quick Layout Presets</h6>
                        <div class="row g-3">
                          <div class="col-6 col-md-3">
                            <button class="btn btn-outline-primary w-100" onclick="applyLayout('executive')">
                              <div class="d-flex flex-column align-items-center py-2">
                                <i class="fas fa-crown mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold">Executive</span>
                                <small class="text-muted">Management View</small>
                              </div>
                            </button>
                          </div>
                          <div class="col-6 col-md-3">
                            <button class="btn btn-outline-success w-100" onclick="applyLayout('operations')">
                              <div class="d-flex flex-column align-items-center py-2">
                                <i class="fas fa-cogs mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold">Operations</span>
                                <small class="text-muted">Daily Operations</small>
                              </div>
                            </button>
                          </div>
                          <div class="col-6 col-md-3">
                            <button class="btn btn-outline-info w-100" onclick="applyLayout('analytics')">
                              <div class="d-flex flex-column align-items-center py-2">
                                <i class="fas fa-chart-bar mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold">Analytics</span>
                                <small class="text-muted">Data Focus</small>
                              </div>
                            </button>
                          </div>
                          <div class="col-6 col-md-3">
                            <button class="btn btn-outline-warning w-100" onclick="applyLayout('minimal')">
                              <div class="d-flex flex-column align-items-center py-2">
                                <i class="fas fa-compress mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold">Minimal</span>
                                <small class="text-muted">Clean View</small>
                              </div>
                            </button>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Widget Management -->
                      <div class="col-md-12">
                        <h6 class="mb-3"><i class="fas fa-th me-2"></i>Widget Management</h6>
                        <div class="widget-selection-panel">
                          <div class="row g-2" id="widgetSelectionGrid">
                            <!-- Widget cards will be populated by JavaScript -->
                          </div>
                          <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center">
                              <small class="text-muted">Click widgets to toggle visibility • Changes are saved automatically</small>
                              <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success btn-sm" onclick="enableAllWidgets()" title="Enable All Widgets">
                                  <i class="fas fa-check-double me-1"></i>All On
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="disableAllWidgets()" title="Disable All Widgets">
                                  <i class="fas fa-times-circle me-1"></i>All Off
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customization Toggle Button -->
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h4 class="mb-0">Dashboard Overview</h4>
                    <small class="text-muted">Welcome back, Admin • Last login: <span id="lastLoginTime">Loading...</span> • Last updated: <span id="lastDashboardUpdate">Just now</span></small>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="toggleCustomizationPanel()" id="customizeBtn">
                      <i class="fas fa-palette me-2"></i>Customize Layout
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleFullscreenDashboard()">
                      <i class="fas fa-expand me-2"></i>Fullscreen
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="refreshDashboard()">
                      <i class="fas fa-sync-alt me-2"></i>Refresh All
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- KPI Cards Row -->
            <div class="row" data-widget="kpi-cards">
              <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-icon">
                        <div class="icon-big text-center icon-primary bubble-shadow-small">
                          <i class="fas fa-car"></i>
                        </div>
                      </div>
                      <div class="col col-stats ms-3">
                        <div class="numbers">
                          <p class="card-category">Fleet Utilization</p>
                          <h4 class="card-title">73.5%</h4>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-icon">
                        <div class="icon-big text-center icon-info bubble-shadow-small">
                          <i class="fas fa-calendar-check"></i>
                        </div>
                      </div>
                      <div class="col col-stats ms-3">
                        <div class="numbers">
                          <p class="card-category">Active Bookings</p>
                          <h4 class="card-title">47</h4>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-icon">
                        <div class="icon-big text-center icon-warning bubble-shadow-small">
                          <i class="fas fa-exclamation-triangle"></i>
                        </div>
                      </div>
                      <div class="col col-stats ms-3">
                        <div class="numbers">
                          <p class="card-category">Overdue Returns</p>
                          <h4 class="card-title">3</h4>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-icon">
                        <div class="icon-big text-center icon-success bubble-shadow-small">
                          <i class="fas fa-dollar-sign"></i>
                        </div>
                      </div>
                      <div class="col col-stats ms-3">
                        <div class="numbers">
                          <p class="card-category">Today's Revenue</p>
                          <h4 class="card-title">$8,450</h4>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Live Fleet Map Row -->
            <div class="row" data-widget="fleet-map">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header">
                    <div class="d-flex align-items-center">
                      <h4 class="card-title"><i class="fas fa-map-marked-alt me-2"></i>Live Fleet Tracking</h4>
                      <div class="ms-auto">
                        <button class="btn btn-outline-primary btn-sm me-2">
                          <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary btn-sm me-2">
                          <i class="fas fa-expand"></i> Fullscreen
                        </button>
                        <button id="toggleClusterBtn" class="btn btn-secondary btn-sm" type="button">
                          <i class="fas fa-layer-group"></i> Clustering
                        </button>
                        <button id="toggleGeofenceBtn" class="btn btn-outline-success btn-sm" type="button">
                          <i class="fas fa-draw-polygon"></i> Geofence Tool
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-2">
                    <div class="map-container">
                      <div id="fleetMap" style="height: 500px; width: 100%;"></div> 
                    </div>
                    <!-- Map Legend -->
                    <div class="map-legend p-3 border-top">
                      <div class="row">
                        <div class="col-md-8">
                          <div class="d-flex flex-wrap gap-3">
                            <div class="d-flex align-items-center">
                              <div class="map-marker-legend" style="width: 12px; height: 12px; background: #28a745; border-radius: 50%; margin-right: 5px;"></div>
                              <small>Available (120)</small>
                            </div>
                            <div class="d-flex align-items-center">
                              <div class="map-marker-legend" style="width: 12px; height: 12px; background: #007bff; border-radius: 50%; margin-right: 5px;"></div>
                              <small>Rented (86)</small>
                            </div>
                            <div class="d-flex align-items-center">
                              <div class="map-marker-legend" style="width: 12px; height: 12px; background: #ffc107; border-radius: 50%; margin-right: 5px;"></div>
                              <small>In Service (11)</small>
                            </div>
                            <div class="d-flex align-items-center">
                              <div class="map-marker-legend" style="width: 12px; height: 12px; background: #dc3545; border-radius: 50%; margin-right: 5px;"></div>
                              <small>Alert (16)</small>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-4 text-end">
                          <small class="text-muted">Last updated: <span id="lastUpdate">Just now</span></small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts and Data Row -->
            <div class="row" data-widget="financial-snapshot">
              <!-- Fleet Availability Chart -->
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <div class="card-title">Fleet Availability</div>
                  </div>
                  <div class="card-body">
                    <div class="chart-container d-flex justify-content-center">
                      <canvas id="fleetChart" style="width: 100%; height: 300px; max-width: 400px;"></canvas>
                    </div>
                    <div class="mt-3">
                      <div class="row text-center">
                        <div class="col-4">
                          <div class="d-flex align-items-center justify-content-center">
                            <div class="badge bg-success me-2" style="width: 12px; height: 12px;"></div>
                            <small>Available (120)</small>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="d-flex align-items-center justify-content-center">
                            <div class="badge bg-primary me-2" style="width: 12px; height: 12px;"></div>
                            <small>Booked (86)</small>
                          </div>
                        </div>
                        <div class="col-4">
                          <div class="d-flex align-items-center justify-content-center">
                            <div class="badge bg-warning me-2" style="width: 12px; height: 12px;"></div>
                            <small>Repair (11)</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Financial Snapshot -->
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <div class="card-title">Financial Snapshot</div>
                    <div class="ms-auto">
                      <!-- Mobile dropdown for small screens -->
                      <div class="dropdown d-md-none">
                        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                          <span id="mobile-period-text">Today</span>
                        </button>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#" onclick="setMobilePeriod('Today', 'fs-today')">Today</a></li>
                          <li><a class="dropdown-item" href="#" onclick="setMobilePeriod('Week', 'fs-week')">Week</a></li>
                          <li><a class="dropdown-item" href="#" onclick="setMobilePeriod('This Month', 'fs-month')">This Month</a></li>
                          <li><a class="dropdown-item" href="#" onclick="setMobilePeriod('Past Month', 'fs-lastmonth')">Past Month</a></li>
                          <li><a class="dropdown-item" href="#" onclick="setMobilePeriod('Custom', 'fs-custom')">Custom</a></li>
                        </ul>
                      </div>
                      <!-- Desktop button group -->
                      <div class="btn-group d-none d-md-flex" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm active" id="fs-today">Today</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="fs-week">Week</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="fs-month">This Month</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="fs-lastmonth">Past Month</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="fs-custom">Custom</button>
                      </div>
                      <div id="fs-custom-range" class="mt-2" style="display:none;">
                        <div class="d-flex flex-column flex-sm-row gap-2">
                          <input type="date" id="fs-date-from" class="form-control form-control-sm" />
                          <span class="align-self-center d-none d-sm-inline">to</span>
                          <input type="date" id="fs-date-to" class="form-control form-control-sm" />
                          <button class="btn btn-primary btn-sm" id="fs-apply-range">Apply</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-6">
                        <div class="text-center">
                          <h3 class="text-success">$8,450</h3>
                          <p class="text-muted mb-0">Today's Revenue</p>
                        </div>
                      </div>
                      <div class="col-6">
                        <div class="text-center">
                          <h3 class="text-info">$125,330</h3>
                          <p class="text-muted mb-0">This Month</p>
                        </div>
                      </div>
                    </div>
                    <hr>
                    <div class="row">
                      <div class="col-6">
                        <div class="text-center">
                          <h4 class="text-warning">$23,500</h4>
                          <p class="text-muted mb-0">Pending Deposits</p>
                        </div>
                      </div>
                      <div class="col-6">
                        <div class="text-center">
                          <h4 class="text-primary">$4,200</h4>
                          <p class="text-muted mb-0">Pending Refunds</p>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3">
                      <button class="btn btn-primary btn-sm me-2">View Transactions</button>
                      <button class="btn btn-outline-secondary btn-sm">Generate Report</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Revenue Analytics Row -->
            <div class="row mb-4" data-widget="revenue-charts">
              <div class="col-md-8">
                <div class="card">
                  <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                      <h4 class="card-title"><i class="fas fa-chart-line me-2"></i>Revenue Trends</h4>
                      <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="revenueTimeFilter" onchange="updateRevenueChart()" style="width: 150px;">
                          <option value="7">Last 7 Days</option>
                          <option value="30" selected>Last 30 Days</option>
                          <option value="90">Last 3 Months</option>
                        </select>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportRevenueData()">
                          <i class="fas fa-download"></i> Export
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <canvas id="revenueTrendChart" height="100"></canvas>
                    <div class="row mt-3">
                      <div class="col-md-3 text-center">
                        <h6 class="text-success">$284,573</h6>
                        <small class="text-muted">Total Revenue</small>
                      </div>
                      <div class="col-md-3 text-center">
                        <h6 class="text-info">$186,200</h6>
                        <small class="text-muted">Total Costs</small>
                      </div>
                      <div class="col-md-3 text-center">
                        <h6 class="text-primary">$98,373</h6>
                        <small class="text-muted">Net Profit</small>
                      </div>
                      <div class="col-md-3 text-center">
                        <h6 class="text-warning">34.6%</h6>
                        <small class="text-muted">Profit Margin</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <!-- Revenue by Category -->
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-pie-chart me-2"></i>Revenue Breakdown</h5>
                  </div>
                  <div class="card-body">
                    <canvas id="revenueBreakdownChart" height="200"></canvas>
                    <div class="mt-3">
                      <div class="d-flex justify-content-between mb-2">
                        <div class="d-flex align-items-center">
                          <div class="bg-primary rounded" style="width: 12px; height: 12px; margin-right: 8px;"></div>
                          <span>Vehicle Rentals</span>
                        </div>
                        <strong>69.7%</strong>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <div class="d-flex align-items-center">
                          <div class="bg-success rounded" style="width: 12px; height: 12px; margin-right: 8px;"></div>
                          <span>Insurance & Fees</span>
                        </div>
                        <strong>18.3%</strong>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <div class="d-flex align-items-center">
                          <div class="bg-warning rounded" style="width: 12px; height: 12px; margin-right: 8px;"></div>
                          <span>Fuel & Services</span>
                        </div>
                        <strong>12.0%</strong>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Advanced Quick Actions Panel -->
            <div class="row mb-4" data-widget="quick-actions">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions & Operations</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <!-- Emergency Actions -->
                      <div class="col-md-3">
                        <h6 class="text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Emergency</h6>
                        <div class="d-grid gap-2">
                          <button class="btn btn-danger btn-sm" onclick="emergencyVehicleDispatch()">
                            <i class="fas fa-ambulance me-2"></i>Emergency Dispatch
                          </button>
                          <button class="btn btn-warning btn-sm" onclick="lockdownMode()">
                            <i class="fas fa-lock me-2"></i>System Lockdown
                          </button>
                          <button class="btn btn-outline-danger btn-sm" onclick="broadcastAlert()">
                            <i class="fas fa-broadcast-tower me-2"></i>Broadcast Alert
                          </button>
                        </div>
                      </div>
                      
                      <!-- Daily Operations -->
                      <div class="col-md-3">
                        <h6 class="text-primary mb-3"><i class="fas fa-tasks me-2"></i>Daily Ops</h6>
                        <div class="d-grid gap-2">
                          <button class="btn btn-primary btn-sm" onclick="quickVehicleAssignment()">
                            <i class="fas fa-car me-2"></i>Assign Vehicle
                          </button>
                          <button class="btn btn-success btn-sm" onclick="instantCheckout()">
                            <i class="fas fa-check-circle me-2"></i>Quick Checkout
                          </button>
                          <button class="btn btn-info btn-sm" onclick="scheduleMaintenance()">
                            <i class="fas fa-wrench me-2"></i>Schedule Service
                          </button>
                        </div>
                      </div>
                      
                      <!-- Customer Support -->
                      <div class="col-md-3">
                        <h6 class="text-success mb-3"><i class="fas fa-headset me-2"></i>Customer Support</h6>
                        <div class="d-grid gap-2">
                          <button class="btn btn-success btn-sm" onclick="customerSupportChat()">
                            <i class="fas fa-comments me-2"></i>Live Chat
                          </button>
                          <button class="btn btn-outline-success btn-sm" onclick="processRefund()">
                            <i class="fas fa-undo me-2"></i>Process Refund
                          </button>
                          <button class="btn btn-outline-info btn-sm" onclick="escalateIssue()">
                            <i class="fas fa-arrow-up me-2"></i>Escalate Issue
                          </button>
                        </div>
                      </div>
                      
                      <!-- Reporting & Analytics -->
                      <div class="col-md-3">
                        <h6 class="text-info mb-3"><i class="fas fa-chart-bar me-2"></i>Reports</h6>
                        <div class="d-grid gap-2">
                          <button class="btn btn-info btn-sm" onclick="generateInstantReport()">
                            <i class="fas fa-file-alt me-2"></i>Instant Report
                          </button>
                          <button class="btn btn-outline-info btn-sm" onclick="exportDashboardData()">
                            <i class="fas fa-download me-2"></i>Export Data
                          </button>
                          <button class="btn btn-outline-secondary btn-sm" onclick="scheduleReport()">
                            <i class="fas fa-calendar-plus me-2"></i>Schedule Report
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Executive Summary Dashboard -->
            <div class="row mb-4" data-widget="executive-summary">
              <div class="col-md-8">
                <div class="card">
                  <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                      <h4 class="card-title"><i class="fas fa-chart-area me-2"></i>Executive Summary</h4>
                      <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="executivePeriodFilter" onchange="updateExecutiveSummary()" style="width: 150px;">
                          <option value="today">Today</option>
                          <option value="week" selected>This Week</option>
                          <option value="month">This Month</option>
                          <option value="quarter">This Quarter</option>
                        </select>
                        <button class="btn btn-outline-success btn-sm" onclick="exportExecutiveSummary()">
                          <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Executive KPIs -->
                    <div class="row mb-4">
                      <div class="col-md-3 text-center">
                        <div class="executive-metric">
                          <h3 class="text-primary mb-1" id="businessHealthScore">87%</h3>
                          <p class="text-muted mb-0">Business Health</p>
                          <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar bg-primary" style="width: 87%"></div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3 text-center">
                        <div class="executive-metric">
                          <h3 class="text-success mb-1" id="customerSatisfaction">4.6</h3>
                          <p class="text-muted mb-0">Customer Rating</p>
                          <div class="mt-2" id="customerStars">
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star-half-alt text-warning"></i>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3 text-center">
                        <div class="executive-metric">
                          <h3 class="text-warning mb-1" id="marketShare">23.4%</h3>
                          <p class="text-muted mb-0">Market Share</p>
                          <small class="text-success">+2.1% vs last period</small>
                        </div>
                      </div>
                      <div class="col-md-3 text-center">
                        <div class="executive-metric">
                          <h3 class="text-info mb-1" id="growthRate">+12.8%</h3>
                          <p class="text-muted mb-0">Growth Rate</p>
                          <small class="text-success">Above target (+10%)</small>
                        </div>
                      </div>
                    </div>

                    <!-- Performance Trends -->
                    <div class="row">
                      <div class="col-md-12">
                        <canvas id="executivePerformanceChart" height="80"></canvas>
                      </div>
                    </div>

                    <!-- Key Insights -->
                    <div class="row mt-3">
                      <div class="col-md-12">
                        <div class="alert alert-info">
                          <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Key Insights</h6>
                          <div class="row">
                            <div class="col-md-4">
                              <strong>🎯 Top Opportunity:</strong><br>
                              <small>Weekend bookings up 18% - consider dynamic pricing</small>
                            </div>
                            <div class="col-md-4">
                              <strong>⚠️ Risk Alert:</strong><br>
                              <small>Fleet utilization below optimal in Bronx branch</small>
                            </div>
                            <div class="col-md-4">
                              <strong>💡 Recommendation:</strong><br>
                              <small>Add 3 vehicles to Manhattan for peak demand</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <!-- Calendar Integration -->
                <div class="card">
                  <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title mb-0"><i class="fas fa-calendar-alt me-2"></i>Operations Calendar</h5>
                      <button class="btn btn-outline-primary btn-sm" onclick="openFullCalendar()">
                        <i class="fas fa-expand"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Mini Calendar -->
                    <div id="miniCalendar" class="mb-3">
                      <!-- Populated by JavaScript -->
                    </div>
                    
                    <!-- Today's Schedule -->
                    <div class="schedule-today">
                      <h6 class="mb-3">Today's Schedule</h6>
                      <div id="todaySchedule">
                        <!-- Populated by JavaScript -->
                      </div>
                    </div>

                    <!-- Quick Schedule Actions -->
                    <div class="mt-3 d-grid gap-2">
                      <button class="btn btn-primary btn-sm" onclick="scheduleMaintenanceSlot()">
                        <i class="fas fa-wrench me-2"></i>Schedule Maintenance
                      </button>
                      <button class="btn btn-success btn-sm" onclick="bookStaffMeeting()">
                        <i class="fas fa-users me-2"></i>Staff Meeting
                      </button>
                      <button class="btn btn-info btn-sm" onclick="planVehicleInspection()">
                        <i class="fas fa-clipboard-check me-2"></i>Vehicle Inspection
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Weather & Demand Forecast Widget -->
            <div class="row mb-4" data-widget="weather-demand">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-cloud-sun me-2"></i>Weather Impact & Demand</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="weather-info text-center mb-3">
                          <div class="weather-icon mb-2">
                            <i class="fas fa-sun text-warning" style="font-size: 2rem;"></i>
                          </div>
                          <h5 class="mb-1">72°F</h5>
                          <p class="text-muted mb-0">Sunny, Clear</p>
                          <small class="text-success">+15% booking impact</small>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="demand-forecast">
                          <h6 class="mb-2">Today's Forecast</h6>
                          <div class="mb-2">
                            <div class="d-flex justify-content-between">
                              <span>Expected Bookings</span>
                              <strong class="text-success">+23%</strong>
                            </div>
                            <div class="progress" style="height: 4px;">
                              <div class="progress-bar bg-success" style="width: 75%"></div>
                            </div>
                          </div>
                          <div class="mb-2">
                            <div class="d-flex justify-content-between">
                              <span>Peak Hours</span>
                              <strong>2PM - 6PM</strong>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <!-- Maintenance Alerts Widget -->
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-wrench me-2"></i>Maintenance Alerts</h5>
                  </div>
                  <div class="card-body">
                    <div id="maintenanceAlertsList">
                      <!-- Populated by JavaScript -->
                    </div>
                    <div class="mt-3">
                      <button class="btn btn-warning btn-sm w-100" onclick="openMaintenanceCenter()">
                        <i class="fas fa-tools me-1"></i>Maintenance Center
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer Insights & Branch Performance Row -->
            <div class="row mb-4" data-widget="customer-insights">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-users me-2"></i>Customer Insights</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="text-center">
                          <h4 class="text-primary">4.6</h4>
                          <p class="text-muted mb-1">Avg Rating</p>
                          <div class="rating-stars mb-2">
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star-half-alt text-warning"></i>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-center">
                          <h4 class="text-success">73%</h4>
                          <p class="text-muted mb-1">Repeat Rate</p>
                          <small class="text-success">+5% this month</small>
                        </div>
                      </div>
                    </div>
                    <div class="customer-segments mt-3">
                      <div class="d-flex justify-content-between mb-2">
                        <span>Corporate</span>
                        <strong class="text-primary">45%</strong>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span>Individual</span>
                        <strong class="text-success">38%</strong>
                      </div>
                      <div class="d-flex justify-content-between">
                        <span>Tourist</span>
                        <strong class="text-info">17%</strong>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <!-- Branch Performance Widget -->
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-building me-2"></i>Branch Performance</h5>
                  </div>
                  <div class="card-body">
                    <div id="branchPerformanceList">
                      <!-- Populated by JavaScript -->
                    </div>
                    <div class="mt-3">
                      <button class="btn btn-primary btn-sm w-100" onclick="openBranchAnalytics()">
                        <i class="fas fa-chart-line me-1"></i>Branch Analytics
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Fleet Usage Analytics Widget -->
            <div class="row mb-4" data-widget="fleet-usage">
              <div class="col-md-12">
                <div class="card fleet-usage-widget">
                  <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title mb-0"><i class="fas fa-tachometer-alt me-2"></i>Fleet Usage Analytics</h5>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="setUsagePeriod('today')">24 Hours</button>
                        <button class="btn btn-outline-primary" onclick="setUsagePeriod('week')">7 Days</button>
                        <button class="btn btn-outline-primary" onclick="setUsagePeriod('month')">12 Months</button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-3">
                    <div class="row">
                      <!-- Usage Summary Cards -->
                      <div class="col-md-3">
                        <div class="usage-summary-cards" style="max-height: 280px;">
                          <div class="usage-card mb-2">
                            <div class="usage-card-header">
                              <i class="fas fa-clock text-primary"></i>
                              <span>Total Usage Hours</span>
                            </div>
                            <div class="usage-card-value" id="totalUsageHours">847.5h</div>
                            <div class="usage-card-change text-success">+12.3% vs last period</div>
                          </div>
                          
                          <div class="usage-card mb-2">
                            <div class="usage-card-header">
                              <i class="fas fa-route text-warning"></i>
                              <span>Total Miles</span>
                            </div>
                            <div class="usage-card-value" id="totalMiles">12,847</div>
                            <div class="usage-card-change text-success">+8.7% vs last period</div>
                          </div>
                          
                          <div class="usage-card mb-2">
                            <div class="usage-card-header">
                              <i class="fas fa-percentage text-success"></i>
                              <span>Efficiency Rate</span>
                            </div>
                            <div class="usage-card-value" id="efficiencyRate">87.3%</div>
                            <div class="usage-card-change text-success">+2.1% vs last period</div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Usage Charts -->
                      <div class="col-md-9">
                        <div class="row">
                          <div class="col-md-8">
                            <div class="chart-container w-100">
                              <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Usage Pattern Over Time</h6>
                                <span class="badge bg-secondary" id="seasonalIndicator">Peak Season</span>
                              </div>
                              <div class="chart-wrapper w-100" style="height: 320px; position: relative;">
                                <canvas id="usagePatternChart" style="width: 100% !important; height: 100% !important;"></canvas>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-4">
                            <div class="chart-container w-100">
                              <h6 class="mb-3">Vehicle Type Distribution</h6>
                              <div class="chart-wrapper w-100" style="height: 320px; position: relative;">
                                <canvas id="vehicleTypeUsageChart" style="width: 100% !important; height: 100% !important;"></canvas>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Detailed Usage Table -->
                    <div class="row mt-3">
                      <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <h6 class="mb-0">Vehicle Usage Details</h6>
                          <button class="btn btn-outline-secondary btn-sm" onclick="toggleUsageTable()">
                            <i class="fas fa-chevron-down" id="tableToggleIcon"></i>
                            <span id="tableToggleText">Show Details</span>
                          </button>
                        </div>
                        <div class="table-responsive" id="usageTableContainer" style="display: none; max-height: 300px; overflow-y: auto;">
                          <table class="table table-hover table-sm">
                            <thead class="table-light sticky-top">
                              <tr>
                                <th>Vehicle</th>
                                <th>Usage Hours</th>
                                <th>Miles Driven</th>
                                <th>Efficiency</th>
                                <th>Peak Hours</th>
                                <th>Status</th>
                              </tr>
                            </thead>
                            <tbody id="usageDetailsTable">
                              <!-- Populated by JavaScript -->
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Critical Alerts & Notifications Widget -->
            <div class="row mb-4" data-widget="critical-alerts">
              <div class="col-md-12">
                <div class="card border-danger">
                  <div class="card-header bg-danger text-white">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Critical Alerts & Notifications
                        <span class="badge bg-light text-danger ms-2" id="criticalAlertCount">5</span>
                      </h5>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light btn-sm" onclick="filterAlerts('all')" id="alertFilterAll">All</button>
                        <button class="btn btn-outline-light btn-sm" onclick="filterAlerts('high')" id="alertFilterHigh">High</button>
                        <button class="btn btn-outline-light btn-sm" onclick="filterAlerts('medium')" id="alertFilterMedium">Medium</button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-3">
                    <div class="row">
                      <!-- Alert Summary Cards -->
                      <div class="col-md-3">
                        <div class="alert-summary-cards">
                          <div class="alert-summary-card bg-danger text-white mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-clock"></i>
                                <span class="ms-2">Overdue Returns</span>
                              </div>
                              <h4 class="mb-0" id="overdueCount">3</h4>
                            </div>
                          </div>
                          
                          <div class="alert-summary-card bg-warning text-dark mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-shield-alt"></i>
                                <span class="ms-2">Insurance Expiring</span>
                              </div>
                              <h4 class="mb-0" id="insuranceCount">2</h4>
                            </div>
                          </div>
                          
                          <div class="alert-summary-card bg-info text-white mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-credit-card"></i>
                                <span class="ms-2">Payment Issues</span>
                              </div>
                              <h4 class="mb-0" id="paymentCount">1</h4>
                            </div>
                          </div>
                          
                          <div class="alert-summary-card bg-secondary text-white mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-tools"></i>
                                <span class="ms-2">Maintenance Due</span>
                              </div>
                              <h4 class="mb-0" id="maintenanceCount">4</h4>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Critical Alerts List -->
                      <div class="col-md-9">
                        <div class="critical-alerts-container" style="max-height: 350px; overflow-y: auto;">
                          <div id="criticalAlertsList">
                            <!-- Populated by JavaScript -->
                          </div>
                        </div>
                        
                        <!-- Alert Actions -->
                        <div class="mt-3">
                          <div class="btn-group w-100">
                            <button class="btn btn-danger btn-sm" onclick="handleEmergencyAlert()">
                              <i class="fas fa-phone me-1"></i>Emergency Response
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="acknowledgeAllAlerts()">
                              <i class="fas fa-check me-1"></i>Acknowledge All
                            </button>
                            <button class="btn btn-info btn-sm" onclick="openAlertCenter()">
                              <i class="fas fa-bell me-1"></i>Alert Center
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="generateAlertReport()">
                              <i class="fas fa-file-alt me-1"></i>Report
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Upcoming Bookings & Top Customers Row -->
            <div class="row mb-4" data-widget="upcoming-bookings">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-calendar-plus me-2"></i>Upcoming Bookings</h5>
                  </div>
                  <div class="card-body">
                    <div id="upcomingBookingsList">
                      <!-- Populated by JavaScript -->
                    </div>
                    <div class="mt-3">
                      <button class="btn btn-info btn-sm w-100" onclick="openBookingCenter()">
                        <i class="fas fa-calendar-alt me-1"></i>Booking Center
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <!-- Top Customers Widget -->
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-crown me-2"></i>VIP Customers</h5>
                  </div>
                  <div class="card-body">
                    <div id="topCustomersList">
                      <!-- Populated by JavaScript -->
                    </div>
                    <div class="mt-3">
                      <button class="btn btn-success btn-sm w-100" onclick="openCustomerCenter()">
                        <i class="fas fa-users me-1"></i>Customer Center
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Active Reservations and Alerts Row -->
            <div class="row" data-widget="reservations">
              <!-- Today's Active Reservations -->
              <div class="col-md-8">
                <div class="card">
                  <div class="card-header">
                    <div class="d-flex align-items-center">
                      <h4 class="card-title">Today's Active Reservations</h4>
                      <button class="btn btn-primary btn-round ms-auto btn-sm">
                        <i class="fa fa-plus"></i> New Booking
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th scope="col">Customer</th>
                            <th scope="col">Vehicle</th>
                            <th scope="col">Pickup Time</th>
                            <th scope="col">Status</th>
                            <th scope="col">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>John Smith</td>
                            <td>Toyota Camry - ABC123</td>
                            <td>09:30 AM</td>
                            <td><span class="badge bg-success">Ready</span></td>
                            <td>
                              <button class="btn btn-primary btn-xs">Check-out</button>
                            </td>
                          </tr>
                          <tr>
                            <td>Sarah Johnson</td>
                            <td>Honda CR-V - XYZ789</td>
                            <td>11:00 AM</td>
                            <td><span class="badge bg-warning">Preparing</span></td>
                            <td>
                              <button class="btn btn-outline-primary btn-xs">View</button>
                            </td>
                          </tr>
                          <tr>
                            <td>Mike Davis</td>
                            <td>Ford Focus - DEF456</td>
                            <td>02:15 PM</td>
                            <td><span class="badge bg-info">Confirmed</span></td>
                            <td>
                              <button class="btn btn-outline-primary btn-xs">View</button>
                            </td>
                          </tr>
                          <tr>
                            <td>Lisa Wong</td>
                            <td>Nissan Altima - GHI012</td>
                            <td>04:30 PM</td>
                            <td><span class="badge bg-danger">Overdue Return</span></td>
                            <td>
                              <button class="btn btn-warning btn-xs">Contact</button>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Enhanced Alerts & Real-Time Status Panel -->
              <div class="col-md-4">
                <!-- Enhanced Alert System -->
                <div class="card">
                  <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title mb-0"><i class="fas fa-bell me-2"></i>Live Alerts</h5>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-danger btn-sm active" onclick="filterAlerts('all')" title="All Alerts">
                          <i class="fas fa-list"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="filterAlerts('critical')" title="Critical Only">
                          <i class="fas fa-exclamation-triangle"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="filterAlerts('info')" title="Info">
                          <i class="fas fa-info"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="liveAlertsList">
                      <!-- Populated by JavaScript -->
                    </div>
                    <div class="mt-3">
                      <button class="btn btn-primary btn-sm w-100" onclick="showAlertCenter()">
                        <i class="fas fa-cog me-1"></i>Alert Center
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Real-Time Staff & Vehicle Status -->
                <div class="card mt-3">
                  <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-pulse me-2"></i>Real-Time Status</h5>
                  </div>
                  <div class="card-body">
                    <!-- Staff Status -->
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Staff Online</h6>
                        <span class="badge bg-success" id="staffOnlineCount">18/28</span>
                      </div>
                      <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: 64%" id="staffOnlineProgress"></div>
                      </div>
                    </div>
                    
                    <!-- Vehicle Status -->
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Active Vehicles</h6>
                        <span class="badge bg-info" id="activeVehicleCount">108/120</span>
                      </div>
                      <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-info" style="width: 90%" id="activeVehicleProgress"></div>
                      </div>
                    </div>

                    <!-- Branch Capacity -->
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Total Capacity</h6>
                        <span class="badge bg-warning" id="totalCapacityCount">187/200</span>
                      </div>
                      <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-warning" style="width: 94%" id="totalCapacityProgress"></div>
                      </div>
                    </div>

                    <button class="btn btn-outline-primary btn-sm w-100" onclick="showRealTimeMonitoring()">
                      <i class="fas fa-eye me-1"></i>Live Dashboard
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- JS Files -->
    <script src="assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="assets/js/core/popper.min.js"></script>
    <script src="assets/js/core/bootstrap.min.js"></script>
    <script src="assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="assets/js/lynxlite.min.js"></script>
    
    <!-- Chart.js for Fleet Availability Pie Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script>
      // Dark mode toggle logic
      function setDarkMode(enabled) {
        if (enabled) {
          document.body.classList.add('dark-mode');
        } else {
          document.body.classList.remove('dark-mode');
        }
      }

      // Main DOMContentLoaded event - consolidating all initialization
      document.addEventListener('DOMContentLoaded', function() {
        // === DARK MODE INITIALIZATION ===
        const darkModeSwitch = document.getElementById('darkModeSwitch');
        const darkPref = localStorage.getItem('darkMode') === 'true';
        setDarkMode(darkPref);
        if (darkModeSwitch) {
          darkModeSwitch.checked = darkPref;
          darkModeSwitch.addEventListener('change', function() {
            setDarkMode(this.checked);
            localStorage.setItem('darkMode', this.checked);
          });
        }

        // === FINANCIAL SNAPSHOT FILTERS ===
        const btns = ['fs-today', 'fs-week', 'fs-month', 'fs-lastmonth', 'fs-custom'];
        btns.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.addEventListener('click', function() {
              btns.forEach(bid => {
                const b = document.getElementById(bid);
                if (b) b.classList.remove('active');
              });
              btn.classList.add('active');
              const customRange = document.getElementById('fs-custom-range');
              if (customRange) {
                customRange.style.display = (id === 'fs-custom') ? '' : 'none';
              }
            });
          }
        });

        const applyRangeBtn = document.getElementById('fs-apply-range');
        if (applyRangeBtn) {
          applyRangeBtn.addEventListener('click', function() {
            // TODO: Add logic to update the snapshot data for the selected range
          });
        }

        // === MOBILE PERIOD SELECTOR ===
        window.setMobilePeriod = function(text, buttonId) {
          document.getElementById('mobile-period-text').textContent = text;
          // Trigger the same logic as desktop buttons
          const btn = document.getElementById(buttonId);
          if (btn) {
            btn.click();
          }
        };

        // === CHART INITIALIZATION ===
        initializeAllCharts();

        // === MAP INITIALIZATION ===
        try {
          initFleetMap();
        } catch (error) {
          console.error('Error initializing fleet map:', error);
          showMapError();
        }

        // === SIDEBAR TOGGLE FUNCTIONALITY ===
        initializeSidebarToggles();

        // === SEARCH FUNCTIONALITY ===
        initializeSearchFunctionality();

        // === RESERVATION MANAGEMENT ===
        initializeReservationManagement();

        // === ENHANCED FEATURES INITIALIZATION ===
        initializeLoginTracking();
        initializeEnhancedAlerts();
        initializeRealTimeStatus();
        initializeExecutiveSummary();
        initializeCalendarIntegration();
        initializeLayoutCustomization();
        initializeWidgetSelectionPanel();
        initializeNewWidgets();
        initializeFleetUsageWidget();
        initializeCriticalAlertsWidget();
        
        // Add keyboard shortcut for feedback (Ctrl+Shift+F)
        document.addEventListener('keydown', function(e) {
          if (e.ctrlKey && e.shiftKey && e.key === 'F') {
            e.preventDefault();
            openFeedbackModal();
          }
        });
      });

      // === ENHANCED CHART INITIALIZATION ===
      function initializeAllCharts() {
        // Fleet Chart
        const fleetCtx = document.getElementById('fleetChart');
        if (fleetCtx) {
          new Chart(fleetCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['Available', 'Booked', 'Under Repair'],
              datasets: [{
                data: [120, 86, 11],
                backgroundColor: ['#28a745', '#007bff', '#ffc107'],
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.parsed;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((value / total) * 100).toFixed(1);
                      return `${label}: ${value} vehicles (${percentage}%)`;
                    }
                  }
                }
              },
              cutout: '60%'
            }
          });
        }

        // Revenue Trend Chart
        const revenueTrendCtx = document.getElementById('revenueTrendChart');
        if (revenueTrendCtx) {
          window.revenueTrendChart = new Chart(revenueTrendCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
              datasets: [{
                label: 'Revenue',
                data: [68450, 72180, 75920, 68023],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
              }, {
                label: 'Costs',
                data: [44200, 46800, 49100, 44200],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
              }, {
                label: 'Profit',
                data: [24250, 25380, 26820, 23823],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }

        // Revenue Breakdown Chart
        const revenueBreakdownCtx = document.getElementById('revenueBreakdownChart');
        if (revenueBreakdownCtx) {
          new Chart(revenueBreakdownCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['Vehicle Rentals', 'Insurance & Fees', 'Fuel & Services'],
              datasets: [{
                data: [198450, 52180, 33943],
                backgroundColor: ['#007bff', '#28a745', '#ffc107']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }

        // Executive Performance Chart
        const executiveCtx = document.getElementById('executivePerformanceChart');
        if (executiveCtx) {
          window.executiveChart = new Chart(executiveCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
              datasets: [{
                label: 'Business Health Score',
                data: [82, 85, 87, 89, 88, 91, 87],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
              }, {
                label: 'Customer Satisfaction',
                data: [4.2, 4.4, 4.5, 4.6, 4.5, 4.7, 4.6],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true,
                yAxisID: 'y1'
              }, {
                label: 'Fleet Utilization %',
                data: [68, 72, 75, 78, 76, 82, 74],
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                y: { 
                  beginAtZero: true, 
                  max: 100,
                  position: 'left'
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  min: 0,
                  max: 5,
                  grid: {
                    drawOnChartArea: false,
                  },
                }
              }
            }
          });
        }
      }

      // === ENHANCED ALERT SYSTEM ===
      let allAlerts = [];
      let currentAlertFilter = 'all';

      function initializeEnhancedAlerts() {
        allAlerts = [
          { id: 1, type: 'maintenance', message: 'Honda Civic - ABC123 due for service', severity: 'warning', time: '2 min ago', vehicle: 'ABC123' },
          { id: 2, type: 'insurance', message: 'BMW X3 insurance expires in 3 days', severity: 'critical', time: '5 min ago', vehicle: 'GHI345' },
          { id: 3, type: 'geofence', message: 'Mercedes C-Class left authorized area', severity: 'high', time: '8 min ago', vehicle: 'MNO345' },
          { id: 4, type: 'fuel', message: '3 vehicles below 25% fuel level', severity: 'medium', time: '12 min ago', vehicle: 'Multiple' },
          { id: 5, type: 'overdue', message: 'Toyota Camry overdue return (2 hours)', severity: 'high', time: '15 min ago', vehicle: 'DEF456' }
        ];
        
        updateLiveAlerts();
        
        // Simulate real-time alerts every 45 seconds
        setInterval(() => {
          if (Math.random() > 0.85) { // 15% chance
            generateRandomAlert();
          }
        }, 45000);
      }

      function updateLiveAlerts() {
        const filteredAlerts = currentAlertFilter === 'all' ? 
          allAlerts : allAlerts.filter(a => a.severity === currentAlertFilter);
        
        const container = document.getElementById('liveAlertsList');
        if (!container) return;
        
        container.innerHTML = filteredAlerts.slice(0, 5).map(alert => `
          <div class="alert-item d-flex justify-content-between align-items-start p-2 mb-2 border-start border-3 border-${getSeverityColor(alert.severity)} ${alert.severity === 'critical' ? 'bg-danger bg-opacity-10' : ''}">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center mb-1">
                <i class="fas ${getAlertIcon(alert.type)} me-2"></i>
                <span class="fw-bold small">${alert.message}</span>
              </div>
              <small class="text-muted">${alert.time} • ${alert.vehicle}</small>
            </div>
            <div class="d-flex gap-1">
              <button class="btn btn-outline-primary btn-sm" onclick="handleAlert(${alert.id})" title="Handle">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="dismissAlert(${alert.id})" title="Dismiss">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        `).join('');
      }

      // === REAL-TIME STATUS MONITORING ===
      function initializeRealTimeStatus() {
        updateRealTimeStatus();
        setInterval(updateRealTimeStatus, 20000); // Update every 20 seconds
      }

      function updateRealTimeStatus() {
        // Staff Online Status
        const staffOnline = Math.floor(16 + Math.random() * 12); // 16-28 range
        const staffTotal = 28;
        const staffPercentage = Math.round((staffOnline / staffTotal) * 100);
        
        document.getElementById('staffOnlineCount').textContent = `${staffOnline}/${staffTotal}`;
        document.getElementById('staffOnlineProgress').style.width = `${staffPercentage}%`;
        
        // Active Vehicles
        const activeVehicles = Math.floor(100 + Math.random() * 20); // 100-120 range
        const vehicleTotal = 120;
        const vehiclePercentage = Math.round((activeVehicles / vehicleTotal) * 100);
        
        document.getElementById('activeVehicleCount').textContent = `${activeVehicles}/${vehicleTotal}`;
        document.getElementById('activeVehicleProgress').style.width = `${vehiclePercentage}%`;
        
        // Total Capacity
        const totalCapacity = Math.floor(180 + Math.random() * 20); // 180-200 range
        const capacityTotal = 200;
        const capacityPercentage = Math.round((totalCapacity / capacityTotal) * 100);
        
        document.getElementById('totalCapacityCount').textContent = `${totalCapacity}/${capacityTotal}`;
        document.getElementById('totalCapacityProgress').style.width = `${capacityPercentage}%`;
      }

      // === EXECUTIVE SUMMARY DASHBOARD ===
      function initializeExecutiveSummary() {
        updateExecutiveMetrics();
        setInterval(updateExecutiveMetrics, 60000); // Update every minute
      }

      function updateExecutiveMetrics() {
        // Business Health Score (80-95% range)
        const healthScore = Math.floor(80 + Math.random() * 15);
        document.getElementById('businessHealthScore').textContent = `${healthScore}%`;
        document.querySelector('#businessHealthScore').parentElement.querySelector('.progress-bar').style.width = `${healthScore}%`;
        
        // Customer Satisfaction (4.0-5.0 range)
        const satisfaction = (4.0 + Math.random() * 1.0).toFixed(1);
        document.getElementById('customerSatisfaction').textContent = satisfaction;
        updateStarRating(satisfaction);
        
        // Market Share (20-30% range)
        const marketShare = (20 + Math.random() * 10).toFixed(1);
        document.getElementById('marketShare').textContent = `${marketShare}%`;
        
        // Growth Rate (8-18% range)
        const growthRate = (8 + Math.random() * 10).toFixed(1);
        document.getElementById('growthRate').textContent = `+${growthRate}%`;
      }

      function updateStarRating(rating) {
        const container = document.getElementById('customerStars');
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        
        let stars = '';
        for (let i = 0; i < fullStars; i++) {
          stars += '<i class="fas fa-star text-warning"></i>';
        }
        if (hasHalfStar) {
          stars += '<i class="fas fa-star-half-alt text-warning"></i>';
        }
        const emptyStars = 5 - Math.ceil(rating);
        for (let i = 0; i < emptyStars; i++) {
          stars += '<i class="far fa-star text-muted"></i>';
        }
        
        container.innerHTML = stars;
      }

      function updateExecutiveSummary() {
        const period = document.getElementById('executivePeriodFilter').value;
        console.log('Updating executive summary for period:', period);
        
        // Update executive chart based on period
        if (window.executiveChart) {
          let newLabels, newData;
          
          switch(period) {
            case 'today':
              newLabels = ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'];
              newData = [
                [75, 82, 87, 89, 85, 78],
                [4.1, 4.3, 4.6, 4.7, 4.5, 4.4],
                [45, 68, 74, 78, 72, 58]
              ];
              break;
            case 'month':
              newLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
              newData = [
                [84, 87, 89, 87],
                [4.3, 4.5, 4.6, 4.6],
                [71, 75, 78, 74]
              ];
              break;
            case 'quarter':
              newLabels = ['Month 1', 'Month 2', 'Month 3'];
              newData = [
                [85, 88, 87],
                [4.4, 4.6, 4.6],
                [73, 76, 74]
              ];
              break;
            default: // week
              newLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
              newData = [
                [82, 85, 87, 89, 88, 91, 87],
                [4.2, 4.4, 4.5, 4.6, 4.5, 4.7, 4.6],
                [68, 72, 75, 78, 76, 82, 74]
              ];
          }
          
          window.executiveChart.data.labels = newLabels;
          window.executiveChart.data.datasets[0].data = newData[0];
          window.executiveChart.data.datasets[1].data = newData[1];
          window.executiveChart.data.datasets[2].data = newData[2];
          window.executiveChart.update();
        }
      }

      // === CALENDAR INTEGRATION ===
      function initializeCalendarIntegration() {
        generateMiniCalendar();
        populateTodaySchedule();
        
        // Update schedule every 30 minutes
        setInterval(populateTodaySchedule, 1800000);
      }

      function generateMiniCalendar() {
        const container = document.getElementById('miniCalendar');
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        const currentDate = today.getDate();
        
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        let calendarHTML = `
          <div class="mini-calendar">
            <div class="calendar-header text-center mb-2">
              <h6 class="mb-0">${monthNames[currentMonth]} ${currentYear}</h6>
            </div>
            <div class="calendar-grid">
              <div class="row text-center mb-1">
                <div class="col calendar-day-header"><small>S</small></div>
                <div class="col calendar-day-header"><small>M</small></div>
                <div class="col calendar-day-header"><small>T</small></div>
                <div class="col calendar-day-header"><small>W</small></div>
                <div class="col calendar-day-header"><small>T</small></div>
                <div class="col calendar-day-header"><small>F</small></div>
                <div class="col calendar-day-header"><small>S</small></div>
              </div>
        `;
        
        let dayCount = 1;
        for (let week = 0; week < 6; week++) {
          calendarHTML += '<div class="row text-center mb-1">';
          for (let day = 0; day < 7; day++) {
            if ((week === 0 && day < firstDay) || dayCount > daysInMonth) {
              calendarHTML += '<div class="col calendar-day"></div>';
            } else {
              const isToday = dayCount === currentDate;
              const hasEvent = Math.random() > 0.7; // 30% chance of event
              calendarHTML += `
                <div class="col calendar-day">
                  <small class="calendar-date ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}" 
                         onclick="showDaySchedule(${dayCount})">${dayCount}</small>
                </div>
              `;
              dayCount++;
            }
          }
          calendarHTML += '</div>';
          if (dayCount > daysInMonth) break;
        }
        
        calendarHTML += '</div></div>';
        container.innerHTML = calendarHTML;
      }

      function populateTodaySchedule() {
        const container = document.getElementById('todaySchedule');
        const scheduleItems = [
          { time: '09:00', type: 'maintenance', title: 'Honda Civic Service', priority: 'high' },
          { time: '11:30', type: 'meeting', title: 'Staff Briefing', priority: 'medium' },
          { time: '14:00', type: 'inspection', title: 'Fleet Inspection', priority: 'high' },
          { time: '16:30', type: 'customer', title: 'VIP Customer Pickup', priority: 'high' },
          { time: '18:00', type: 'maintenance', title: 'BMW X3 Oil Change', priority: 'medium' }
        ];
        
        container.innerHTML = scheduleItems.map(item => `
          <div class="schedule-item d-flex justify-content-between align-items-center p-2 mb-2 border rounded ${getPriorityClass(item.priority)}">
            <div class="d-flex align-items-center">
              <div class="schedule-time me-3">
                <strong>${item.time}</strong>
              </div>
              <div>
                <div class="fw-bold">${item.title}</div>
                <small class="text-muted">${getScheduleTypeIcon(item.type)} ${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</small>
              </div>
            </div>
            <span class="badge bg-${getPriorityColor(item.priority)}">${item.priority}</span>
          </div>
        `).join('');
      }

      function getPriorityClass(priority) {
        return priority === 'high' ? 'border-warning' : '';
      }

      function getPriorityColor(priority) {
        const colors = { high: 'danger', medium: 'warning', low: 'info' };
        return colors[priority] || 'secondary';
      }

      function getScheduleTypeIcon(type) {
        const icons = {
          maintenance: '🔧',
          meeting: '👥',
          inspection: '📋',
          customer: '👤'
        };
        return icons[type] || '📅';
      }

      // === LAYOUT CUSTOMIZATION SYSTEM ===
      let layoutPreferences = {
        widgets: {
          'kpi-cards': true,
          'revenue-charts': true,
          'executive-summary': true,
          'quick-actions': true,
          'fleet-map': true,
          'reservations': true,
          'financial-snapshot': true,
          'weather-demand': true,
          'customer-insights': true,
          'upcoming-bookings': true,
          'fleet-usage': true,
          'critical-alerts': true
        },
        density: 'compact',
        updateFrequency: 30,
        animations: true
      };

      function initializeWidgetSelectionPanel() {
        const container = document.getElementById('widgetSelectionGrid');
        if (!container) return;

        const widgets = [
          { id: 'kpi-cards', name: 'KPI Cards', icon: 'fas fa-chart-bar', description: 'Key performance metrics' },
          { id: 'revenue-charts', name: 'Revenue Charts', icon: 'fas fa-chart-line', description: 'Financial analytics' },
          { id: 'executive-summary', name: 'Executive Summary', icon: 'fas fa-crown', description: 'Management insights' },
          { id: 'quick-actions', name: 'Quick Actions', icon: 'fas fa-bolt', description: 'Operational shortcuts' },
          { id: 'fleet-map', name: 'Fleet Map', icon: 'fas fa-map-marked-alt', description: 'Live vehicle tracking' },
          { id: 'reservations', name: 'Reservations', icon: 'fas fa-calendar-check', description: 'Active bookings' },
          { id: 'financial-snapshot', name: 'Financial Snapshot', icon: 'fas fa-money-bill-wave', description: 'Financial overview' },
          { id: 'weather-demand', name: 'Weather & Demand', icon: 'fas fa-cloud-sun', description: 'Weather impact analysis' },
          { id: 'customer-insights', name: 'Customer Insights', icon: 'fas fa-users', description: 'Customer analytics' },
          { id: 'upcoming-bookings', name: 'Upcoming Bookings', icon: 'fas fa-calendar-plus', description: 'Booking pipeline' },
          { id: 'fleet-usage', name: 'Fleet Usage', icon: 'fas fa-tachometer-alt', description: 'Fleet usage analytics and patterns' },
          { id: 'critical-alerts', name: 'Critical Alerts', icon: 'fas fa-exclamation-triangle', description: 'Urgent notifications and alerts' }
        ];

        container.innerHTML = widgets.map(widget => `
          <div class="col-6 col-sm-4 col-md-3 col-lg-2">
            <div class="widget-card ${layoutPreferences.widgets[widget.id] ? 'active' : 'inactive'}" 
                 data-widget-id="${widget.id}" 
                 onclick="toggleWidgetCard('${widget.id}')"
                 title="${widget.description}">
              <div class="widget-card-status"></div>
              <i class="widget-card-icon ${widget.icon}"></i>
              <p class="widget-card-title">${widget.name}</p>
            </div>
          </div>
        `).join('');
      }

      function toggleWidgetCard(widgetId) {
        try {
          // Validate widget ID
          if (!widgetId || typeof widgetId !== 'string') {
            console.error('Invalid widget ID provided:', widgetId);
            showNotification('Error: Invalid widget ID', 'danger');
            return false;
          }
          
          // Check if widget exists in preferences
          if (!(widgetId in layoutPreferences.widgets)) {
            console.error('Widget not found in preferences:', widgetId);
            showNotification(`Error: Widget "${widgetId}" not found`, 'danger');
            return false;
          }
          
          const card = document.querySelector(`[data-widget-id="${widgetId}"]`);
          const widget = document.querySelector(`[data-widget="${widgetId}"]`);
          
          if (!card) {
            console.error('Widget card not found:', widgetId);
            showNotification('Error: Widget card not found', 'danger');
            return false;
          }
          
          if (!widget) {
            console.warn('Widget element not found (may not be rendered yet):', widgetId);
          }
          
          // Get current state
          const wasActive = layoutPreferences.widgets[widgetId];
          const willBeActive = !wasActive;
          
          // Update preferences
          layoutPreferences.widgets[widgetId] = willBeActive;
          
          // Update card appearance with enhanced feedback
          updateCardState(card, willBeActive, widgetId);
          
          // Update widget visibility if element exists
          if (widget) {
            updateWidgetVisibility(widget, willBeActive, widgetId);
          }
          
          // Update UI components
          updateWidgetCounter();
          updateDashboardStats();
          
          // Save preferences automatically with debouncing
          debouncedSave();
          
          // Track analytics
          trackEvent('widget_toggled', {
            widget_id: widgetId,
            action: willBeActive ? 'enabled' : 'disabled',
            total_active: Object.values(layoutPreferences.widgets).filter(Boolean).length
          });
          
          return true;
          
        } catch (error) {
          console.error('Error toggling widget card:', error);
          showNotification('An error occurred while toggling the widget', 'danger');
          return false;
        }
      }

      function updateCardState(card, isActive, widgetId) {
        if (!card) return;
        
        // Remove existing states
        card.classList.remove('active', 'inactive', 'transitioning');
        
        // Add transitioning state
        card.classList.add('transitioning');
        
        // Update state after brief delay for smooth animation
        setTimeout(() => {
          card.classList.remove('transitioning');
          card.classList.add(isActive ? 'active' : 'inactive');
          
          // Add pulse effect for visual feedback
          card.classList.add('pulse-effect');
          setTimeout(() => card.classList.remove('pulse-effect'), 600);
          
          // Visual feedback notification
          const widgetName = getWidgetName(widgetId);
          const message = `${widgetName} ${isActive ? 'enabled' : 'disabled'}`;
          const type = isActive ? 'success' : 'warning';
          
          showNotification(message, type);
        }, 50);
      }

      function updateWidgetVisibility(widget, isVisible, widgetId) {
        if (!widget) return;
        
        if (isVisible) {
          // Show widget with smooth animation
          widget.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
          widget.style.display = '';
          widget.style.opacity = '0';
          widget.style.transform = 'translateY(-20px) scale(0.95)';
          
          // Force reflow
          widget.offsetHeight;
          
          setTimeout(() => {
            widget.style.opacity = '1';
            widget.style.transform = 'translateY(0) scale(1)';
          }, 10);
          
          // Clean up transition after animation
          setTimeout(() => {
            widget.style.transition = '';
          }, 400);
          
        } else {
          // Hide widget with smooth animation
          widget.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
          widget.style.opacity = '0';
          widget.style.transform = 'translateY(-20px) scale(0.95)';
          
          setTimeout(() => {
            widget.style.display = 'none';
            widget.style.transition = '';
          }, 300);
        }
      }

      // Debounced save function to prevent excessive localStorage writes
      let saveTimeout;
      function debouncedSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          saveLayoutPreferences();
        }, 500);
      }

      function getWidgetName(widgetId) {
        const names = {
          'kpi-cards': 'KPI Cards',
          'revenue-charts': 'Revenue Charts',
          'executive-summary': 'Executive Summary',
          'quick-actions': 'Quick Actions',
          'fleet-map': 'Fleet Map',
          'reservations': 'Reservations',
          'financial-snapshot': 'Financial Snapshot',
          'weather-demand': 'Weather & Demand',
          'customer-insights': 'Customer Insights',
          'upcoming-bookings': 'Upcoming Bookings',
          'fleet-usage': 'Fleet Usage',
          'critical-alerts': 'Critical Alerts'
        };
        return names[widgetId] || widgetId;
      }

      function updateWidgetCounter() {
        const activeCount = Object.values(layoutPreferences.widgets).filter(Boolean).length;
        const totalCount = Object.keys(layoutPreferences.widgets).length;
        const counter = document.getElementById('selectedWidgetCount');
        if (counter) {
          counter.textContent = `${activeCount}/${totalCount} widgets selected`;
          counter.className = `badge me-2 ${activeCount === totalCount ? 'bg-success text-white' : activeCount > totalCount/2 ? 'bg-warning text-dark' : 'bg-light text-primary'}`;
        }
      }

      function updateWidgetCards() {
        try {
          Object.keys(layoutPreferences.widgets).forEach(widgetId => {
            const card = document.querySelector(`[data-widget-id="${widgetId}"]`);
            const isActive = layoutPreferences.widgets[widgetId];
            
            if (card) {
              // Remove all state classes
              card.classList.remove('active', 'inactive', 'transitioning', 'pulse-effect');
              
              // Add appropriate state class
              card.classList.add(isActive ? 'active' : 'inactive');
              
              // Update accessibility attributes
              card.setAttribute('aria-pressed', isActive.toString());
              card.setAttribute('title', `${getWidgetName(widgetId)} - ${isActive ? 'Enabled' : 'Disabled'}`);
            } else {
              console.warn(`Widget card not found: ${widgetId}`);
            }
          });
        } catch (error) {
          console.error('Error updating widget cards:', error);
        }
      }

      function updateDashboardStats() {
        try {
          const totalWidgets = Object.keys(layoutPreferences.widgets).length;
          const activeWidgets = Object.values(layoutPreferences.widgets).filter(Boolean).length;
          const inactiveWidgets = totalWidgets - activeWidgets;
          
          // Update stats in customization panel if elements exist
          const statsElements = {
            total: document.getElementById('totalWidgetCount'),
            active: document.getElementById('activeWidgetCount'),
            inactive: document.getElementById('inactiveWidgetCount')
          };
          
          if (statsElements.total) statsElements.total.textContent = totalWidgets;
          if (statsElements.active) statsElements.active.textContent = activeWidgets;
          if (statsElements.inactive) statsElements.inactive.textContent = inactiveWidgets;
          
          // Update dashboard performance metrics
          updatePerformanceMetrics(activeWidgets, totalWidgets);
          
        } catch (error) {
          console.error('Error updating dashboard stats:', error);
        }
      }

      function updatePerformanceMetrics(activeWidgets, totalWidgets) {
        const utilizationPercentage = Math.round((activeWidgets / totalWidgets) * 100);
        
        // Update any performance indicators
        const perfIndicator = document.getElementById('dashboardUtilization');
        if (perfIndicator) {
          perfIndicator.textContent = `${utilizationPercentage}%`;
          perfIndicator.className = `badge ${utilizationPercentage > 80 ? 'bg-success' : utilizationPercentage > 50 ? 'bg-warning' : 'bg-danger'}`;
        }
      }

      // Analytics tracking function
      function trackEvent(eventName, properties = {}) {
        try {
          // Basic analytics tracking - can be extended with real analytics service
          const event = {
            name: eventName,
            timestamp: new Date().toISOString(),
            properties: {
              ...properties,
              page: 'dashboard',
              user_agent: navigator.userAgent,
              viewport: `${window.innerWidth}x${window.innerHeight}`
            }
          };
          
          // Store in localStorage for now (replace with real analytics)
          const analytics = JSON.parse(localStorage.getItem('dashboard_analytics') || '[]');
          analytics.push(event);
          
          // Keep only last 100 events
          if (analytics.length > 100) {
            analytics.splice(0, analytics.length - 100);
          }
          
          localStorage.setItem('dashboard_analytics', JSON.stringify(analytics));
          
          console.log('Analytics event:', event);
        } catch (error) {
          console.error('Error tracking event:', error);
        }
      }

      // Widget state validation
      function validateWidgetState() {
        try {
          const issues = [];
          
          Object.keys(layoutPreferences.widgets).forEach(widgetId => {
            const card = document.querySelector(`[data-widget-id="${widgetId}"]`);
            const widget = document.querySelector(`[data-widget="${widgetId}"]`);
            const isActive = layoutPreferences.widgets[widgetId];
            
            if (!card) {
              issues.push(`Missing card for widget: ${widgetId}`);
            }
            
            if (isActive && widget && widget.style.display === 'none') {
              issues.push(`Active widget is hidden: ${widgetId}`);
            }
            
            if (!isActive && widget && widget.style.display !== 'none') {
              issues.push(`Inactive widget is visible: ${widgetId}`);
            }
          });
          
          if (issues.length > 0) {
            console.warn('Widget state validation issues:', issues);
            return false;
          }
          
          return true;
        } catch (error) {
          console.error('Error validating widget state:', error);
          return false;
        }
      }

      // Bulk widget operations
      function enableAllWidgets() {
        try {
          Object.keys(layoutPreferences.widgets).forEach(widgetId => {
            layoutPreferences.widgets[widgetId] = true;
          });
          
          updateWidgetCards();
          updateWidgetCounter();
          updateDashboardStats();
          applyLayoutPreferences();
          debouncedSave();
          
          trackEvent('bulk_enable_widgets', { count: Object.keys(layoutPreferences.widgets).length });
          showNotification('All widgets enabled successfully', 'success');
        } catch (error) {
          console.error('Error enabling all widgets:', error);
          showNotification('Error enabling all widgets', 'danger');
        }
      }

      function disableAllWidgets() {
        try {
          const confirmMessage = 'Are you sure you want to disable all widgets?\n\nThis will hide all dashboard content.';
          
          if (!confirm(confirmMessage)) {
            return;
          }
          
          Object.keys(layoutPreferences.widgets).forEach(widgetId => {
            layoutPreferences.widgets[widgetId] = false;
          });
          
          updateWidgetCards();
          updateWidgetCounter();
          updateDashboardStats();
          applyLayoutPreferences();
          debouncedSave();
          
          trackEvent('bulk_disable_widgets', { count: Object.keys(layoutPreferences.widgets).length });
          showNotification('All widgets disabled', 'warning');
        } catch (error) {
          console.error('Error disabling all widgets:', error);
          showNotification('Error disabling all widgets', 'danger');
        }
      }

      // User-facing validation function with feedback
      function runWidgetValidation() {
        try {
          const button = event.target.closest('button');
          const icon = button.querySelector('i');
          
          // Show loading state
          icon.className = 'fas fa-spinner fa-spin me-1';
          button.disabled = true;
          
          setTimeout(() => {
            const isValid = validateWidgetState();
            
            // Reset button state
            icon.className = 'fas fa-check-circle me-1';
            button.disabled = false;
            
            if (isValid) {
              showNotification('✅ All widgets are in valid state', 'success');
              trackEvent('widget_validation_success');
            } else {
              showNotification('⚠️ Widget state validation found issues - check console', 'warning');
              trackEvent('widget_validation_failed');
            }
          }, 1000);
          
        } catch (error) {
          console.error('Error running widget validation:', error);
          showNotification('Error running validation', 'danger');
        }
      }

      function initializeLayoutCustomization() {
        // Load saved preferences
        const saved = localStorage.getItem('dashboardLayout');
        if (saved) {
          layoutPreferences = { ...layoutPreferences, ...JSON.parse(saved) };
        }
        
        // Update widget counter
        updateWidgetCounter();
        
        // Apply saved preferences
        applyLayoutPreferences();
      }

      function toggleCustomizationPanel() {
        const panel = document.getElementById('customizationPanel');
        const btn = document.getElementById('customizeBtn');
        
        if (!panel || !btn) {
          console.error('Customization panel elements not found');
          return;
        }
        
        const isOpen = panel.style.display !== 'none';
        
        if (!isOpen) {
          openCustomizationPanel();
        } else {
          closeCustomizationPanel();
        }
      }

      function openCustomizationPanel() {
        const panel = document.getElementById('customizationPanel');
        const btn = document.getElementById('customizeBtn');
        
        // Show panel with animation
        panel.style.display = 'block';
        panel.style.opacity = '0';
        panel.style.transform = 'translateY(-20px)';
        
        // Update button state
        btn.innerHTML = '<i class="fas fa-times me-2"></i>Close Customization';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-primary');
        
        // Animate panel in
        setTimeout(() => {
          panel.style.opacity = '1';
          panel.style.transform = 'translateY(0)';
        }, 10);
        
        // Update widget counter and cards
        updateWidgetCounter();
        updateWidgetCards();
        
        // Track analytics
        trackEvent('customization_panel_opened');
        
        showNotification('Customization panel opened', 'info');
      }

      function closeCustomizationPanel() {
        const panel = document.getElementById('customizationPanel');
        const btn = document.getElementById('customizeBtn');
        
        if (!panel || !btn) return;
        
        // Animate panel out
        panel.style.opacity = '0';
        panel.style.transform = 'translateY(-20px)';
        
        // Update button state
        btn.innerHTML = '<i class="fas fa-palette me-2"></i>Customize Layout';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
        
        // Hide panel after animation
        setTimeout(() => {
          panel.style.display = 'none';
        }, 300);
        
        // Track analytics
        trackEvent('customization_panel_closed');
        
        showNotification('Customization panel closed', 'info');
      }

      function toggleWidget(widgetName) {
        const widget = document.querySelector(`[data-widget="${widgetName}"]`);
        
        // Correct ID mapping
        const idMap = {
          'kpi-cards': 'showKPICards',
          'revenue-charts': 'showRevenueCharts', 
          'executive-summary': 'showExecutiveSummary',
          'quick-actions': 'showQuickActions',
          'fleet-map': 'showFleetMap',
          'reservations': 'showReservations',
          'financial-snapshot': 'showFinancialSnapshot',
          'weather-demand': 'showWeatherDemand',
          'customer-insights': 'showCustomerInsights',
          'upcoming-bookings': 'showUpcomingBookings',
          'fleet-usage': 'showFleetUsage',
          'critical-alerts': 'showCriticalAlerts'
        };
        
        const checkbox = document.getElementById(idMap[widgetName]);
        
        if (widget && checkbox) {
          if (checkbox.checked) {
            widget.style.display = '';
            widget.style.opacity = '1';
            widget.style.transform = 'translateY(0)';
          } else {
            widget.style.opacity = '0';
            widget.style.transform = 'translateY(-10px)';
            setTimeout(() => {
              widget.style.display = 'none';
            }, 300);
          }
          
          layoutPreferences.widgets[widgetName] = checkbox.checked;
          saveLayoutPreferences();
        } else {
          console.error(`Widget or checkbox not found: ${widgetName}, checkbox ID: ${idMap[widgetName]}`);
        }
      }

      function applyLayout(layoutType) {
        const layouts = {
          executive: {
            'kpi-cards': true,
            'revenue-charts': true,
            'executive-summary': true,
            'quick-actions': false,
            'fleet-map': false,
            'reservations': false,
            'financial-snapshot': true,
            'weather-demand': false,
            'customer-insights': true,
            'upcoming-bookings': false,
            'fleet-usage': false,
            'critical-alerts': true
          },
          operations: {
            'kpi-cards': true,
            'revenue-charts': false,
            'executive-summary': false,
            'quick-actions': true,
            'fleet-map': true,
            'reservations': true,
            'financial-snapshot': false,
            'weather-demand': true,
            'customer-insights': false,
            'upcoming-bookings': true,
            'fleet-usage': true,
            'critical-alerts': true
          },
          analytics: {
            'kpi-cards': true,
            'revenue-charts': true,
            'executive-summary': true,
            'quick-actions': false,
            'fleet-map': false,
            'reservations': false,
            'financial-snapshot': true,
            'weather-demand': true,
            'customer-insights': true,
            'upcoming-bookings': false,
            'fleet-usage': true,
            'critical-alerts': false
          },
          minimal: {
            'kpi-cards': true,
            'revenue-charts': false,
            'executive-summary': false,
            'quick-actions': false,
            'fleet-map': false,
            'reservations': true,
            'financial-snapshot': false,
            'weather-demand': false,
            'customer-insights': false,
            'upcoming-bookings': false,
            'fleet-usage': false,
            'critical-alerts': false
          }
        };

        const layout = layouts[layoutType];
        if (layout) {
          // Update layout preferences
          layoutPreferences.widgets = { ...layoutPreferences.widgets, ...layout };
          
          // Update widget cards
          updateWidgetCards();
          updateWidgetCounter();
          
          // Apply the layout
          applyLayoutPreferences();
          
          // Save the updated preferences
          saveLayoutPreferences();
          
          showNotification(`${layoutType.charAt(0).toUpperCase() + layoutType.slice(1)} layout applied successfully!`, 'success');
        }
      }

      function changeDashboardDensity() {
        const density = document.getElementById('dashboardDensity').value;
        const body = document.body;
        
        // Remove existing density classes
        body.classList.remove('dashboard-comfortable', 'dashboard-compact', 'dashboard-dense');
        
        // Add new density class
        body.classList.add(`dashboard-${density}`);
        
        layoutPreferences.density = density;
        saveLayoutPreferences();
        
        showNotification(`Dashboard density changed to ${density}`, 'info');
      }

      function changeUpdateFrequency() {
        const frequency = parseInt(document.getElementById('updateFrequency').value);
        layoutPreferences.updateFrequency = frequency;
        
        // Clear existing intervals and restart with new frequency
        clearInterval(window.kpiUpdateInterval);
        clearInterval(window.statusUpdateInterval);
        
        window.kpiUpdateInterval = setInterval(updateKPICards, frequency * 1000);
        window.statusUpdateInterval = setInterval(updateRealTimeStatus, frequency * 1000);
        
        saveLayoutPreferences();
        showNotification(`Update frequency changed to every ${frequency} seconds`, 'info');
      }

      function toggleAnimations() {
        const enabled = document.getElementById('enableAnimations').checked;
        layoutPreferences.animations = enabled;
        
        if (enabled) {
          document.body.classList.remove('no-animations');
        } else {
          document.body.classList.add('no-animations');
        }
        
        saveLayoutPreferences();
        showNotification(`Animations ${enabled ? 'enabled' : 'disabled'}`, 'info');
      }

      function saveLayoutPreferences() {
        localStorage.setItem('dashboardLayout', JSON.stringify(layoutPreferences));
        console.log('Layout preferences saved:', layoutPreferences);
      }

      function applyLayoutPreferences() {
        // Apply widget visibility
        Object.keys(layoutPreferences.widgets).forEach(widget => {
          setWidgetVisibility(widget, layoutPreferences.widgets[widget]);
        });
        
        // Update widget cards
        updateWidgetCards();
        updateWidgetCounter();
      }

      // Simplified widget visibility function for internal use
      function setWidgetVisibility(widgetName, isVisible) {
        const widget = document.querySelector(`[data-widget="${widgetName}"]`);
        
        if (widget) {
          if (isVisible) {
            widget.style.display = '';
            widget.style.opacity = '1';
            widget.style.transform = 'translateY(0)';
          } else {
            widget.style.opacity = '0';
            widget.style.transform = 'translateY(-10px)';
            setTimeout(() => {
              widget.style.display = 'none';
            }, 300);
          }
        }
      }

      function resetToDefault() {
        if (confirm('Reset dashboard to default layout?\n\nThis will:\n• Show all widgets\n• Reset to compact density\n• Set 30-second updates\n• Enable animations')) {
          layoutPreferences = {
            widgets: {
              'kpi-cards': true,
              'revenue-charts': true,
              'executive-summary': true,
              'quick-actions': true,
              'fleet-map': true,
              'reservations': true,
              'financial-snapshot': true,
              'weather-demand': true,
              'customer-insights': true,
              'upcoming-bookings': true,
              'fleet-usage': true,
              'critical-alerts': true
            },
            density: 'compact',
            updateFrequency: 30,
            animations: true
          };
          
          // Update widget cards to reflect reset state
          updateWidgetCards();
          updateWidgetCounter();
          
          // Apply layout preferences
          applyLayoutPreferences();
          
          // Save preferences
          saveLayoutPreferences();
          
          showNotification('Dashboard reset to default layout successfully!', 'success');
        }
      }

      function exportLayoutConfig() {
        const config = {
          layout: layoutPreferences,
          timestamp: new Date().toISOString(),
          version: '1.0'
        };
        
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dashboard-layout-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('Layout configuration exported', 'success');
      }

      function importLayoutConfig() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              try {
                const config = JSON.parse(e.target.result);
                if (config.layout) {
                  layoutPreferences = { ...layoutPreferences, ...config.layout };
                  applyLayoutPreferences();
                  showNotification('Layout configuration imported successfully', 'success');
                } else {
                  showNotification('Invalid configuration file', 'danger');
                }
              } catch (error) {
                showNotification('Error reading configuration file', 'danger');
              }
            };
            reader.readAsText(file);
          }
        };
        input.click();
      }

      function toggleFullscreenDashboard() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().then(() => {
            showNotification('Dashboard in fullscreen mode', 'info');
          });
        } else {
          document.exitFullscreen().then(() => {
            showNotification('Exited fullscreen mode', 'info');
          });
        }
      }

      function refreshDashboard() {
        const btn = event.target.closest('button');
        const icon = btn.querySelector('i');
        
        icon.classList.add('fa-spin');
        
        // Refresh all components
        updateKPICards();
        updateRealTimeStatus();
        updateExecutiveMetrics();
        populateTodaySchedule();
        generateRandomAlert();
        
        // Update last refresh time
        document.getElementById('lastDashboardUpdate').textContent = new Date().toLocaleTimeString();
        
        setTimeout(() => {
          icon.classList.remove('fa-spin');
          showNotification('Dashboard refreshed successfully', 'success');
        }, 1500);
      }
      
      // --- Geofence Storage ---
      let geofenceSource = new ol.source.Vector();
      let geofenceLayer = new ol.layer.Vector({
        source: geofenceSource,
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: '#28a745', width: 2 }),
          fill: new ol.style.Fill({ color: 'rgba(40,167,69,0.1)' })
        })
      });

      // --- Geofence Drawing Interaction ---
      let drawGeofence = null;
      let geofenceMode = false;

      function enableGeofenceDrawing(map) {
        if (drawGeofence) map.removeInteraction(drawGeofence);
        drawGeofence = new ol.interaction.Draw({
          source: geofenceSource,
          type: 'Polygon',
        });
        map.addInteraction(drawGeofence);
        drawGeofence.on('drawend', function(evt) {
          setTimeout(() => map.removeInteraction(drawGeofence), 100); // Remove after drawing
          geofenceMode = false;
          document.getElementById('toggleGeofenceBtn').classList.remove('active');
          // Show geofence rules popup
          showGeofenceRulesPopup(evt.feature);
        });
      }

      // --- Geofence Rules Popup ---
      function showGeofenceRulesPopup(feature) {
        // Create modal HTML if not present
        let modal = document.getElementById('geofenceRulesModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'geofenceRulesModal';
          modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                <h5 class="mb-3">Geofence Rules</h5>
                <form id="geofenceRulesForm">
                  <div class="mb-2">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" name="name" required placeholder="Geofence name">
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Allowed Vehicle Status</label>
                    <select class="form-control" name="status">
                      <option value="all">All</option>
                      <option value="available">Available</option>
                      <option value="rented">Rented</option>
                      <option value="service">In Service</option>
                      <option value="alert">Alert</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Alert on Entry?</label>
                    <select class="form-control" name="alertEntry">
                      <option value="yes">Yes</option>
                      <option value="no">No</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Alert on Exit?</label>
                    <select class="form-control" name="alertExit">
                      <option value="yes">Yes</option>
                      <option value="no">No</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" name="notes" rows="2" placeholder="Optional notes"></textarea>
                  </div>
                  <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" id="geofenceRulesCancel">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        } else {
          modal.style.display = 'flex';
        }
        // Cancel button closes modal and removes geofence
        document.getElementById('geofenceRulesCancel').onclick = function() {
          modal.style.display = 'none';
          // Remove the just-drawn geofence
          geofenceSource.removeFeature(feature);
        };
        // Save button closes modal (add your logic here)
        document.getElementById('geofenceRulesForm').onsubmit = function(e) {
          e.preventDefault();
          // You can collect rule data here:
          // const data = Object.fromEntries(new FormData(this).entries());
          modal.style.display = 'none';
          // Optionally, attach rule data to the feature:
          // feature.set('rules', data);
        };
      }
    

      function toggleGeofenceMode(map) {
        geofenceMode = !geofenceMode;
        const btn = document.getElementById('toggleGeofenceBtn');
        if (geofenceMode) {
          btn.classList.add('active');
          enableGeofenceDrawing(map);
        } else {
          btn.classList.remove('active');
          if (drawGeofence) map.removeInteraction(drawGeofence);
        }
      }

      // Remove all geofences helper
      function clearGeofences() {
        geofenceSource.clear();
      }

      function showMapError() {
        const mapContainer = document.getElementById('fleetMap');
        if (mapContainer) {
          mapContainer.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #6c757d;">
              <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
              <h5>Map Loading Error</h5>
              <p>Unable to load the fleet tracking map. Please check your internet connection and refresh the page.</p>
              <button class="btn btn-primary btn-sm" onclick="location.reload()">
                <i class="fas fa-sync-alt me-2"></i>Retry
              </button>
            </div>
          `;
        }
      }

      function initFleetMap() {
        // Check if OpenLayers is available
        if (typeof ol === 'undefined') {
          console.error('OpenLayers library not loaded');
          showMapError();
          return;
        }

        try {
        // --- Vehicle Data Simulation ---
        function randomLatLon() {
          const minLat = 31.90, maxLat = 32.05;
          const minLon = 35.80, maxLon = 36.00;
          return {
            lat: +(Math.random() * (maxLat - minLat) + minLat).toFixed(6),
            lon: +(Math.random() * (maxLon - minLon) + minLon).toFixed(6)
          };
        }
        function randomPlate() {
          const letters = () => String.fromCharCode(65 + Math.floor(Math.random() * 26));
          return `${letters()}${letters()}${letters()}${Math.floor(100 + Math.random() * 900)}`;
        }
        const vehicleData = [];
        let id = 1;
        for (let i = 0; i < 120; i++, id++) {
          const pos = randomLatLon();
          vehicleData.push({ id, name: `Vehicle ${id} - ${randomPlate()}`, lat: pos.lat, lon: pos.lon, status: 'available', driver: null });
        }
        for (let i = 0; i < 86; i++, id++) {
          const pos = randomLatLon();
          vehicleData.push({ id, name: `Vehicle ${id} - ${randomPlate()}`, lat: pos.lat, lon: pos.lon, status: 'rented', driver: `Driver ${id}` });
        }
        for (let i = 0; i < 11; i++, id++) {
          const pos = randomLatLon();
          vehicleData.push({ id, name: `Vehicle ${id} - ${randomPlate()}`, lat: pos.lat, lon: pos.lon, status: 'service', driver: null });
        }
        for (let i = 0; i < 16; i++, id++) {
          const pos = randomLatLon();
          vehicleData.push({ id, name: `Vehicle ${id} - ${randomPlate()}`, lat: pos.lat, lon: pos.lon, status: 'alert', driver: `Driver ${id}` });
        }

        // --- OpenLayers Sources & Layers ---
        const vectorSource = new ol.source.Vector();
        vehicleData.forEach(vehicle => {
          const marker = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.fromLonLat([vehicle.lon, vehicle.lat])),
            name: vehicle.name,
            status: vehicle.status,
            driver: vehicle.driver,
            id: vehicle.id
          });
          vectorSource.addFeature(marker);
        });
        const vectorLayer = new ol.layer.Vector({
          source: vectorSource,
          style: function(feature) {
            const status = feature.get('status');
            let color = '#28a745';
            switch(status) {
              case 'rented': color = '#007bff'; break;
              case 'service': color = '#ffc107'; break;
              case 'alert': color = '#dc3545'; break;
              default: color = '#28a745';
            }
            return new ol.style.Style({
              image: new ol.style.Circle({ radius: 8, fill: new ol.style.Fill({ color: color }), stroke: new ol.style.Stroke({ color: '#fff', width: 2 }) }),
              text: new ol.style.Text({ text: feature.get('name').split(' - ')[1], offsetY: -20, fill: new ol.style.Fill({ color: '#000' }), stroke: new ol.style.Stroke({ color: '#fff', width: 2 }), font: '12px Arial, sans-serif' })
            });
          }
        });

        // Cluster source/layer
        const clusterSource = new ol.source.Cluster({
          distance: 40,
          source: vectorSource
        });
        const clusterLayer = new ol.layer.Vector({
          source: clusterSource,
          style: function(feature) {
            const size = feature.get('features').length;
            if (size === 1) {
              // Single marker, use normal style
              return vectorLayer.getStyle()(feature.get('features')[0]);
            }
            // Clustered style
            return new ol.style.Style({
              image: new ol.style.Circle({
                radius: 14,
                fill: new ol.style.Fill({ color: '#6666ff' }),
                stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
              }),
              text: new ol.style.Text({
                text: size.toString(),
                fill: new ol.style.Fill({ color: '#fff' }),
                font: 'bold 14px Arial, sans-serif'
              })
            });
          }
        });

        // --- Map Initialization ---
        const map = new ol.Map({
          target: 'fleetMap',
          layers: [
            new ol.layer.Tile({ source: new ol.source.OSM() }),
            vectorLayer,
            geofenceLayer
          ],
          view: new ol.View({ center: ol.proj.fromLonLat([35.9106, 31.9632]), zoom: 12 })
        });

        // --- Refresh Button Functionality ---
        const refreshBtn = document.querySelector('.btn-outline-primary');
        if (refreshBtn && refreshBtn.querySelector('.fa-sync-alt')) {
          refreshBtn.addEventListener('click', function() {
            // Add spinning animation
            const icon = this.querySelector('.fa-sync-alt');
            icon.classList.add('fa-spin');

            // Simulate data refresh
            setTimeout(() => {
              // Update map markers with new positions
              vectorSource.getFeatures().forEach(feature => {
                const currentCoords = feature.getGeometry().getCoordinates();
                const lonLat = ol.proj.toLonLat(currentCoords);

                // Slightly move each vehicle (simulate movement)
                const newLon = lonLat[0] + (Math.random() - 0.5) * 0.001;
                const newLat = lonLat[1] + (Math.random() - 0.5) * 0.001;

                feature.getGeometry().setCoordinates(ol.proj.fromLonLat([newLon, newLat]));
              });

              // Update last refresh time
              updateLastRefreshTime();

              // Remove spinning animation
              icon.classList.remove('fa-spin');

              // Show success message
              showNotification('Fleet data refreshed successfully!', 'success');
            }, 1500);
          });
        }

        // --- Fullscreen Toggle Functionality ---
        const fullscreenBtn = document.querySelector('.btn-primary[class*="btn-sm"]');
        if (fullscreenBtn && fullscreenBtn.querySelector('.fa-expand')) {
          fullscreenBtn.addEventListener('click', function() {
            const mapContainer = document.getElementById('fleetMap').parentElement.parentElement.parentElement;
            const icon = this.querySelector('i');

            if (!document.fullscreenElement) {
              mapContainer.requestFullscreen().then(() => {
                icon.className = 'fas fa-compress';
                this.innerHTML = '<i class="fas fa-compress"></i> Exit Fullscreen';

                // Resize map after entering fullscreen
                setTimeout(() => {
                  map.updateSize();
                }, 100);
              });
            } else {
              document.exitFullscreen().then(() => {
                icon.className = 'fas fa-expand';
                this.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';

                // Resize map after exiting fullscreen
                setTimeout(() => {
                  map.updateSize();
                }, 100);
              });
            }
          });
        }

        // --- Geofence Tool Button Logic ---
        document.getElementById('toggleGeofenceBtn').addEventListener('click', function() {
          toggleGeofenceMode(map);
        });

        // Optional: Right-click to remove all geofences
        map.getViewport().addEventListener('contextmenu', function(e) {
          if (geofenceSource.getFeatures().length > 0) {
            e.preventDefault();
            if (confirm('Remove all geofences?')) clearGeofences();
          }
        });

        // --- Clustering Toggle Logic ---
        let clusteringEnabled = false;
        const toggleBtn = document.getElementById('toggleClusterBtn');
        function setClustering(enabled) {
          clusteringEnabled = enabled;
          // Helper to check if a layer is present
          function hasLayer(layer) {
            return map.getLayers().getArray().includes(layer);
          }
          if (enabled) {
            if (hasLayer(vectorLayer)) map.removeLayer(vectorLayer);
            if (!hasLayer(clusterLayer)) map.addLayer(clusterLayer);
            toggleBtn.classList.add('active');
            toggleBtn.innerHTML = '<i class="fas fa-layer-group"></i> Clustering On';
          } else {
            if (hasLayer(clusterLayer)) map.removeLayer(clusterLayer);
            if (!hasLayer(vectorLayer)) map.addLayer(vectorLayer);
            toggleBtn.classList.remove('active');
            toggleBtn.innerHTML = '<i class="fas fa-layer-group"></i> Clustering';
          }
        }
        toggleBtn.addEventListener('click', function() {
          setClustering(!clusteringEnabled);
        });
        // Default: clustering off
        setClustering(false);

        // --- Map Interactions ---
        map.on('click', function(evt) {
          if (clusteringEnabled) {
            // Check if a cluster was clicked
            const clusterFeature = map.forEachFeatureAtPixel(evt.pixel, function(f) { return f; });
            if (clusterFeature && clusterFeature.get('features')) {
              const features = clusterFeature.get('features');
              if (features.length === 1) {
                // Single vehicle in cluster: show info
                const feature = features[0];
                const vehicleName = feature.get('name');
                const status = feature.get('status');
                const driver = feature.get('driver');
                let statusText = status.charAt(0).toUpperCase() + status.slice(1);
                let driverText = driver ? `Driver: ${driver}` : 'No driver assigned';
                alert(`${vehicleName}\nStatus: ${statusText}\n${driverText}`);
              } else if (features.length > 1) {
                // Zoom in on cluster
                const extent = ol.extent.createEmpty();
                features.forEach(function(f) {
                  ol.extent.extend(extent, f.getGeometry().getExtent());
                });
                map.getView().fit(extent, { duration: 500, maxZoom: 18, padding: [40, 40, 40, 40] });
              }
            }
          } else {
            // Not clustering: show info for single vehicle
            const feature = map.forEachFeatureAtPixel(evt.pixel, function(f) { return f; });
            if (feature) {
              const vehicleName = feature.get('name');
              const status = feature.get('status');
              const driver = feature.get('driver');
              let statusText = status.charAt(0).toUpperCase() + status.slice(1);
              let driverText = driver ? `Driver: ${driver}` : 'No driver assigned';
              alert(`${vehicleName}\nStatus: ${statusText}\n${driverText}`);
            }
          }
        });
        map.on('pointermove', function(evt) {
          const hit = map.hasFeatureAtPixel(evt.pixel);
          map.getTargetElement().style.cursor = hit ? 'pointer' : '';
        });
        window.fleetMap = map;
        setInterval(function() { updateLastRefreshTime(); }, 30000);

        // Start real-time KPI updates
        startKPIUpdates();

        } catch (error) {
          console.error('Error during map initialization:', error);
          showMapError();
        }
      }

      // Notification system function (needs to be defined before use)
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 10000;
          min-width: 300px;
          max-width: 400px;
        `;
        notification.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        // Auto remove after 3 seconds
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 3000);
      }


      function updateLastRefreshTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        document.getElementById('lastUpdate').textContent = timeString;
      }

      // Real-time KPI update functions
      function startKPIUpdates() {
        // Update KPI cards every 45 seconds with realistic variations
        setInterval(updateKPICards, 45000);

        // Update financial data every 2 minutes
        setInterval(updateFinancialData, 120000);
      }

      function updateKPICards() {
        // Fleet Utilization (70-80% range)
        const fleetUtil = (70 + Math.random() * 10).toFixed(1) + '%';
        const fleetCard = document.querySelector('.card-stats:nth-child(1) .card-title');
        if (fleetCard) {
          animateCounterUpdate(fleetCard, fleetUtil);
        }

        // Active Bookings (40-55 range)
        const activeBookings = Math.floor(40 + Math.random() * 15);
        const bookingsCard = document.querySelector('.card-stats:nth-child(2) .card-title');
        if (bookingsCard) {
          animateCounterUpdate(bookingsCard, activeBookings.toString());
        }

        // Overdue Returns (0-8 range)
        const overdueReturns = Math.floor(Math.random() * 9);
        const overdueCard = document.querySelector('.card-stats:nth-child(3) .card-title');
        if (overdueCard) {
          animateCounterUpdate(overdueCard, overdueReturns.toString());
        }

        // Today's Revenue ($6000-$12000 range)
        const revenue = Math.floor(6000 + Math.random() * 6000);
        const revenueCard = document.querySelector('.card-stats:nth-child(4) .card-title');
        if (revenueCard) {
          animateCounterUpdate(revenueCard, '$' + revenue.toLocaleString());
        }
      }

      function updateFinancialData() {
        // Update Financial Snapshot numbers
        const todayRevenue = Math.floor(6000 + Math.random() * 6000);
        const monthRevenue = Math.floor(100000 + Math.random() * 50000);
        const pendingDeposits = Math.floor(15000 + Math.random() * 15000);
        const pendingRefunds = Math.floor(2000 + Math.random() * 5000);

        // Find and update financial elements by content
        const financialElements = document.querySelectorAll('.text-success, .text-info, .text-warning, .text-primary');
        financialElements.forEach(el => {
          const text = el.textContent.trim();
          if (text.includes('$8,450') || text.includes('Today\'s Revenue')) {
            animateCounterUpdate(el, '$' + todayRevenue.toLocaleString());
          } else if (text.includes('$125,330') || text.includes('This Month')) {
            animateCounterUpdate(el, '$' + monthRevenue.toLocaleString());
          } else if (text.includes('$23,500') || text.includes('Pending Deposits')) {
            animateCounterUpdate(el, '$' + pendingDeposits.toLocaleString());
          } else if (text.includes('$4,200') || text.includes('Pending Refunds')) {
            animateCounterUpdate(el, '$' + pendingRefunds.toLocaleString());
          }
        });
      }

      function animateCounterUpdate(element, newValue) {
        if (!element) return;

        // Add update animation
        element.style.transition = 'all 0.3s ease';
        element.style.transform = 'scale(1.1)';
        element.style.color = '#007bff';

        setTimeout(() => {
          element.textContent = newValue;
          setTimeout(() => {
            element.style.transform = 'scale(1)';
            element.style.color = '';
          }, 150);
        }, 150);
      }

      // === SIDEBAR TOGGLE FUNCTIONS ===
      function initializeSidebarToggles() {
        const toggleSidebarBtns = document.querySelectorAll('.toggle-sidebar');
        const sidenavTogglers = document.querySelectorAll('.sidenav-toggler');
        const topbarTogglers = document.querySelectorAll('.topbar-toggler');
        const sidebar = document.querySelector('.sidebar');
        const mainPanel = document.querySelector('.main-panel');

        // Toggle sidebar visibility
        toggleSidebarBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            if (sidebar) {
              sidebar.classList.toggle('sidebar-collapse');
              if (mainPanel) {
                mainPanel.classList.toggle('full-width');
              }
              if (window.fleetMap) {
                setTimeout(() => window.fleetMap.updateSize(), 300);
              }
            }
          });
        });

        // Side navigation togglers (for mobile)
        sidenavTogglers.forEach(btn => {
          btn.addEventListener('click', function() {
            if (sidebar) sidebar.classList.toggle('sidebar-show');
          });
        });

        // Topbar togglers (for mobile menu)
        topbarTogglers.forEach(btn => {
          btn.addEventListener('click', function() {
            const navbar = document.querySelector('.navbar-header');
            if (navbar) navbar.classList.toggle('mobile-menu-show');
          });
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
          if (window.innerWidth <= 768 && sidebar) {
            if (!sidebar.contains(e.target) && !e.target.closest('.sidenav-toggler')) {
              sidebar.classList.remove('sidebar-show');
            }
          }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
          if (window.innerWidth > 768 && sidebar) {
            sidebar.classList.remove('sidebar-show');
          }
          if (window.fleetMap) {
            setTimeout(() => window.fleetMap.updateSize(), 100);
          }
          // Update mobile period selector visibility
          const mobileDropdown = document.querySelector('.dropdown.d-md-none');
          const desktopGroup = document.querySelector('.btn-group.d-none.d-md-flex');
          if (mobileDropdown && desktopGroup) {
            if (window.innerWidth < 768) {
              mobileDropdown.style.display = 'block';
              desktopGroup.style.display = 'none';
            } else {
              mobileDropdown.style.display = 'none';
              desktopGroup.style.display = 'flex';
            }
          }
        });
      }

      // === SEARCH FUNCTIONS ===
      function initializeSearchFunctionality() {
        const searchInputs = document.querySelectorAll('input[placeholder="Search ..."]');
        const searchButtons = document.querySelectorAll('.btn-search');

        function performSearch(query) {
          if (!query.trim()) return;
          showSearchResults(query);
        }

        function showSearchResults(query) {
          let modal = document.getElementById('searchResultsModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'searchResultsModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:600px;max-height:80vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Search Results for: "<span id="searchQuery"></span>"</h5>
                    <button class="btn-close" id="closeSearchModal"></button>
                  </div>
                  <div id="searchResultsContent">
                    <div class="row">
                      <div class="col-md-4">
                        <h6><i class="fas fa-car me-2"></i>Vehicles</h6>
                        <div id="vehicleResults"></div>
                      </div>
                      <div class="col-md-4">
                        <h6><i class="fas fa-users me-2"></i>Customers</h6>
                        <div id="customerResults"></div>
                      </div>
                      <div class="col-md-4">
                        <h6><i class="fas fa-calendar-alt me-2"></i>Bookings</h6>
                        <div id="bookingResults"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closeSearchModal').onclick = function() {
              modal.style.display = 'none';
            };
          }

          document.getElementById('searchQuery').textContent = query;

          // Simulate search results
          const mockVehicles = ['Toyota Camry - ABC123', 'Honda CR-V - XYZ789', 'Ford Focus - DEF456'];
          const mockCustomers = ['John Smith', 'Sarah Johnson', 'Mike Davis'];
          const mockBookings = ['Booking #1001', 'Booking #1002', 'Booking #1003'];

          const vehicleResults = mockVehicles.filter(v => v.toLowerCase().includes(query.toLowerCase()))
            .map(v => `<div class="mb-1"><small>${v}</small></div>`).join('');
          const customerResults = mockCustomers.filter(c => c.toLowerCase().includes(query.toLowerCase()))
            .map(c => `<div class="mb-1"><small>${c}</small></div>`).join('');
          const bookingResults = mockBookings.filter(b => b.toLowerCase().includes(query.toLowerCase()))
            .map(b => `<div class="mb-1"><small>${b}</small></div>`).join('');

          document.getElementById('vehicleResults').innerHTML = vehicleResults || '<small class="text-muted">No vehicles found</small>';
          document.getElementById('customerResults').innerHTML = customerResults || '<small class="text-muted">No customers found</small>';
          document.getElementById('bookingResults').innerHTML = bookingResults || '<small class="text-muted">No bookings found</small>';

          modal.style.display = 'flex';
        }

        // Add search functionality to all search inputs
        searchInputs.forEach(input => {
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              performSearch(this.value);
            }
          });
        });

        searchButtons.forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const input = this.parentElement.parentElement.querySelector('input');
            if (input) {
              performSearch(input.value);
            }
          });
        });

        // Sidebar navigation functionality
        const sidebarLinks = document.querySelectorAll('.sidebar .nav-item a');
        sidebarLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            if (!this.getAttribute('href') || this.getAttribute('href') === '#') {
              e.preventDefault();
              const pageName = this.querySelector('p').textContent.trim();
              showPagePlaceholder(pageName);
            }
          });
        });
      }

      function showPagePlaceholder(pageName) {
          let modal = document.getElementById('pageModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'pageModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:2rem;border-radius:8px;width:95vw;max-width:400px;text-align:center;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="mb-3">
                    <i class="fas fa-info-circle text-primary" style="font-size: 48px;"></i>
                  </div>
                  <h4 id="modalPageTitle" class="mb-3"></h4>
                  <p class="text-muted mb-4">This page is under development and will be available soon.</p>
                  <button class="btn btn-primary" id="closePageModal">OK</button>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closePageModal').onclick = function() {
              modal.style.display = 'none';
            };
          }

          document.getElementById('modalPageTitle').textContent = pageName;
          modal.style.display = 'flex';
      }

      // === RESERVATION MANAGEMENT FUNCTIONS ===
      function initializeReservationManagement() {
        // New Booking button functionality
        const newBookingBtn = document.querySelector('.btn-primary.btn-round');
        if (newBookingBtn && newBookingBtn.querySelector('.fa-plus')) {
          newBookingBtn.addEventListener('click', function() {
            showBookingForm();
          });
        }

        // Reservation table action buttons
        document.addEventListener('click', handleReservationActions);
      }

      function showBookingForm() {
          let modal = document.getElementById('bookingModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'bookingModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:600px;max-height:80vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-plus-circle me-2"></i>New Booking</h4>
                    <button class="btn-close" id="closeBookingModal"></button>
                  </div>
                  <form id="newBookingForm">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Customer Name *</label>
                        <input type="text" class="form-control" name="customerName" required placeholder="Enter customer name">
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" name="phoneNumber" required placeholder="Enter phone number">
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" placeholder="customer@example.com">
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Vehicle Type *</label>
                        <select class="form-control" name="vehicleType" required>
                          <option value="">Select vehicle type</option>
                          <option value="economy">Economy</option>
                          <option value="compact">Compact</option>
                          <option value="suv">SUV</option>
                          <option value="luxury">Luxury</option>
                        </select>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Pickup Date *</label>
                        <input type="datetime-local" class="form-control" name="pickupDate" required>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Return Date *</label>
                        <input type="datetime-local" class="form-control" name="returnDate" required>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Pickup Location</label>
                      <input type="text" class="form-control" name="pickupLocation" placeholder="Branch location or address">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Special Requirements</label>
                      <textarea class="form-control" name="requirements" rows="3" placeholder="Any special requirements or notes"></textarea>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                      <button type="button" class="btn btn-secondary" id="cancelBooking">Cancel</button>
                      <button type="submit" class="btn btn-primary">Create Booking</button>
                    </div>
                  </form>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closeBookingModal').onclick = function() {
              modal.style.display = 'none';
            };
            document.getElementById('cancelBooking').onclick = function() {
              modal.style.display = 'none';
            };

            document.getElementById('newBookingForm').onsubmit = function(e) {
              e.preventDefault();
              const formData = Object.fromEntries(new FormData(this).entries());

              // Simulate booking creation
              showNotification('Booking created successfully!', 'success');
              modal.style.display = 'none';

              // Reset form
              this.reset();
            };
          }

          modal.style.display = 'flex';
        }

      // Consolidated reservation action handler
      function handleReservationActions(e) {
        // Check-out button
        if (e.target.matches('.btn-primary.btn-xs') || e.target.closest('.btn-primary.btn-xs')) {
          const button = e.target.closest('.btn-primary.btn-xs') || e.target;
          if (button.textContent.trim() === 'Check-out') {
            const row = button.closest('tr');
            const customerName = row.cells[0].textContent;
            const vehicle = row.cells[1].textContent;
            showCheckoutModal(customerName, vehicle);
          }
        }

        // View button
        if (e.target.matches('.btn-outline-primary.btn-xs') || e.target.closest('.btn-outline-primary.btn-xs')) {
          const button = e.target.closest('.btn-outline-primary.btn-xs') || e.target;
          const row = button.closest('tr');
          const customerName = row.cells[0].textContent;
          const vehicle = row.cells[1].textContent;
          const status = row.cells[3].textContent.trim();
          showReservationDetails(customerName, vehicle, status);
        }

        // Contact button
        if (e.target.matches('.btn-warning.btn-xs') || e.target.closest('.btn-warning.btn-xs')) {
          const button = e.target.closest('.btn-warning.btn-xs') || e.target;
          if (button.textContent.trim() === 'Contact') {
            const row = button.closest('tr');
            const customerName = row.cells[0].textContent;
            const vehicle = row.cells[1].textContent;
            showContactModal(customerName, vehicle);
          }
        }
      }

      function showCheckoutModal(customerName, vehicle) {
          let modal = document.getElementById('checkoutModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'checkoutModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-car me-2"></i>Vehicle Check-out</h4>
                    <button class="btn-close" id="closeCheckoutModal"></button>
                  </div>
                  <div class="mb-3">
                    <h6>Customer: <span id="checkoutCustomer"></span></h6>
                    <h6>Vehicle: <span id="checkoutVehicle"></span></h6>
                  </div>
                  <form id="checkoutForm">
                    <div class="mb-3">
                      <label class="form-label">Mileage Reading</label>
                      <input type="number" class="form-control" name="mileage" required placeholder="Current mileage">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Fuel Level</label>
                      <select class="form-control" name="fuelLevel" required>
                        <option value="">Select fuel level</option>
                        <option value="full">Full</option>
                        <option value="3/4">3/4</option>
                        <option value="1/2">1/2</option>
                        <option value="1/4">1/4</option>
                        <option value="empty">Empty</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Vehicle Condition</label>
                      <textarea class="form-control" name="condition" rows="3" placeholder="Note any damages or issues"></textarea>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                      <button type="button" class="btn btn-secondary" id="cancelCheckout">Cancel</button>
                      <button type="submit" class="btn btn-success">Complete Check-out</button>
                    </div>
                  </form>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closeCheckoutModal').onclick = function() {
              modal.style.display = 'none';
            };
            document.getElementById('cancelCheckout').onclick = function() {
              modal.style.display = 'none';
            };

            document.getElementById('checkoutForm').onsubmit = function(e) {
              e.preventDefault();
              showNotification('Vehicle checked out successfully!', 'success');
              modal.style.display = 'none';
              this.reset();
            };
          }

          document.getElementById('checkoutCustomer').textContent = customerName;
          document.getElementById('checkoutVehicle').textContent = vehicle;
          modal.style.display = 'flex';
        }

      function showReservationDetails(customerName, vehicle, status) {
          let modal = document.getElementById('detailsModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'detailsModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-info-circle me-2"></i>Reservation Details</h4>
                    <button class="btn-close" id="closeDetailsModal"></button>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <h6>Customer Information</h6>
                      <p><strong>Name:</strong> <span id="detailsCustomer"></span></p>
                      <p><strong>Phone:</strong> +1 (555) 123-4567</p>
                      <p><strong>Email:</strong> customer@example.com</p>
                    </div>
                    <div class="col-md-6">
                      <h6>Booking Details</h6>
                      <p><strong>Vehicle:</strong> <span id="detailsVehicle"></span></p>
                      <p><strong>Status:</strong> <span id="detailsStatus"></span></p>
                      <p><strong>Duration:</strong> 3 days</p>
                    </div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Pickup:</strong> Today 09:30 AM</p>
                      <p><strong>Return:</strong> Dec 20, 2024 09:30 AM</p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Total Amount:</strong> $450.00</p>
                      <p><strong>Deposit:</strong> $100.00</p>
                    </div>
                  </div>
                  <div class="d-flex justify-content-end">
                    <button class="btn btn-primary" id="closeDetailsBtn">Close</button>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closeDetailsModal').onclick = function() {
              modal.style.display = 'none';
            };
            document.getElementById('closeDetailsBtn').onclick = function() {
              modal.style.display = 'none';
            };
          }

          document.getElementById('detailsCustomer').textContent = customerName;
          document.getElementById('detailsVehicle').textContent = vehicle;
          document.getElementById('detailsStatus').innerHTML = status;
          modal.style.display = 'flex';
        }

      function showContactModal(customerName, vehicle) {
          let modal = document.getElementById('contactModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'contactModal';
            modal.innerHTML = `
              <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;">
                <div style="background:#fff;padding:1.5rem;border-radius:8px;width:95vw;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.1);">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-phone me-2"></i>Contact Customer</h4>
                    <button class="btn-close" id="closeContactModal"></button>
                  </div>
                  <div class="mb-3">
                    <h6>Customer: <span id="contactCustomer"></span></h6>
                    <h6>Vehicle: <span id="contactVehicle"></span></h6>
                    <div class="alert alert-warning">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      Vehicle return is overdue. Customer needs to be contacted immediately.
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="window.location.href='tel:+15551234567'">
                      <i class="fas fa-phone me-2"></i>Call Customer
                    </button>
                    <button class="btn btn-info" onclick="window.location.href='sms:+15551234567'">
                      <i class="fas fa-sms me-2"></i>Send SMS
                    </button>
                    <button class="btn btn-success" onclick="window.location.href='mailto:customer@example.com'">
                      <i class="fas fa-envelope me-2"></i>Send Email
                    </button>
                  </div>
                  <div class="mt-3 d-flex justify-content-end">
                    <button class="btn btn-secondary" id="closeContactBtn">Close</button>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('closeContactModal').onclick = function() {
              modal.style.display = 'none';
            };
            document.getElementById('closeContactBtn').onclick = function() {
              modal.style.display = 'none';
            };
          }

          document.getElementById('contactCustomer').textContent = customerName;
          document.getElementById('contactVehicle').textContent = vehicle;
          modal.style.display = 'flex';
        };

      // === ENHANCED DASHBOARD UTILITY FUNCTIONS ===
      function getSeverityColor(severity) {
        const colors = {
          critical: 'danger',
          high: 'warning', 
          medium: 'info',
          warning: 'warning',
          info: 'info'
        };
        return colors[severity] || 'secondary';
      }

      function getAlertIcon(type) {
        const icons = {
          maintenance: 'fa-wrench',
          insurance: 'fa-shield-alt',
          geofence: 'fa-map-marker-alt',
          fuel: 'fa-gas-pump',
          overdue: 'fa-clock',
          booking: 'fa-calendar-alt'
        };
        return icons[type] || 'fa-bell';
      }

      function generateRandomAlert() {
        const alertTypes = [
          { type: 'maintenance', message: 'Ford Focus requires oil change', severity: 'medium', vehicle: 'FOR123' },
          { type: 'fuel', message: 'Nissan Altima fuel level critical (8%)', severity: 'high', vehicle: 'NIS456' },
          { type: 'geofence', message: 'Honda CR-V entered restricted zone', severity: 'warning', vehicle: 'HON789' },
          { type: 'booking', message: 'Customer requesting immediate pickup', severity: 'info', vehicle: 'TBD' }
        ];
        
        const randomAlert = alertTypes[Math.floor(Math.random() * alertTypes.length)];
        const newAlert = {
          id: Date.now(),
          ...randomAlert,
          time: 'Just now'
        };
        
        allAlerts.unshift(newAlert);
        if (allAlerts.length > 15) allAlerts.pop();
        
        updateLiveAlerts();
        
        if (newAlert.severity === 'critical') {
          showNotification(`CRITICAL: ${newAlert.message}`, 'danger');
        }
      }

      // === ENHANCED ACTION FUNCTIONS ===
      function filterAlerts(type) {
        currentAlertFilter = type;
        updateLiveAlerts();
        
        document.querySelectorAll('.btn-group-sm button').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
      }

      function handleAlert(alertId) {
        const alert = allAlerts.find(a => a.id === alertId);
        if (alert) {
          alert(`Handling Alert: ${alert.message}\n\nRecommended Actions:\n• Contact relevant staff\n• Verify alert details\n• Take corrective action\n• Update alert status`);
        }
      }

      function dismissAlert(alertId) {
        allAlerts = allAlerts.filter(a => a.id !== alertId);
        updateLiveAlerts();
        showNotification('Alert dismissed', 'info');
      }

      function showAlertCenter() {
        alert('Alert Management Center\n\nFeatures:\n• Alert history and tracking\n• Automated escalation rules\n• Performance threshold configuration\n• Notification preferences\n• Alert analytics and trends');
      }

      function showRealTimeMonitoring() {
        alert('Real-Time Operations Monitor\n\nLive Data:\n• Staff locations and status\n• Vehicle tracking and assignments\n• Branch capacity and alerts\n• System performance metrics\n• Emergency response coordination');
      }

      function updateRevenueChart() {
        const period = document.getElementById('revenueTimeFilter').value;
        console.log('Updating revenue chart for period:', period);
        
        if (window.revenueTrendChart) {
          let newData, newLabels;
          
          switch(period) {
            case '7':
              newLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
              newData = [
                [9800, 10200, 11500, 12800, 13200, 15600, 14200],
                [6400, 6800, 7200, 7800, 8200, 9800, 8900],
                [3400, 3400, 4300, 5000, 5000, 5800, 5300]
              ];
              break;
            case '90':
              newLabels = ['Month 1', 'Month 2', 'Month 3'];
              newData = [
                [198450, 205600, 189300],
                [128200, 132800, 121500],
                [70250, 72800, 67800]
              ];
              break;
            default:
              newLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
              newData = [
                [68450, 72180, 75920, 68023],
                [44200, 46800, 49100, 44200],
                [24250, 25380, 26820, 23823]
              ];
          }
          
          window.revenueTrendChart.data.labels = newLabels;
          window.revenueTrendChart.data.datasets[0].data = newData[0];
          window.revenueTrendChart.data.datasets[1].data = newData[1];
          window.revenueTrendChart.data.datasets[2].data = newData[2];
          window.revenueTrendChart.update();
        }
      }

      function exportRevenueData() {
        alert('Revenue Data Export\n\nExporting:\n• Revenue trends and forecasts\n• Cost analysis breakdown\n• Profit margin calculations\n• Performance comparisons\n\nFormats: Excel, PDF, CSV');
      }

      // Quick Action Functions
      function emergencyVehicleDispatch() {
        alert('🚨 EMERGENCY DISPATCH SYSTEM 🚨\n\nActivating:\n• Emergency response protocols\n• Nearest vehicle identification\n• Staff notification system\n• Customer communication\n• Incident logging');
      }

      function lockdownMode() {
        if (confirm('⚠️ ACTIVATE SYSTEM LOCKDOWN? ⚠️\n\nThis will:\n• Disable new bookings\n• Lock vehicle assignments\n• Alert all staff\n• Enable emergency protocols\n\nConfirm lockdown?')) {
          alert('🔒 SYSTEM LOCKDOWN ACTIVATED\n\nAll operations secured.\nEmergency protocols enabled.\nStaff have been notified.');
        }
      }

      function broadcastAlert() {
        const message = prompt('📢 Broadcast Message to All Staff:', 'URGENT: Please check your stations immediately');
        if (message) {
          alert(`📡 BROADCASTING TO ALL STAFF:\n\n"${message}"\n\nDelivery:\n• SMS notifications sent\n• Email alerts dispatched\n• Dashboard notifications active\n• Mobile app push notifications`);
        }
      }

      function quickVehicleAssignment() {
        alert('🚗 Quick Vehicle Assignment\n\nFeatures:\n• Smart vehicle matching\n• Instant availability check\n• Automated customer notification\n• GPS location verification\n• Digital key assignment');
      }

      function instantCheckout() {
        alert('✅ Instant Checkout System\n\nStreamlined process:\n• QR code vehicle identification\n• Digital signature capture\n• Automated documentation\n• Real-time status updates\n• Customer SMS confirmation');
      }

      function customerSupportChat() {
        alert('💬 Live Customer Support\n\nCapabilities:\n• Real-time chat interface\n• Customer history access\n• Screen sharing support\n• Escalation workflows\n• Multi-language support');
      }

      function processRefund() {
        alert('💰 Quick Refund Processing\n\nFeatures:\n• Instant refund approval\n• Multiple payment methods\n• Automated customer notifications\n• Audit trail creation\n• Compliance verification');
      }

      function escalateIssue() {
        alert('⬆️ Issue Escalation System\n\nEscalation levels:\n• Level 1: Supervisor (immediate)\n• Level 2: Branch Manager (15 min)\n• Level 3: Regional Director (30 min)\n• Emergency: Executive team (immediate)');
      }

      function generateInstantReport() {
        alert('📊 Instant Report Generator\n\nQuick reports:\n• Daily operations summary\n• Revenue snapshot analysis\n• Fleet utilization metrics\n• Customer satisfaction scores\n• Performance benchmarks');
      }

      function exportDashboardData() {
        alert('📁 Dashboard Data Export\n\nExport options:\n• Complete dashboard dataset\n• Selected widgets only\n• Custom date ranges\n• Multiple formats available\n• Automated scheduling');
      }

      function scheduleReport() {
        alert('📅 Report Scheduling\n\nAutomated reporting:\n• Daily operational reports\n• Weekly performance summaries\n• Monthly analytics\n• Custom intervals\n• Multi-recipient delivery');
      }

      // === EXECUTIVE SUMMARY FUNCTIONS ===
      function exportExecutiveSummary() {
        alert('📊 Executive Summary Export\n\nGenerating comprehensive executive report:\n• Business health analysis\n• Performance metrics\n• Key insights and recommendations\n• Market position analysis\n• Strategic action items\n\nFormat: Professional PDF report');
      }

      // === LOGIN TIME TRACKING SYSTEM ===
      function initializeLoginTracking() {
        updateLastLoginTime();
        updateCurrentSessionTime();
        
        // Update session time every minute
        setInterval(updateCurrentSessionTime, 60000);
      }

      function updateLastLoginTime() {
        const lastLoginElement = document.getElementById('lastLoginTime');
        if (!lastLoginElement) return;
        
        // Get stored login times
        let lastLoginTime = localStorage.getItem('lastLoginTime');
        let currentSessionStart = localStorage.getItem('currentSessionStart');
        const now = new Date().toISOString();
        
        // Check if this is a new session (more than 30 minutes since last activity)
        const lastActivity = localStorage.getItem('lastActivity');
        const isNewSession = !lastActivity || (new Date() - new Date(lastActivity)) > (30 * 60 * 1000); // 30 minutes
        
        if (!lastLoginTime) {
          // Very first time using the system
          lastLoginElement.textContent = 'First time login';
          localStorage.setItem('lastLoginTime', now);
          localStorage.setItem('currentSessionStart', now);
        } else if (isNewSession) {
          // New session - display the previous login time
          const loginDate = new Date(lastLoginTime);
          const timeDiff = new Date() - loginDate;
          let timeAgo = formatTimeAgo(timeDiff);
          lastLoginElement.textContent = timeAgo;
          
          // Update last login time to current session start for next time
          localStorage.setItem('lastLoginTime', now);
          localStorage.setItem('currentSessionStart', now);
        } else {
          // Same session continuing - show the last login (before current session)
          if (lastLoginTime) {
            const loginDate = new Date(lastLoginTime);
            const timeDiff = new Date() - loginDate;
            let timeAgo = formatTimeAgo(timeDiff);
            lastLoginElement.textContent = timeAgo;
          }
        }
        
        // Update last activity timestamp
        localStorage.setItem('lastActivity', now);
      }

      function updateCurrentSessionTime() {
        // Use the currentSessionStart time that was set during login tracking
        const sessionStart = localStorage.getItem('currentSessionStart') || localStorage.getItem('sessionStartTime') || new Date().toISOString();
        
        // Ensure we have a session start time
        if (!localStorage.getItem('currentSessionStart')) {
          localStorage.setItem('currentSessionStart', sessionStart);
        }
        
        const startTime = new Date(sessionStart);
        const now = new Date();
        const sessionDuration = now - startTime;
        
        // Update session info in the dashboard update span
        const updateElement = document.getElementById('lastDashboardUpdate');
        if (updateElement) {
          const sessionTime = formatSessionDuration(sessionDuration);
          updateElement.textContent = `Just now (Session: ${sessionTime})`;
        }
        
        // Update last activity for session tracking
        localStorage.setItem('lastActivity', now.toISOString());
      }

      function formatTimeAgo(milliseconds) {
        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        const weeks = Math.floor(days / 7);
        const months = Math.floor(days / 30);
        
        if (months > 0) return `${months} month${months > 1 ? 's' : ''} ago`;
        if (weeks > 0) return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
        if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
        if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        return 'Just now';
      }

      function formatSessionDuration(milliseconds) {
        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        if (hours > 0) {
          const remainingMinutes = minutes % 60;
          return `${hours}h ${remainingMinutes}m`;
        }
        if (minutes > 0) {
          return `${minutes}m`;
        }
        return '< 1m';
      }

      // === NEW WIDGET INITIALIZATION ===
      function initializeNewWidgets() {
        populateMaintenanceAlerts();
        populateBranchPerformance();
        populateUpcomingBookings();
        populateTopCustomers();
        updateWeatherData();
        
        // Update weather every 30 minutes
        setInterval(updateWeatherData, 1800000);
      }

      function populateMaintenanceAlerts() {
        const container = document.getElementById('maintenanceAlertsList');
        if (!container) return;
        
        const maintenanceAlerts = [
          { vehicle: 'Honda Civic - ABC123', issue: 'Oil Change Due', priority: 'medium', dueDate: 'Today' },
          { vehicle: 'Ford Focus - DEF456', issue: 'Brake Inspection', priority: 'high', dueDate: 'Tomorrow' },
          { vehicle: 'BMW X3 - GHI345', issue: 'Tire Rotation', priority: 'low', dueDate: 'Dec 20' }
        ];
        
        container.innerHTML = maintenanceAlerts.map(alert => `
          <div class="maintenance-alert d-flex justify-content-between align-items-center p-2 mb-2 border-start border-3 border-${getPriorityColor(alert.priority)}">
            <div>
              <div class="fw-bold">${alert.vehicle}</div>
              <small class="text-muted">${alert.issue} • Due: ${alert.dueDate}</small>
            </div>
            <span class="badge bg-${getPriorityColor(alert.priority)}">${alert.priority}</span>
          </div>
        `).join('');
      }

      function populateBranchPerformance() {
        const container = document.getElementById('branchPerformanceList');
        if (!container) return;
        
        const branchData = [
          { name: 'Manhattan', performance: 87, vehicles: 42, status: 'excellent' },
          { name: 'Brooklyn', performance: 82, vehicles: 28, status: 'good' },
          { name: 'Queens', performance: 76, vehicles: 31, status: 'average' },
          { name: 'Bronx', performance: 68, vehicles: 18, status: 'needs-attention' }
        ];
        
        container.innerHTML = branchData.map(branch => `
          <div class="branch-performance d-flex justify-content-between align-items-center mb-3">
            <div>
              <div class="fw-bold">${branch.name}</div>
              <small class="text-muted">${branch.vehicles} vehicles</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-${getPerformanceColor(branch.performance)}">${branch.performance}%</div>
              <div class="progress mt-1" style="width: 60px; height: 4px;">
                <div class="progress-bar bg-${getPerformanceColor(branch.performance)}" style="width: ${branch.performance}%"></div>
              </div>
            </div>
          </div>
        `).join('');
      }

      function populateUpcomingBookings() {
        const container = document.getElementById('upcomingBookingsList');
        if (!container) return;
        
        const upcomingBookings = [
          { customer: 'Alice Brown', vehicle: 'Toyota Camry', time: '10:30 AM', type: 'pickup' },
          { customer: 'Bob Wilson', vehicle: 'Honda CR-V', time: '2:15 PM', type: 'return' },
          { customer: 'Carol Davis', vehicle: 'BMW X3', time: '4:45 PM', type: 'pickup' },
          { customer: 'David Lee', vehicle: 'Ford Focus', time: '6:00 PM', type: 'return' }
        ];
        
        container.innerHTML = upcomingBookings.map(booking => `
          <div class="upcoming-booking d-flex justify-content-between align-items-center p-2 mb-2 border rounded">
            <div>
              <div class="fw-bold">${booking.customer}</div>
              <small class="text-muted">${booking.vehicle} • ${booking.time}</small>
            </div>
            <span class="badge bg-${booking.type === 'pickup' ? 'success' : 'info'}">${booking.type}</span>
          </div>
        `).join('');
      }

      function populateTopCustomers() {
        const container = document.getElementById('topCustomersList');
        if (!container) return;
        
        const topCustomers = [
          { name: 'TechCorp Inc.', spent: 45200, type: 'corporate', rating: 4.9 },
          { name: 'Global Solutions', spent: 38900, type: 'corporate', rating: 4.8 },
          { name: 'John Smith', spent: 8450, type: 'individual', rating: 4.6 },
          { name: 'Tourism Agency', spent: 12300, type: 'tourist', rating: 4.2 }
        ];
        
        container.innerHTML = topCustomers.map((customer, index) => `
          <div class="top-customer d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
              <span class="badge bg-${index === 0 ? 'warning' : index < 3 ? 'success' : 'primary'} rounded-pill me-2">#${index + 1}</span>
              <div>
                <div class="fw-bold">${customer.name}</div>
                <small class="text-muted">${getCustomerTypeIcon(customer.type)} ${customer.rating} ⭐</small>
              </div>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">$${customer.spent.toLocaleString()}</div>
            </div>
          </div>
        `).join('');
      }

      function updateWeatherData() {
        // Simulate weather API data
        const weatherConditions = [
          { icon: 'fa-sun', temp: 72, condition: 'Sunny, Clear', impact: '+15%', color: 'warning' },
          { icon: 'fa-cloud-sun', temp: 68, condition: 'Partly Cloudy', impact: '+8%', color: 'info' },
          { icon: 'fa-cloud-rain', temp: 65, condition: 'Light Rain', impact: '-12%', color: 'primary' },
          { icon: 'fa-snowflake', temp: 45, condition: 'Snow', impact: '-25%', color: 'secondary' }
        ];
        
        const randomWeather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
        
        const weatherIcon = document.querySelector('.weather-icon i');
        const tempElement = document.querySelector('.weather-info h5');
        const conditionElement = document.querySelector('.weather-info p');
        const impactElement = document.querySelector('.weather-info small');
        
        if (weatherIcon) {
          weatherIcon.className = `fas ${randomWeather.icon} text-${randomWeather.color}`;
        }
        if (tempElement) {
          tempElement.textContent = `${randomWeather.temp}°F`;
        }
        if (conditionElement) {
          conditionElement.textContent = randomWeather.condition;
        }
        if (impactElement) {
          impactElement.textContent = `${randomWeather.impact} booking impact`;
          impactElement.className = randomWeather.impact.startsWith('+') ? 'text-success' : 'text-danger';
        }
      }

      function getPerformanceColor(performance) {
        if (performance >= 85) return 'success';
        if (performance >= 75) return 'primary';
        if (performance >= 65) return 'warning';
        return 'danger';
      }

      function getCustomerTypeIcon(type) {
        const icons = {
          corporate: '🏢',
          individual: '👤',
          tourist: '✈️'
        };
        return icons[type] || '👤';
      }

      // New Widget Action Functions
      function openMaintenanceCenter() {
        alert('🔧 Maintenance Center\n\nOpening comprehensive maintenance management:\n• Predictive maintenance alerts\n• Service scheduling\n• Parts inventory\n• Technician assignments\n• Cost tracking\n• Compliance monitoring');
      }

      function openBranchAnalytics() {
        alert('📊 Branch Analytics Center\n\nDetailed branch analysis:\n• Performance comparisons\n• Revenue per branch\n• Staff productivity\n• Vehicle utilization\n• Customer satisfaction\n• Market penetration');
      }

      function openBookingCenter() {
        alert('📅 Booking Management Center\n\nAdvanced booking operations:\n• Booking pipeline\n• Demand forecasting\n• Capacity planning\n• Customer preferences\n• Pricing optimization\n• Availability management');
      }

      function openCustomerCenter() {
        alert('👥 Customer Relationship Center\n\nVIP customer management:\n• Customer lifetime value\n• Loyalty programs\n• Personalized offers\n• Communication history\n• Satisfaction tracking\n• Retention strategies');
      }

      // === FLOATING FEEDBACK SYSTEM ===
      function openFeedbackModal() {
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        modal.show();
        
        // Focus on name field
        setTimeout(() => {
          document.getElementById('feedbackName').focus();
        }, 500);
      }

      function getCurrentPageName() {
        const path = window.location.pathname;
        const fileName = path.split('/').pop();
        
        const pageMap = {
          'index.html': 'Dashboard',
          'fleet-management.html': 'Fleet Management',
          'booking-management.html': 'Booking Management',
          'customer-management.html': 'Customer Management',
          'billing-payments.html': 'Billing & Payments',
          'telematics-tracking.html': 'Telematics & Tracking',
          'reports-analytics.html': 'Reports & Analytics',
          'maintenance-compliance.html': 'Maintenance & Compliance',
          'branch-staff-management.html': 'Branch & Staff Management'
        };
        
        return pageMap[fileName] || '';
      }

      async function submitFeedback() {
        const form = document.getElementById('feedbackForm');
        const submitBtn = document.getElementById('submitFeedbackBtn');
        const statusDiv = document.getElementById('feedbackStatus');
        
        // Validate form
        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }
        
        // Disable submit button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';
        
        // Collect form data (simplified for 4-column sheet)
        const feedbackData = {
          Name: document.getElementById('feedbackName').value,
          'Specific Module': document.getElementById('feedbackModule').value,
          Page: getCurrentPageName(),
          Comment: document.getElementById('feedbackComment').value
        };
        
        try {
          // Submit to SheetDB API
          const response = await fetch('https://sheetdb.io/api/v1/m6e9alkji637v', {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(feedbackData)
          });
          
          if (response.ok) {
            // Success
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = `
              <i class="fas fa-check-circle me-2"></i>
              <strong>Thank you!</strong> Your feedback has been submitted successfully.
            `;
            statusDiv.style.display = 'block';
            
            // Reset form
            form.reset();
            form.classList.remove('was-validated');
            
            // Auto-close modal after 3 seconds
            setTimeout(() => {
              bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
            }, 3000);
            
            // Show success notification
            showNotification('✅ Feedback submitted successfully! Thank you for helping us improve.', 'success');
            
          } else {
            throw new Error('Failed to submit feedback');
          }
          
        } catch (error) {
          console.error('Feedback submission error:', error);
          
          // Show error message
          statusDiv.className = 'alert alert-danger';
          statusDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Submission Failed</strong><br>
            Please try again or contact IT support if the problem persists.<br>
            <small class="text-muted">Error: ${error.message}</small>
          `;
          statusDiv.style.display = 'block';
        }
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Submit Feedback';
      }

      // === CALENDAR INTEGRATION FUNCTIONS ===
      function openFullCalendar() {
        alert('📅 Full Calendar System\n\nOpening comprehensive calendar with:\n• Monthly/weekly/daily views\n• Booking management\n• Staff scheduling\n• Maintenance planning\n• Event coordination\n• Integration with all modules');
      }

      // === FLEET USAGE ANALYTICS WIDGET ===
      function initializeFleetUsageWidget() {
        populateFleetUsageData();
        initializeUsageCharts();
        updateSeasonalIndicator();
        
        // Update fleet usage data every 5 minutes
        setInterval(populateFleetUsageData, 300000);
        
        // Add window resize handler for chart responsiveness
        window.addEventListener('resize', function() {
          if (usagePatternChart) {
            setTimeout(() => {
              usagePatternChart.resize();
            }, 100);
          }
        });
      }

      let currentUsagePeriod = 'today';
      let usagePatternChart = null;
      
      const fleetUsageData = {
        today: {
          totalHours: 847.5,
          totalMiles: 12847,
          efficiency: 87.3,
          hoursChange: '+12.3%',
          milesChange: '+8.7%',
          efficiencyChange: '+2.1%',
          chartLabels: ['12AM', '2AM', '4AM', '6AM', '8AM', '10AM', '12PM', '2PM', '4PM', '6PM', '8PM', '10PM'],
          chartData: [12, 8, 5, 15, 35, 45, 52, 68, 75, 62, 38, 25],
          vehicles: [
            { name: 'Toyota Camry - ABC123', hours: 8.5, miles: 245, efficiency: 92, peak: '2-6 PM', status: 'Active' },
            { name: 'Honda CR-V - XYZ789', hours: 7.2, miles: 198, efficiency: 88, peak: '10-2 PM', status: 'Active' },
            { name: 'Ford Focus - DEF456', hours: 6.8, miles: 167, efficiency: 85, peak: '9-1 PM', status: 'Maintenance' },
            { name: 'BMW X3 - GHI345', hours: 9.1, miles: 287, efficiency: 94, peak: '1-5 PM', status: 'Active' },
            { name: 'Nissan Altima - JKL012', hours: 5.3, miles: 134, efficiency: 78, peak: '3-7 PM', status: 'Available' }
          ]
        },
        week: {
          totalHours: 5234.8,
          totalMiles: 89567,
          efficiency: 84.7,
          hoursChange: '+15.6%',
          milesChange: '+11.2%',
          efficiencyChange: '+3.8%',
          chartLabels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
          chartData: [420, 480, 520, 580, 610, 720, 650],
          vehicles: [
            { name: 'Toyota Camry - ABC123', hours: 52.3, miles: 1567, efficiency: 91, peak: 'Weekdays 2-6 PM', status: 'Active' },
            { name: 'Honda CR-V - XYZ789', hours: 48.7, miles: 1423, efficiency: 87, peak: 'Weekdays 10-2 PM', status: 'Active' },
            { name: 'Ford Focus - DEF456', hours: 41.2, miles: 1198, efficiency: 82, peak: 'Weekends 9-1 PM', status: 'Maintenance' },
            { name: 'BMW X3 - GHI345', hours: 58.9, miles: 1789, efficiency: 93, peak: 'Daily 1-5 PM', status: 'Active' },
            { name: 'Nissan Altima - JKL012', hours: 35.6, miles: 987, efficiency: 76, peak: 'Evenings 3-7 PM', status: 'Available' }
          ]
        },
        month: {
          totalHours: 21456.3,
          totalMiles: 387234,
          efficiency: 82.1,
          hoursChange: '+18.9%',
          milesChange: '+14.3%',
          efficiencyChange: '+5.2%',
          chartLabels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          chartData: [1850, 1920, 2100, 2280, 2450, 2680, 2820, 2750, 2580, 2380, 2150, 1890],
          vehicles: [
            { name: 'Toyota Camry - ABC123', hours: 234.7, miles: 6789, efficiency: 89, peak: 'Business Hours', status: 'Active' },
            { name: 'Honda CR-V - XYZ789', hours: 198.3, miles: 5634, efficiency: 85, peak: 'Morning Rush', status: 'Active' },
            { name: 'Ford Focus - DEF456', hours: 167.8, miles: 4567, efficiency: 80, peak: 'Weekend Peak', status: 'Maintenance' },
            { name: 'BMW X3 - GHI345', hours: 267.2, miles: 7890, efficiency: 91, peak: 'Afternoon Peak', status: 'Active' },
            { name: 'Nissan Altima - JKL012', hours: 145.9, miles: 3987, efficiency: 74, peak: 'Evening Hours', status: 'Available' }
          ]
        }
      };

      function setUsagePeriod(period) {
        currentUsagePeriod = period;
        
        // Update button states
        document.querySelectorAll('.fleet-usage-widget .btn-group .btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update data and charts
        populateFleetUsageData();
        updateUsagePatternChart();
        updateSeasonalIndicator();
        
        showNotification(`Fleet usage switched to ${period} view`, 'info');
      }

      function updateUsagePatternChart() {
        if (!usagePatternChart) return;
        
        const data = fleetUsageData[currentUsagePeriod];
        
        // Update chart data
        usagePatternChart.data.labels = data.chartLabels;
        usagePatternChart.data.datasets[0].data = data.chartData;
        
        // Update chart title based on period
        const periodTitles = {
          today: 'Usage Pattern - 24 Hours',
          week: 'Usage Pattern - 7 Days', 
          month: 'Usage Pattern - 12 Months'
        };
        
        usagePatternChart.options.plugins.title = {
          display: true,
          text: periodTitles[currentUsagePeriod] || 'Usage Pattern'
        };
        
        // Animate the update
        usagePatternChart.update('active');
      }

      function updateSeasonalIndicator() {
        const indicator = document.getElementById('seasonalIndicator');
        if (!indicator) return;
        
        const indicators = {
          today: 'Real-time',
          week: 'Weekly Trend',
          month: 'Yearly Overview'
        };
        
        const colors = {
          today: 'bg-success',
          week: 'bg-primary', 
          month: 'bg-info'
        };
        
        indicator.textContent = indicators[currentUsagePeriod];
        indicator.className = `badge ${colors[currentUsagePeriod]}`;
      }

      function populateFleetUsageData() {
        const data = fleetUsageData[currentUsagePeriod];
        
        // Update summary cards
        document.getElementById('totalUsageHours').textContent = data.totalHours + 'h';
        document.getElementById('totalMiles').textContent = data.totalMiles.toLocaleString();
        document.getElementById('efficiencyRate').textContent = data.efficiency + '%';
        
        // Update usage details table
        populateUsageDetailsTable(data.vehicles);
      }

      function populateUsageDetailsTable(vehicles) {
        const tbody = document.getElementById('usageDetailsTable');
        if (!tbody) return;
        
        tbody.innerHTML = vehicles.map(vehicle => `
          <tr>
            <td>
              <div class="fw-bold">${vehicle.name}</div>
            </td>
            <td>
              <span class="badge bg-primary">${vehicle.hours}h</span>
            </td>
            <td>
              <span class="text-muted">${vehicle.miles.toLocaleString()} mi</span>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="progress me-2" style="width: 60px; height: 8px;">
                  <div class="progress-bar bg-${getEfficiencyColor(vehicle.efficiency)}" 
                       style="width: ${vehicle.efficiency}%"></div>
                </div>
                <span class="text-${getEfficiencyColor(vehicle.efficiency)}">${vehicle.efficiency}%</span>
              </div>
            </td>
            <td>
              <small class="text-muted">${vehicle.peak}</small>
            </td>
            <td>
              <span class="badge bg-${getStatusColor(vehicle.status)}">${vehicle.status}</span>
            </td>
          </tr>
        `).join('');
      }

      function getEfficiencyColor(efficiency) {
        if (efficiency >= 90) return 'success';
        if (efficiency >= 80) return 'primary';
        if (efficiency >= 70) return 'warning';
        return 'danger';
      }

      function getStatusColor(status) {
        const colors = {
          'Active': 'success',
          'Available': 'info',
          'Maintenance': 'warning',
          'Out of Service': 'danger'
        };
        return colors[status] || 'secondary';
      }

      function initializeUsageCharts() {
        initializeUsagePatternChart();
        initializeVehicleTypeUsageChart();
      }

      function initializeUsagePatternChart() {
        const ctx = document.getElementById('usagePatternChart');
        if (!ctx) return;
        
        const initialData = fleetUsageData[currentUsagePeriod];
        
        usagePatternChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: initialData.chartLabels,
            datasets: [{
              label: 'Active Vehicles',
              data: initialData.chartData,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.1)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#007bff',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2.5,
            plugins: {
              legend: { 
                display: true,
                position: 'top',
                labels: {
                  usePointStyle: true,
                  padding: 20
                }
              },
              title: {
                display: true,
                text: 'Usage Pattern - 24 Hours',
                font: {
                  size: 16,
                  weight: 'bold'
                },
                padding: 20
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function(context) {
                    return `Active Vehicles: ${context.parsed.y}`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                  maxRotation: 45
                }
              },
              y: { 
                beginAtZero: true,
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                  callback: function(value) {
                    return value + ' vehicles';
                  }
                }
              }
            },
            interaction: {
              intersect: false,
              mode: 'index'
            }
          }
        });
      }

      function initializeVehicleTypeUsageChart() {
        const ctx = document.getElementById('vehicleTypeUsageChart');
        if (!ctx) return;
        
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Sedan', 'SUV', 'Compact', 'Luxury'],
            datasets: [{
              data: [35, 28, 22, 15],
              backgroundColor: ['#007bff', '#28a745', '#ffc107', '#6f42c1'],
              borderWidth: 3,
              borderColor: '#ffffff',
              cutout: '65%'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { 
                  padding: 15, 
                  usePointStyle: true,
                  font: { size: 12 },
                  generateLabels: function(chart) {
                    const data = chart.data;
                    if (data.labels.length && data.datasets.length) {
                      return data.labels.map((label, i) => {
                        const dataset = data.datasets[0];
                        const value = dataset.data[i];
                        const total = dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return {
                          text: `${label}: ${percentage}%`,
                          fillStyle: dataset.backgroundColor[i],
                          strokeStyle: dataset.borderColor,
                          lineWidth: dataset.borderWidth,
                          pointStyle: 'circle'
                        };
                      });
                    }
                    return [];
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                cornerRadius: 8,
                callbacks: {
                  label: function(context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                    return `${context.label}: ${context.parsed} vehicles (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }

      function toggleUsageTable() {
        const container = document.getElementById('usageTableContainer');
        const icon = document.getElementById('tableToggleIcon');
        const text = document.getElementById('tableToggleText');
        
        if (container.style.display === 'none') {
          container.style.display = 'block';
          icon.className = 'fas fa-chevron-up';
          text.textContent = 'Hide Details';
          
          const data = fleetUsageData[currentUsagePeriod];
          populateUsageDetailsTable(data.vehicles);
        } else {
          container.style.display = 'none';
          icon.className = 'fas fa-chevron-down';
          text.textContent = 'Show Details';
        }
      }

      // === CRITICAL ALERTS & NOTIFICATIONS WIDGET ===
      function initializeCriticalAlertsWidget() {
        populateCriticalAlerts();
        updateAlertCounts();
        
        // Update alerts every 2 minutes
        setInterval(() => {
          populateCriticalAlerts();
          updateAlertCounts();
        }, 120000);
      }

      const criticalAlertsData = [
        {
          id: 'OVR001',
          type: 'overdue',
          priority: 'high',
          title: 'Vehicle Overdue Return',
          message: 'Toyota Camry (ABC123) - 2 days overdue',
          customer: 'John Smith',
          vehicle: 'Toyota Camry - ABC123',
          time: '2 days ago',
          status: 'active',
          businessImpact: 'high'
        },
        {
          id: 'INS002',
          type: 'insurance',
          priority: 'high',
          title: 'Insurance Expiring Soon',
          message: 'BMW X3 (GHI345) insurance expires in 3 days',
          customer: 'Fleet Vehicle',
          vehicle: 'BMW X3 - GHI345',
          time: '1 hour ago',
          status: 'active',
          businessImpact: 'critical'
        },
        {
          id: 'PAY003',
          type: 'payment',
          priority: 'medium',
          title: 'Payment Failure',
          message: 'Credit card declined for booking #BK-2024-0156',
          customer: 'Sarah Johnson',
          vehicle: 'Honda CR-V - XYZ789',
          time: '30 minutes ago',
          status: 'active',
          businessImpact: 'medium'
        }
      ];

      function populateCriticalAlerts() {
        const container = document.getElementById('criticalAlertsList');
        if (!container) return;
        
        const filteredAlerts = currentAlertFilter === 'all' 
          ? criticalAlertsData.filter(alert => alert.status === 'active')
          : criticalAlertsData.filter(alert => alert.status === 'active' && alert.priority === currentAlertFilter);
        
        container.innerHTML = filteredAlerts.map(alert => `
          <div class="critical-alert-item ${alert.priority}-priority mb-3" data-alert-id="${alert.id}">
            <div class="d-flex justify-content-between align-items-start">
              <div class="alert-content flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas ${getAlertIcon(alert.type)} text-${getAlertColor(alert.priority)} me-2"></i>
                  <h6 class="mb-0 fw-bold">${alert.title}</h6>
                  <span class="badge bg-${getAlertColor(alert.priority)} ms-2">${alert.priority}</span>
                </div>
                <p class="mb-2 text-muted">${alert.message}</p>
                <div class="alert-meta">
                  <small class="text-muted">
                    <i class="fas fa-user me-1"></i>${alert.customer} • 
                    <i class="fas fa-clock me-1"></i>${alert.time} • 
                    <i class="fas fa-exclamation-circle me-1"></i>${alert.businessImpact} impact
                  </small>
                </div>
              </div>
              <div class="alert-actions ms-3">
                <div class="btn-group-vertical btn-group-sm">
                  <button class="btn btn-outline-success btn-sm" onclick="resolveAlert('${alert.id}')" title="Resolve Alert">
                    <i class="fas fa-check"></i>
                  </button>
                  <button class="btn btn-outline-warning btn-sm" onclick="snoozeAlert('${alert.id}')" title="Snooze Alert">
                    <i class="fas fa-clock"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      function updateAlertCounts() {
        const overdueAlerts = criticalAlertsData.filter(a => a.type === 'overdue' && a.status === 'active');
        const insuranceAlerts = criticalAlertsData.filter(a => a.type === 'insurance' && a.status === 'active');
        const paymentAlerts = criticalAlertsData.filter(a => a.type === 'payment' && a.status === 'active');
        const maintenanceAlerts = criticalAlertsData.filter(a => a.type === 'maintenance' && a.status === 'active');
        
        document.getElementById('overdueCount').textContent = overdueAlerts.length;
        document.getElementById('insuranceCount').textContent = insuranceAlerts.length;
        document.getElementById('paymentCount').textContent = paymentAlerts.length;
        document.getElementById('maintenanceCount').textContent = maintenanceAlerts.length;
        
        const totalAlerts = criticalAlertsData.filter(a => a.status === 'active').length;
        document.getElementById('criticalAlertCount').textContent = totalAlerts;
      }

      function getAlertColor(priority) {
        const colors = {
          high: 'danger',
          medium: 'warning',
          low: 'info'
        };
        return colors[priority] || 'secondary';
      }

      function resolveAlert(alertId) {
        const alert = criticalAlertsData.find(a => a.id === alertId);
        if (!alert) return;
        
        alert.status = 'resolved';
        populateCriticalAlerts();
        updateAlertCounts();
        showNotification(`Alert ${alertId} resolved successfully`, 'success');
      }

      function snoozeAlert(alertId) {
        const alert = criticalAlertsData.find(a => a.id === alertId);
        if (!alert) return;
        
        alert.status = 'snoozed';
        populateCriticalAlerts();
        updateAlertCounts();
        showNotification(`Alert ${alertId} snoozed for 1 hour`, 'warning');
        
        // Reactivate after 1 hour
        setTimeout(() => {
          if (alert.status === 'snoozed') {
            alert.status = 'active';
            populateCriticalAlerts();
            updateAlertCounts();
            showNotification(`Alert ${alertId} reactivated`, 'info');
          }
        }, 3600000);
      }

      function handleEmergencyAlert() {
        alert('🚨 Emergency Response Protocol\n\nActivating emergency procedures:\n• Notifying on-call manager\n• Dispatching roadside assistance\n• Contacting emergency services if needed\n• Creating incident report\n• Customer communication initiated');
      }

      function acknowledgeAllAlerts() {
        const activeAlerts = criticalAlertsData.filter(a => a.status === 'active');
        
        if (activeAlerts.length === 0) {
          showNotification('No active alerts to acknowledge', 'info');
          return;
        }
        
        if (confirm(`Acknowledge all ${activeAlerts.length} active alerts?`)) {
          activeAlerts.forEach(alert => {
            alert.acknowledged = true;
          });
          
          populateCriticalAlerts();
          showNotification(`${activeAlerts.length} alerts acknowledged`, 'success');
        }
      }

      function openAlertCenter() {
        alert('🔔 Alert Management Center\n\nComprehensive alert management:\n• Alert history and trends\n• Notification settings\n• Escalation rules\n• Alert templates\n• Response procedures\n• Performance metrics');
      }

      function generateAlertReport() {
        alert('📊 Critical Alerts Report\n\nGenerating comprehensive alert report:\n• Active alerts summary\n• Response time analysis\n• Alert trend analysis\n• Performance metrics\n• Recommendations');
      }

      function showDaySchedule(day) {
        alert(`📅 Schedule for Day ${day}\n\nShowing:\n• All scheduled events\n• Staff assignments\n• Vehicle bookings\n• Maintenance appointments\n• Available time slots\n• Conflict detection`);
      }

      function scheduleMaintenanceSlot() {
        alert('🔧 Schedule Maintenance\n\nMaintenance scheduling:\n• Available service slots\n• Vehicle selection\n• Technician assignment\n• Customer notification\n• Parts availability check\n• Service duration estimation');
      }

      function bookStaffMeeting() {
        alert('👥 Staff Meeting Scheduler\n\nMeeting planning:\n• Staff availability check\n• Room booking\n• Agenda creation\n• Calendar invitations\n• Video conference setup\n• Reminder notifications');
      }

      function planVehicleInspection() {
        alert('📋 Vehicle Inspection Planner\n\nInspection scheduling:\n• Inspection checklist\n• Inspector assignment\n• Time slot booking\n• Vehicle preparation\n• Documentation setup\n• Compliance tracking');
      }
    </script>

    <!-- Floating Feedback Button -->
    <div class="floating-feedback-btn" onclick="openFeedbackModal()" title="Share Your Feedback (Ctrl+Shift+F)">
      <i class="fas fa-comment-dots"></i>
      <span class="feedback-pulse"></span>
    </div>

    <!-- Feedback Modal -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-gradient-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-comment-medical me-2"></i>Share Your Feedback
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="feedback-intro text-center mb-4">
              <i class="fas fa-users text-primary" style="font-size: 3rem;"></i>
              <h6 class="mt-2">Help Us Improve LynxLite</h6>
              <p class="text-muted">Your feedback helps us build a better rental management experience</p>
            </div>

            <form id="feedbackForm" class="needs-validation" novalidate>
              <div class="mb-3">
                <label for="feedbackName" class="form-label">
                  <i class="fas fa-user me-1"></i>Name <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control" id="feedbackName" placeholder="Your name" required>
                <div class="invalid-feedback">Please provide your name.</div>
              </div>

              <div class="mb-3">
                <label for="feedbackModule" class="form-label">
                  <i class="fas fa-puzzle-piece me-1"></i>Specific Module <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="feedbackModule" required>
                  <option value="">Select Module</option>
                  <option value="Dashboard">📊 Dashboard</option>
                  <option value="Fleet Management">🚗 Fleet Management</option>
                  <option value="Booking Management">📅 Booking Management</option>
                  <option value="Customer Management">👥 Customer Management</option>
                  <option value="Billing & Payments">💳 Billing & Payments</option>
                  <option value="Telematics & Tracking">📍 Telematics & Tracking</option>
                  <option value="Reports & Analytics">📈 Reports & Analytics</option>
                  <option value="Maintenance & Compliance">🔧 Maintenance & Compliance</option>
                  <option value="Branch & Staff Management">🏢 Branch & Staff Management</option>
                  <option value="General System">⚙️ General System</option>
                </select>
                <div class="invalid-feedback">Please select a specific module.</div>
              </div>

              <div class="mb-3">
                <label for="feedbackComment" class="form-label">
                  <i class="fas fa-comment me-1"></i>Comment <span class="text-danger">*</span>
                </label>
                <textarea class="form-control" id="feedbackComment" rows="4" 
                          placeholder="Please share your feedback, suggestions, or report any issues..." 
                          required></textarea>
                <div class="invalid-feedback">Please provide your comment.</div>
              </div>

              <!-- Submission Status -->
              <div id="feedbackStatus" class="alert" style="display: none;"></div>
            </form>
          </div>
          <div class="modal-footer">
            <div class="d-flex justify-content-between w-100 align-items-center">
              <div>
                <small class="text-muted">
                  <i class="fas fa-shield-alt me-1"></i>Your feedback is confidential and helps improve the system
                </small>
              </div>
              <div>
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                  <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="submitFeedback()" id="submitFeedbackBtn">
                  <i class="fas fa-paper-plane me-1"></i>Submit Feedback
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
